<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/png" href="/icon.png?v=2">
    <link rel="apple-touch-icon" href="/icon.png?v=2">
    <link rel="icon" type="image/png" sizes="192x192" href="/iconcropped.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/iconcropped.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a365d">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortality Card - Rose Farm</title>

    <!-- Barn Software Styles -->
    <link rel="stylesheet" href="../barnsoftwares-css/barn-software-styles.css">
    <link rel="stylesheet" href="../barnsoftwares-css/mortalitycard.css">
    <script src="../barnsoftwares-css/barn-header.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>



    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import {
            getFirestore, collection, doc, onSnapshot, deleteDoc, getDocs
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "API_KEY",
            authDomain: "chicken-project-2.firebaseapp.com",
            projectId: "chicken-project-2",
            storageBucket: "chicken-project-2.firebasestorage.app",
            messagingSenderId: "596273529964",
            appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
            measurementId: "G-9YLPHR08DB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let startDate = null;
        let birdPlacement = 0;
        let currentFloor = 'bottom'; // Default to bottom floor

        function getCurrentFloorData() {
            return currentFloor === 'top' ? 'top_floor' : 'bottom_floor';
        }

        function getCurrentCollection() {
            return currentFloor === 'top' ? 'vas-b1-f2-MC' : 'vas-b1-f1-MC';
        }

        function getCurrentAmmoniaCollection() {
            return currentFloor === 'top' ? 'ammonia_levels_f2' : 'ammonia_levels';
        }

        function fetchFirestoreData() {
            const docRef = doc(db, "startnewcrop", "vas-b1-snc");

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const floorData = data[getCurrentFloorData()] || {};

                    document.getElementById("barn_number").innerText = data.barn_number || "N/A";
                    birdPlacement = parseInt(floorData.birds_placed) || 0;
                    document.getElementById("amount_placed").innerText = birdPlacement;
                    document.getElementById("sex").innerText = floorData.sex || "N/A";
                    document.getElementById("quota_period").innerText = data.quota_period || "N/A";
                    document.getElementById("hatchery").innerText = data.Hatchery || "N/A";
                    document.getElementById("hatch_id").innerText = data["Hatch ID#"] || "N/A";
                    document.getElementById("notes").innerText = floorData.notes || "No notes available.";
                    document.getElementById("notes_display").innerText = floorData.notes || "No notes available.";

                    document.getElementById("farm_name").innerText = data.farm_name || "N/A";
                    document.getElementById("farm_number").innerText = data.farm_number || "N/A";

                    // Update floor indicator
                    document.getElementById("floor_indicator").innerText = currentFloor === 'top' ? '-Top' : '-Bottom';

                    if (data.date_started && data.date_started.seconds) {
                        const tempDate = new Date(data.date_started.seconds * 1000);
                        const localYear = tempDate.getFullYear();
                        const localMonth = (tempDate.getMonth() + 1).toString().padStart(2, '0');
                        const localDay = tempDate.getDate().toString().padStart(2, '0');
                        const localDateString = `${localYear}-${localMonth}-${localDay}`;

                        startDate = new Date(localYear, tempDate.getMonth(), tempDate.getDate());
                        startDate.setHours(0, 0, 0, 0);

                        document.getElementById("date_placed").innerText = localDateString;

                        console.log("✅ Correctly parsed start date:", localDateString);

                        generateCalendar();
                        updateMortalityTable();
                    }
                }
            });
        }

        function generateCalendar() {
            if (!startDate) return;

            const table = document.getElementById("mortality_table");
            const weekDays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            const startDayIndex = startDate.getDay();

            let thead = "<thead><tr><th>Week</th>";
            for (let i = 0; i < 7; i++) {
                thead += `<th>${weekDays[(startDayIndex + i) % 7]}</th>`;
            }
            thead += "<th>Week Total</th><th>Grand Total</th></tr></thead>";

            let tbody = "<tbody>";
            for (let week = 1; week <= 8; week++) {
                tbody += `<tr><td>Week ${week}</td>`;
                for (let day = 0; day < 7; day++) {
                    const cellDate = new Date(startDate.getTime());
                    cellDate.setDate(startDate.getDate() + (week - 1) * 7 + day);
                    cellDate.setHours(0, 0, 0, 0);

                    const year = cellDate.getFullYear();
                    const month = String(cellDate.getMonth() + 1).padStart(2, '0');
                    const dayOfMonth = String(cellDate.getDate()).padStart(2, '0');
                    const cellId = `${year}-${month}-${dayOfMonth}`;

                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    const formattedDate = cellDate.toLocaleDateString('en-US', options);

                    tbody += `
                       <td id="${cellId}" class="mortality-cell" data-date="${cellId}">
                           <div class="cell-content tooltip">
                               <span class="tooltiptext">${formattedDate}</span>
                               <span class="cell-data"></span>
                           </div>
                       </td>`;
                }
                tbody += `<td id="week_total_${week}">0</td><td id="grand_total_${week}">0</td></tr>`;
            }
            tbody += "</tbody>";

            table.innerHTML = thead + tbody;
        }

        function updateMortalityTable() {
            const collectionRef = collection(db, getCurrentCollection());
            const weekTotals = Array(8).fill(0);
            const cullsPerWeek = Array(8).fill(0);
            const mortalityPerWeek = Array(8).fill(0);
            let totalBirds = 0;

            onSnapshot(collectionRef, (snapshot) => {
                // Clear previous data
                weekTotals.fill(0);
                cullsPerWeek.fill(0);
                mortalityPerWeek.fill(0);
                totalBirds = 0;

                // Clear all cells
                const cells = document.querySelectorAll('.mortality-cell .cell-data');
                cells.forEach(cell => cell.innerHTML = '');

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const date = data.date;
                    const cell = document.getElementById(date);

                    if (cell) {
                        const cellContent = cell.querySelector(".cell-data");
                        if (cellContent) {
                            const culls = parseInt(data.culls) || 0;
                            const mortality = parseInt(data.mortality) || 0;
                            const total = culls + mortality;

                            cellContent.innerHTML = `
                               <span class="top-left">${culls}</span>
                               <span class="center"><b>${total}</b></span>
                               <span class="bottom-right">${mortality}</span>
                           `;

                            const cellDate = new Date(date);
                            const dayDifference = Math.floor((cellDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                            const weekIndex = Math.floor(dayDifference / 7);

                            if (weekIndex >= 0 && weekIndex < 8) {
                                weekTotals[weekIndex] += total;
                                cullsPerWeek[weekIndex] += culls;
                                mortalityPerWeek[weekIndex] += mortality;
                                totalBirds += total;
                            }
                        }
                    }
                });

                let cumulativeTotal = 0;

                weekTotals.forEach((weekTotal, index) => {
                    cumulativeTotal += weekTotal;

                    if (index === 0) {
                        document.getElementById(`week_total_${index + 1}`).innerHTML = `
                           Cull: ${cullsPerWeek[index]}<br>
                           Mort: ${mortalityPerWeek[index]}
                       `;
                    } else {
                        document.getElementById(`week_total_${index + 1}`).innerText = weekTotal;
                    }

                    document.getElementById(`grand_total_${index + 1}`).innerText = cumulativeTotal;
                });

                document.getElementById("total_mortality").innerText = cumulativeTotal;
                document.getElementById("mortality_percentage").innerText = birdPlacement > 0 ?
                    ((totalBirds / birdPlacement) * 100).toFixed(2) + "%" : "0.00%";
            });
        }

        function fetchAmmoniaLevels() {
            console.log("📊 Fetching ammonia levels data...");

            const checkStartDate = setInterval(() => {
                if (startDate) {
                    clearInterval(checkStartDate);
                    console.log("✅ Start date available:", startDate);

                    const dayIntervals = [21, 28, 35, 42, 49, 56];

                    for (let i = 0; i < dayIntervals.length; i++) {
                        const targetDate = new Date(startDate.getTime());
                        targetDate.setDate(startDate.getDate() + dayIntervals[i] - 1);

                        const year = targetDate.getFullYear();
                        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
                        const day = String(targetDate.getDate()).padStart(2, '0');
                        const dateStr = `${year}-${month}-${day}`;

                        document.getElementById(`date_${i + 1}`).innerText = dateStr;
                    }

                    fetchAmmoniaReadings();
                }
            }, 500);
        }

        function fetchAmmoniaReadings() {
            const ammoniaDocRef = doc(db, getCurrentAmmoniaCollection(), "fixed_days");

            onSnapshot(ammoniaDocRef, (docSnap) => {
                if (!docSnap.exists()) {
                    console.warn(`No ammonia doc found at ${getCurrentAmmoniaCollection()}/fixed_days`);
                    for (let i = 1; i <= 6; i++) {
                        document.getElementById(`level_${i}`).innerText = "N/A";
                    }
                    return;
                }

                const data = docSnap.data();
                const dayIntervals = [21, 28, 35, 42, 49, 56];
                for (let i = 0; i < dayIntervals.length; i++) {
                    const fieldName = `day_${dayIntervals[i]}`;
                    const val = data[fieldName] !== undefined ? data[fieldName] : "N/A";
                    document.getElementById(`level_${i + 1}`).innerText = val;
                }
            }, (err) => {
                console.error("Error fetching ammonia levels:", err);
                for (let i = 1; i <= 6; i++) {
                    document.getElementById(`level_${i}`).innerText = "N/A";
                }
            });
        }

        function switchFloor() {
            const toggle = document.getElementById('floor_toggle');
            currentFloor = toggle.checked ? 'top' : 'bottom';  // Flipped the logic

            console.log(`Switching to ${currentFloor} floor`);

            // Clear existing data
            document.getElementById("mortality_table").innerHTML = "";
            document.getElementById("total_mortality").innerText = "0";
            document.getElementById("mortality_percentage").innerText = "0%";

            // Fetch new data
            fetchFirestoreData();
            fetchAmmoniaLevels();
        }

        window.resetCalendar = async function () {
            try {
                const mortalityCollection = collection(db, getCurrentCollection());
                const snapshot = await getDocs(mortalityCollection);

                if (snapshot.empty) {
                    alert("No data to reset.");
                    return;
                }

                const deletePromises = snapshot.docs.map((doc) => deleteDoc(doc.ref));
                await Promise.all(deletePromises);

                alert("🗑️ All data has been reset successfully!");

                // Clear the calendar visually
                document.getElementById("mortality_table").innerHTML = "";
                document.getElementById("total_mortality").innerText = "0";
                document.getElementById("mortality_percentage").innerText = "0%";

                // Re-generate an empty calendar
                generateCalendar();

            } catch (error) {
                console.error("Error resetting calendar:", error);
                alert("❌ Failed to reset data. Check the console for details.");
            }
        };

        window.onload = () => {
            console.log("🚀 Page loaded, initializing...");

            // Set up floor toggle event listener
            document.getElementById('floor_toggle').addEventListener('change', switchFloor);

            // Initialize with bottom floor (default)
            fetchFirestoreData();
            fetchAmmoniaLevels();
        };
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById("save_button").addEventListener("click", async function () {
                console.log("📄 Generating PDF with Centered & Scaled Content...");

                const reportContent = document.querySelector(".main-layout");
                const saveButton = document.getElementById("save_button");
                saveButton.style.display = "none";

                try {
                    const mortalityTable = document.getElementById("mortality_table");
                    const originalBorder = mortalityTable.style.border;
                    mortalityTable.style.border = "1px solid black";
                    mortalityTable.style.borderCollapse = "collapse";

                    const canvas = await html2canvas(reportContent, {
                        scale: 3,
                        useCORS: true,
                        logging: false,
                        backgroundColor: "#ffffff",
                        width: reportContent.scrollWidth,
                        height: reportContent.scrollHeight
                    });

                    mortalityTable.style.border = originalBorder;
                    mortalityTable.style.borderCollapse = "";

                    saveButton.style.display = "block";

                    const imgData = canvas.toDataURL("image/png");

                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;

                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight) * 0.95;

                    const scaledWidth = imgWidth * ratio;
                    const scaledHeight = imgHeight * ratio;
                    const marginX = (pdfWidth - scaledWidth) / 2;
                    const marginY = (pdfHeight - scaledHeight) / 2;

                    pdf.addImage(imgData, 'PNG', marginX, marginY, scaledWidth, scaledHeight);

                    const floorName = currentFloor.charAt(0).toUpperCase() + currentFloor.slice(1);
                    pdf.save(`Mortality_Card_${floorName}_Floor.pdf`);

                    console.log("✅ PDF saved successfully with Centered & Scaled Content!");
                } catch (error) {
                    console.error("❌ Error generating PDF:", error);
                    alert("Failed to generate PDF. Check console for details.");
                    saveButton.style.display = "block";
                }
            });
        });
    </script>
</head>

<body>
    <!-- Main Layout Wrapper -->
    <div class="main-layout">
        <!-- Floor Toggle at the Top -->
        <div class="floor-toggle-container">
            <span class="floor-label">Bottom Floor</span>
            <label class="floor-toggle">
                <input type="checkbox" id="floor_toggle" unchecked>
                <span class="floor-toggle-slider"></span>
            </label>
            <span class="floor-label">Top Floor</span>
        </div>

        <!-- Farm Info at the Top -->
        <div class="farm-info-box">
            <h2 id="rsmsize">Vassilakos Barn 1</h2>
            <div class="header-box">
                <div><strong>Farm Name:</strong> <span id="farm_name">Loading...</span></div>
                <div><strong>Farm Number:</strong> <span id="farm_number">Loading...</span></div>
                <div><strong>Quota Period:</strong> <span id="quota_period">Loading...</span></div>
                <div><strong>Amount Placed:</strong> <span id="amount_placed">Loading...</span></div>
                <div><strong>Sex:</strong> <span id="sex">Loading...</span></div>
                <div><strong>Barn #:</strong> <span id="barn_number">Loading...</span><span id="floor_indicator">
                        -Bottom</span></div>
                <div><strong>Date Placed:</strong> <span id="date_placed">Loading...</span></div>
                <div><strong>Hatchery:</strong> <span id="hatchery">Loading...</span></div>
                <div><strong>Hatch ID#:</strong> <span id="hatch_id">Loading...</span></div>
                <div><strong class="notev hide-notes-duplicate">Notes:</strong> <span id="notes"
                        class="notev hide-notes-duplicate">Loading...</span></div>
            </div>
        </div>

        <!-- Calendar Section (Left) -->
        <div class="calendar-container">
            <div class="content-layout">
                <!-- Calendar Section (Left) -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3>Mortality Card</h3>
                        <div class="farm-totals-box">
                            <strong>Total Mortality:</strong> <span id="total_mortality">0</span><br>
                            <strong>Mortality Percentage:</strong> <span id="mortality_percentage">0%</span>
                        </div>
                    </div>

                    <table id="mortality_table" border="1"></table>

                    <!-- Save Button -->
                    <div class="save-button-container">
                        <button id="save_button" class="save-button">Save as PDF</button>
                    </div>
                </div>

                <!-- Right Side Column for Ammonia and Notes -->
                <div class="side-column">
                    <!-- Notes Box (appears first/top) -->
                    <div class="notes-info-box">
                        <h3 class="custom-info-title">Notes</h3>
                        <div class="notes-content" id="notes_display">Loading...</div>
                    </div>

                    <!-- Ammonia Levels Box (appears second/bottom) -->
                    <div class="custom-info-box">
                        <h3 class="custom-info-title">Ammonia Levels</h3>
                        <table class="custom-ammonia-table">
                            <thead>
                                <tr>
                                    <th>Level</th>
                                    <th>Day</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><span id="level_1">Loading...</span> PPM</td>
                                    <td>21</td>
                                    <td><span id="date_1">Loading...</span></td>
                                </tr>
                                <tr>
                                    <td><span id="level_2">Loading...</span> PPM</td>
                                    <td>28</td>
                                    <td><span id="date_2">Loading...</span></td>
                                </tr>
                                <tr>
                                    <td><span id="level_3">Loading...</span> PPM</td>
                                    <td>35</td>
                                    <td><span id="date_3">Loading...</span></td>
                                </tr>
                                <tr>
                                    <td><span id="level_4">Loading...</span> PPM</td>
                                    <td>42</td>
                                    <td><span id="date_4">Loading...</span></td>
                                </tr>
                                <tr>
                                    <td><span id="level_5">Loading...</span> PPM</td>
                                    <td>49</td>
                                    <td><span id="date_5">Loading...</span></td>
                                </tr>
                                <tr>
                                    <td><span id="level_6">Loading...</span> PPM</td>
                                    <td>56</td>
                                    <td><span id="date_6">Loading...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

</html>