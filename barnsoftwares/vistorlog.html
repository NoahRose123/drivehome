<!DOCTYPE html>
<html lang="en">

<head>
        <link rel="icon" type="image/png" href="/icon.png?v=2">
        <link rel="apple-touch-icon" href="/icon.png?v=2">
        <link rel="icon" type="image/png" sizes="192x192" href="/iconcropped.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/iconcropped.png">
        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#1a365d">

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>VAS Barn 1 - Visitor Log</title>

        <!-- Barn Software Styles -->
        <link rel="stylesheet" href="../barnsoftwares-css/barn-software-styles.css">
        <link rel="stylesheet" href="../barnsoftwares-css/vistorlog.css">
        <script src="../barnsoftwares-css/barn-header.js"></script>
        
        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
            import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, query, where, onSnapshot }
                from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

            // ‚úÖ Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyB20OmcQemfIXm4712im9mqiBnpeVt8sJQ",
                authDomain: "chicken-project-2.firebaseapp.com",
                projectId: "chicken-project-2",
                storageBucket: "chicken-project-2.firebasestorage.app",
                messagingSenderId: "596273529964",
                appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
                measurementId: "G-9YLPHR08DB"
            };

            const app = initializeApp(firebaseConfig);
            const db = getFirestore(app);

            // ‚úÖ Attach Firebase functions to window for non-module scripts
            window.db = db;
            window.collection = collection;
            window.addDoc = addDoc;
            window.getDocs = getDocs;
            window.deleteDoc = deleteDoc;
            window.doc = doc;
            window.getDoc = getDoc;
            window.query = query;
            window.where = where;
            window.onSnapshot = onSnapshot;

            // ‚úÖ Fetch Farm Info
            async function fetchFarmInfo() {
                console.log("üì• Fetching Farm Info...");
                const docRef = doc(db, "startnewcrop", "vas-b1-snc");

                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById("farmName").innerText = data.farm_name || "Unknown";
                        document.getElementById("barnNumber").innerText = data.barn_number || "Unknown";
                        document.getElementById("farmNumber").innerText = data.farm_number || "Unknown";
                        document.getElementById("quotaPeriod").innerText = data.quota_period || "No Data";
                    } else {
                        console.error("‚ùå Document does not exist in `startnewcrop`!");
                    }
                });
            }

            window.fetchFarmInfo = fetchFarmInfo;
        </script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        <script>
            window.loadVisitors = async function () {
                console.log("üì• Loading Visitor Logs...");
                const visitorLogs = document.getElementById("visitorLogs");
                visitorLogs.innerHTML = `<tr><td colspan='5' style="text-align: center; padding: 20px; color: #666;">üîÑ Loading visitor logs...</td></tr>`;

                try {
                    const q = collection(db, "visitor_logs");
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        console.log("üìù No visitors found in database");
                        visitorLogs.innerHTML = `<tr><td colspan='5' style="text-align: center; padding: 20px; color: #666;">üìù No visitor logs found.<br><br>Add your first visitor above!</td></tr>`;
                        return;
                    }

                    // ‚úÖ Convert documents to an array and sort by date (newest first)
                    const visitors = querySnapshot.docs
                        .map(docSnap => ({
                            id: docSnap.id,
                            ...docSnap.data(),
                            date: docSnap.data().date ? new Date(docSnap.data().date) : null
                        }))
                        .sort((a, b) => (a.date - b.date)); // üî• Sorting ascending (oldest first)

                    visitors.forEach((visitor) => {
                        const visitorDate = visitor.date ? visitor.date.toLocaleDateString() : "N/A";
                        const visitorName = visitor.name || "Unknown";
                        const visitorReason = visitor.reason || "No reason provided";
                        const visitorContact = visitor.contact_with_poultry || "N/A";

                        const row = document.createElement("tr");
                        row.setAttribute("data-id", visitor.id);
                        row.innerHTML = `
    <td>${visitorDate}</td>
    <td>${visitorName}</td>
    <td>${visitorContact}</td>
    <td>${visitorReason}</td>
    <td class="delete-hover">‚ùå</td>
`;

                        row.lastElementChild.addEventListener("click", async () => {
                            if (confirm(`Are you sure you want to delete ${visitorName}?`)) {
                                try {
                                    await deleteDoc(doc(db, "visitor_logs", visitor.id));
                                    alert(`‚úÖ ${visitorName} has been deleted.`);
                                    loadVisitors();
                                } catch (error) {
                                    console.error("‚ùå Error deleting visitor:", error);
                                    alert(`‚ùå Error deleting ${visitorName}: ${error.message}\n\nPlease try again.`);
                                }
                            }
                        });

                        visitorLogs.appendChild(row);
                    });

                    console.log("‚úÖ Visitors successfully loaded and sorted!");
                } catch (error) {
                    console.error("üî• Error Fetching Visitors", error);
                    visitorLogs.innerHTML = `<tr><td colspan='5' style="color: red; text-align: center; padding: 20px; font-weight: bold;">‚ùå Error loading visitor data<br><br>Please check your internet connection and refresh the page.<br><br>Error: ${error.message}</td></tr>`;
                }
            };

            window.downloadLogs = async function () {
                console.log("üì• Downloading Logs as PDF...");

                try {
                    const { jsPDF } = window.jspdf;
                    if (!jsPDF) {
                        console.error("‚ùå jsPDF is not loaded correctly.");
                        alert("‚ùå Error downloading logs. Please try again.");
                        return;
                    }

                    // ‚úÖ Create landscape PDF
                    const pdfDoc = new jsPDF('landscape');

                    // ‚úÖ Colors and styling
                    const primaryColor = [41, 128, 185]; // Professional blue
                    const lightGray = [248, 249, 250];
                    const darkGray = [52, 58, 64];
                    const borderColor = [206, 212, 218];

                    // ‚úÖ Header Section with background
                    pdfDoc.setFillColor(...lightGray);
                    pdfDoc.rect(0, 0, 297, 55, 'F');

                    // ‚úÖ Main Title
                    pdfDoc.setTextColor(...primaryColor);
                    pdfDoc.setFontSize(24);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.text("VISITOR LOG", 15, 20);

                    // ‚úÖ Decorative line under title
                    pdfDoc.setDrawColor(...primaryColor);
                    pdfDoc.setLineWidth(2);
                    pdfDoc.line(15, 25, 100, 25);

                    // ‚úÖ Farm Information Section
                    pdfDoc.setTextColor(...darkGray);
                    pdfDoc.setFontSize(12);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.text("FARM INFORMATION", 15, 35);

                    pdfDoc.setFont(undefined, 'normal');
                    pdfDoc.setFontSize(10);
                    const farmName = document.getElementById("farmName").innerText;
                    const barnNumber = document.getElementById("barnNumber").innerText;
                    const farmNumber = document.getElementById("farmNumber").innerText;
                    const quotaPeriod = document.getElementById("quotaPeriod").innerText;

                    pdfDoc.text(`Farm: ${farmName}`, 15, 42);
                    pdfDoc.text(`Manager: Chris Rose # 905-741-1544`, 15, 47);
                    pdfDoc.text(`Barn: ${barnNumber}`, 150, 42);
                    pdfDoc.text(`Farm Number: ${farmNumber}`, 150, 47);
                    pdfDoc.text(`Quota Period: ${quotaPeriod}`, 230, 42);

                    // ‚úÖ Table Header Background
                    let y = 70;
                    pdfDoc.setFillColor(...primaryColor);
                    pdfDoc.rect(10, y - 8, 275, 12, 'F');

                    // ‚úÖ Table Headers
                    pdfDoc.setTextColor(255, 255, 255);
                    pdfDoc.setFontSize(11);
                    pdfDoc.setFont(undefined, 'bold');
                    pdfDoc.text("DATE", 15, y);
                    pdfDoc.text("VISITOR NAME", 45, y);
                    pdfDoc.text("POULTRY CONTACT (24H)", 85, y);
                    pdfDoc.text("REASON FOR VISIT", 140, y);

                    y += 15;

                    // ‚úÖ Load Visitor Data
                    const q = collection(db, "visitor_logs");
                    const querySnapshot = await getDocs(q);

                    if (querySnapshot.empty) {
                        pdfDoc.setTextColor(...darkGray);
                        pdfDoc.setFont(undefined, 'italic');
                        pdfDoc.setFontSize(12);
                        pdfDoc.text("No visitor logs found.", 15, y + 20);
                    } else {
                        // ‚úÖ Sort by date (newest first)
                        const visitors = querySnapshot.docs
                            .map(docSnap => ({
                                ...docSnap.data(),
                                date: docSnap.data().date ? new Date(docSnap.data().date) : null
                            }))
                            .sort((a, b) => (a.date - b.date));
                        let rowIndex = 0;
                        // Replace the visitor row rendering section in your downloadLogs function
                        // Find this part and replace it:

                        visitors.forEach((visitor) => {
                            const date = visitor.date ? visitor.date.toLocaleDateString() : "N/A";
                            const name = visitor.name || "Unknown";
                            const contact = visitor.contact_with_poultry || "N/A";
                            const reason = visitor.reason || "No reason provided";

                            // ‚úÖ Handle long reason text with line wrapping
                            const maxReasonWidth = 180; // Full width for reason column
                            const reasonLines = pdfDoc.splitTextToSize(reason, maxReasonWidth);
                            const lineHeight = 5;
                            const totalReasonHeight = reasonLines.length * lineHeight;
                            const rowHeight = Math.max(12, totalReasonHeight + 4);

                            // ‚úÖ Alternating row background for better readability
                            if (rowIndex % 2 === 0) {
                                pdfDoc.setFillColor(248, 249, 250);
                                pdfDoc.rect(10, y - 2, 275, rowHeight, 'F');
                            }

                            // ‚úÖ Row content - ALL TEXT ALIGNED TO SAME BASELINE
                            pdfDoc.setTextColor(...darkGray);
                            pdfDoc.setFont(undefined, 'normal');
                            pdfDoc.setFontSize(9);

                            // ‚úÖ All content starts at the same Y position (top of the row)
                            const textStartY = y + 3;

                            pdfDoc.text(date, 15, textStartY);
                            pdfDoc.text(name, 45, textStartY);
                            pdfDoc.text(contact, 85, textStartY);

                            // ‚úÖ Reason text starts at the same Y as other columns
                            reasonLines.forEach((line, index) => {
                                pdfDoc.text(line, 140, textStartY + (index * lineHeight));
                            });

                            // ‚úÖ Subtle row border
                            pdfDoc.setDrawColor(...borderColor);
                            pdfDoc.setLineWidth(0.2);
                            pdfDoc.line(10, y + rowHeight - 2, 285, y + rowHeight - 2);

                            y += rowHeight;
                            rowIndex++;

                            // ‚úÖ Page break if needed
                            if (y > 180) {
                                pdfDoc.addPage('landscape');
                                y = 20;
                                rowIndex = 0;
                            }
                        });
                    }

                    // ‚úÖ Footer
                    const pageCount = pdfDoc.internal.getNumberOfPages();
                    for (let i = 1; i <= pageCount; i++) {
                        pdfDoc.setPage(i);
                        pdfDoc.setFontSize(8);
                        pdfDoc.setTextColor(100, 100, 100);
                    }

                    // ‚úÖ Save PDF
                    pdfDoc.save(`Visitor_Log_${new Date().toISOString().split('T')[0]}.pdf`);
                } catch (error) {
                    console.error("‚ùå Error downloading logs:", error);
                    alert("‚ùå Error downloading logs. Please try again.");
                }
            };

            // ‚úÖ Add Visitor (Fixed)
            window.addVisitor = async function () {
                console.log("‚ûï Adding Visitor...");

                const visitorName = document.getElementById("visitorName").value.trim();
                const visitorReason = document.getElementById("reason").value.trim();
                const visitorContact = document.querySelector('input[name="contactPoultry"]:checked')?.value || "N/A";
                const visitorDateInput = document.getElementById("visitorDate").value;

                // Ensure a valid date is provided
                const visitorDate = visitorDateInput ? new Date(visitorDateInput).toISOString() : new Date().toISOString();

                if (!visitorName) {
                    alert("‚ö† Please enter a visitor name.");
                    return;
                }

                try {
                    // ‚úÖ Add to Firestore
                    await addDoc(collection(db, "visitor_logs"), {
                        name: visitorName,
                        reason: visitorReason || "No reason provided",
                        contact_with_poultry: visitorContact,
                        date: visitorDate
                    });

                    alert("‚úÖ Visitor added successfully!");

                    // ‚úÖ Clear form after submission
                    document.getElementById("visitorName").value = "";
                    document.getElementById("reason").value = "";
                    document.getElementById("visitorDate").value = "";
                    document.querySelectorAll('input[name="contactPoultry"]').forEach(radio => radio.checked = false);

                    // ‚úÖ Refresh visitor list
                    loadVisitors();
                } catch (error) {
                    console.error("‚ùå Error adding visitor:", error);
                    alert("‚ùå Error adding visitor. Please try again.");
                }
            };


            window.onload = function () {
                console.log("üöÄ Page loaded, starting initialization...");
                
                // Check if table elements exist
                const tableContainer = document.querySelector('.table-container');
                const visitorLogsTable = document.getElementById('visitorLogs');
                
                console.log("üìã Table container found:", tableContainer ? "‚úÖ YES" : "‚ùå NO");
                console.log("üìã Visitor logs tbody found:", visitorLogsTable ? "‚úÖ YES" : "‚ùå NO");
                
                if (!tableContainer) {
                    console.error("‚ùå CRITICAL: .table-container not found!");
                    alert("‚ùå ERROR: Table container not found. Check HTML structure.");
                    return;
                }
                
                if (!visitorLogsTable) {
                    console.error("‚ùå CRITICAL: #visitorLogs tbody not found!");
                    alert("‚ùå ERROR: Visitor logs table body not found. Check HTML structure.");
                    return;
                }
                
                console.log("üîÑ Starting Firebase initialization...");
                
                // Check if Firebase is loaded
                if (typeof window.db === 'undefined') {
                    console.error("‚ùå CRITICAL: Firebase not initialized!");
                    alert("‚ùå ERROR: Firebase not loaded. Check internet connection.");
                    return;
                }
                
                console.log("‚úÖ Firebase initialized successfully");
                
                try {
                    fetchFarmInfo();
                    loadVisitors();
                } catch (error) {
                    console.error("‚ùå Error during initialization:", error);
                    alert(`‚ùå Initialization Error: ${error.message}`);
                }
            };
        </script>
    </head>

<body>
    <div class="visitor-log-form">
        <h1>VAS Barn 1 - Visitor Log</h1>

        <!-- Farm Information Section -->
        <div class="info-section">
            <h2>Farm Name: <span id="farmName">Loading...</span></h2>
            <h2>Barn: <span id="barnNumber">Loading...</span></h2>
            <h2>Farm Number: <span id="farmNumber">Loading...</span></h2>
            <h2>Quota Period: <span id="quotaPeriod">Loading...</span></h2>
        </div>

        <!-- Form Section -->
        <div class="form-section">
        <div class="form-group">
            <label for="visitorDate">Date:</label>
            <input type="date" id="visitorDate">
        </div>
        
        <div class="form-group">
            <label for="visitorName">Visitor Name:</label>
            <input type="text" id="visitorName" placeholder="Enter visitor name">
        </div>
        
        <div class="form-group">
            <label for="reason">Reason for Visit:</label>
            <textarea id="reason" placeholder="Enter reason for visit"></textarea>
        </div>

        <div class="radio-section">
            <label>Contact with poultry in the last 24 hours?</label>
            <div class="radio-group">
                <div class="radio-option">
                    <input type="radio" name="contactPoultry" value="Yes" id="contactYes">
                    <label for="contactYes">Yes</label>
                </div>
                <div class="radio-option">
                    <input type="radio" name="contactPoultry" value="No" id="contactNo">
                    <label for="contactNo">No</label>
                </div>
            </div>
        </div>

        <div class="button-group">
            <button onclick="addVisitor()">Add Visitor</button>
            <button onclick="downloadLogs()">Download PDF</button>
        </div>
    </div>

    <!-- Table Section -->
    <div class="table-container">
        <h2>Visitor Records</h2>
        <table>
            <!-- Replace the existing table header section with this: -->
            <!-- Replace the table header section with this: -->
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Name</th>
                    <th>Contact with Poultry in the Last 24 Hours</th>
                    <th>Reason for Visit</th>
                    <th>Delete</th>
                </tr>
            </thead>
            <tbody id="visitorLogs">
                <!-- Visitor logs will be populated here -->
            </tbody>
        </table>
    </div>
    <script>
        // Set today's date as default
        document.getElementById('visitorDate').value = new Date().toISOString().split('T')[0];
        
        // Emergency fallback - show table structure if nothing else works
        setTimeout(() => {
            const visitorLogsTable = document.getElementById('visitorLogs');
            if (visitorLogsTable && visitorLogsTable.innerHTML.trim() === '') {
                console.warn("‚ö†Ô∏è FALLBACK: Table is empty after 3 seconds, showing test data");
                visitorLogsTable.innerHTML = `
                    <tr style="background: #fff3cd; color: #856404;">
                        <td colspan='5' style="text-align: center; padding: 20px; font-weight: bold;">
                            ‚ö†Ô∏è TABLE STRUCTURE TEST ‚ö†Ô∏è<br><br>
                            If you see this message, the table HTML is working but data loading failed.<br>
                            Check browser console for errors.
                        </td>
                    </tr>
                `;
            }
        }, 3000);
    </script>
</body>

</html>