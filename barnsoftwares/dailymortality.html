<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="icon" type="image/png" href="/icon.png?v=2">
    <link rel="apple-touch-icon" href="/icon.png?v=2">
    <link rel="icon" type="image/png" sizes="192x192" href="/iconcropped.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/iconcropped.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a365d">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Records - Farm Management Hub</title>

    <!-- Barn Software Styles -->
    <link rel="stylesheet" href="../barnsoftwares-css/barn-software-styles.css">
    <link rel="stylesheet" href="../barnsoftwares-css/dailymortality.css">
    <script src="../barnsoftwares-css/barn-header.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Clean, modern styling for the combined page */
        .main-container {
            background: #ffffff;
            border-radius: 16px;
            padding: 32px;
            margin: 24px auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.08);
            border: 1px solid #e8eaed;
            max-width: 900px;
        }
        
        .section-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, #e0e0e0, transparent);
            margin: 48px 0;
        }
        
        .section-title {
            color: #1a1a1a;
            font-size: 28px;
            font-weight: 600;
            margin: 0 0 24px 0;
            padding-bottom: 12px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-title i {
            color: #5f6368;
            font-size: 24px;
        }
        
        /* Form styling */
        .form-section {
            background: #fafafa;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #e8eaed;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-label {
            font-weight: 500;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-label i {
            color: #5f6368;
            font-size: 14px;
            width: 16px;
        }
        
        .form-input {
            padding: 12px 16px;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            font-size: 14px;
            color: #1a1a1a;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        .form-input::placeholder {
            color: #9aa0a6;
        }
        

        
        /* Environment Readings Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        .alarm-input-group {
            grid-column: 1 / -1;
        }
        
        .unit-select {
            margin-left: 8px;
            padding: 8px 12px;
            border: 2px solid #e8eaed;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        .unit-select:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }
        
        /* Alarm system styling */
        .alarm-container {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .alarm-entries {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .alarm-entry {
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 12px;
            background: #ffffff;
            transition: all 0.2s ease;
        }
        
        .alarm-entry:hover {
            border-color: #4285f4;
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.1);
        }
        
        .alarm-number {
            background: #4285f4;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .alarm-input {
            flex: 1;
            border: none;
            outline: none;
            padding: 8px 12px;
            font-size: 14px;
            color: #1a1a1a;
            background: transparent;
            border-radius: 4px;
        }
        
        .alarm-input:focus {
            background: #f8f9fa;
        }
        
        .alarm-delete {
            background: #ea4335;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .alarm-delete:hover {
            background: #d93025;
            transform: scale(1.1);
        }
        
        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        
        .btn-primary {
            background: #4285f4;
            color: white;
        }
        
        .btn-primary:hover {
            background: #3367d6;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .btn-secondary {
            background: #34a853;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #2d8e47;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.3);
        }
        
        .btn-danger {
            background: #ea4335;
            color: white;
        }
        
        .btn-danger:hover {
            background: #d93025;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            color: #4285f4;
            border: 2px solid #4285f4;
        }
        
        .btn-outline:hover {
            background: #4285f4;
            color: white;
        }
        
        /* Info boxes */
        .info-box {
            background: #e8f0fe;
            border: 1px solid #4285f4;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 24px;
        }
        
        .info-box p {
            margin: 0;
            color: #1a73e8;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .warning-box {
            background: #fef7e0;
            border: 1px solid #fbbc04;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .warning-box small {
            color: #b06000;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Ammonia input styling */
        .ammonia-box {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
        }
        
        .ammonia-box h3 {
            color: #1a1a1a;
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px;
                margin: 16px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .form-row {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .section-title {
                font-size: 24px;
            }
        }
        
        /* Required field indicator */
        .required::after {
            content: " *";
            color: #ea4335;
            font-weight: 600;
        }
    </style>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import {
            getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot,
            query, where, getDocs, deleteDoc, updateDoc, getDoc, setDoc
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB20OmcQemfIXm4712im9mqiBnpeVt8sJQ",
            authDomain: "chicken-project-2.firebaseapp.com",
            projectId: "chicken-project-2",
            storageBucket: "chicken-project-2.firebasestorage.app",
            messagingSenderId: "596273529964",
            appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
            measurementId: "G-9YLPHR08DB"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let startCropDate = null;
        let currentFloor = 1; // Track current active floor
        let alarmEntries = []; // For environment readings

        function updateFloorTitle() {
            const floorTitle = document.getElementById('floor-title');
            floorTitle.textContent = `Vassilakos Farm - Barn 1 - Floor ${currentFloor} - Daily Records`;
        }

        // Mortality tracking functions
        function fetchStartDate() {
            const docRef = doc(db, "startnewcrop", "vas-b1-snc");
            const dateInput = document.getElementById("mortality-date");

            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const localToday = `${year}-${month}-${day}`;

            if (!dateInput.value) {
                dateInput.value = localToday;
            }

            console.log(`üìÖ Defaulting Bird Adder Date to Today's Date: ${localToday}`);

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().date_started) {
                    const data = docSnap.data();
                    const firestoreTimestamp = data.date_started.seconds * 1000;
                    const originalStartDate = new Date(firestoreTimestamp);
                    originalStartDate.setUTCHours(0, 0, 0, 0);

                    if (currentFloor === 1) {
                        startCropDate = new Date(originalStartDate);
                        console.log(`üìÖ Floor 1 Start Date: ${startCropDate.toISOString().split('T')[0]}`);
                    } else {
                        startCropDate = new Date(originalStartDate);
                        console.log(`üìÖ Floor 2 Start Date (same as Floor 1): ${startCropDate.toISOString().split('T')[0]}`);
                    }

                    const dateStartedField = document.getElementById("date_started");
                    if (dateStartedField) {
                        dateStartedField.value = startCropDate.toISOString().split('T')[0];
                    }

                    setTimeout(checkAmmoniaInput, 200);
                } else {
                    console.warn("‚ö†Ô∏è No Start Date Found in Firestore. Birds can be added anytime.");
                }
            });
        }

        window.checkAmmoniaInput = function () {
            if (!startCropDate) return;

            const selectedDate = new Date(document.getElementById("mortality-date").value);
            selectedDate.setUTCHours(0, 0, 0, 0);

            const daysDiff = Math.floor((selectedDate - startCropDate) / (1000 * 60 * 60 * 24)) + 1;
            const birdCycleDay = daysDiff;

            console.log(`üìÖ Bird Cycle Day: ${birdCycleDay}`);

            let ammoniaDays, displayDay;
            if (currentFloor === 1) {
                ammoniaDays = [21, 28, 35, 42, 49, 56];
                displayDay = birdCycleDay;
            } else {
                ammoniaDays = [21, 28, 35, 42, 49, 56];
                displayDay = birdCycleDay;
            }

            console.log(`üîç Checking if day ${birdCycleDay} is in ammonia days:`, ammoniaDays);
            console.log(`üìä Current Floor: ${currentFloor}`);

            if (ammoniaDays.includes(birdCycleDay)) {
                document.getElementById("ammonia-input-box").style.display = "block";
                document.getElementById("ammonia-day").innerText = displayDay;
                console.log(`‚úÖ Showing ammonia input for day ${displayDay}`);
            } else {
                document.getElementById("ammonia-input-box").style.display = "none";
                console.log(`‚ùå Hiding ammonia input - day ${birdCycleDay} not in required days`);
            }
        };

        function validateDateRange() {
            if (!startCropDate) return true;

            const selectedDate = new Date(document.getElementById("mortality-date").value);
            selectedDate.setUTCHours(0, 0, 0, 0);

            const maxDate = new Date(startCropDate);
            if (currentFloor === 1) {
                maxDate.setDate(startCropDate.getDate() + 55);
            } else {
                maxDate.setDate(startCropDate.getDate() + 56);
            }
            maxDate.setUTCHours(0, 0, 0, 0);

            if (selectedDate < startCropDate) {
                alert("‚ö†Ô∏è Date reset to Date Placed. Cannot select earlier dates.");
                document.getElementById("mortality-date").value = startCropDate.toISOString().split('T')[0];
                return false;
            }

            if (selectedDate > maxDate) {
                const maxDays = currentFloor === 1 ? 56 : 56;
                alert(`‚ö†Ô∏è Date reset to maximum allowed (${maxDays} days after Date Placed).`);
                document.getElementById("mortality-date").value = maxDate.toISOString().split('T')[0];
                return false;
            }

            return true;
        }

        window.saveMortalityData = async function () {
            if (!validateDateRange()) return;

            const date = document.getElementById("mortality-date").value;
            const culls = parseInt(document.getElementById("culls").value) || 0;
            const mortality = parseInt(document.getElementById("mortality").value) || 0;
            const totalDeadBirds = culls + mortality;
            const ammoniaLevel = document.getElementById("ammonia-level").value.trim();
            const formattedDate = date;

            if (!startCropDate) {
                alert("‚ö†Ô∏è Start Date not available. Cannot add birds until it's set in Firestore.");
                return;
            }

            const selectedDate = new Date(date);
            selectedDate.setUTCHours(0, 0, 0, 0);
            const daysDiff = Math.floor((selectedDate - startCropDate) / (1000 * 60 * 60 * 24)) + 1;
            const birdCycleDay = daysDiff;

            try {
                const collectionName = currentFloor === 1 ? "vas-b1-f1-MC" : "vas-b1-f2-MC";
                const mortalityCollection = collection(db, collectionName);

                if (currentFloor === 1) {
                    const q = query(mortalityCollection, where("date", "==", formattedDate));
                    const querySnapshot = await getDocs(q);

                    if (!querySnapshot.empty) {
                        const deletePromises = querySnapshot.docs.map((doc) => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);
                        console.log(`üóëÔ∏è Deleted existing records for ${formattedDate}`);
                    }
                }

                let firestoreData = {
                    date: formattedDate,
                    culls: culls,
                    mortality: mortality,
                    totalDeadBirds: totalDeadBirds,
                    timestamp: serverTimestamp()
                };

                await addDoc(mortalityCollection, firestoreData);
                console.log(`‚úÖ Saved mortality/culls data for ${formattedDate} on Floor ${currentFloor}`);

                let ammoniaDays, ammoniaCollection, ammoniaField;
                if (currentFloor === 1) {
                    ammoniaDays = [21, 28, 35, 42, 49, 56];
                    ammoniaCollection = "ammonia_levels";
                    ammoniaField = `day_${birdCycleDay}`;
                } else {
                    ammoniaDays = [21, 28, 35, 42, 49, 56];
                    ammoniaCollection = "ammonia_levels_f2";
                    ammoniaField = `day_${birdCycleDay}`;
                }

                if (ammoniaDays.includes(birdCycleDay)) {
                    if (ammoniaLevel === "") {
                        alert("‚ö†Ô∏è Please enter an ammonia level for this required day.");
                        return;
                    }

                    const ammoniaDocRef = doc(db, ammoniaCollection, "fixed_days");

                    try {
                        const docSnap = await getDoc(ammoniaDocRef);

                        if (docSnap.exists()) {
                            await updateDoc(ammoniaDocRef, {
                                [ammoniaField]: Number(ammoniaLevel),
                                timestamp: serverTimestamp()
                            });
                            console.log(`‚úÖ Updated Ammonia Level ${ammoniaField}: ${ammoniaLevel} PPM in ${ammoniaCollection}`);
                        } else {
                            console.error(`‚ùå 'fixed_days' document does not exist in ${ammoniaCollection}!`);
                            await setDoc(ammoniaDocRef, {
                                [ammoniaField]: Number(ammoniaLevel),
                                timestamp: serverTimestamp()
                            });
                            console.log(`‚úÖ Created new document and saved ammonia level ${ammoniaField}: ${ammoniaLevel} PPM`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error saving ammonia level:`, error);
                        alert("Failed to save ammonia level. Check console for details.");
                    }
                }

                alert(`‚úÖ Mortality data saved successfully for ${formattedDate} on Floor ${currentFloor}`);
            } catch (error) {
                console.error("‚ùå Error saving data:", error);
                alert("Failed to save data. Check the console for details.");
            }
        };

        // Environment readings functions
        function clearEnvironmentForm() {
            document.getElementById('env-date').value = '';
            document.getElementById('max-temp').value = '';
            document.getElementById('min-temp').value = '';
            document.getElementById('humidity-min').value = '';
            document.getElementById('humidity-max').value = '';
            document.getElementById('ammonia-min').value = '';
            document.getElementById('ammonia-max').value = '';
            document.getElementById('water-reading').value = '';
            alarmEntries = [];
            updateAlarmTable();
            updateAlarmPreview();
        }

        window.addAlarmEntry = function() {
            alarmEntries.push('');
            updateAlarmTable();
            updateAlarmPreview();
        };

        window.deleteAlarmEntry = function(index) {
            alarmEntries.splice(index, 1);
            updateAlarmTable();
            updateAlarmPreview();
        };

        window.updateAlarmEntry = function(index, value) {
            alarmEntries[index] = value;
            updateAlarmPreview();
        };

        function updateAlarmTable() {
            const container = document.getElementById('alarm-table-body');
            container.innerHTML = '';
            
            alarmEntries.forEach((entry, index) => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'alarm-entry';
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'alarm-number';
                numberDiv.textContent = index + 1;
                
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'alarm-input';
                input.value = entry;
                input.placeholder = 'Enter alarm description (e.g., "High temperature alert", "Ventilation issue")';
                input.onchange = function() { updateAlarmEntry(index, this.value); };
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'alarm-delete';
                deleteBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteBtn.onclick = function() { deleteAlarmEntry(index); };
                
                entryDiv.appendChild(numberDiv);
                entryDiv.appendChild(input);
                entryDiv.appendChild(deleteBtn);
                container.appendChild(entryDiv);
            });
        }
        
        function updateAlarmPreview() {
            const previewDiv = document.getElementById('alarm-preview');
            const previewContent = document.getElementById('alarm-preview-content');
            const validAlarms = alarmEntries.filter(alarm => alarm.trim() !== '');
            
            if (validAlarms.length === 0) {
                previewDiv.style.display = 'none';
                return;
            }
            
            previewDiv.style.display = 'block';
            previewContent.innerHTML = '';
            
            validAlarms.forEach((alarm, index) => {
                const alarmEntry = document.createElement('div');
                alarmEntry.style.cssText = `
                    margin-bottom: ${index === validAlarms.length - 1 ? '0' : '6px'};
                    padding: 6px 8px;
                    background-color: ${index % 2 === 0 ? '#fff3cd' : '#d1ecf1'};
                    border-radius: 4px;
                    font-size: 10px;
                    line-height: 1.4;
                    word-wrap: break-word;
                    color: ${index % 2 === 0 ? '#856404' : '#0c5460'};
                    font-weight: 500;
                `;
                
                if (validAlarms.length > 1) {
                    const numberSpan = document.createElement('span');
                    numberSpan.style.cssText = `
                        background: ${index % 2 === 0 ? '#ffc107' : '#17a2b8'};
                        color: white;
                        padding: 2px 6px;
                        border-radius: 50%;
                        font-size: 8px;
                        font-weight: bold;
                        margin-right: 6px;
                        display: inline-block;
                        min-width: 16px;
                        text-align: center;
                    `;
                    numberSpan.textContent = index + 1;
                    alarmEntry.appendChild(numberSpan);
                }
                
                const textSpan = document.createElement('span');
                textSpan.textContent = alarm;
                alarmEntry.appendChild(textSpan);
                
                previewContent.appendChild(alarmEntry);
            });
        }
        
        window.clearAllAlarms = function() {
            alarmEntries = [];
            updateAlarmTable();
            updateAlarmPreview();
        };

        window.saveEnvironmentData = async function() {
            const date = document.getElementById('env-date').value;
            const maxTemp = document.getElementById('max-temp').value;
            const minTemp = document.getElementById('min-temp').value;
            const humidityMin = document.getElementById('humidity-min').value;
            const humidityMax = document.getElementById('humidity-max').value;
            const ammoniaMin = document.getElementById('ammonia-min').value;
            const ammoniaMax = document.getElementById('ammonia-max').value;
            const waterReading = document.getElementById('water-reading').value;
            
            if (!date) {
                alert('‚ùå Please select a date');
                document.getElementById('env-date').focus();
                return;
            }
            
            if (!maxTemp || !minTemp) {
                alert('‚ùå Please fill in both Max and Min Temperature');
                if (!maxTemp) document.getElementById('max-temp').focus();
                else document.getElementById('min-temp').focus();
                return;
            }
            
            if (!humidityMin || !humidityMax) {
                alert('‚ùå Please fill in both Min and Max Humidity');
                if (!humidityMin) document.getElementById('humidity-min').focus();
                else document.getElementById('humidity-max').focus();
                return;
            }
            
            if (!ammoniaMin || !ammoniaMax) {
                alert('‚ùå Please fill in both Min and Max Ammonia');
                if (!ammoniaMin) document.getElementById('ammonia-min').focus();
                else document.getElementById('ammonia-max').focus();
                return;
            }
            
            if (!waterReading) {
                alert('‚ùå Please fill in Water Meter Reading');
                document.getElementById('water-reading').focus();
                return;
            }
            
            const tempUnit = document.getElementById('temp-unit').value;
            const waterUnit = document.getElementById('water-unit').value;
            
            const data = {
                maxTemp: parseFloat(maxTemp),
                minTemp: parseFloat(minTemp),
                tempUnit: tempUnit,
                humidityMin: parseFloat(humidityMin),
                humidityMax: parseFloat(humidityMax),
                ammoniaMin: parseFloat(ammoniaMin),
                ammoniaMax: parseFloat(ammoniaMax),
                waterReading: parseFloat(waterReading),
                waterUnit: waterUnit,
                alarms: alarmEntries.filter(alarm => alarm.trim() !== ''),
                timestamp: serverTimestamp(),
                date: date
            };

            try {
                const collectionName = currentFloor === 1 ? "vas-b1-f1-ER" : "vas-b1-f2-ER";
                
                const existingQuery = query(collection(db, collectionName), where("date", "==", date));
                const existingSnapshot = await getDocs(existingQuery);
                
                if (!existingSnapshot.empty) {
                    const confirmOverwrite = confirm(
                        `‚ö†Ô∏è WARNING: Data for ${date} already exists in Floor ${currentFloor}!\n\n` +
                        `Are you sure you want to replace the existing data?\n` +
                        `The older version will be permanently deleted.\n\n` +
                        `Click OK to proceed with replacement.\n` +
                        `Click Cancel to keep the existing data.`
                    );
                    
                    if (confirmOverwrite) {
                        const deletePromises = existingSnapshot.docs.map(doc => deleteDoc(doc.ref));
                        await Promise.all(deletePromises);
                        console.log(`üóëÔ∏è Deleted ${existingSnapshot.size} existing document(s) for ${date} in Floor ${currentFloor}`);
                    } else {
                        console.log('‚ùå User cancelled overwrite operation');
                        return;
                    }
                }
                
                await addDoc(collection(db, collectionName), data);
                console.log(`‚úÖ Environment data saved to Floor ${currentFloor} collection (${collectionName}) for ${date}`);
                
                alert(`‚úÖ Environment data saved successfully to Floor ${currentFloor}!`);
                clearEnvironmentForm();
            } catch (error) {
                console.error("‚ùå Error saving environment data:", error);
                if (error.code === 'permission-denied') {
                    alert("‚ùå Permission denied. Please check Firebase security rules.");
                } else {
                    alert("‚ùå Failed to save environment data. Check the console for details.");
                }
            }
        };



        // Floor switching function
        window.switchFloor = function (floor) {
            currentFloor = floor;

            const toggle = document.getElementById('floor_toggle');
            toggle.checked = (floor === 2);

            updateFloorTitle();

            // Clear forms
            document.getElementById("mortality-date").value = "";
            document.getElementById("culls").value = "";
            document.getElementById("mortality").value = "";
            document.getElementById("ammonia-level").value = "";
            document.getElementById("ammonia-input-box").style.display = "none";

            // Clear environment form
            clearEnvironmentForm();

            // Refresh start date for new floor
            fetchStartDate();

            console.log(`üîÑ Switched to Floor ${floor}`);
        };

        window.switchFloorToggle = function () {
            const toggle = document.getElementById('floor_toggle');
            const newFloor = toggle.checked ? 2 : 1;
            switchFloor(newFloor);
        };

        window.onload = function () {
            console.log("üöÄ Daily Records page loaded");

            // Set up floor toggle event listener
            document.getElementById('floor_toggle').addEventListener('change', switchFloorToggle);

            // Set up mortality date change listener
            document.getElementById("mortality-date").addEventListener('change', checkAmmoniaInput);

            // Set initial floor to 1
            switchFloor(1);

            // Set today's date as default for environment readings
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('env-date').value = today;
        };
    </script>
</head>

<script src="load-header.js"></script>

<body>
    <!-- Floor Toggle Navigation -->
    <div class="floor-toggle-container" id="floor-toggle">
        <span class="floor-label">Bottom Floor</span>
        <label class="floor-toggle">
            <input type="checkbox" id="floor_toggle" unchecked>
            <span class="floor-toggle-slider"></span>
        </label>
        <span class="floor-label">Top Floor</span>
    </div>
    <h2 id="floor-title">Vassilakos Farm - Barn 1 - Floor 1 - Daily Records</h2>

    <div class="main-container">
        <!-- Mortality Tracking Section -->
        <h3 class="section-title">
            <i class="fas fa-chart-line"></i>
            Mortality Tracking
        </h3>
        
        <div class="form-section">
            <div class="info-box">
                <p><i class="fas fa-info-circle"></i> Record daily mortality and cull counts for the current floor.</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-calendar"></i>
                        Date
                    </label>
                    <input type="date" id="mortality-date" class="form-input" required onchange="checkAmmoniaInput()">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-cut"></i>
                        Culls
                    </label>
                    <input type="number" id="culls" class="form-input" min="0" placeholder="Enter culls">
                </div>

                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-skull"></i>
                        Mortality
                    </label>
                    <input type="number" id="mortality" class="form-input" min="0" placeholder="Enter mortality">
                </div>
            </div>

            <!-- Ammonia Level Input (Hidden by Default) -->
            <div id="ammonia-input-box" class="ammonia-box" style="display: none;">
                <h3><i class="fas fa-exclamation-triangle"></i> Enter Ammonia Level for Day <span id="ammonia-day"></span></h3>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-flask"></i>
                        PPM
                    </label>
                    <input type="number" id="ammonia-level" class="form-input" placeholder="Enter PPM">
                </div>
            </div>

            <div class="btn-group">
                <button onclick="saveMortalityData()" class="btn btn-primary">
                    <i class="fas fa-save"></i>
                    Save Mortality Data
                </button>
            </div>
        </div>

        <!-- Section Divider -->
        <div class="section-divider"></div>

        <!-- Environment Readings Section -->
        <h3 class="section-title">
            <i class="fas fa-thermometer-half"></i>
            High Density
        </h3>
        
        <div class="form-section">
            <div class="info-box">
                <p><i class="fas fa-info-circle"></i> All fields marked with <span style="color: #ea4335; font-weight: bold;">*</span> must be filled out before saving.</p>
            </div>
            
            <div class="form-grid">
                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-calendar"></i>
                        Date
                    </label>
                    <input type="date" id="env-date" class="form-input" required>
                </div>
                
                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-thermometer-half"></i>
                        Max Temperature
                    </label>
                    <div style="display: flex; align-items: center;">
                        <input type="number" id="max-temp" class="form-input" step="0.1" placeholder="Enter max temperature" required>
                        <select id="temp-unit" class="unit-select">
                            <option value="F">¬∞F</option>
                            <option value="C">¬∞C</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-thermometer-half"></i>
                        Min Temperature
                    </label>
                    <input type="number" id="min-temp" class="form-input" step="0.1" placeholder="Enter min temperature" required>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-tint"></i>
                        Humidity Min (%)
                    </label>
                    <input type="number" id="humidity-min" class="form-input" min="0" max="100" placeholder="Enter min humidity" required>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-tint"></i>
                        Humidity Max (%)
                    </label>
                    <input type="number" id="humidity-max" class="form-input" min="0" max="100" placeholder="Enter max humidity" required>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-flask"></i>
                        Ammonia Min (PPM)
                    </label>
                    <input type="number" id="ammonia-min" class="form-input" step="0.1" placeholder="Enter min ammonia" required>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-flask"></i>
                        Ammonia Max (PPM)
                    </label>
                    <input type="number" id="ammonia-max" class="form-input" step="0.1" placeholder="Enter max ammonia" required>
                </div>

                <div class="input-group">
                    <label class="form-label required">
                        <i class="fas fa-tint"></i>
                        Water Meter Reading
                    </label>
                    <div style="display: flex; align-items: center;">
                        <input type="number" id="water-reading" class="form-input" step="0.1" placeholder="Enter water reading" required>
                        <select id="water-unit" class="unit-select">
                            <option value="gallons">Gallons</option>
                            <option value="liters">Liters</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="input-group alarm-input-group">
                <label class="form-label">
                    <i class="fas fa-bell"></i>
                    Record Any Alarms
                </label>
                <div class="warning-box">
                    <small><i class="fas fa-lightbulb"></i> Add multiple alarm entries. Each will be numbered and color-coded in the chart for easy identification.</small>
                </div>
                
                <div class="alarm-container">
                    <div id="alarm-table-body" class="alarm-entries">
                    </div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-outline" onclick="addAlarmEntry()">
                        <i class="fas fa-plus"></i>
                        Add Alarm
                    </button>
                    <button class="btn btn-danger" onclick="clearAllAlarms()">
                        <i class="fas fa-trash"></i>
                        Clear All
                    </button>
                </div>
                
                <!-- Alarm Preview -->
                <div id="alarm-preview" style="margin-top: 15px; display: none;">
                    <label style="font-size: 14px; color: #1a1a1a; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-eye"></i>
                        Preview (how it will appear in chart):
                    </label>
                    <div id="alarm-preview-content" style="border: 2px solid #e8eaed; padding: 12px; border-radius: 8px; background: white; min-height: 80px; margin-top: 8px;">
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button onclick="saveEnvironmentData()" class="btn btn-secondary">
                    <i class="fas fa-save"></i>
                    Save Environment Data
                </button>
                <a href="test-page-2.html" class="btn btn-outline">
                    <i class="fas fa-chart-bar"></i>
                    View Chart
                </a>
            </div>
        </div>
    </div>

    <script>
        // Add this to handle showing/hiding the button panel based on floor
        function updateButtonPanel() {
            const buttonPanel = document.getElementById('button-panel');
            if (currentFloor === 1) {
                buttonPanel.style.display = 'flex';
            } else {
                buttonPanel.style.display = 'none';
            }
        }

        // Initialize button panel on load
        window.addEventListener('load', updateButtonPanel);
    </script>

</html>