<!DOCTYPE html>
<html lang="en">

<head>

    <head>
        <link rel="icon" type="image/png" href="/icon.png?v=2">
        <link rel="apple-touch-icon" href="/icon.png?v=2">
        <link rel="icon" type="image/png" sizes="192x192" href="/iconcropped.png">
        <link rel="icon" type="image/png" sizes="512x512" href="/iconcropped.png">
        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#1a365d">

        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Farm Management Hub</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Complete Farm Records</title>

        <!-- Barn Software Styles -->
        <link rel="stylesheet" href="../barnsoftwares-css/barn-software-styles.css">
        <link rel="stylesheet" href="../barnsoftwares-css/flocklog.css">
        <script src="../barnsoftwares-css/barn-header.js"></script>
    </head>
</head>

<body>
    <div class="section-navigator">
        <div class="section-nav-header">Quick Nav</div>
        <div class="section-nav-items">
            <a href="#production-info" class="section-nav-item">Production Info</a>
            <a href="#chick-quality" class="section-nav-item">Chick Quality Assessment</a>
            <a href="#water-section" class="section-nav-item">Water</a>
            <a href="#feed-section" class="section-nav-item">Feed</a>
            <a href="#feed-transfer" class="section-nav-item">Feed Transfer</a>
            <a href="#barn-cleaning" class="section-nav-item">Barn Cleaning</a>
            <a href="#facilities-preparation" class="section-nav-item">Facilities Preparation</a>
            <a href="#pest-control" class="section-nav-item">Pest Control</a>
            <a href="#medications" class="section-nav-item">Medications</a>
            <a href="#deviation-chart" class="section-nav-item">Deviation Chart</a>
            <a href="#daily-checks" class="section-nav-item">Daily Checks</a>
        </div>
        <button class="section-nav-toggle">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <body>
        </div>
        </div>
        <header class="modern-header">
            <div class="header-container">
                <div class="logo-section">
                    <button class="nav-btn" id="backButton" title="Go Back">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button class="nav-btn" id="mainMenuButton" title="Main Menu">
                        <i class="fas fa-home"></i>
                    </button>
                    <img src="/rosefarmmangement.jpeg" alt="Rose Farm Management" class="main-logo-img">
                </div>
                <nav class="nav-container">
                    <div class="nav-links">
                        <a href="#" class="nav-item active" data-page="vas-b1-F1-MC.html"
                            title="Daily Mortality Floor 1">
                            <i class="fas fa-chart-line nav-icon"></i>
                            <span class="nav-label">Daily Mortality</span>
                        </a>
                        <a href="#" class="nav-item" data-page="vas-b1-VF.html" title="Visitor Log">
                            <i class="fas fa-users nav-icon"></i>
                            <span class="nav-label">Visitors</span>
                        </a>
                        <a href="#" class="nav-item" data-page="../floors/vbarn-1-1.html"
                            title="Mortality Card Floor 1">
                            <i class="fas fa-clipboard-list nav-icon"></i>
                            <span class="nav-label">Mortality Records</span>
                        </a>
                        <a href="#" class="nav-item" data-page="vas-b1-FL.html" title="Flock Log">
                            <i class="fas fa-feather-alt nav-icon"></i>
                            <span class="nav-label">Flock</span>
                        </a>
                        <a href="#" class="nav-item" data-page="vas-b1-SF.html" title="Shipping Log">
                            <i class="fas fa-shipping-fast nav-icon"></i>
                            <span class="nav-label">Shipping</span>
                        </a>
                    </div>
                </nav>
                <div class="action-buttons">
                    <button class="action-btn secondary" id="saveFormButton" title="Save Changes">
                        <i class="fas fa-save"></i>
                        <span>Save</span>
                    </button>
                    <button class="action-btn primary" id="printPDFButton" title="Print as PDF">
                        <i class="fas fa-file-pdf"></i>
                        <span>Print PDF</span>
                    </button>
                </div>
                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle mobile menu">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="mobile-nav-menu" id="mobileNavMenu">
                <div class="mobile-nav-content">
                    <div class="mobile-nav-links">
                        <a href="#" class="mobile-nav-item active" data-page="vas-b1-F1-MC.html">
                            <i class="fas fa-chart-line"></i>
                            <span>Daily Mortality</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-page="vas-b1-VF.html">
                            <i class="fas fa-users"></i>
                            <span>Visitors</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-page="../floors/vbarn-1-1.html">
                            <i class="fas fa-clipboard-list"></i>
                            <span>Mortality Records</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-page="vas-b1-FL.html">
                            <i class="fas fa-feather-alt"></i>
                            <span>Flock</span>
                        </a>
                        <a href="#" class="mobile-nav-item" data-page="vas-b1-SF.html">
                            <i class="fas fa-shipping-fast"></i>
                            <span>Shipping</span>
                        </a>
                    </div>
                    <div class="mobile-actions">
                        <button class="mobile-action-item" id="mobileSaveButton">
                            <i class="fas fa-save"></i>
                            <span>Save Changes</span>
                        </button>
                        <button class="mobile-action-item" id="mobilePrintButton">
                            <i class="fas fa-file-pdf"></i>
                            <span>Print PDF</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>
        <div class="status-messages">
            <div id="saveStatus" class="status-message"></div>
            <div id="resetStatus" class="status-message"></div>
        </div>
        <script>
            class HeaderNavigation {
                constructor() {
                    this.initializeNavigation();
                    this.initializeMobileMenu();
                    this.initializeActionButtons();
                    this.bindEvents();
                }
                initializeNavigation() {
                    this.navItems = document.querySelectorAll('.nav-item, .mobile-nav-item');
                    this.navItems.forEach(item => {
                        item.addEventListener('click', this.handleNavClick.bind(this));
                    });
                }
                initializeMobileMenu() {
                    this.mobileToggle = document.getElementById('mobileMenuToggle');
                    this.mobileMenu = document.getElementById('mobileNavMenu');

                    if (this.mobileToggle) {
                        this.mobileToggle.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            this.toggleMobileMenu();
                            return false;
                        });
                    }
                }
                initializeActionButtons() {
                    this.desktopBackButton = document.getElementById('desktopBackButton');
                    this.desktopMainMenuButton = document.getElementById('desktopMainMenuButton');

                    this.saveButton = document.getElementById('saveFormButton');
                    this.resetButton = document.getElementById('resetFormButton');
                    this.printButton = document.getElementById('printPDFButton');

                    this.mobileSaveButton = document.getElementById('mobileSaveButton');
                    this.mobileResetButton = document.getElementById('mobileResetButton');
                    this.mobilePrintButton = document.getElementById('mobilePrintButton');
                    this.mobileBackButton = document.getElementById('mobileBackButton');
                    this.mobileMainMenuButton = document.getElementById('mobileMainMenuButton');
                    if (this.desktopBackButton) this.desktopBackButton.addEventListener('click', this.handleBack.bind(this));
                    if (this.desktopMainMenuButton) this.desktopMainMenuButton.addEventListener('click', this.handleMainMenu.bind(this));
                    if (this.saveButton) this.saveButton.addEventListener('click', this.handleSave.bind(this));
                    if (this.resetButton) this.resetButton.addEventListener('click', this.handleReset.bind(this));
                    if (this.printButton) this.printButton.addEventListener('click', this.handlePrint.bind(this));

                    if (this.mobileSaveButton) this.mobileSaveButton.addEventListener('click', this.handleSave.bind(this));
                    if (this.mobileResetButton) this.mobileResetButton.addEventListener('click', this.handleReset.bind(this));
                    if (this.mobilePrintButton) this.mobilePrintButton.addEventListener('click', this.handlePrint.bind(this));
                    if (this.mobileBackButton) this.mobileBackButton.addEventListener('click', this.handleBack.bind(this));
                    if (this.mobileMainMenuButton) this.mobileMainMenuButton.addEventListener('click', this.handleMainMenu.bind(this));
                }
                bindEvents() {
                    document.addEventListener('click', this.handleOutsideClick.bind(this));

                    window.addEventListener('resize', this.handleResize.bind(this));
                }
                handleNavClick(event) {
                    event.preventDefault();

                    const clickedItem = event.currentTarget;
                    const page = clickedItem.dataset.page;

                    this.navItems.forEach(item => item.classList.remove('active'));

                    clickedItem.classList.add('active');

                    const counterpart = document.querySelector(
                        clickedItem.classList.contains('nav-item')
                            ? `.mobile-nav-item[data-page="${page}"]`
                            : `.nav-item[data-page="${page}"]`
                    );

                    if (counterpart) {
                        counterpart.classList.add('active');
                    }

                    this.closeMobileMenu();

                    if (page) {
                        this.navigateToPage(page);
                    }
                }
                toggleMobileMenu() {
                    const isActive = this.mobileToggle.classList.contains('active');

                    if (isActive) {
                        this.closeMobileMenu();
                    } else {
                        this.openMobileMenu();
                    }
                }
                openMobileMenu() {
                    this.mobileToggle.classList.add('active');
                    this.mobileMenu.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
                closeMobileMenu() {
                    this.mobileToggle.classList.remove('active');
                    this.mobileMenu.classList.remove('active');
                    document.body.style.overflow = '';
                }
                handleOutsideClick(event) {
                    if (this.mobileMenu && this.mobileToggle &&
                        !this.mobileMenu.contains(event.target) &&
                        !this.mobileToggle.contains(event.target) &&
                        this.mobileMenu.classList.contains('active')) {
                        this.closeMobileMenu();
                    }
                }
                handleResize() {
                    if (window.innerWidth > 768 && this.mobileMenu.classList.contains('active')) {
                        this.closeMobileMenu();
                    }
                }
                handleSave() {
                    this.showStatusMessage('Changes saved successfully!', 'success');
                }
                handleReset() {
                    if (confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
                        this.showStatusMessage('Form reset successfully!', 'success');
                    }
                }
                handleBack() {
                    this.closeMobileMenu();
                    if (window.history.length > 1) {
                        window.history.back();
                    } else {
                        this.navigateToPage('../floors-dash/v-floor-b1.html');
                    }
                }
                handleMainMenu() {
                    this.closeMobileMenu();
                    this.navigateToPage('../Extra/main-dashboard.html');
                }
                navigateToPage(page) {
                    if (page) {
                        this.showStatusMessage('Loading page...', 'success');

                        setTimeout(() => {
                            window.location.href = page;
                        }, 300);
                    }
                }
                showStatusMessage(message, type = 'success') {
                    const statusContainer = document.querySelector('.status-messages');
                    const statusElement = document.createElement('div');
                    statusElement.className = `status-message ${type}`;
                    statusElement.textContent = message;

                    statusContainer.appendChild(statusElement);

                    setTimeout(() => {
                        statusElement.classList.add('show');
                    }, 100);

                    setTimeout(() => {
                        statusElement.classList.remove('show');
                        setTimeout(() => {
                            if (statusElement.parentNode) {
                                statusElement.parentNode.removeChild(statusElement);
                            }
                        }, 300);
                    }, 3000);
                }
                updateConnectionStatus(isOnline = true) {
                    const statusIndicator = document.querySelector('.status-indicator');
                    const statusDot = document.querySelector('.status-dot');
                    const statusText = statusIndicator.querySelector('span');

                    if (isOnline) {
                        statusDot.style.background = 'var(--success-color)';
                        statusText.textContent = 'Online';
                        statusIndicator.style.color = 'white';
                    } else {
                        statusDot.style.background = 'var(--warning-color)';
                        statusText.textContent = 'Offline';
                        statusIndicator.style.color = 'white';
                    }
                }
            }
            function exportDocument(options = {}) {
                const defaultOptions = {
                    filename: 'Flock Log - Vassilaokos Farm Inc. - Barn #1',
                    format: 'pdf'
                };

                const settings = { ...defaultOptions, ...options };

                showExportOptionsModal(settings);
            }
            function showExportOptionsModal(settings) {
                const existingModal = document.querySelector('.export-options-modal');
                if (existingModal) {
                    document.body.removeChild(existingModal);
                }

                const modal = document.createElement('div');
                modal.className = 'export-options-modal';

                const modalContent = document.createElement('div');
                modalContent.className = 'export-options-content';

                const modalHeader = document.createElement('div');
                modalHeader.innerHTML = `
    <h2>Export PDF</h2>
    <p>Choose your filename</p>
  `;

                const form = document.createElement('form');

                const filenameGroup = document.createElement('div');
                filenameGroup.innerHTML = `
    <label for="export-filename">Filename</label>
    <input type="text" id="export-filename" value="${settings.filename}">
  `;

                const buttonGroup = document.createElement('div');

                const cancelButton = document.createElement('button');
                cancelButton.textContent = 'Cancel';
                cancelButton.type = 'button';

                const generateButton = document.createElement('button');
                generateButton.textContent = 'Export PDF';
                generateButton.type = 'button';

                form.appendChild(filenameGroup);
                form.appendChild(buttonGroup);
                buttonGroup.appendChild(cancelButton);
                buttonGroup.appendChild(generateButton);

                modalContent.appendChild(modalHeader);
                modalContent.appendChild(form);

                modal.appendChild(modalContent);

                document.body.appendChild(modal);

                function closeModal() {
                    if (modal.parentNode) {
                        document.body.removeChild(modal);
                    }
                }

                cancelButton.addEventListener('click', closeModal, { once: true });

                modal.addEventListener('click', function (e) {
                    if (e.target === modal) {
                        closeModal();
                    }
                });

                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape') {
                        closeModal();
                    }
                }, { once: true });

                generateButton.addEventListener('click', function () {
                    const filename = document.getElementById('export-filename').value || 'farm-records';
                    const format = 'pdf';

                    closeModal();

                    showLoading();

                    setTimeout(() => {
                        createAndDownloadPDF(filename + '.pdf');
                    }, 100);
                }, { once: true });
            }
            function showLoading() {
                const loadingEl = document.createElement('div');
                loadingEl.id = 'export-loading-indicator';

                loadingEl.innerHTML = `
    <div></div>
    <p>Generating document...</p>
  `;

                document.body.appendChild(loadingEl);
            }
            function hideLoading() {
                const loadingEl = document.getElementById('export-loading-indicator');
                if (loadingEl) {
                    document.body.removeChild(loadingEl);
                }
            }
            async function createAndDownloadPDF(filename) {
                try {
                    showLoading();

                    await loadLibraries([
                        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
                        'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'
                    ]);

                    const pdf = new jspdf.jsPDF({
                        format: 'letter',
                        orientation: 'portrait',
                        unit: 'mm',
                        compress: true
                    });

                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();

                    const margin = 10;
                    const usableHeight = pdfHeight - (2 * margin);

                    document.body.classList.add('pdf-export-mode');

                    const pdfStylesheet = document.createElement('style');
                    pdfStylesheet.id = 'pdf-export-styles';
                    pdfStylesheet.textContent = ``;
                    document.head.appendChild(pdfStylesheet);

                    function cleanElementForPDF(element) {
                        const cleaned = element.cloneNode(true);

                        if (cleaned.classList && cleaned.classList.contains('right-column')) {
                            const table = cleaned.querySelector('table');
                            if (table) {
                                table.classList.add('chick-quality-table');

                                const thead = table.querySelector('thead');
                                if (thead) {
                                    const allHeaderRows = thead.querySelectorAll('tr');
                                    allHeaderRows.forEach(row => {
                                        row.style.display = 'table-row';
                                        row.style.visibility = 'visible';

                                        const allHeaderCells = row.querySelectorAll('th');
                                        allHeaderCells.forEach(cell => {
                                            cell.style.display = 'table-cell';
                                            cell.style.visibility = 'visible';
                                            cell.style.textAlign = 'center';
                                            cell.style.border = '1px solid #dadce0';
                                            cell.style.backgroundColor = '#e8f0fe';
                                            cell.style.color = '#1a73e8';
                                            cell.style.padding = '6px';
                                            cell.style.fontWeight = 'bold';
                                            cell.style.fontSize = '10px';

                                            if (cell.hasAttribute('rowspan')) {
                                                cell.style.verticalAlign = 'middle';
                                            }
                                        });
                                    });
                                }

                                const allCells = table.querySelectorAll('td');
                                allCells.forEach(cell => {
                                    cell.style.textAlign = 'center';
                                    cell.style.verticalAlign = 'middle';
                                    cell.style.display = 'table-cell';
                                    cell.style.visibility = 'visible';
                                });
                            }

                            return cleaned;
                        }

                        const sectionHeader = cleaned.querySelector('.section-header');
                        const headerText = sectionHeader ? sectionHeader.textContent : '';

                        const keepAllColumns = ['BARN CLEANING', 'Facilities Preparation', 'Pest Control'];
                        const shouldKeepAllColumns = keepAllColumns.some(text => headerText.includes(text));

                        const hideLastColumn = ['Water - Record all products', 'Feed', 'Feed Transfer Record', 'Medications - Complete', 'Deviation Chart'];
                        const shouldHideLastColumn = hideLastColumn.some(text => headerText.includes(text));

                        if (shouldKeepAllColumns) {
                            const tables = cleaned.querySelectorAll('table');
                            tables.forEach(table => {
                                table.classList.add('keep-all-columns');
                                const allCells = table.querySelectorAll('th, td');
                                allCells.forEach(cell => {
                                    cell.style.display = 'table-cell';
                                    cell.style.visibility = 'visible';
                                });
                            });
                        } else if (shouldHideLastColumn) {
                            const tables = cleaned.querySelectorAll('table');
                            tables.forEach(table => {
                                const rows = table.querySelectorAll('tr');
                                rows.forEach(row => {
                                    const cells = row.querySelectorAll('th, td');
                                    if (cells.length > 0) {
                                        const lastCell = cells[cells.length - 1];

                                        lastCell.style.display = 'none';
                                        lastCell.style.visibility = 'hidden';
                                        lastCell.style.width = '0';
                                        lastCell.style.maxWidth = '0';
                                        lastCell.style.padding = '0';
                                        lastCell.style.margin = '0';
                                        lastCell.style.border = 'none';
                                        lastCell.style.fontSize = '0';
                                        lastCell.style.lineHeight = '0';
                                        lastCell.style.height = '0';
                                        lastCell.style.opacity = '0';
                                        lastCell.style.position = 'absolute';
                                        lastCell.style.left = '-9999px';
                                        lastCell.style.overflow = 'hidden';

                                        lastCell.innerHTML = '';
                                    }
                                });
                            });
                        }

                        const addButtons = cleaned.querySelectorAll('button[id*="add"]');
                        addButtons.forEach(button => {
                            button.style.display = 'none';
                            button.style.visibility = 'hidden';
                            button.style.height = '0';
                            button.style.margin = '0';
                            button.style.padding = '0';

                            const container = button.parentNode;
                            if (container) {
                                container.style.display = 'none';
                                container.style.visibility = 'hidden';
                                container.style.height = '0';
                                container.style.margin = '0';
                                container.style.padding = '0';
                                container.style.overflow = 'hidden';
                            }
                        });

                        return cleaned;
                    }

                    async function measureElementHeight(element) {
                        const tempContainer = document.createElement('div');
                        tempContainer.style.position = 'absolute';
                        tempContainer.style.left = '-9999px';
                        tempContainer.style.top = '0';
                        tempContainer.style.width = `${pdfWidth - 2 * margin}mm`;
                        tempContainer.style.backgroundColor = 'white';

                        const clonedElement = element.cloneNode(true);
                        tempContainer.appendChild(clonedElement);

                        document.body.appendChild(tempContainer);

                        await new Promise(resolve => setTimeout(resolve, 0));

                        const rect = tempContainer.getBoundingClientRect();
                        const height = rect.height;

                        document.body.removeChild(tempContainer);

                        const heightInMm = (height / 96) * 25.4;

                        return heightInMm;
                    }

                    const titleSection = document.querySelector('.title-section');
                    const productionInfo = document.querySelector('.production-info');
                    const placementNotes = document.querySelector('div[style*="margin: 20px 0"]');
                    const sections = Array.from(document.querySelectorAll('.section'));

                    const logoImg = document.querySelector('.main-logo-img');
                    const logoSrc = logoImg ? logoImg.src : null;

                    const contentElements = [];

                    if (titleSection) {
                        const cleaned = cleanElementForPDF(titleSection);
                        const height = await measureElementHeight(cleaned);
                        contentElements.push({ element: cleaned, height: height, type: 'title' });
                    }

                    if (productionInfo) {
                        const cleaned = cleanElementForPDF(productionInfo);
                        const height = await measureElementHeight(cleaned);
                        contentElements.push({ element: cleaned, height: height, type: 'productionInfo' });
                    }

                    if (placementNotes) {
                        const cleaned = cleanElementForPDF(placementNotes);
                        const height = await measureElementHeight(cleaned);
                        contentElements.push({ element: cleaned, height: height, type: 'placementNotes' });
                    }

                    for (const section of sections) {
                        const cleaned = cleanElementForPDF(section);
                        const height = await measureElementHeight(cleaned);
                        contentElements.push({ element: cleaned, height: height, type: 'section' });
                    }

                    const pages = [];
                    let currentPage = [];
                    let currentPageHeight = 0;
                    let isFirstPage = true;

                    const logoSpace = isFirstPage && logoSrc ? 56 : 0;
                    let maxHeight = usableHeight - logoSpace;

                    for (const content of contentElements) {
                        if (currentPageHeight + content.height > maxHeight && currentPage.length > 0) {
                            pages.push(currentPage);

                            currentPage = [];
                            currentPageHeight = 0;
                            isFirstPage = false;
                            maxHeight = usableHeight;
                        }

                        currentPage.push(content);
                        currentPageHeight += content.height;
                    }

                    if (currentPage.length > 0) {
                        pages.push(currentPage);
                    }

                    for (let pageIndex = 0; pageIndex < pages.length; pageIndex++) {
                        if (pageIndex > 0) {
                            pdf.addPage();
                        }

                        const pageContainer = document.createElement('div');
                        pageContainer.style.width = `${pdfWidth - 2 * margin}mm`;
                        pageContainer.style.padding = `${margin}mm`;
                        pageContainer.style.backgroundColor = 'white';
                        pageContainer.style.position = 'relative';

                        if (pageIndex === 0 && logoSrc) {
                            const logoElement = document.createElement('img');
                            logoElement.src = logoSrc;
                            logoElement.className = 'pdf-logo';
                            logoElement.style.position = 'absolute';
                            logoElement.style.top = '0';
                            logoElement.style.left = '0';
                            logoElement.style.width = '130.5px';
                            logoElement.style.height = 'auto';
                            logoElement.style.marginBottom = '10px';
                            pageContainer.appendChild(logoElement);

                            const spacer = document.createElement('div');
                            spacer.style.height = '145.5px';
                            pageContainer.appendChild(spacer);
                        }

                        pages[pageIndex].forEach(content => {
                            pageContainer.appendChild(content.element);
                        });

                        document.body.appendChild(pageContainer);

                        try {
                            const canvas = await html2canvas(pageContainer, {
                                scale: 2,
                                useCORS: true,
                                logging: false,
                                backgroundColor: '#ffffff',
                                allowTaint: true,
                                onclone: function (clonedDocument) {
                                    if (pageIndex === 0) {
                                        const clonedLogo = clonedDocument.querySelector('.pdf-logo');
                                        if (clonedLogo) {
                                            clonedLogo.style.display = 'block';
                                            clonedLogo.style.visibility = 'visible';
                                        }
                                    }

                                    const rightColumn = clonedDocument.querySelector('.right-column');
                                    if (rightColumn) {
                                        const table = rightColumn.querySelector('table');
                                        if (table) {
                                            const thead = table.querySelector('thead');
                                            if (thead) {
                                                const headerRows = thead.querySelectorAll('tr');
                                                headerRows.forEach((row, index) => {
                                                    row.style.display = 'table-row';
                                                    row.style.visibility = 'visible';

                                                    const cells = row.querySelectorAll('th');
                                                    cells.forEach(cell => {
                                                        cell.style.display = 'table-cell';
                                                        cell.style.visibility = 'visible';
                                                        cell.style.textAlign = 'center';
                                                        cell.style.verticalAlign = 'middle';
                                                        cell.style.border = '1px solid #dadce0';
                                                        cell.style.backgroundColor = '#e8f0fe';
                                                        cell.style.color = '#1a73e8';
                                                        cell.style.fontWeight = 'bold';
                                                        cell.style.fontSize = '10px';
                                                    });
                                                });
                                            }

                                            const allCells = table.querySelectorAll('td');
                                            allCells.forEach(cell => {
                                                cell.style.display = 'table-cell';
                                                cell.style.visibility = 'visible';
                                                cell.style.textAlign = 'center';
                                                cell.style.verticalAlign = 'middle';
                                            });
                                        }
                                    }

                                    const sections = clonedDocument.querySelectorAll('.section');
                                    sections.forEach(section => {
                                        const header = section.querySelector('.section-header');
                                        if (header) {
                                            const headerText = header.textContent;
                                            const shouldHide = ['Water - Record all products', 'Feed', 'Feed Transfer Record', 'Medications - Complete', 'Deviation Chart'].some(text => headerText.includes(text));

                                            if (shouldHide) {
                                                const tables = section
                                                const tables = section.querySelectorAll('table');
                                                tables.forEach(table => {
                                                    const rows = table.querySelectorAll('tr');
                                                    rows.forEach(row => {
                                                        const cells = row.querySelectorAll('th, td');
                                                        if (cells.length > 0) {
                                                            const lastCell = cells[cells.length - 1];
                                                            lastCell.style.display = 'none';
                                                            lastCell.style.visibility = 'hidden';
                                                            lastCell.style.width = '0';
                                                            lastCell.style.padding = '0';
                                                            lastCell.style.margin = '0';
                                                            lastCell.style.border = 'none';
                                                            lastCell.innerHTML = '';
                                                        }
                                                    });
                                                });
                                            }
                                        }
                                    });
                                }
                            });

                            const imgData = canvas.toDataURL('image/jpeg', 1.0);
                            const canvasWidth = canvas.width;
                            const canvasHeight = canvas.height;

                            const scale = Math.min(
                                (pdfWidth - 2 * margin) / canvasWidth,
                                (pdfHeight - 2 * margin) / canvasHeight
                            );

                            const scaledWidth = canvasWidth * scale;
                            const scaledHeight = canvasHeight * scale;

                            const x = (pdfWidth - scaledWidth) / 2;
                            const y = margin;

                            pdf.addImage(imgData, 'JPEG', x, y, scaledWidth, scaledHeight);
                        } catch (error) {
                            console.error("Error rendering page:", error);
                        } finally {
                            document.body.removeChild(pageContainer);
                        }
                    }

                    document.body.classList.remove('pdf-export-mode');
                    document.head.removeChild(pdfStylesheet);

                    pdf.save(filename);

                    setTimeout(() => {
                        hideLoading();
                    }, 100);

                    showMessage('PDF generated successfully!', 'success');

                } catch (error) {
                    console.error('Error generating PDF:', error);
                    hideLoading();
                    showMessage('Error generating PDF. Please try again.', 'error');
                }
            }
            function optimizeSectionsForPDF() {
                const largeSections = document.querySelectorAll('.section');

                largeSections.forEach(section => {
                    if (section.offsetHeight > 700) {
                        section.classList.add('pdf-large-section');

                        const tables = section.querySelectorAll('table');
                        tables.forEach(table => {
                            table.classList.add('pdf-breakable-table');
                        });
                    }
                });

                const additionalCSS = ``;

                return additionalCSS;
            }
            function createAndDownloadTXT(filename) {
                try {
                    const pages = document.querySelectorAll('.page');
                    let textContent = '';

                    pages.forEach((page, pageIndex) => {
                        const clonedPage = page.cloneNode(true);

                        const pageTitle = clonedPage.querySelector('.page-title');
                        if (pageTitle) {
                            textContent += '='.repeat(40) + '\n';
                            textContent += pageTitle.textContent.trim() + '\n';
                            textContent += '='.repeat(40) + '\n\n';
                        } else if (pageIndex > 0) {
                            textContent += '\n\n' + '-'.repeat(40) + '\n\n';
                        }

                        const sections = clonedPage.querySelectorAll('.section');

                        sections.forEach(section => {
                            const sectionHeader = section.querySelector('.section-header');
                            if (sectionHeader) {
                                textContent += sectionHeader.textContent.trim() + '\n';
                                textContent += '-'.repeat(sectionHeader.textContent.trim().length) + '\n\n';
                            }

                            const tables = section.querySelectorAll('table');

                            tables.forEach(table => {
                                const headers = Array.from(table.querySelectorAll('th')).map(th => th.textContent.trim());

                                if (headers.length > 0) {
                                    textContent += headers.join(' | ') + '\n';
                                    textContent += headers.map(h => '-'.repeat(h.length)).join('-+-') + '\n';

                                    const rows = table.querySelectorAll('tbody tr');

                                    rows.forEach(row => {
                                        if (row.classList.contains('note-row')) {
                                            const noteTextarea = row.querySelector('textarea');
                                            if (noteTextarea && noteTextarea.value) {
                                                textContent += 'Note: ' + noteTextarea.value + '\n';
                                            }
                                        } else {
                                            const cells = Array.from(row.querySelectorAll('td')).map(td => {
                                                const input = td.querySelector('input[type="text"], input[type="date"], textarea');
                                                const checkbox = td.querySelector('input[type="checkbox"]');

                                                if (input && input.value) {
                                                    return input.value.trim();
                                                } else if (checkbox) {
                                                    return checkbox.checked ? '[X]' : '[ ]';
                                                } else {
                                                    return td.textContent.trim();
                                                }
                                            });

                                            textContent += cells.join(' | ') + '\n';
                                        }
                                    });

                                    textContent += '\n';
                                }
                            });

                            const inputs = section.querySelectorAll('input[type="text"]:not([data-processed]), textarea:not([data-processed])');

                            inputs.forEach(input => {
                                const label = input.previousElementSibling;
                                if (label && label.tagName === 'LABEL') {
                                    textContent += label.textContent.trim() + ': ' + input.value.trim() + '\n';
                                }

                                input.setAttribute('data-processed', 'true');
                            });

                            textContent += '\n\n';
                        });

                        const inputs = page.querySelectorAll('input[type="text"]:not([data-processed]), textarea:not([data-processed])');

                        inputs.forEach(input => {
                            const label = input.previousElementSibling;
                            if (label && label.tagName === 'LABEL') {
                                textContent += label.textContent.trim() + ': ' + input.value.trim() + '\n';
                            }

                            input.setAttribute('data-processed', 'true');
                        });
                    });

                    document.querySelectorAll('[data-processed]').forEach(el => {
                        el.removeAttribute('data-processed');
                    });

                    const blob = new Blob([textContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    hideLoading();

                    showMessage('Text file generated successfully!', 'success');

                } catch (error) {
                    console.error('Error generating text file:', error);
                    hideLoading();
                    showMessage('Error generating text file. Please try again.', 'error');
                }
            }
            function loadLibraries(urls) {
                return Promise.all(urls.map(url => {
                    return new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = url;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                }));
            }
            function showMessage(message, type = 'info') {
                const toast = document.createElement('div');

                if (type === 'success') {
                    toast.style.backgroundColor = '#e6f4ea';
                    toast.style.color = '#137333';
                    toast.style.border = '1px solid #34a853';
                } else if (type === 'error') {
                    toast.style.backgroundColor = '#fce8e6';
                    toast.style.color = '#c5221f';
                    toast.style.border = '1px solid #ea4335';
                } else {
                    toast.style.backgroundColor = '#e8f0fe';
                    toast.style.color = '#1a73e8';
                    toast.style.border = '1px solid #4285f4';
                }

                toast.innerHTML = `${message}`;

                document.body.appendChild(toast);

                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 3000);
            }
            function attachExportButtons() {
                const printButton = document.getElementById('printPDFButton');
                if (printButton) {
                    printButton.addEventListener('click', function () {
                        exportDocument();
                    });
                }

                const mobilePrintButton = document.getElementById('mobilePrintButton');
                if (mobilePrintButton) {
                    mobilePrintButton.addEventListener('click', function () {
                        exportDocument();
                    });
                }
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', attachExportButtons);
            } else {
                attachExportButtons();
            }
            window.exportDocument = exportDocument;
            document.addEventListener('DOMContentLoaded', function () {
                const navigation = new HeaderNavigation();

                const mobileToggle = document.getElementById('mobileMenuToggle');
                if (mobileToggle) {
                    mobileToggle.addEventListener('click', function (e) {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();

                        navigation.toggleMobileMenu();
                        return false;
                    });
                }

                setInterval(() => {
                    navigation.updateConnectionStatus(navigator.onLine);
                }, 5000);

                window.addEventListener('online', () => {
                    navigation.updateConnectionStatus(true);
                    navigation.showStatusMessage('Connection restored', 'success');
                });

                window.addEventListener('offline', () => {
                    navigation.updateConnectionStatus(false);
                    navigation.showStatusMessage('Connection lost', 'error');
                });
            });
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Escape') {
                    const mobileMenu = document.getElementById('mobileNavMenu');
                    const mobileToggle = document.getElementById('mobileMenuToggle');
                    if (mobileMenu && mobileMenu.classList.contains('active')) {
                        mobileToggle.click();
                    }
                }

                if (e.altKey && e.key === 'm' && window.innerWidth <= 768) {
                    const mobileToggle = document.getElementById('mobileMenuToggle');
                    if (mobileToggle) {
                        mobileToggle.click();
                    }
                }
            });

            function attachPrintButton() {
                const printButton = document.getElementById('printPDFButton');
                if (printButton) {
                    printButton.addEventListener('click', function () {
                        exportDocument();
                    });
                }

                const mobilePrintButton = document.getElementById('mobilePrintButton');
                if (mobilePrintButton) {
                    mobilePrintButton.addEventListener('click', function () {
                        exportDocument();
                    });
                }
            }
            function convertInputsInContainer(container) {
                const textInputs = container.querySelectorAll('input[type="text"]:not(.signature-input)');

                textInputs.forEach(input => {
                    const textarea = document.createElement('textarea');

                    Array.from(input.attributes).forEach(attr => {
                        textarea.setAttribute(attr.name, attr.value);
                    });

                    textarea.value = input.value;
                    textarea.rows = 1;

                    input.parentNode.replaceChild(textarea, input);
                });
            }
            function convertAllInputsToTextareas() {
                convertInputsInContainer(document.body);
            }
            const originalAppendChild = Element.prototype.appendChild;
            Element.prototype.appendChild = function (child) {
                const result = originalAppendChild.call(this, child);

                if (child && (child.tagName === 'TR' || child.tagName === 'DIV')) {
                    setTimeout(() => {
                        convertInputsInContainer(child);
                    }, 10);
                }

                return result;
            };
            document.addEventListener('DOMContentLoaded', function () {
                setTimeout(convertAllInputsToTextareas, 100);
            });
            const originalLoadFormData = loadFormData;
            loadFormData = async function () {
                await originalLoadFormData();
                setTimeout(convertAllInputsToTextareas, 500);
            };
        </script>
    </body>

</html>

<body>

    <div class="main-content">
        <div class="title-section">
            <div class="main-title">Raised by a Canadian Farmer</div>
            <div class="subtitle">On-Farm Food Safety Program (2021) and<br>Animal Care Program (2018) Flock-Specific
                Records</div>
        </div>
        <div class="production-info">
            <div class="left-column">
                <div>Production Information</div>
                <div class="info-row">
                    <span class="info-label">Farm:</span>
                    <span class="info-label">Vassilaokos Farm Inc.</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Quota Period:</span>
                    <span class="info-value-no-underline" id="quotaPeriodDisplay">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Barn #:</span>
                    <span class="info-label">1</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Floor #:</span>
                    <span class="info-label">1 and 2</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Placement Date:</span>
                    <span class="info-value-no-underline" id="placementDateDisplay">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Name of farm representative:</span>
                    <input type="text" class="info-value" placeholder="Chris Rose">
                </div>
            </div>

            <div class="right-column">
                <div>Chick Quality Assessment</div>
                <table class="table-header-dark">
                    <thead>
                        <tr>
                            <th rowspan="2">Quality Assessment</th>
                            <th colspan="2">Upon Receipt of Chicks</th>
                            <th colspan="2">3-4 Day-old Chicks</th>
                        </tr>
                        <tr>
                            <th>Acceptable</th>
                            <th>Not Acceptable</th>
                            <th>Acceptable</th>
                            <th>Not Acceptable</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Alertness</td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                        <tr>
                            <td>Vigour</td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                        <tr>
                            <td>Condition</td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                        <tr>
                            <td>Normality</td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                            <td><input type="checkbox"></td>
                        </tr>
                    </tbody>

                    </tbody>
                </table>
            </div>
        </div>
        <div>
            <label>Placement notes:</label>
            <textarea class="full-width" placeholder="Additional comments or notes"></textarea>
        </div>
        <div class="section">
            <div class="section-header">
                Water - Record all products (e.g. for cleaning, acidification/pH, probiotics, etc.) used in the water.
                For cleaning products, record the verification results (at least twice during the grow-out)
            </div>
            <div class="section-content">
                <table class="table-header-dark">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Date(s) Used</th>
                            <th colspan="2">Chemical Concentration Verification</th>
                            <th></th>
                        </tr>
                        <tr>
                            <th></th>
                            <th></th>
                            <th>Date</th>
                            <th>Results (e.g. ppm, pH)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="table-input" placeholder="Product name"></td>
                            <td><input type="date" class="table-input"></td>
                            <td><input type="date" class="table-input"></td>
                            <td><input type="text" class="table-input" placeholder="Results"></td>
                            <td>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div>
                    <button type="button" id="addWaterEntryButton">
                        Add Entry
                    </button>
                </div>
            </div>
        </div>
        <div class="section">
            <div class="section-header">Feed</div>
            <div class="section-content">
                <div class="note">
                    Each load of feed is visually inspected and the bill checked for medications and kept in the
                    producer's file:
                    <input type="text" class="signature-input" placeholder="Chris Rose" id="feedSignature">

                </div>

                <table class="table-header-dark">
                    <thead>
                        <tr>
                            <th>Record the date that control measures were used when switching from a medicated feed
                                with a withdrawal period to feed without a withdrawal period*</th>
                            <th>Record the type and amount of ingredients (e.g. wheat) added to finished feeds</th>
                            <th>Record the dates of feed samples (if required)</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="date" class="table-input"></td>
                            <td><textarea class="table-input" placeholder="Enter ingredients"></textarea></td>
                            <td><input type="date" class="table-input"></td>
                            <td>
                            </td>
                        </tr>
                        <tr class="note-row">
                            <td colspan="4">
                                <div>
                                    <label>Notes:</label>
                                    <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div>
                    <button type="button" id="addFeedEntryButton">
                        Add Entry
                    </button>
                </div>
                <div class="note">
                    * For single bin systems record the date when the sides of the bin were knocked down to prevent feed
                    hang-ups; for double bin systems record the date when the switch to the feed bin without a
                    withdrawal period occurred.
                </div>
            </div>
        </div>
        <div class="section">
            <div class="section-header">Feed Transfer Record</div>
            <div class="section-content">
                <table class="table-header-dark">
                    <thead>
                        <tr>
                            <table class="table-header-dark">
                                <thead>
                                    <tr>
                                        <th>Date feed moved</th>
                                        <th>Original farm name and bin #</th>
                                        <th>Destination farm name and bin #</th>
                                        <th>List any medications with withdrawal periods used in the flock</th>
                                        <th>Method of transport</th>
                                        <th>Sample taken</th>
                                        <th>Cross-contamination prevention measures used at the original bin</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><input type="date" class="table-input"></td>
                                        <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
                                        <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
                                        <td><textarea class="table-input" placeholder="Medications"></textarea></td>
                                        <td><input type="text" class="table-input" placeholder="Truck"></td>
                                        <td>
                                            <select class="table-input">
                                                <option value="Yes" selected>Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="table-input" placeholder="Yes" value="Yes"></td>
                                        <td>
                                        </td>
                                    </tr>
                                    <tr class="note-row">
                                        <td colspan="8">
                                            <div>
                                                <label>Notes:</label>
                                                <textarea class="entry-note-input"
                                                    placeholder="Notes for this entry..."></textarea>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            <div>
                                <button type="button" id="addFeedTransferEntryButton">
                                    Add Entry
                                </button>
                            </div>
            </div>
        </div>
        <div class="page">
            <div class="page-title">Barn Preparation Checklist</div>
            <div class="section">
                <div class="section-content">
                    <table class="table-header-dark">
                        <thead>
                            <tr>
                                <th class="task-description">BARN CLEANING</th>
                                <th class="date-column">DATE(S) COMPLETED</th>
                                <th class="product-column">RECORD THE PRODUCT NAME AND/OR A DESCRIPTION OF THE PROCEDURE
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Remove litter/manure from barn *If using Option #3 - time since shipment of last
                                    flock:</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Location/procedure"></td>
                            </tr>
                            <tr>
                                <td>Dry-clean (i.e. blow down/brushing) barn, entranceway and equipment
                                    (feeders/drinkers/fans/floor/walls/barn footwear/ catching equipment etc.)</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Service/procedure"></td>
                            </tr>
                            <tr>
                                <td>Mortality buckets/pails are washed with water and detergent and/or disinfectant</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Prevail Disinfectant"></td>
                            </tr>
                            <tr>
                                <td>Barn and equipment (as per the above dry-clean list) is pressure washed with water
                                </td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Service/product"></td>
                            </tr>
                            <tr>
                                <td>Option 1: <input type="checkbox" id="option1_detergent"> Detergent and/or <input
                                        type="checkbox" id="option1_disinfectant"> disinfectant/fumigation used in the
                                    barn and on the equipment</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Prevail Disinfectant"></td>
                            </tr>
                            <tr>
                                <td>Option 2: <input type="checkbox" id="option2_detergent"> Detergent and/or <input
                                        type="checkbox" id="option2_disinfectant"> disinfectant/fumigation used on the
                                    equipment</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="N/A"></td>
                            </tr>
                            <tr>
                                <td>Equipment used during clean-out is cleaned</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="See Linde Poultry Service"></td>
                            </tr>
                            <tr>
                                <td>Flush, clean and/or disinfect water lines (open drinkers disinfected if applicable)
                                </td>
                                <td><input type="date" class="table-input"></td>
                                <td>
                                    <div class="checkbox-container">
                                        <input type="checkbox" id="flush">
                                        <label for="flush">Flush</label>
                                    </div>
                                    <input type="text" class="table-input" placeholder="Product name">
                                </td>
                            </tr>
                            <tr>
                                <td>Inspect inside and outside of feed bin and clean if needed (min. 1/year)</td>
                                <td><input type="date" class="table-input"></td>
                                <td><textarea class="table-input" placeholder="Description"></textarea></td>
                            </tr>
                            <tr>
                                <td>Downtime: Indicate the number of days from when the flock was shipped to the
                                    placement of chicks</td>
                                <td colspan="2"><input type="number" class="small-input" placeholder="Days" min="0">
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="section">
                <div class="section-content">
                    <table class="table-header-dark">
                        <thead>
                            <tr>
                                <th class="task-description">Facilities Preparation</th>
                                <th class="date-column">Date(s)</th>
                                <th class="product-column">Description/Results</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Water system checked (including filters or UV bulbs)</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Dates of filters/bulbs changed">
                                </td>
                            </tr>
                            <tr>
                                <td>Heating system checked</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>Stand-by generator checked</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Test results"></td>
                            </tr>
                            <tr>
                                <td>Monitoring system checked</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Test results"></td>
                            </tr>
                            <tr>
                                <td>Ventilation system checked</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>Light system checked</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>Drinkers and feeders checked individually</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>Bedding material (checked for mold/feathers/droppings/sharp edges or harmful
                                    compounds at placement)</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Condition and type"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="section">
                <div class="section-content">
                    <table class="table-header-dark">
                        <thead>
                            <tr>
                                <th class="task-description">Pest Control - Describe the pest control methods used</th>
                                <th class="date-column">Date(s)</th>
                                <th class="product-column">Description/Product</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Describe any barn repairs</td>
                                <td><input type="date" class="table-input"></td>
                                <td><textarea class="table-input" placeholder="Description of repairs"></textarea></td>
                            </tr>
                            <tr>
                                <td>Vegetation cut around building(s)</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>CAZ kept maintained</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Status"></td>
                            </tr>
                            <tr>
                                <td>Rodent controls used</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Product/method"></td>
                            </tr>
                            <tr>
                                <td>Wild bird controls used</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Product/method"></td>
                            </tr>
                            <tr>
                                <td>Fly controls used</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Product"></td>
                            </tr>
                            <tr>
                                <td>Insecticides (e.g. for darkling beetles) used</td>
                                <td><input type="date" class="table-input"></t <td>Insecticides (e.g. for darkling
                                    beetles) used</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Product"></td>
                            </tr>
                            <tr>
                                <td>Other pests (names) and controls used</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="table-input" placeholder="Controls"></td>
                            </tr>
                            <tr>
                                <td>No pets in the RA ()</td>
                                <td><input type="date" class="table-input"></td>
                                <td><input type="text" class="signature-input" placeholder="Signature"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="page">
                <div class="header-info">
                    <span>Flock Information</span>
                </div>
                <div class="section">
                    <div class="section-header">
                        Medications - Complete the following table for all medications administered through feed or
                        water
                    </div>
                    <div class="section-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>Name of Medications</th>
                                    <th>Route of Administration</th>
                                    <th colspan="3">Water Medicator Tested</th>
                                    <th>Record any control measures used in the last 2 weeks of grow-out*</th>
                                    <th></th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th></th>
                                    <th>Date</th>
                                    <th>Results</th>
                                    <th>Corrective Actions (if any)</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><input type="text" class="table-input" placeholder="Medication name"></td>
                                    <td>
                                        <div class="checkbox-container">
                                            <input type="checkbox" id="feed1">
                                            <label for="feed1">feed</label>
                                        </div>
                                        <div class="checkbox-container">
                                            <input type="checkbox" id="water1">
                                            <label for="water1">water</label>
                                        </div>
                                    </td>
                                    <td><input type="date" class="table-input"></td>
                                    <td><input type="date" class="table-input"></td>
                                    <td><input type="text" class="table-input" placeholder="Actions"></td>
                                    <td><input type="text" class="table-input" placeholder="Control measures"></td>
                                    <td>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div>
                            <button type="button" id="addMedicationEntryButton">
                                Add Entry
                            </button>
                        </div>
                        <div class="note">
                            *For medication with a withdrawal period used in the last 14 days. Record the date feed was
                            minimized or the water lines flushed.
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-header">
                        Deviation Chart
                    </div>
                    <div class="section-content">
                        <p>Complete this table when a deviation from <u>any</u> Standard Operating Procedures occurs
                            including:</p>
                        <div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="temp">
                                <label for="temp">Temperature levels</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="lighting">
                                <label for="lighting">Lighting program</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="humidity">
                                <label for="humidity">Humidity or ammonia levels</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="mortality">
                                <label for="mortality">High mortality</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="bedding">
                                <label for="bedding">Bedding quality</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="medication">
                                <label for="medication">Medication administered through feed or water</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="alarms">
                                <label for="alarms">Alarms</label>
                            </div>
                        </div>
                        <p><strong>Deviations only need to be recorded if they exceed upper or lower limits outlined in
                                SOP.</strong></p>

                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description of the Deviation</th>
                                    <th>Reason for the Deviation</th>
                                    <th>Actions taken to Correct the Deviation</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>

                                <tr>
                                    <td><input type="date" class="table-input"></td>
                                    <td><textarea class="table-input" placeholder="Describe deviation"></textarea></td>
                                    <td><textarea class="table-input" placeholder="Reason for deviation"></textarea>
                                    </td>
                                    <td><textarea class="table-input" placeholder="Corrective actions"></textarea></td>
                                    <td>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div>
                            <button type="button" id="addDeviationEntryButton">
                                Add Entry
                            </button>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">Daily Checks</div>
                    <div class="section-content">
                        <p>I confirm that the information on these Flock Specific records is accurate and that the
                            following food safety and animal care checks have been performed on a daily basis (any
                            deviations from SOP's are to be recorded in the Deviation Chart):</p>

                        <div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="feedquality">
                                <label for="feedquality">Feed quality and availability</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="thermal">
                                <label for="thermal">Thermal comfort of the flock</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="templevels">
                                <label for="templevels">Temperature levels</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="humiditylevels">
                                <label for="humiditylevels">Humidity levels</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="wateravail">
                                <label for="wateravail">Water availability (quality  cloudiness and discoloration 
                                    checked weekly)</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="flockhealth">
                                <label for="flockhealth">Flock Health</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="ventilation">
                                <label for="ventilation">Ventilation system</laalevels< /label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="waterquality">
                                <label for="waterquality">Water quality (mold and slime) for open drinkers</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="heatingsystem">
                                <label for="heatingsystem">Heating system</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="lightingsystem">
                                <label for="lightingsystem">Lighting system</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="litterquality">
                                <label for="litterquality">Litter quality</label>
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" id="birdsinspected">
                                <label for="birdsinspected">Birds inspected minimum twice daily</label>
                            </div>
                        </div>
                        <div>
                            <label>Additional notes:</label>
                            <textarea class="full-width" placeholder="Additional comments or notes"></textarea>
                        </div>
                        <div class="signature-section">
                            <div class="form-row">
                                <label>Signature:</label>
                                <img src="/dad signaiture.jpg" alt="Signature">
                            </div>
                            <div class="form-row">
                                <label>Date:</label>
                                <input type="date" class="medium-input">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</body>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, query, where, onSnapshot, setDoc }
        from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
    const firebaseConfig = {
        apiKey: "AIzaSyB20OmcQemfIXm4712im9mqiBnpeVt8sJQ",
        authDomain: "chicken-project-2.firebaseapp.com",
        projectId: "chicken-project-2",
        storageBucket: "chicken-project-2.firebasestorage.app",
        messagingSenderId: "596273529964",
        appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
        measurementId: "G-9YLPHR08DB"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    window.getDoc = getDoc;
    window.query = query;
    window.where = where;
    window.onSnapshot = onSnapshot;
    window.setDoc = setDoc;
    function setupFlockLogListener() {
        console.log(" Setting up Flock Log Firebase listener...");

        const quotaPeriodDisplay = document.getElementById('quotaPeriodDisplay');
        const placementDateDisplay = document.getElementById('placementDateDisplay');

        if (quotaPeriodDisplay) {
            quotaPeriodDisplay.textContent = 'Loading from database...';
        }
        if (placementDateDisplay) {
            placementDateDisplay.textContent = 'Loading...';
        }
        const docRef = doc(db, 'startnewcrop', 'vas-b1-snc');

        onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                console.log(" Flock data received:", data);
                console.log(" Available fields:", Object.keys(data));
                console.log(" quota_period value:", data.quota_period);
                console.log(" date_started value:", data.date_started);

                if (quotaPeriodDisplay) {
                    if (data.quota_period) {
                        quotaPeriodDisplay.textContent = data.quota_period;
                        console.log(" Quota period updated to:", data.quota_period);
                    } else {
                        quotaPeriodDisplay.textContent = 'No quota period found';
                        console.log(" No quota_period field found");
                    }
                }
                if (placementDateDisplay) {
                    if (data.date_started) {
                        let dateValue;
                        if (data.date_started.toDate) {
                            dateValue = data.date_started.toDate().toLocaleDateString();
                        } else if (data.date_started.seconds) {
                            dateValue = new Date(data.date_started.seconds * 1000).toLocaleDateString();
                        } else {
                            dateValue = data.date_started;
                        }
                        placementDateDisplay.textContent = dateValue;
                        console.log(" Placement date updated to:", dateValue);
                    } else {
                        placementDateDisplay.textContent = 'No date found';
                        console.log(" No date_started field found");
                    }
                }
            } else {
                console.error(" Document does not exist in startnewcrop collection!");
                if (quotaPeriodDisplay) {
                    quotaPeriodDisplay.textContent = 'No data found';
                }
            }
        }, (error) => {
            console.error(' Error fetching flock data:', error);
            if (quotaPeriodDisplay) {
                quotaPeriodDisplay.textContent = 'Error loading data';
            }
        });
    }
    async function saveFormData() {
        console.log(" Saving form data...");

        const saveButton = document.getElementById('saveFormButton');
        const saveStatus = document.getElementById('saveStatus');

        const isMobile = window.innerWidth <= 768;

        saveButton.disabled = true;
        if (!isMobile) {
            saveButton.textContent = ' Saving...';
        }
        saveStatus.textContent = 'Saving data to database...';
        saveStatus.style.color = 'blue';

        try {
            const docRef = doc(db, 'vas-b1-fl', 'vas-b1-f1');

            console.log(" Finding form elements...");

            const farmRepInput = document.querySelector('input[placeholder="Chris Rose"]');
            const placementNotesTextarea = document.querySelector('textarea[placeholder="Additional comments or notes"]');
            console.log("Farm rep input:", farmRepInput?.value);
            console.log("Placement notes:", placementNotesTextarea?.value);

            const chickTable = document.querySelector('.table-header-dark');
            console.log("Chick table found:", !!chickTable);

            const allCheckboxes = document.querySelectorAll('input[type="checkbox"]');
            console.log("Total checkboxes found:", allCheckboxes.length);

            function getChickQualityData() {
                const chickQuality = {
                    upon_receipt: { alertness: {}, vigour: {}, condition: {}, normality: {} },
                    three_four_days: { alertness: {}, vigour: {}, condition: {}, normality: {} }
                };

                const chickTable = document.querySelector('.table-header-dark');
                if (!chickTable) {
                    console.log(" Chick table not found");
                    return chickQuality;
                }
                const tableRows = chickTable.querySelectorAll('tbody tr');
                console.log(" Chick table structure:", chickTable);
                console.log(" Found tbody:", !!chickTable.querySelector('tbody'));
                console.log("Chick quality table rows found:", tableRows.length);

                tableRows.forEach((row, index) => {
                    const rowCheckboxes = row.querySelectorAll('input[type="checkbox"]');
                    console.log(`Row ${index}:`, row.textContent.trim());
                    console.log(`Row ${index} checkboxes:`, rowCheckboxes.length);

                    if (rowCheckboxes.length >= 4 && index < 4) {
                        const qualities = ['alertness', 'vigour', 'condition', 'normality'];
                        const quality = qualities[index];

                        console.log(`Processing ${quality} row...`);
                        console.log(`Checkbox states: [${rowCheckboxes[0].checked}, ${rowCheckboxes[1].checked}, ${rowCheckboxes[2].checked}, ${rowCheckboxes[3].checked}]`);

                        chickQuality.upon_receipt[quality] = {
                            acceptable: rowCheckboxes[0].checked,
                            not_acceptable: rowCheckboxes[1].checked
                        };
                        chickQuality.three_four_days[quality] = {
                            acceptable: rowCheckboxes[2].checked,
                            not_acceptable: rowCheckboxes[3].checked
                        };
                    }
                });
                console.log(" Final chick quality data:", chickQuality);

                return chickQuality;
            }

            function getBarnCleaningData() {
                console.log(" Collecting barn cleaning data...");

                const allSections = document.querySelectorAll('.section');
                let barnCleaningSection = null;

                allSections.forEach(section => {
                    const table = section.querySelector('.table-header-dark');
                    if (table && table.textContent.includes('BARN CLEANING')) {
                        barnCleaningSection = section;
                    }
                });

                if (!barnCleaningSection) {
                    console.log(" Barn cleaning section not found");
                    return {};
                }

                const barnCleaningData = {};
                const tableRows = barnCleaningSection.querySelectorAll('.table-header-dark tbody tr');

                console.log("Barn cleaning table rows found:", tableRows.length);

                const taskIds = [
                    'remove_litter_manure',
                    'dry_clean_barn',
                    'mortality_buckets_wash',
                    'pressure_wash_barn',
                    'option1_detergent_disinfectant',
                    'option2_detergent_disinfectant',
                    'equipment_cleanout',
                    'flush_water_lines',
                    'inspect_feed_bin',
                    'downtime_days'
                ];

                tableRows.forEach((row, index) => {
                    if (index < taskIds.length) {
                        const taskId = taskIds[index];
                        const inputs = row.querySelectorAll('input, textarea, select');

                        console.log(`Barn cleaning row ${index} (${taskId}):`, inputs.length, 'inputs found');

                        if (taskId === 'downtime_days') {
                            const downtimeInput = row.querySelector('input[type="number"]');
                            barnCleaningData[taskId] = {
                                days: downtimeInput?.value ? parseInt(downtimeInput.value) : null
                            };
                        } else if (taskId === 'option1_detergent_disinfectant' || taskId === 'option2_detergent_disinfectant') {
                            const dateInput = inputs[0];
                            const productInput = row.querySelector('td:nth-child(3) input[type="text"]');
                            const checkboxes = row.querySelectorAll('input[type="checkbox"]');

                            barnCleaningData[taskId] = {
                                date_completed: dateInput?.value || "",
                                product_description: productInput?.value || "",
                                detergent_used: checkboxes[0]?.checked || false,
                                disinfectant_used: checkboxes[1]?.checked || false
                            };
                        } else if (taskId === 'flush_water_lines') {
                            const dateInput = inputs[0];
                            const productInput = inputs[inputs.length - 1];
                            const flushCheckbox = row.querySelector('input[type="checkbox"]');

                            barnCleaningData[taskId] = {
                                date_completed: dateInput?.value || "",
                                product_description: productInput?.value || "",
                                flush_performed: flushCheckbox?.checked || false
                            };
                        } else {
                            const dateInput = inputs[0];
                            const descriptionInput = inputs[1];

                            barnCleaningData[taskId] = {
                                date_completed: dateInput?.value || "",
                                product_description: descriptionInput?.value || ""
                            };
                        }

                        console.log(`${taskId}:`, barnCleaningData[taskId]);
                    }
                });

                console.log(" Final barn cleaning data:", barnCleaningData);
                return barnCleaningData;
            }
            function getFacilitiesPreparationData() {
                console.log(" Collecting facilities preparation data...");

                const allSections = document.querySelectorAll('.section');
                let facilitiesSection = null;

                allSections.forEach(section => {
                    const table = section.querySelector('.table-header-dark');
                    if (table && table.textContent.includes('Facilities Preparation')) {
                        facilitiesSection = section;
                    }
                });

                if (!facilitiesSection) {
                    console.log(" Facilities preparation section not found");
                    return {};
                }

                const facilitiesData = {};
                const tableRows = facilitiesSection.querySelectorAll('.table-header-dark tbody tr');

                console.log("Facilities preparation table rows found:", tableRows.length);

                const taskIds = [
                    'water_system_checked',
                    'heating_system_checked',
                    'standby_generator_checked',
                    'monitoring_system_checked',
                    'ventilation_system_checked',
                    'light_system_checked',
                    'drinkers_feeders_checked',
                    'bedding_material_checked'
                ];

                tableRows.forEach((row, index) => {
                    if (index < taskIds.length) {
                        const taskId = taskIds[index];
                        const inputs = row.querySelectorAll('input, textarea');

                        console.log(`Facilities prep row ${index} (${taskId}):`, inputs.length, 'inputs found');

                        const dateInput = inputs[0];
                        const descriptionInput = inputs[1];

                        facilitiesData[taskId] = {
                            date_completed: dateInput?.value || "",
                            description_results: descriptionInput?.value || ""
                        };

                        console.log(`${taskId}:`, facilitiesData[taskId]);
                    }
                });

                console.log(" Final facilities preparation data:", facilitiesData);
                return facilitiesData;
            }
            function getPestControlData() {
                console.log(" Collecting pest control data...");

                const allSections = document.querySelectorAll('.section');
                let pestControlSection = null;

                allSections.forEach(section => {
                    const table = section.querySelector('.table-header-dark');
                    if (table && table.textContent.includes('Pest Control - Describe the pest control methods used')) {
                        pestControlSection = section;
                    }
                });

                if (!pestControlSection) {
                    console.log(" Pest control section not found");
                    return {};
                }

                const pestControlData = {};
                const tableRows = pestControlSection.querySelectorAll('.table-header-dark tbody tr');

                console.log("Pest control table rows found:", tableRows.length);

                const taskIds = [
                    'describe_barn_repairs',
                    'vegetation_cut_around_buildings',
                    'caz_kept_maintained',
                    'rodent_controls_used',
                    'wild_bird_controls_used',
                    'fly_controls_used',
                    'insecticides_used',
                    'other_pests_controls',
                    'no_pets_in_ra'
                ];

                tableRows.forEach((row, index) => {
                    if (index < taskIds.length) {
                        const taskId = taskIds[index];
                        const inputs = row.querySelectorAll('input, textarea');

                        console.log(`Pest control row ${index} (${taskId}):`, inputs.length, 'inputs found');

                        if (taskId === 'no_pets_in_ra') {
                            const dateInput = inputs[0];
                            const signatureInput = inputs[1];

                            pestControlData[taskId] = {
                                date_completed: dateInput?.value || "",
                                signature: signatureInput?.value || ""
                            };
                        } else {
                            const dateInput = inputs[0];
                            const descriptionInput = inputs[1];

                            pestControlData[taskId] = {
                                date_completed: dateInput?.value || "",
                                description_product: descriptionInput?.value || ""
                            };
                        }

                        console.log(`${taskId}:`, pestControlData[taskId]);
                    }
                });

                console.log(" Final pest control data:", pestControlData);
                return pestControlData;
            }
            function getMedicationsData() {
                console.log(" Collecting medications data...");

                const allSections = document.querySelectorAll('.section');
                let medicationsSection = null;

                allSections.forEach(section => {
                    const header = section.querySelector('.section-header');
                    if (header && header.textContent.includes('Medications - Complete the following table')) {
                        medicationsSection = section;
                    }
                });

                if (!medicationsSection) {
                    console.log(" Medications section not found");
                    return {};
                }

                const medicationsData = {
                    medications: []
                };

                const tableRows = medicationsSection.querySelectorAll('table tbody tr');
                console.log("Medications table rows found:", tableRows.length);

                tableRows.forEach((row, index) => {
                    if (!row || !document.contains(row)) {
                        console.log(`Skipping deleted medication row ${index}`);
                        return;
                    }

                    const inputs = row.querySelectorAll('input, select');
                    const checkboxes = row.querySelectorAll('input[type="checkbox"]');

                    console.log(`Medications row ${index}:`, inputs.length, 'inputs found,', checkboxes.length, 'checkboxes found');

                    if (inputs.length >= 5) {
                        const medicationNameInput = row.querySelector('input[type="text"]');

                        const feedCheckbox = row.querySelector('input[id*="feed"]') || checkboxes[0];
                        const waterCheckbox = row.querySelector('input[id*="water"]') || checkboxes[1];

                        const dateInputs = row.querySelectorAll('input[type="date"]');
                        const testDate = dateInputs[0];
                        const resultDate = dateInputs[1];

                        const textInputs = row.querySelectorAll('input[type="text"]');
                        const correctiveActions = textInputs.length > 1 ? textInputs[textInputs.length - 2] : null;
                        const controlMeasures = textInputs[textInputs.length - 1];

                        const medicationName = medicationNameInput?.value || "";
                        const feedRoute = feedCheckbox?.checked || false;
                        const waterRoute = waterCheckbox?.checked || false;
                        const testDateValue = testDate?.value || "";
                        const resultDateValue = resultDate?.value || "";
                        const correctiveActionsValue = correctiveActions?.value || "";
                        const controlMeasuresValue = controlMeasures?.value || "";

                        console.log(`Medication ${index} data:`, {
                            medicationName,
                            feedRoute,
                            waterRoute,
                            testDateValue,
                            resultDateValue,
                            correctiveActionsValue,
                            controlMeasuresValue
                        });
                        medicationsData.medications.push({
                            name: medicationName,
                            route_of_administration: {
                                feed: feedRoute,
                                water: waterRoute
                            },
                            water_medicator_tested: {
                                date: testDateValue,
                                results: resultDateValue
                            },
                            corrective_actions: correctiveActionsValue,
                            control_measures: controlMeasuresValue
                        });
                    }
                });

                console.log(" Final medications data:", medicationsData);
                return medicationsData;
            }
            function getDeviationChartData() {
                console.log(" Collecting deviation chart data...");

                const allSections = document.querySelectorAll('.section');
                let deviationSection = null;

                allSections.forEach(section => {
                    const header = section.querySelector('.section-header');
                    if (header && header.textContent.includes('Deviation Chart')) {
                        deviationSection = section;
                    }
                });

                if (!deviationSection) {
                    console.log(" Deviation chart section not found");
                    return {};
                }

                const deviationData = {
                    deviation_types_checkboxes: {},
                    deviations: []
                };

                const checkboxes = deviationSection.querySelectorAll('input[type="checkbox"]');
                const checkboxIds = ['temp', 'lighting', 'humidity', 'mortality', 'bedding', 'medication', 'alarms'];

                console.log("Deviation checkboxes found:", checkboxes.length);

                checkboxes.forEach((checkbox, index) => {
                    if (index < checkboxIds.length) {
                        const checkboxId = checkboxIds[index];
                        deviationData.deviation_types_checkboxes[checkboxId] = checkbox.checked;
                        console.log(`Deviation type ${checkboxId}:`, checkbox.checked);
                    }
                });

                const tableRows = deviationSection.querySelectorAll('table tbody tr');
                console.log("Deviation table rows found:", tableRows.length);

                tableRows.forEach((row, index) => {
                    if (!row || !document.contains(row)) {
                        console.log(`Skipping deleted deviation row ${index}`);
                        return;
                    }
                    const inputs = row.querySelectorAll('input, textarea');

                    console.log(`Deviation row ${index}:`, inputs.length, 'inputs found');

                    if (inputs.length >= 4) {
                        const dateInput = inputs[0];
                        const descriptionTextarea = inputs[1];
                        const reasonTextarea = inputs[2];
                        const actionsTextarea = inputs[3];

                        const date = dateInput?.value || "";
                        const description = descriptionTextarea?.value || "";
                        const reason = reasonTextarea?.value || "";
                        const actions = actionsTextarea?.value || "";

                        console.log(`Deviation ${index} data:`, {
                            date,
                            description,
                            reason,
                            actions
                        });

                        deviationData.deviations.push({
                            date: date,
                            description_of_deviation: description,
                            reason_for_deviation: reason,
                            actions_taken_to_correct: actions
                        });
                    }
                });

                console.log(" Final deviation chart data:", deviationData);
                return deviationData;
            }
            console.log(" Collecting feed data...");
            const initialInput = document.getElementById('feedSignature');

            const allSections = document.querySelectorAll('.section');
            let feedSection = null;
            allSections.forEach(section => {
                const header = section.querySelector('.section-header');
                if (header && header.textContent.trim() === 'Feed') {
                    feedSection = section;
                }
            });
            if (!feedSection) {
                console.log(" Feed section not found, trying alternative approach...");
                feedSection = Array.from(allSections).find(section =>
                    section.textContent.includes('Record the dates of feed samples')
                );
            }
            console.log(" Feed section found:", !!feedSection);
            const feedEntries = [];
            if (feedSection) {
                const feedTableRows = feedSection.querySelectorAll('.table-header-dark tbody tr');
                console.log("Feed table rows found:", feedTableRows.length);

                feedTableRows.forEach((row, index) => {
                    if (!row.parentNode || row.classList.contains('note-row')) {
                        return;
                    }

                    const inputs = row.querySelectorAll('input, textarea');
                    console.log(`Feed row ${index} inputs found:`, inputs.length);

                    if (inputs.length >= 3) {
                        const controlMeasuresDate = inputs[0]?.value || "";
                        const addedIngredients = inputs[1]?.value || "";
                        const feedSampleDate = inputs[2]?.value || "";

                        const noteRow = row.nextElementSibling;
                        let entryNote = "";
                        if (noteRow && noteRow.classList.contains('note-row')) {
                            const noteTextarea = noteRow.querySelector('.entry-note-input');
                            entryNote = noteTextarea?.value || "";
                        }

                        feedEntries.push({
                            control_measures_date: controlMeasuresDate ? new Date(controlMeasuresDate) : null,
                            added_ingredients: addedIngredients,
                            feed_sample_date: feedSampleDate ? new Date(feedSampleDate) : null,
                            entry_note: entryNote
                        });
                    }
                });
            }
            const feedData = {
                visual_inspection_initial: initialInput?.value || "",
                feed_entries: feedEntries
            };
            console.log(" Final feed data to save:", feedData);
            console.log(" Collecting feed transfer data...");
            let feedTransferSection = null;
            allSections.forEach(section => {
                const header = section.querySelector('.section-header');
                if (header && header.textContent.trim() === 'Feed Transfer Record') {
                    feedTransferSection = section;
                }
            });
            if (!feedTransferSection) {
                console.log(" Feed Transfer Record section not found, trying alternative approach...");
                feedTransferSection = Array.from(allSections).find(section =>
                    section.textContent.includes('Date feed moved')
                );
            }
            console.log(" Feed Transfer Record section found:", !!feedTransferSection);
            const feedTransfers = [];
            if (feedTransferSection) {
                const transferTableRows = feedTransferSection.querySelectorAll('.table-header-dark tbody tr');
                console.log("Feed transfer table rows found:", transferTableRows.length);

                transferTableRows.forEach((row, index) => {
                    if (!row || !document.contains(row) || row.classList.contains('note-row')) {
                        console.log(`Skipping deleted or note row ${index}`);
                        return;
                    }

                    const inputs = row.querySelectorAll('input, select, textarea');
                    console.log(`Transfer row ${index} inputs found:`, inputs.length);

                    if (inputs.length >= 7) {
                        const dateMoved = inputs[0]?.value || "";
                        const originalFarmBin = inputs[1]?.value || "";
                        const destinationFarmBin = inputs[2]?.value || "";
                        const medications = inputs[3]?.value || "";
                        const transportMethod = inputs[4]?.value || "";
                        const sampleTaken = inputs[5]?.value || "";
                        const preventionMeasures = inputs[6]?.value || "";

                        const noteRow = row.nextElementSibling;
                        let entryNote = "";
                        if (noteRow && noteRow.classList.contains('note-row')) {
                            const noteTextarea = noteRow.querySelector('.entry-note-input');
                            entryNote = noteTextarea?.value || "";
                        }

                        console.log(`Feed transfer row ${index} data:`, {
                            dateMoved,
                            originalFarmBin,
                            destinationFarmBin,
                            medications,
                            transportMethod,
                            sampleTaken,
                            preventionMeasures,
                            entryNote
                        });

                        feedTransfers.push({
                            date_moved: dateMoved ? new Date(dateMoved) : null,
                            original_farm_bin: originalFarmBin,
                            destination_farm_bin: destinationFarmBin,
                            medications: medications,
                            transport_method: transportMethod,
                            sample_taken: sampleTaken,
                            prevention_measures: preventionMeasures,
                            entry_note: entryNote
                        });
                    }
                });
                console.log(" Final feed transfers to save:", feedTransfers);
            }
            console.log(" Collecting water products data...");
            console.log(" Final feed transfers to save:", feedTransfers);
            console.log(" Collecting water products data...");
            const waterSections = document.querySelectorAll('.section');
            let waterSection = null;
            waterSections.forEach(section => {
                const header = section.querySelector('.section-header');
                if (header && header.textContent.includes('Water - Record all products')) {
                    waterSection = section;
                }
            });
            if (!waterSection) {
                waterSection = document.querySelector('.section');
            }
            const waterTableRows = waterSection?.querySelectorAll('.table-header-dark tbody tr') || [];
            console.log("Water table rows found:", waterTableRows.length);
            const waterProducts = [];
            waterTableRows.forEach((row, index) => {
                if (!row.parentNode) {
                    console.log(`Skipping deleted row ${index}`);
                    return;
                }

                const inputs = row.querySelectorAll('input');
                console.log(`Water row ${index} inputs found:`, inputs.length);

                if (inputs.length >= 4) {
                    const productName = inputs[0]?.value || "";
                    const dateUsed = inputs[1]?.value || "";
                    const verificationDate = inputs[2]?.value || "";
                    const results = inputs[3]?.value || "";

                    console.log(`Water row ${index} data:`, {
                        productName,
                        dateUsed,
                        verificationDate,
                        results
                    });

                    waterProducts.push({
                        product_name: productName,
                        dates_used: dateUsed ? [new Date(dateUsed)] : [],
                        verification: [{
                            date: verificationDate,
                            results: results
                        }]
                    });
                }
            });
            console.log(" Final water products to save:", waterProducts);

            const dailyCheckboxes = document.querySelectorAll('#feedquality, #thermal, #templevels, #humiditylevels, #wateravail, #flockhealth, #ventilation, #ammonialevels, #waterquality, #heatingsystem, #lightingsystem, #litterquality, #birdsinspected');
            const checkedDaily = Array.from(dailyCheckboxes).filter(cb => cb.checked).map(cb => cb.id);

            const signatureInput = null;
            const signatureDateInput = document.querySelector('input[type="date"].medium-input');
            const additionalNotesDaily = document.querySelector('.signature-section').previousElementSibling?.querySelector('textarea');

            console.log("Daily checks:");
            console.log("- Checkboxes found:", dailyCheckboxes.length);
            console.log("- Checked boxes:", checkedDaily);
            console.log("- Signature:", !!signatureInput, signatureInput?.value);
            console.log("- Signature date:", !!signatureDateInput, signatureDateInput?.value);
            console.log("- Additional notes:", !!additionalNotesDaily, additionalNotesDaily?.value);


            const formData = {
                production_info: {
                    farm_representative: farmRepInput?.value || "",
                    placement_notes: placementNotesTextarea?.value || ""
                },

                chick_quality: getChickQualityData(),

                water_products: waterProducts,

                feed: feedData,

                feed_transfers: {
                    transfers: feedTransfers
                },
                barn_cleaning: getBarnCleaningData(),
                facilities_preparation: getFacilitiesPreparationData(),
                pest_control: getPestControlData(),
                medications: getMedicationsData(),
                deviation_chart: getDeviationChartData(),

                daily_checks: {
                    confirmed_checks: checkedDaily,
                    additional_notes: additionalNotesDaily?.value || "",
                    signature: signatureInput?.value || "",
                    signature_date: signatureDateInput?.value ? new Date(signatureDateInput.value) : null
                },

                metadata: {
                    updated_at: new Date(),
                    last_saved_by: "user"
                }
            };

            console.log(" Final form data to save:", formData);

            await setDoc(docRef, formData, { merge: true });

            saveButton.disabled = false;
            if (!isMobile) {
                saveButton.textContent = ' Save Farm Records';
            }
            saveStatus.textContent = ' Data saved successfully!';
            saveStatus.style.color = 'green';

            console.log(" Form data saved successfully!");

            setTimeout(() => {
                saveStatus.textContent = '';
            }, 3000);

        } catch (error) {
            console.error(" Error saving form data:", error);

            saveButton.disabled = false;
            if (!isMobile) {
                saveButton.textContent = ' Save Farm Records';
            }
            saveStatus.textContent = ' Error saving data. Please try again.';
            saveStatus.style.color = 'red';

            setTimeout(() => {
                saveStatus.textContent = '';
            }, 5000);
        }
    }
    async function loadFormData() {
        console.log(" Loading existing form data...");

        try {
            const docRef = doc(db, 'vas-b1-fl', 'vas-b1-f1');
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                console.log(" Loaded data:", data);

                const farmRepInput = document.querySelector('input[placeholder="Chris Rose"]');
                if (farmRepInput && data.production_info?.farm_representative) {
                    farmRepInput.value = data.production_info.farm_representative;
                    console.log(" Loaded farm representative:", data.production_info.farm_representative);
                }

                const placementNotesTextarea = document.querySelector('textarea[placeholder="Additional comments or notes"]');
                if (placementNotesTextarea && data.production_info?.placement_notes) {
                    placementNotesTextarea.value = data.production_info.placement_notes;
                }

                if (data.chick_quality) {
                    const tbody = document.querySelector('.table-header-dark tbody');
                    const rows = tbody?.querySelectorAll('tr') || [];
                    const qualities = ['alertness', 'vigour', 'condition', 'normality'];

                    rows.forEach((row, index) => {
                        if (index < 4) {
                            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
                            const quality = qualities[index];

                            if (checkboxes.length >= 4 && data.chick_quality.upon_receipt?.[quality]) {
                                if (checkboxes[0]) checkboxes[0].checked = data.chick_quality.upon_receipt[quality].acceptable;
                                if (checkboxes[1]) checkboxes[1].checked = data.chick_quality.upon_receipt[quality].not_acceptable;
                            }

                            if (checkboxes.length >= 4 && data.chick_quality.three_four_days?.[quality]) {
                                if (checkboxes[2]) checkboxes[2].checked = data.chick_quality.three_four_days[quality].acceptable;
                                if (checkboxes[3]) checkboxes[3].checked = data.chick_quality.three_four_days[quality].not_acceptable;
                            }
                        }
                    });
                }
                if (data.water_products && data.water_products.length > 0) {
                    console.log(" Loading water products data...");

                    const waterSections = document.querySelectorAll('.section');
                    let waterSection = null;

                    waterSections.forEach(section => {
                        const header = section.querySelector('.section-header');
                        if (header && header.textContent.includes('Water - Record all products')) {
                            waterSection = section;
                        }
                    });

                    if (!waterSection) {
                        waterSection = document.querySelector('.section');
                    }

                    const waterTableBody = waterSection?.querySelector('.table-header-dark tbody');

                    if (waterTableBody) {
                        const existingRows = waterTableBody.querySelectorAll('tr');
                        for (let i = 1; i < existingRows.length; i++) {
                            existingRows[i].remove();
                        }

                        data.water_products.forEach((waterProduct, index) => {
                            let targetRow;

                            if (index === 0) {
                                targetRow = waterTableBody.querySelector('tr');
                            } else {
                                targetRow = document.createElement('tr');
                                targetRow.innerHTML = `
                   <td><input type="text" class="table-input" placeholder="Product name"></td>
                   <td><input type="date" class="table-input"></td>
                   <td><input type="date" class="table-input"></td>
                   <td><input type="text" class="table-input" placeholder="Results"></td>
                   <td>
                       <button type="button" class="delete-water-row" onclick="deleteWaterRow(this)"></button>
                   </td>
               `;
                                waterTableBody.appendChild(targetRow);
                            }

                            const inputs = targetRow.querySelectorAll('input');

                            if (inputs.length >= 4) {
                                if (inputs[0] && waterProduct.product_name) {
                                    inputs[0].value = waterProduct.product_name;
                                }

                                if (inputs[1] && waterProduct.dates_used && waterProduct.dates_used.length > 0) {
                                    const date = waterProduct.dates_used[0].toDate ?
                                        waterProduct.dates_used[0].toDate() :
                                        new Date(waterProduct.dates_used[0]);
                                    inputs[1].value = date.toISOString().split('T')[0];
                                }

                                if (waterProduct.verification && waterProduct.verification.length > 0) {
                                    if (inputs[2] && waterProduct.verification[0].date) {
                                        inputs[2].value = waterProduct.verification[0].date;
                                    }
                                    if (inputs[3] && waterProduct.verification[0].results) {
                                        inputs[3].value = waterProduct.verification[0].results;
                                    }
                                }
                            }
                        });
                    }

                    console.log(" Water products data loaded successfully!");
                }

                if (data.feed) {
                    console.log(" Loading feed data...");

                    const visualInspectionInput = document.getElementById('feedSignature');
                    if (visualInspectionInput && data.feed.visual_inspection_initial) {
                        visualInspectionInput.value = data.feed.visual_inspection_initial;
                    }

                    if (data.feed.feed_entries && data.feed.feed_entries.length > 0) {
                        console.log(" Loading feed entries...");

                        const allSections = document.querySelectorAll('.section');
                        let feedSection = null;

                        allSections.forEach(section => {
                            const header = section.querySelector('.section-header');
                            if (header && header.textContent.trim() === 'Feed') {
                                feedSection = section;
                            }
                        });

                        if (!feedSection) {
                            feedSection = Array.from(allSections).find(section =>
                                section.textContent.includes('Record the dates of feed samples')
                            );
                        }

                        if (feedSection) {
                            const feedTableBody = feedSection.querySelector('.table-header-dark tbody');

                            if (feedTableBody) {
                                const existingRows = feedTableBody.querySelectorAll('tr');
                                for (let i = 2; i < existingRows.length; i++) {
                                    existingRows[i].remove();
                                }

                                data.feed.feed_entries.forEach((feedEntry, index) => {
                                    let targetRow;

                                    const isDarkEntry = index % 2 === 0;

                                    if (index === 0) {
                                        targetRow = feedTableBody.querySelector('tr:not(.note-row)');
                                        if (targetRow) {
                                            if (isDarkEntry) {
                                                targetRow.style.backgroundColor = '#f5f5f5';
                                                targetRow.style.borderTop = '2px solid #333';
                                            } else {
                                                targetRow.style.backgroundColor = '#ffffff';
                                                targetRow.style.borderTop = '1px solid #ccc';
                                            }
                                        }
                                    } else {
                                        targetRow = document.createElement('tr');
                                        if (isDarkEntry) {
                                            targetRow.style.backgroundColor = '#f5f5f5';
                                            targetRow.style.borderTop = '2px solid #333';
                                        } else {
                                            targetRow.style.backgroundColor = '#ffffff';
                                            targetRow.style.borderTop = '1px solid #ccc';
                                        }
                                        targetRow.innerHTML = `
           <td><input type="date" class="table-input"></td>
           <td><textarea class="table-input" placeholder="Enter ingredients"></textarea></td>
           <td><input type="date" class="table-input"></td>
           <td>
               <button type="button" class="delete-feed-row" onclick="deleteFeedRow(this)"></button>
           </td>
       `;

                                        const noteRow = document.createElement('tr');
                                        noteRow.className = 'note-row';
                                        if (isDarkEntry) {
                                            noteRow.style.backgroundColor = '#f9f9f9';
                                            noteRow.style.borderBottom = '2px solid #333';
                                        } else {
                                            noteRow.style.backgroundColor = '#fafafa';
                                            noteRow.style.borderBottom = '1px solid #ccc';
                                        }
                                        noteRow.innerHTML = `
   <td colspan="4">
       <div>
           <label>Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;

                                        feedTableBody.appendChild(targetRow);
                                        feedTableBody.appendChild(noteRow);
                                    }

                                    if (index === 0) {
                                        const existingNoteRow = targetRow.nextElementSibling;
                                        if (existingNoteRow && existingNoteRow.classList.contains('note-row')) {
                                            if (isDarkEntry) {
                                                existingNoteRow.style.backgroundColor = '#f9f9f9';
                                                existingNoteRow.style.borderBottom = '2px solid #333';
                                            } else {
                                                existingNoteRow.style.backgroundColor = '#fafafa';
                                                existingNoteRow.style.borderBottom = '1px solid #ccc';
                                            }
                                        }
                                    }

                                    const inputs = targetRow.querySelectorAll('input, textarea');

                                    if (inputs.length >= 3) {
                                        if (inputs[0] && feedEntry.control_measures_date) {
                                            const date = feedEntry.control_measures_date.toDate ?
                                                feedEntry.control_measures_date.toDate() :
                                                new Date(feedEntry.control_measures_date);
                                            inputs[0].value = date.toISOString().split('T')[0];
                                        }

                                        if (inputs[1] && feedEntry.added_ingredients) {
                                            inputs[1].value = feedEntry.added_ingredients;
                                        }

                                        if (inputs[2] && feedEntry.feed_sample_date) {
                                            const date = feedEntry.feed_sample_date.toDate ?
                                                feedEntry.feed_sample_date.toDate() :
                                                new Date(feedEntry.feed_sample_date);
                                            inputs[2].value = date.toISOString().split('T')[0];
                                        }
                                    }

                                    const noteRow = targetRow.nextElementSibling;
                                    if (noteRow && noteRow.classList.contains('note-row') && feedEntry.entry_note) {
                                        const noteTextarea = noteRow.querySelector('.entry-note-input');
                                        if (noteTextarea) {
                                            noteTextarea.value = feedEntry.entry_note;
                                        }
                                    }
                                });
                            }
                        }

                        console.log(" Feed entries loaded successfully!");
                        if (data.feed?.notes) {
                            const feedNotesTextarea = document.getElementById('feedNotes');
                            if (feedNotesTextarea) {
                                feedNotesTextarea.value = data.feed.notes;
                                console.log(" Feed notes loaded successfully!");
                            }
                        }
                    }
                }
                const feedTransfersArray = Array.isArray(data.feed_transfers) ? data.feed_transfers : data.feed_transfers?.transfers || [];
                if (feedTransfersArray.length > 0) {
                    console.log(" Loading feed transfer records...");

                    const allSections = document.querySelectorAll('.section');
                    let feedTransferSection = null;

                    allSections.forEach(section => {
                        const header = section.querySelector('.section-header');
                        if (header && header.textContent.trim() === 'Feed Transfer Record') {
                            feedTransferSection = section;
                        }
                    });

                    if (!feedTransferSection) {
                        feedTransferSection = Array.from(allSections).find(section =>
                            section.textContent.includes('Date feed moved')
                        );
                    }

                    if (feedTransferSection) {
                        const feedTransferTableBody = feedTransferSection.querySelector('.table-header-dark tbody');

                        if (feedTransferTableBody) {
                            const existingRows = feedTransferTableBody.querySelectorAll('tr');
                            for (let i = 2; i < existingRows.length; i++) {
                                existingRows[i].remove();
                            }

                            feedTransfersArray.forEach((transfer, index) => {
                                let targetRow;

                                const isDarkEntry = index % 2 === 0;

                                if (index === 0) {
                                    targetRow = feedTransferTableBody.querySelector('tr:not(.note-row)');
                                    if (targetRow) {
                                        if (isDarkEntry) {
                                            targetRow.style.backgroundColor = '#f5f5f5';
                                            targetRow.style.borderTop = '2px solid #333';
                                        }
                                    }
                                } else {
                                    targetRow = document.createElement('tr');
                                    if (isDarkEntry) {
                                        targetRow.style.backgroundColor = '#f5f5f5';
                                        targetRow.style.borderTop = '2px solid #333';
                                    }
                                    targetRow.innerHTML = `
           <td><input type="date" class="table-input"></td>
           <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
           <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
           <td><textarea class="table-input" placeholder="Medications"></textarea></td>
           <td><input type="text" class="table-input" placeholder="Truck"></td>
           <td>
               <select class="table-input">
                   <option value="Yes" selected>Yes</option>
                   <option value="No">No</option>
               </select>
           </td>
           <td><input type="text" class="table-input" placeholder="Yes"></td>
           <td>
               <button type="button" class="delete-feed-transfer-row" onclick="deleteFeedTransferRow(this)"></button>
           </td>
       `;

                                    const noteRow = document.createElement('tr');
                                    noteRow.className = 'note-row';
                                    if (isDarkEntry) {
                                        noteRow.style.backgroundColor = '#f9f9f9';
                                        noteRow.style.borderBottom = '2px solid #333';
                                    } else {
                                        noteRow.style.backgroundColor = '#fafafa';
                                        noteRow.style.borderBottom = '1px solid #ccc';
                                    }
                                    noteRow.innerHTML = `
   <td colspan="8">
       <div>
           <label>Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;
                                    feedTransferTableBody.appendChild(targetRow);
                                    feedTransferTableBody.appendChild(noteRow);
                                }

                                if (index === 0) {
                                    const existingNoteRow = targetRow.nextElementSibling;
                                    if (existingNoteRow && existingNoteRow.classList.contains('note-row')) {
                                        if (isDarkEntry) {
                                            existingNoteRow.style.backgroundColor = '#f9f9f9';
                                            existingNoteRow.style.borderBottom = '2px solid #333';
                                        } else {
                                            existingNoteRow.style.backgroundColor = '#fafafa';
                                            existingNoteRow.style.borderBottom = '1px solid #ccc';
                                        }
                                    }
                                }

                                const inputs = targetRow.querySelectorAll('input, select, textarea');

                                if (inputs.length >= 7) {
                                    if (inputs[0] && transfer.date_moved) {
                                        const date = transfer.date_moved.toDate ?
                                            transfer.date_moved.toDate() :
                                            new Date(transfer.date_moved);
                                        inputs[0].value = date.toISOString().split('T')[0];
                                    }

                                    if (inputs[1] && transfer.original_farm_bin) {
                                        inputs[1].value = transfer.original_farm_bin;
                                    }
                                    if (inputs[2] && transfer.destination_farm_bin) {
                                        inputs[2].value = transfer.destination_farm_bin;
                                    }
                                    if (inputs[3] && transfer.medications) {
                                        inputs[3].value = transfer.medications;
                                    }
                                    if (inputs[4] && transfer.transport_method) {
                                        inputs[4].value = transfer.transport_method;
                                    }
                                    if (inputs[5] && transfer.sample_taken) {
                                        inputs[5].value = transfer.sample_taken;
                                    }
                                    if (inputs[6] && transfer.prevention_measures) {
                                        inputs[6].value = transfer.prevention_measures;
                                    }
                                }
                                const noteRow = targetRow.nextElementSibling;
                                if (noteRow && noteRow.classList.contains('note-row') && transfer.entry_note) {
                                    const noteTextarea = noteRow.querySelector('.entry-note-input');
                                    if (noteTextarea) {
                                        noteTextarea.value = transfer.entry_note;
                                    }
                                }
                            });
                        }

                        console.log(" Feed transfer records loaded successfully!");
                        if (data.feed_transfers?.notes) {
                            const feedTransferNotesTextarea = document.getElementById('feedTransferNotes');
                            if (feedTransferNotesTextarea) {
                                feedTransferNotesTextarea.value = data.feed_transfers.notes;
                                console.log(" Feed transfer notes loaded successfully!");
                            }
                        }
                    }
                }
                if (data.daily_checks?.confirmed_checks) {
                    const dailyCheckIds = ['feedquality', 'thermal', 'templevels', 'humiditylevels', 'wateravail', 'flockhealth', 'ventilation', 'ammonialevels', 'waterquality', 'heatingsystem', 'lightingsystem', 'litterquality', 'birdsinspected'];
                    dailyCheckIds.forEach(id => {
                        const checkbox = document.getElementById(id);
                        if (checkbox) {
                            checkbox.checked = false;
                            checkbox.setAttribute('data-loaded', 'true');
                        }
                    });

                    data.daily_checks.confirmed_checks.forEach(checkId => {
                        const checkbox = document.getElementById(checkId);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }

                if (data.daily_checks?.signature_date) {
                    const signatureDateInput = document.querySelector('input[type="date"].medium-input');
                    if (signatureDateInput) {
                        const date = data.daily_checks.signature_date.toDate ?
                            data.daily_checks.signature_date.toDate() :
                            new Date(data.daily_checks.signature_date);
                        signatureDateInput.value = date.toISOString().split('T')[0];
                        console.log(" Loaded signature date:", date.toISOString().split('T')[0]);
                    }
                }
                if (data.daily_checks?.additional_notes) {
                    const additionalNotesTextarea = document.querySelector('div.signature-section').previousElementSibling?.querySelector('textarea');
                    if (additionalNotesTextarea) {
                        additionalNotesTextarea.value = data.daily_checks.additional_notes;
                    }
                }
                await loadBarnCleaningData(data);
                await loadFacilitiesPreparationData(data);
                await loadPestControlData(data);
                await loadMedicationsData(data);
                await loadDeviationChartData(data);
                console.log(" Form data loaded successfully!");
            } else {
                console.log(" No existing data found");
            }
        } catch (error) {
            console.error(" Error loading form data:", error);
        }
    }
    function applyAlternatingRowStyling(tableBody, sectionType) {
        const dataRows = tableBody.querySelectorAll('tr:not(.note-row)');

        dataRows.forEach((row, index) => {
            const isDarkEntry = index % 2 === 0;
            const noteRow = row.nextElementSibling;

            row.style.backgroundColor = '';
            row.style.borderTop = '';
            if (noteRow && noteRow.classList.contains('note-row')) {
                noteRow.style.backgroundColor = '';
                noteRow.style.borderBottom = '';
            }

            if (isDarkEntry) {
                row.style.backgroundColor = '#f5f5f5';
                row.style.borderTop = '2px solid #333';

                if (noteRow && noteRow.classList.contains('note-row')) {
                    noteRow.style.backgroundColor = '#f9f9f9';
                    noteRow.style.borderBottom = '2px solid #333';
                }
            }
        });
    }
    async function loadBarnCleaningData(data) {
        if (!data.barn_cleaning) {
            console.log(" No barn cleaning data to load");
            return;
        }

        console.log(" Loading barn cleaning data...");

        const allSections = document.querySelectorAll('.section');
        let barnCleaningSection = null;

        allSections.forEach(section => {
            const table = section.querySelector('.table-header-dark');
            if (table && table.textContent.includes('BARN CLEANING')) {
                barnCleaningSection = section;
            }
        });

        if (!barnCleaningSection) {
            console.log(" Barn cleaning section not found for loading");
            return;
        }

        const tableRows = barnCleaningSection.querySelectorAll('.table-header-dark tbody tr');
        const taskIds = [
            'remove_litter_manure',
            'dry_clean_barn',
            'mortality_buckets_wash',
            'pressure_wash_barn',
            'option1_detergent_disinfectant',
            'option2_detergent_disinfectant',
            'equipment_cleanout',
            'flush_water_lines',
            'inspect_feed_bin',
            'downtime_days'
        ];

        tableRows.forEach((row, index) => {
            if (index < taskIds.length) {
                const taskId = taskIds[index];
                const taskData = data.barn_cleaning[taskId];

                if (!taskData) return;

                const inputs = row.querySelectorAll('input, textarea, select');

                if (taskId === 'downtime_days') {
                    const downtimeInput = row.querySelector('input[type="number"]');
                    if (downtimeInput && taskData.days !== null) {
                        downtimeInput.value = taskData.days;
                    }
                } else if (taskId === 'option1_detergent_disinfectant' || taskId === 'option2_detergent_disinfectant') {
                    const dateInput = inputs[0];
                    const productInput = row.querySelector('td:nth-child(3) input[type="text"]');
                    const checkboxes = row.querySelectorAll('input[type="checkbox"]');

                    if (dateInput && taskData.date_completed) {
                        dateInput.value = taskData.date_completed;
                    }
                    if (productInput && taskData.product_description) {
                        productInput.value = taskData.product_description;
                    }
                    if (checkboxes[0]) {
                        checkboxes[0].checked = taskData.detergent_used;
                    }
                    if (checkboxes[1]) {
                        checkboxes[1].checked = taskData.disinfectant_used;
                    }
                } else if (taskId === 'flush_water_lines') {
                    const dateInput = inputs[0];
                    const productInput = row.querySelector('td:last-child input[type="text"]') || inputs[inputs.length - 1];
                    const flushCheckbox = row.querySelector('input[type="checkbox"]');

                    if (dateInput && taskData.date_completed) {
                        dateInput.value = taskData.date_completed;
                    }
                    if (productInput && taskData.product_description) {
                        productInput.value = taskData.product_description;
                        productInput.setAttribute('data-loaded', 'true');
                    }
                    if (flushCheckbox) {
                        flushCheckbox.checked = taskData.flush_performed;
                    }
                } else {
                    const dateInput = inputs[0];
                    const descriptionInput = inputs[1];

                    if (dateInput && taskData.date_completed) {
                        dateInput.value = taskData.date_completed;
                    }
                    if (descriptionInput && taskData.product_description) {
                        descriptionInput.value = taskData.product_description;
                    }
                }
            }
        });

        console.log(" Barn cleaning data loaded successfully!");
    }
    async function loadFacilitiesPreparationData(data) {
        if (!data.facilities_preparation) {
            console.log(" No facilities preparation data to load");
            return;
        }

        console.log(" Loading facilities preparation data...");

        const allSections = document.querySelectorAll('.section');
        let facilitiesSection = null;

        allSections.forEach(section => {
            const table = section.querySelector('.table-header-dark');
            if (table && table.textContent.includes('Facilities Preparation')) {
                facilitiesSection = section;
            }
        });

        if (!facilitiesSection) {
            console.log(" Facilities preparation section not found for loading");
            return;
        }

        const tableRows = facilitiesSection.querySelectorAll('.table-header-dark tbody tr');
        const taskIds = [
            'water_system_checked',
            'heating_system_checked',
            'standby_generator_checked',
            'monitoring_system_checked',
            'ventilation_system_checked',
            'light_system_checked',
            'drinkers_feeders_checked',
            'bedding_material_checked'
        ];

        tableRows.forEach((row, index) => {
            if (index < taskIds.length) {
                const taskId = taskIds[index];
                const taskData = data.facilities_preparation[taskId];

                if (!taskData) return;

                const inputs = row.querySelectorAll('input, textarea');

                const dateInput = inputs[0];
                const descriptionInput = inputs[1];

                if (dateInput && taskData.date_completed) {
                    dateInput.value = taskData.date_completed;
                }
                if (descriptionInput && taskData.description_results) {
                    descriptionInput.value = taskData.description_results;
                }
            }
        });

        console.log(" Facilities preparation data loaded successfully!");
    }
    async function loadPestControlData(data) {
        if (!data.pest_control) {
            console.log(" No pest control data to load");
            return;
        }

        console.log(" Loading pest control data...");

        const allSections = document.querySelectorAll('.section');
        let pestControlSection = null;

        allSections.forEach(section => {
            const table = section.querySelector('.table-header-dark');
            if (table && table.textContent.includes('Pest Control - Describe the pest control methods used')) {
                pestControlSection = section;
            }
        });

        if (!pestControlSection) {
            console.log(" Pest control section not found for loading");
            return;
        }

        const tableRows = pestControlSection.querySelectorAll('.table-header-dark tbody tr');
        const taskIds = [
            'describe_barn_repairs',
            'vegetation_cut_around_buildings',
            'caz_kept_maintained',
            'rodent_controls_used',
            'wild_bird_controls_used',
            'fly_controls_used',
            'insecticides_used',
            'other_pests_controls',
            'no_pets_in_ra'
        ];

        tableRows.forEach((row, index) => {
            if (index < taskIds.length) {
                const taskId = taskIds[index];
                const taskData = data.pest_control[taskId];

                if (!taskData) return;

                const inputs = row.querySelectorAll('input, textarea');

                if (taskId === 'no_pets_in_ra') {
                    const dateInput = inputs[0];
                    const signatureInput = inputs[1];

                    if (dateInput && taskData.date_completed) {
                        dateInput.value = taskData.date_completed;
                    }
                    if (signatureInput && taskData.signature) {
                        signatureInput.value = taskData.signature;
                    }
                } else {
                    const dateInput = inputs[0];
                    const descriptionInput = inputs[1];

                    if (dateInput && taskData.date_completed) {
                        dateInput.value = taskData.date_completed;
                    }
                    if (descriptionInput && taskData.description_product) {
                        descriptionInput.value = taskData.description_product;
                    }
                }
            }
        });

        console.log(" Pest control data loaded successfully!");
    }
    async function loadMedicationsData(data) {
        if (!data.medications || !data.medications.medications) {
            console.log(" No medications data to load");
            return;
        }

        console.log(" Loading medications data...");

        const allSections = document.querySelectorAll('.section');
        let medicationsSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.includes('Medications - Complete the following table')) {
                medicationsSection = section;
            }
        });

        if (!medicationsSection) {
            console.log(" Medications section not found for loading");
            return;
        }

        const medicationsTableBody = medicationsSection.querySelector('table tbody');

        if (medicationsTableBody) {
            const existingRows = medicationsTableBody.querySelectorAll('tr');
            for (let i = 1; i < existingRows.length; i++) {
                existingRows[i].remove();
            }

            data.medications.medications.forEach((medication, index) => {
                let targetRow;

                if (index === 0) {
                    targetRow = medicationsTableBody.querySelector('tr');
                } else {
                    const rowIndex = index + 1;
                    targetRow = document.createElement('tr');
                    targetRow.innerHTML = `
                   <td><input type="text" class="table-input" placeholder="Medication name"></td>
                   <td>
                       <div class="checkbox-container">
                           <input type="checkbox" id="feed${rowIndex}">
                           <label for="feed${rowIndex}">feed</label>
                       </div>
                       <div class="checkbox-container">
                           <input type="checkbox" id="water${rowIndex}">
                           <label for="water${rowIndex}">water</label>
                       </div>
                   </td>
                   <td><input type="date" class="table-input"></td>
                   <td><input type="date" class="table-input"></td>
                   <td><input type="text" class="table-input" placeholder="Actions"></td>
                   <td><input type="text" class="table-input" placeholder="Control measures"></td>
                   <td>
                       <button type="button" class="delete-medication-row" onclick="deleteMedicationRow(this)"></button>
                   </td>
               `;
                    medicationsTableBody.appendChild(targetRow);
                }

                const inputs = targetRow.querySelectorAll('input, select');
                const checkboxes = targetRow.querySelectorAll('input[type="checkbox"]');

                const medicationNameInput = targetRow.querySelector('input[type="text"]');
                if (medicationNameInput && medication.name) {
                    medicationNameInput.value = medication.name;
                }

                const feedCheckbox = targetRow.querySelector('input[id*="feed"]') || checkboxes[0];
                const waterCheckbox = targetRow.querySelector('input[id*="water"]') || checkboxes[1];

                if (feedCheckbox && medication.route_of_administration) {
                    feedCheckbox.checked = medication.route_of_administration.feed;
                }
                if (waterCheckbox && medication.route_of_administration) {
                    waterCheckbox.checked = medication.route_of_administration.water;
                }

                const dateInputs = targetRow.querySelectorAll('input[type="date"]');
                if (dateInputs[0] && medication.water_medicator_tested?.date) {
                    dateInputs[0].value = medication.water_medicator_tested.date;
                }
                if (dateInputs[1] && medication.water_medicator_tested?.results) {
                    dateInputs[1].value = medication.water_medicator_tested.results;
                }

                const textInputs = targetRow.querySelectorAll('input[type="text"]');
                if (textInputs.length > 1 && medication.corrective_actions) {
                    const correctiveActions = textInputs[textInputs.length - 2];
                    if (correctiveActions) {
                        correctiveActions.value = medication.corrective_actions;
                    }
                }

                if (textInputs.length > 0 && medication.control_measures) {
                    const controlMeasures = textInputs[textInputs.length - 1];
                    if (controlMeasures) {
                        controlMeasures.value = medication.control_measures;
                    }
                }
            });
        }

        console.log(" Medications data loaded successfully!");
    }
    async function loadDeviationChartData(data) {
        if (!data.deviation_chart) {
            console.log(" No deviation chart data to load");
            return;
        }

        console.log(" Loading deviation chart data...");

        const allSections = document.querySelectorAll('.section');
        let deviationSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.includes('Deviation Chart')) {
                deviationSection = section;
            }
        });

        if (!deviationSection) {
            console.log(" Deviation chart section not found for loading");
            return;
        }

        if (data.deviation_chart.deviation_types_checkboxes) {
            const checkboxes = deviationSection.querySelectorAll('input[type="checkbox"]');
            const checkboxIds = ['temp', 'lighting', 'humidity', 'mortality', 'bedding', 'medication', 'alarms'];

            checkboxes.forEach((checkbox, index) => {
                if (index < checkboxIds.length) {
                    const checkboxId = checkboxIds[index];
                    if (data.deviation_chart.deviation_types_checkboxes[checkboxId] !== undefined) {
                        checkbox.checked = data.deviation_chart.deviation_types_checkboxes[checkboxId];
                    }
                }
            });

            console.log(" Deviation type checkboxes loaded!");
        }

        if (data.deviation_chart.deviations && data.deviation_chart.deviations.length > 0) {
            const deviationTableBody = deviationSection.querySelector('table tbody');

            if (deviationTableBody) {
                const existingRows = deviationTableBody.querySelectorAll('tr');
                for (let i = 1; i < existingRows.length; i++) {
                    existingRows[i].remove();
                }

                data.deviation_chart.deviations.forEach((deviation, index) => {
                    let targetRow;
                    if (index === 0) {
                        targetRow = deviationTableBody.querySelector('tr');
                    } else {
                        targetRow = document.createElement('tr');
                        targetRow.innerHTML = `
                       <td><input type="date" class="table-input"></td>
                       <td><textarea class="table-input" placeholder="Describe deviation"></textarea></td>
                       <td><textarea class="table-input" placeholder="Reason for deviation"></textarea></td>
                       <td><textarea class="table-input" placeholder="Corrective actions"></textarea></td>
                       <td>
                           <button type="button" class="delete-deviation-row" onclick="deleteDeviationRow(this)"></button>
                       </td>
                   `;
                        deviationTableBody.appendChild(targetRow);
                    }

                    const inputs = targetRow.querySelectorAll('input, textarea');

                    if (inputs.length >= 4) {
                        if (inputs[0] && deviation.date) {
                            inputs[0].value = deviation.date;
                        }

                        if (inputs[1] && deviation.description_of_deviation) {
                            inputs[1].value = deviation.description_of_deviation;
                        }

                        if (inputs[2] && deviation.reason_for_deviation) {
                            inputs[2].value = deviation.reason_for_deviation;
                        }

                        if (inputs[3] && deviation.actions_taken_to_correct) {
                            inputs[3].value = deviation.actions_taken_to_correct;
                        }
                    }
                });
            }

            console.log(" Deviation table data loaded!");
        }
        console.log(" Deviation chart data loaded successfully!");
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            setupFlockLogListener();

            const saveButton = document.getElementById('saveFormButton');
            if (saveButton) {
                saveButton.addEventListener('click', saveFormData);
            }

            loadFormData();
        });
    } else {
        setupFlockLogListener();

        const saveButton = document.getElementById('saveFormButton');
        if (saveButton) {
            saveButton.addEventListener('click', saveFormData);
        }

        loadFormData();
    }
    function setupChickQualityBehavior(skipDefaults = false) {
        console.log(" Setting up chick quality behavior...", skipDefaults ? "(no defaults)" : "(with defaults)");

        const chickTable = document.querySelector('.table-header-dark');
        if (!chickTable) {
            console.log(" Chick table not found");
            return;
        }

        const tableRows = chickTable.querySelectorAll('tbody tr');
        console.log("Found chick table rows:", tableRows.length);

        tableRows.forEach((row, index) => {
            const checkboxes = row.querySelectorAll('input[type="checkbox"]');
            console.log(`Row ${index} checkboxes:`, checkboxes.length);

            if (checkboxes.length >= 4) {
                if (!skipDefaults) {
                    const hasAnyChecked = Array.from(checkboxes).some(cb => cb.checked);
                    if (!hasAnyChecked) {
                        checkboxes[0].checked = true;
                        checkboxes[2].checked = true;
                        console.log(` Set defaults for row ${index}`);
                    }
                }

                checkboxes[0].addEventListener('change', function () {
                    if (this.checked) checkboxes[1].checked = false;
                });
                checkboxes[1].addEventListener('change', function () {
                    if (this.checked) checkboxes[0].checked = false;
                });
                checkboxes[2].addEventListener('change', function () {
                    if (this.checked) checkboxes[3].checked = false;
                });
                checkboxes[3].addEventListener('change', function () {
                    if (this.checked) checkboxes[2].checked = false;
                });
            }
        });
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            setTimeout(() => setupChickQualityBehavior(false), 100);
        });
    } else {
        setTimeout(() => setupChickQualityBehavior(false), 100);
    }
    const originalLoadFormData = loadFormData;
    loadFormData = async function () {
        await originalLoadFormData();
        setTimeout(() => setupChickQualityBehavior(true), 100);

        window.skipDailyCheckDefaults = true;
    };
    async function resetFormData() {
        console.log(" Resetting form data...");

        const resetButton = document.getElementById('resetFormButton');
        const resetStatus = document.getElementById('resetStatus');

        if (!confirm('Are you sure you want to reset all form data? This action cannot be undone.')) {
            return;
        }

        const isMobile = window.innerWidth <= 768;

        resetButton.disabled = true;
        if (!isMobile) {
            resetButton.textContent = ' Resetting...';
        }
        resetStatus.textContent = 'Resetting all form data...';
        resetStatus.style.color = 'orange';
        try {
            document.querySelectorAll('input[type="text"]').forEach(input => {
                if (input.placeholder === "Chris Rose") {
                    input.value = 'Chris Rose';
                } else if (input.placeholder === "Yes") {
                    input.value = 'Yes';
                } else if (input.placeholder === "Truck") {
                    input.value = 'Truck';
                } else if (input.placeholder === "Product name") {
                    input.value = 'Chlorine';
                } else if (input.placeholder === "Location/procedure") {
                    input.value = 'Removed by Linde Poultry Service';
                } else if (input.placeholder === "Service/procedure") {
                    input.value = 'Blown down by Linde Poultry Service';
                } else if (input.placeholder === "Service/product") {
                    input.value = 'Barn washed by Clean And Scrub with Prevail';
                } else if (input.placeholder === "Prevail Disinfectant") {
                    input.value = 'Prevail Disinfectant';
                } else if (input.placeholder === "See Linde Poultry Service") {
                    input.value = 'See Linde Poultry Service';
                } else if (input.placeholder === "N/A") {
                    input.value = 'N/A';
                } else {
                    input.value = '';
                }
            });
            document.querySelectorAll('textarea').forEach(textarea => {
                if (textarea.placeholder === "Description of repairs") {
                    textarea.value = 'Ok, no issues';
                } else if (textarea.placeholder === "Description") {
                    textarea.value = 'Bin in good condition';
                } else {
                    textarea.value = '';
                }
            });
            document.querySelectorAll('input[type="date"]').forEach(input => {
                input.value = '';
            });

            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.value = '';
            });

            const feedNotesTextarea = document.getElementById('feedNotes');
            if (feedNotesTextarea) {
                feedNotesTextarea.value = '';
            }
            const feedTransferNotesTextarea = document.getElementById('feedTransferNotes');
            if (feedTransferNotesTextarea) {
                feedTransferNotesTextarea.value = '';
            }
            document.querySelectorAll('textarea').forEach(textarea => {
                textarea.value = '';
            });

            const waterSections = document.querySelectorAll('.section');
            let waterSection = null;
            waterSections.forEach(section => {
                const header = section.querySelector('.section-header');
                if (header && header.textContent.includes('Water - Record all products')) {
                    waterSection = section;
                }
            });
            if (!waterSection) {
                waterSection = document.querySelector('.section');
            }
            if (waterSection) {
                const waterTableBody = waterSection.querySelector('.table-header-dark tbody');
                if (waterTableBody) {
                    const rows = waterTableBody.querySelectorAll('tr');
                    for (let i = 1; i < rows.length; i++) {
                        rows[i].remove();
                    }
                }
            }
            const allSections = document.querySelectorAll('.section');
            let feedSection = null;
            allSections.forEach(section => {
                const header = section.querySelector('.section-header');
                if (header && header.textContent.trim() === 'Feed') {
                    feedSection = section;
                }
            });
            if (!feedSection) {
                feedSection = Array.from(allSections).find(section =>
                    section.textContent.includes('Record the dates of feed samples')
                );
            }
            if (feedSection) {
                const feedTableBody = feedSection.querySelector('.table-header-dark tbody');
                if (feedTableBody) {
                    const rows = feedTableBody.querySelectorAll('tr');
                    for (let i = 2; i < rows.length; i++) {
                        rows[i].remove();
                    }

                    if (rows.length === 1 || !rows[1] || !rows[1].classList.contains('note-row')) {
                        const noteRow = document.createElement('tr');
                        noteRow.className = 'note-row';
                        noteRow.innerHTML = `
   <td colspan="4">
       <div>
           <label>Entry Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;

                        if (rows[0]) {
                            rows[0].insertAdjacentElement('afterend', noteRow);
                        } else {
                            feedTableBody.appendChild(noteRow);
                        }
                    }
                }
            }
            const feedTransferSection = Array.from(document.querySelectorAll('.section')).find(section => {
                const header = section.querySelector('.section-header');
                return header && header.textContent.trim() === 'Feed Transfer Record';
            });
            if (feedTransferSection) {
                const feedTransferTableBody = feedTransferSection.querySelector('.table-header-dark tbody');
                if (feedTransferTableBody) {
                    const rows = feedTransferTableBody.querySelectorAll('tr');
                    for (let i = 2; i < rows.length; i++) {
                        rows[i].remove();
                    }

                    if (rows.length === 1 || !rows[1] || !rows[1].classList.contains('note-row')) {
                        const noteRow = document.createElement('tr');
                        noteRow.className = 'note-row';
                        noteRow.innerHTML = `
   <td colspan="8">
       <div>
           <label>Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;

                        if (rows[0]) {
                            rows[0].insertAdjacentElement('afterend', noteRow);
                        } else {
                            feedTransferTableBody.appendChild(noteRow);
                        }
                    }
                }
            }
            const deviationSection = Array.from(document.querySelectorAll('.section')).find(section => {
                const header = section.querySelector('.section-header');
                return header && header.textContent.includes('Deviation Chart');
            });
            if (deviationSection) {
                const deviationTableBody = deviationSection.querySelector('table tbody');
                if (deviationTableBody) {
                    const rows = deviationTableBody.querySelectorAll('tr');
                    for (let i = 1; i < rows.length; i++) {
                        rows[i].remove();
                    }
                }
            }
            const medicationsSection = Array.from(document.querySelectorAll('.section')).find(section => {
                const header = section.querySelector('.section-header');
                return header && header.textContent.includes('Medications - Complete the following table');
            });
            if (medicationsSection) {
                const medicationsTableBody = medicationsSection.querySelector('table tbody');
                if (medicationsTableBody) {
                    const rows = medicationsTableBody.querySelectorAll('tr');
                    for (let i = 1; i < rows.length; i++) {
                        rows[i].remove();
                    }
                }
            }
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });

            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            setTimeout(() => {
                const option1DetergentCheckbox = document.getElementById('option1_detergent');
                const option1DisinfectantCheckbox = document.getElementById('option1_disinfectant');
                const flushCheckbox = document.getElementById('flush');

                if (option1DetergentCheckbox) {
                    option1DetergentCheckbox.checked = true;
                }
                if (option1DisinfectantCheckbox) {
                    option1DisinfectantCheckbox.checked = true;
                }
                if (flushCheckbox) {
                    flushCheckbox.checked = true;
                }

                const dailyCheckIds = ['feedquality', 'thermal', 'templevels', 'humiditylevels', 'wateravail', 'flockhealth', 'ventilation', 'ammonialevels', 'waterquality', 'heatingsystem', 'lightingsystem', 'litterquality', 'birdsinspected'];

                dailyCheckIds.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }, 50);
            setTimeout(() => {
                setupChickQualityBehavior(false);
            }, 100);
            const docRef = doc(db, 'vas-b1-fl', 'vas-b1-f1');
            await deleteDoc(docRef);
            setDefaultFarmRep();
            resetButton.disabled = false;
            if (!isMobile) {
                resetButton.textContent = ' Reset Page';
            }
            resetStatus.textContent = ' Form reset successfully!';
            resetStatus.style.color = 'green';

            console.log(" Form reset completed!");

            setTimeout(() => {
                resetStatus.textContent = '';
            }, 3000);

        } catch (error) {
            console.error(" Error resetting form:", error);

            resetButton.disabled = false;
            if (!isMobile) {
                resetButton.textContent = ' Reset Page';
            }
            resetStatus.textContent = ' Error resetting form. Please try again.';
            resetStatus.style.color = 'red';

            setTimeout(() => {
                resetStatus.textContent = '';
            }, 5000);
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const resetButton = document.getElementById('resetFormButton');
            if (resetButton) {
                resetButton.addEventListener('click', resetFormData);
            }
        });
    } else {
        const resetButton = document.getElementById('resetFormButton');
        if (resetButton) {
            resetButton.addEventListener('click', resetFormData);
        }
    }
    function setDefaultFarmRep() {
        const defaultInputs = [
            { placeholder: "Chris Rose", value: "Chris Rose" },
            { placeholder: "Yes", value: "Yes" },
            { placeholder: "Truck", value: "Truck" }
        ];

        defaultInputs.forEach(({ placeholder, value }) => {
            const inputs = document.querySelectorAll(`input[placeholder="${placeholder}"]`);
            inputs.forEach(input => {
                if (!input.value) {
                    input.value = value;
                }
            });
        });

        const additionalDefaults = [
            { placeholder: "Product name", value: "Chlorine" },
            { placeholder: "Location/procedure", value: "Removed by Linde Poultry Service" },
            { placeholder: "Service/procedure", value: "Blown down by Linde Poultry Service" },
            { placeholder: "Service/product", value: "Barn washed by Clean And Scrub with Prevail" },
            { placeholder: "See Linde Poultry Service", value: "See Linde Poultry Service" },
            { placeholder: "N/A", value: "N/A" },
            { placeholder: "Dates of filters/bulbs changed", value: "Dates of filters/bulbs changed" },
            { placeholder: "Status", value: "Good" },
            { placeholder: "Test results", value: "Tested Ok" },
            { placeholder: "Condition and type", value: "Good Condition - Wood shavings" },
            { placeholder: "Product/method", value: "Bait boxes in place - See program" },
            { placeholder: "Product", value: "Agita" },
            { placeholder: "Controls", value: "None" },
            { placeholder: "Signature", value: "Chris Rose" }
        ];
        additionalDefaults.forEach(({ placeholder, value }) => {
            const inputs = document.querySelectorAll(`input[placeholder="${placeholder}"]`);
            inputs.forEach(input => {
                if (!input.value && !input.hasAttribute('data-loaded')) {
                    input.value = value;
                }
            });
        });
        const prevailInputs = document.querySelectorAll('input[placeholder="Prevail Disinfectant"]');
        prevailInputs.forEach(input => {
            if (!input.hasAttribute('data-loaded')) {
                input.value = 'Prevail Disinfectant';
            }
        });
        const pestControlSection = Array.from(document.querySelectorAll('.section')).find(section => {
            const table = section.querySelector('.table-header-dark');
            return table && table.textContent.includes('Pest Control');
        });
        if (pestControlSection) {
            const cazRow = Array.from(pestControlSection.querySelectorAll('tr')).find(row =>
                row.textContent.includes('CAZ kept maintained')
            );
            if (cazRow) {
                const cazInput = cazRow.querySelector('input[placeholder="Status"]');
                if (cazInput && !cazInput.hasAttribute('data-loaded')) {
                    cazInput.value = 'Yes';
                }
            }
            const wildBirdRow = Array.from(pestControlSection.querySelectorAll('tr')).find(row =>
                row.textContent.includes('Wild bird controls used')
            );
            if (wildBirdRow) {
                const wildBirdInput = wildBirdRow.querySelector('input[placeholder="Product/method"]');
                if (wildBirdInput && !wildBirdInput.hasAttribute('data-loaded')) {
                    wildBirdInput.value = 'Screens in place';
                }
            }
        }
        const textareaDefaults = [
            { placeholder: "Description of repairs", value: "Ok, no issues" },
            { placeholder: "Description", value: "Bin in good condition" }
        ];
        textareaDefaults.forEach(({ placeholder, value }) => {
            const textareas = document.querySelectorAll(`textarea[placeholder="${placeholder}"]`);
            textareas.forEach(textarea => {
                if (!textarea.value) {
                    textarea.value = value;
                }
            });
        });
        const feedSignatureInput = document.getElementById('feedSignature');
        if (feedSignatureInput && !feedSignatureInput.value) {
            feedSignatureInput.value = 'Chris Rose';
        }

        const option1DetergentCheckbox = document.getElementById('option1_detergent');
        const option1DisinfectantCheckbox = document.getElementById('option1_disinfectant');

        if (option1DetergentCheckbox) {
            option1DetergentCheckbox.checked = true;
        }
        if (option1DisinfectantCheckbox) {
            option1DisinfectantCheckbox.checked = true;
        }

        const flushCheckbox = document.getElementById('flush');
        if (flushCheckbox) {
            flushCheckbox.checked = true;
            const dailyCheckIds = ['feedquality', 'thermal', 'templevels', 'humiditylevels', 'wateravail', 'flockhealth', 'ventilation', 'ammonialevels', 'waterquality', 'heatingsystem', 'lightingsystem', 'litterquality', 'birdsinspected'];

            dailyCheckIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && !checkbox.hasAttribute('data-loaded')) {
                    checkbox.checked = true;
                }
            });
        }


        if (!window.skipDailyCheckDefaults) {
            const dailyCheckIds = ['feedquality', 'thermal', 'templevels', 'humiditylevels', 'wateravail', 'flockhealth', 'ventilation', 'ammonialevels', 'waterquality', 'heatingsystem', 'lightingsystem', 'litterquality', 'birdsinspected'];

            dailyCheckIds.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
        }
    }
    function addFeedEntry() {
        console.log("Adding new feed entry...");

        const allSections = document.querySelectorAll('.section');
        let feedSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.trim() === 'Feed') {
                feedSection = section;
            }
        });

        if (!feedSection) {
            feedSection = Array.from(allSections).find(section =>
                section.textContent.includes('Record the dates of feed samples')
            );
        }

        if (!feedSection) {
            console.error(" Feed section still not found");
            return;
        }

        const feedTableBody = feedSection.querySelector('.table-header-dark tbody');

        if (!feedTableBody) {
            console.error(" Feed table body not found");
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
       <td><input type="date" class="table-input"></td>
       <td><textarea class="table-input" placeholder="Enter ingredients"></textarea></td>
       <td><input type="date" class="table-input"></td>
       <td>
           <button type="button" class="delete-feed-row" onclick="deleteFeedRow(this)"></button>
       </td>
   `;

        const noteRow = document.createElement('tr');
        noteRow.className = 'note-row';
        noteRow.innerHTML = `
   <td colspan="4">
       <div>
           <label>Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;

        feedTableBody.appendChild(newRow);
        feedTableBody.appendChild(noteRow);

        applyAlternatingRowStyling(feedTableBody, 'feed');

        console.log(" New feed entry with note added successfully!");

        console.log(" Auto-saving new feed entry...");
        saveFormData();
    }
    function deleteFeedRow(button) {
        console.log(" Delete feed button clicked");

        if (confirm('Are you sure you want to delete this feed entry?')) {
            const row = button.closest('tr');
            if (row) {
                const feedTableBody = row.closest('tbody');

                const noteRow = row.nextElementSibling;
                if (noteRow && noteRow.classList.contains('note-row')) {
                    noteRow.remove();
                }
                row.remove();

                if (feedTableBody) {
                    applyAlternatingRowStyling(feedTableBody, 'feed');
                }

                console.log(" Feed entry and note deleted successfully!");

                console.log(" Auto-saving after deletion...");
                saveFormData();
            }
        }
    }
    window.deleteFeedRow = deleteFeedRow;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const addFeedButton = document.getElementById('addFeedEntryButton');
            if (addFeedButton) {
                addFeedButton.addEventListener('click', addFeedEntry);
            }
        });
    } else {
        const addFeedButton = document.getElementById('addFeedEntryButton');
        if (addFeedButton) {
            addFeedButton.addEventListener('click', addFeedEntry);
        }
    }
    function addWaterEntry() {
        console.log("Adding new water entry...");

        const waterSections = document.querySelectorAll('.section');
        let waterSection = null;

        waterSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.includes('Water - Record all products')) {
                waterSection = section;
            }
        });

        if (!waterSection) {
            waterSection = document.querySelector('.section');
        }

        const waterTableBody = waterSection?.querySelector('.table-header-dark tbody');

        if (!waterTableBody) {
            console.error(" Water table body not found");
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
       <td><input type="text" class="table-input" placeholder="Product name" value="Chlorine"></td>
       <td><input type="date" class="table-input"></td>
       <td><input type="date" class="table-input"></td>
       <td><input type="text" class="table-input" placeholder="Results"></td>
       <td>
           <button type="button" class="delete-water-row" onclick="deleteWaterRow(this)"></button>
       </td>
   `;

        waterTableBody.appendChild(newRow);

        console.log(" New water entry added successfully!");

        console.log(" Auto-saving new water entry...");
        saveFormData();
    }
    function deleteWaterRow(button) {
        console.log(" Delete button clicked");

        if (confirm('Are you sure you want to delete this water entry?')) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
                console.log(" Water entry deleted successfully!");

                console.log(" Auto-saving after deletion...");
                saveFormData();
            }
        }
    }
    window.deleteWaterRow = deleteWaterRow;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const addWaterButton = document.getElementById('addWaterEntryButton');
            if (addWaterButton) {
                addWaterButton.addEventListener('click', addWaterEntry);
            }
        });
    } else {
        const addWaterButton = document.getElementById('addWaterEntryButton');
        if (addWaterButton) {
            addWaterButton.addEventListener('click', addWaterEntry);
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            setDefaultFarmRep();
        });
    } else {
        setDefaultFarmRep();
    }
    function addFeedTransferEntry() {
        console.log("Adding new feed transfer entry...");

        const allSections = document.querySelectorAll('.section');
        let feedTransferSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.trim() === 'Feed Transfer Record') {
                feedTransferSection = section;
            }
        });

        if (!feedTransferSection) {
            feedTransferSection = Array.from(allSections).find(section =>
                section.textContent.includes('Date feed moved')
            );
        }

        if (!feedTransferSection) {
            console.error(" Feed Transfer Record section still not found");
            return;
        }

        const feedTransferTableBody = feedTransferSection.querySelector('.table-header-dark tbody');

        if (!feedTransferTableBody) {
            console.error(" Feed Transfer Record table body not found");
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
       <td><input type="date" class="table-input"></td>
       <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
       <td><input type="text" class="table-input" placeholder="Farm/bin"></td>
       <td><textarea class="table-input" placeholder="Medications"></textarea></td>
       <td><input type="text" class="table-input" placeholder="Truck" value="Truck"></td>
       <td>
           <select class="table-input">
               <option value="Yes" selected>Yes</option>
               <option value="No">No</option>
           </select>
       </td>
       <td><input type="text" class="table-input" placeholder="Yes" value="Yes"></td>
       <td>
           <button type="button" class="delete-feed-transfer-row" onclick="deleteFeedTransferRow(this)"></button>
       </td>
   `;

        const noteRow = document.createElement('tr');
        noteRow.className = 'note-row';
        noteRow.innerHTML = `
   <td colspan="8">
       <div>
           <label>Notes:</label>
           <textarea class="entry-note-input" placeholder="Notes for this entry..."></textarea>
       </div>
   </td>
`;

        feedTransferTableBody.appendChild(newRow);
        feedTransferTableBody.appendChild(noteRow);

        applyAlternatingRowStyling(feedTransferTableBody, 'feedTransfer');

        console.log(" New feed transfer entry with note added successfully!");

        console.log(" Auto-saving new feed transfer entry...");
        saveFormData();
    }
    function deleteFeedTransferRow(button) {
        console.log(" Delete feed transfer button clicked");

        if (confirm('Are you sure you want to delete this feed transfer entry?')) {
            const row = button.closest('tr');
            if (row) {
                const feedTransferTableBody = row.closest('tbody');

                const noteRow = row.nextElementSibling;
                if (noteRow && noteRow.classList.contains('note-row')) {
                    noteRow.remove();
                }
                row.remove();

                if (feedTransferTableBody) {
                    applyAlternatingRowStyling(feedTransferTableBody, 'feedTransfer');
                }

                console.log(" Feed transfer entry and note deleted successfully!");

                console.log(" Auto-saving after deletion...");
                saveFormData();
            }
        }
    }
    function applyStylesAfterDataLoad() {
        const feedSection = Array.from(document.querySelectorAll('.section')).find(section => {
            const header = section.querySelector('.section-header');
            return header && header.textContent.trim() === 'Feed';
        });

        if (feedSection) {
            const feedTableBody = feedSection.querySelector('.table-header-dark tbody');
            if (feedTableBody) {
                applyAlternatingRowStyling(feedTableBody, 'feed');
            }
        }

        const feedTransferSection = Array.from(document.querySelectorAll('.section')).find(section => {
            const header = section.querySelector('.section-header');
            return header && header.textContent.trim() === 'Feed Transfer Record';
        });

        if (feedTransferSection) {
            const feedTransferTableBody = feedTransferSection.querySelector('.table-header-dark tbody');
            if (feedTransferTableBody) {
                applyAlternatingRowStyling(feedTransferTableBody, 'feedTransfer');
            }
        }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {

            setTimeout(() => {
                applyStylesAfterDataLoad();
            }, 100);
        });
    } else {

        setTimeout(() => {
            applyStylesAfterDataLoad();
        }, 100);
    }
    window.deleteFeedTransferRow = deleteFeedTransferRow;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const addFeedTransferButton = document.getElementById('addFeedTransferEntryButton');
            if (addFeedTransferButton) {
                addFeedTransferButton.addEventListener('click', addFeedTransferEntry);
            }
        });
    } else {
        const addFeedTransferButton = document.getElementById('addFeedTransferEntryButton');
        if (addFeedTransferButton) {
            addFeedTransferButton.addEventListener('click', addFeedTransferEntry);
        }
    }
    function addMedicationEntry() {
        console.log("Adding new medication entry...");

        const allSections = document.querySelectorAll('.section');
        let medicationsSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.includes('Medications - Complete the following table')) {
                medicationsSection = section;
            }
        });

        if (!medicationsSection) {
            console.error(" Medications section not found");
            return;
        }

        const medicationsTableBody = medicationsSection.querySelector('table tbody');

        if (!medicationsTableBody) {
            console.error(" Medications table body not found");
            return;
        }

        const rowIndex = medicationsTableBody.querySelectorAll('tr').length + 1;

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
       <td><input type="text" class="table-input" placeholder="Medication name"></td>
      <td>
   <div class="checkbox-container">
       <input type="checkbox" id="feed${rowIndex}" onchange="handleRouteChange(this, 'water${rowIndex}')">
       <label for="feed${rowIndex}">feed</label>
   </div>
   <div class="checkbox-container">
       <input type="checkbox" id="water${rowIndex}" onchange="handleRouteChange(this, 'feed${rowIndex}')">
       <label for="water${rowIndex}">water</label>
   </div>
</td>
       <td><input type="date" class="table-input"></td>
       <td><input type="date" class="table-input"></td>
       <td><input type="text" class="table-input" placeholder="Actions"></td>
       <td><input type="text" class="table-input" placeholder="Control measures"></td>
       <td>
           <button type="button" class="delete-medication-row" onclick="deleteMedicationRow(this)"></button>
       </td>
   `;

        medicationsTableBody.appendChild(newRow);

        console.log(" New medication entry added successfully!");

        console.log(" Auto-saving new medication entry...");
        saveFormData();
    }
    function deleteMedicationRow(button) {
        console.log(" Delete medication button clicked");

        if (confirm('Are you sure you want to delete this medication entry?')) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
                console.log(" Medication entry deleted successfully!");

                console.log(" Auto-saving after deletion...");
                saveFormData();
            }
        }
    }
    window.deleteMedicationRow = deleteMedicationRow;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const addMedicationButton = document.getElementById('addMedicationEntryButton');
            if (addMedicationButton) {
                addMedicationButton.addEventListener('click', addMedicationEntry);
            }
        });
    } else {
        const addMedicationButton = document.getElementById('addMedicationEntryButton');
        if (addMedicationButton) {
            addMedicationButton.addEventListener('click', addMedicationEntry);
        }
    }
    function addDeviationEntry() {
        console.log("Adding new deviation entry...");

        const allSections = document.querySelectorAll('.section');
        let deviationSection = null;

        allSections.forEach(section => {
            const header = section.querySelector('.section-header');
            if (header && header.textContent.includes('Deviation Chart')) {
                deviationSection = section;
            }
        });

        if (!deviationSection) {
            console.error(" Deviation Chart section not found");
            return;
        }

        const deviationTableBody = deviationSection.querySelector('table tbody');

        if (!deviationTableBody) {
            console.error(" Deviation Chart table body not found");
            return;
        }

        const newRow = document.createElement('tr');
        newRow.innerHTML = `
       <td><input type="date" class="table-input"></td>
       <td><textarea class="table-input" placeholder="Describe deviation"></textarea></td>
       <td><textarea class="table-input" placeholder="Reason for deviation"></textarea></td>
       <td><textarea class="table-input" placeholder="Corrective actions"></textarea></td>
       <td>
           <button type="button" class="delete-deviation-row" onclick="deleteDeviationRow(this)"></button>
       </td>
   `;

        deviationTableBody.appendChild(newRow);

        console.log(" New deviation entry added successfully!");

        console.log(" Auto-saving new deviation entry...");
        saveFormData();
    }
    function deleteDeviationRow(button) {
        console.log(" Delete deviation button clicked");

        if (confirm('Are you sure you want to delete this deviation entry?')) {
            const row = button.closest('tr');
            if (row) {
                row.remove();
                console.log(" Deviation entry deleted successfully!");

                console.log(" Auto-saving after deletion...");
                saveFormData();
            }
        }
    }
    window.deleteDeviationRow = deleteDeviationRow;
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function () {
            const addDeviationButton = document.getElementById('addDeviationEntryButton');
            if (addDeviationButton) {
                addDeviationButton.addEventListener('click', addDeviationEntry);
            }
        });
    } else {
        const addDeviationButton = document.getElementById('addDeviationEntryButton');
        if (addDeviationButton) {
            addDeviationButton.addEventListener('click', addDeviationEntry);
        }
    }
    function handleRouteChange(checkedBox, otherBoxId) {
        if (checkedBox.checked) {
            const otherBox = document.getElementById(otherBoxId);
            if (otherBox) {
                otherBox.checked = false;
            }
        }
    }
    window.handleRouteChange = handleRouteChange;
    document.addEventListener('DOMContentLoaded', function () {
        const feed1 = document.getElementById('feed1');
        const water1 = document.getElementById('water1');

        if (feed1 && water1) {
            feed1.onchange = function () { handleRouteChange(this, 'water1'); };
            water1.onchange = function () { handleRouteChange(this, 'feed1'); };
        }
    });
    function toggleSidebar() {
        console.log(" Toggling sidebar...");
        document.body.classList.toggle('sidebar-collapsed');
    }
    window.toggleSidebar = toggleSidebar;
    function navigateToPage(filename) {
        console.log(`Navigating to: ${filename}`);
        window.location.href = filename;
    }
    document.addEventListener('DOMContentLoaded', function () {
        const customStyle = document.createElement('style');
        customStyle.textContent = ``;
        document.head.appendChild(customStyle);
    });
    attachPrintButton();
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachPrintButton);
    } else {
        setTimeout(attachPrintButton, 500);
    }
    document.getElementById('mobileBackButton').addEventListener('click', function () {
        window.location.href = '../floors-dash/v-floor-b1.html';
    });
    document.getElementById('mobileMainMenuButton').addEventListener('click', function () {
        window.location.href = '../../index.html';
    });
    window.navigateToPage = navigateToPage;
    window.setupFlockLogListener = setupFlockLogListener;
</script>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Farm Records</title>
</head>

</html>