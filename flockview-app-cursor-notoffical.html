<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlockView - Multi-Farm Management Dashboard</title>
    <link rel="stylesheet" href="flockview-app-styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- PDF.js for better PDF handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"></script>
    
</head>

<body>
    <!-- Navigation (hidden on login page) -->
    <nav class="app-nav" id="mainNavigation">
        <div class="nav-container">
            <div class="nav-logo">h67
                <span class="logo-text">Flock<span class="logo-accent">View</span></span>
            </div>
            <div class="nav-menu">
                <a href="#dashboard" class="nav-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="#feed-schedules" class="nav-link" data-section="feed-schedules">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Feed Schedules</span>
                </a>
                <a href="#calendar" class="nav-link" data-section="calendar">
                    <i class="fas fa-calendar"></i>
                    <span>Calendar</span>
                </a>
                <a href="#notes" class="nav-link" data-section="notes">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </a>
            </div>
            <div class="nav-user">
                <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle" title="Toggle Theme">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-trigger" onclick="toggleProfileDropdown()">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name" id="headerUserName">Farm Manager</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="profile-menu" id="profileMenu">
                        <div class="profile-header">
                            <div class="profile-info">
                                <div class="profile-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <div class="profile-details">
                                    <h4 id="profileUserName">Farm Manager</h4>
                                    <p id="profileUserEmail">Multi-Farm System</p>
                                </div>
                            </div>
                        </div>
                        <div class="profile-actions">
                            <a href="#" class="profile-action" onclick="openProfileSettings()">
                                <i class="fas fa-user-cog"></i>
                                <span>Profile Settings</span>
                            </a>
                            <a href="#" class="profile-action" onclick="openSystemSettings()">
                                <i class="fas fa-cog"></i>
                                <span>System Settings</span>
                            </a>
                            <a href="#" class="profile-action" onclick="openNotifications()">
                                <i class="fas fa-bell"></i>
                                <span>Notifications</span>
                            </a>
                            <div class="profile-divider"></div>
                            <a href="#" class="profile-action" onclick="openHelp()">
                                <i class="fas fa-question-circle"></i>
                                <span>Help & Support</span>
                            </a>
                            <a href="#" class="profile-action logout" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                <span>Sign Out</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>


    <!-- Main Content -->       
    <main class="app-main" id="mainContent">
        <!-- Dashboard Section -->
        <section id="dashboard" class="app-section">
            <div class="section-header">
                <h1>Multi-Farm Dashboard</h1>
                <p>Overview of all farm operations across the network</p>
            </div>



            <!-- Top Dashboard Section - Farm Overview and Quick Upload Side by Side -->
            <div class="dashboard-top-grid">
                <!-- Farm Network Overview -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2>Farm Network Overview</h2>
                    </div>
                    <div class="farm-overview">
                        <div class="farm-summary">
                            <div class="farm-item">
                                <div class="farm-icon vas">VAS</div>
                                <div class="farm-details">
                                    <h4>Vassilakos Farm</h4>
                                    <p>4 barns • 3 active flocks • Operational</p>
                                </div>
                                <button class="btn btn-outline btn-sm" onclick="navigateToFarm('vassilakos')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div class="farm-item">
                                <div class="farm-icon edg">EDG</div>
                                <div class="farm-details">
                                    <h4>EDG Farm</h4>
                                    <p>4 barns • 2 active flocks • Operational</p>
                                </div>
                                <button class="btn btn-outline btn-sm" onclick="navigateToFarm('edg')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div class="farm-item">
                                <div class="farm-icon apo">APO</div>
                                <div class="farm-details">
                                    <h4>Apostolakos Farm</h4>
                                    <p>4 barns • 3 active flocks • Operational</p>
                                </div>
                                <button class="btn btn-outline btn-sm" onclick="navigateToFarm('apostolakos')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div class="farm-item">
                                <div class="farm-icon sig">SIG</div>
                                <div class="farm-details">
                                    <h4>Sigma Farm</h4>
                                    <p>4 barns • 4 active flocks • Operational</p>
                                </div>
                                <button class="btn btn-outline btn-sm" onclick="navigateToFarm('sigma')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                            <div class="farm-item">
                                <div class="farm-icon dfi">DFI</div>
                                <div class="farm-details">
                                    <h4>DFI Farm</h4>
                                    <p>4 barns • 3 active flocks • Operational</p>
                                </div>
                                <button class="btn btn-outline btn-sm" onclick="navigateToFarm('dfi')">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Calendar Access -->
                        <div class="quick-calendar-access">
                            <div class="calendar-access-item">
                                <div class="calendar-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="calendar-details">
                                    <h4>Farm Calendar</h4>
                                    <p>View all farm events, feed schedules, and important dates</p>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="navigateToSection('calendar')">
                                    <i class="fas fa-calendar"></i> Open Calendar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Quick Notes Access -->
                        <div class="quick-notes-access">
                            <div class="notes-access-item">
                                <div class="notes-icon">
                                    <i class="fas fa-sticky-note"></i>
                                </div>
                                <div class="notes-details">
                                    <h4>Farm Notes</h4>
                                    <p>Create and manage notes for farm operations</p>
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="navigateToSection('notes')">
                                    <i class="fas fa-plus"></i> New Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Feed Schedule Upload Section -->
                <div class="dashboard-card">
                <div class="card-header">
                    <h2>Quick Feed Schedule Upload</h2>
                    <button class="btn btn-primary btn-sm" onclick="navigateToSection('feed-schedules')">
                        <i class="fas fa-calendar"></i> Manage All
                    </button>
                </div>
                <div class="quick-upload-section">
                    <div class="quick-upload-area wide" id="quickUploadArea">
                        <div class="upload-content-wide">
                            <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="upload-text">
                        <h4>Quick Upload</h4>
                        <p>Drag and drop a PDF file here for automatic processing</p>
                        <p class="upload-note">Farm and barn information will be automatically extracted from the PDF</p>
                            </div>
                            <div class="upload-action">
                        <input type="file" id="quickPdfFileInput" accept=".pdf" style="display: none;">
                        <button class="btn btn-outline" onclick="document.getElementById('quickPdfFileInput').click()">
                            <i class="fas fa-file-pdf"></i> Choose PDF File
                        </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Location Selection (hidden initially) -->
                    <div class="quick-location-selection" id="quickLocationSelection" style="display: none;">
                        <h4>Select Location</h4>
                        <p>Please specify the farm, barn, and floor for this feed schedule:</p>
                        <div class="quick-location-selector">
                            <div class="quick-selector-group">
                                <label for="quickFarmSelect">Farm:</label>
                                <select id="quickFarmSelect" class="form-select">
                                    <option value="">Select Farm</option>
                                    <option value="VAS">Vassilakos Farm (VAS)</option>
                                    <option value="EDG">EDG Farm (EDG)</option>
                                    <option value="APO">Apostolakos Farm (APO)</option>
                                    <option value="SIG">Sigma Farm (SIG)</option>
                                    <option value="DFI">DFI Farm (DFI)</option>
                                </select>
                            </div>
                            <div class="quick-selector-group">
                                <label for="quickBarnSelect">Barn:</label>
                                <select id="quickBarnSelect" class="form-select">
                                    <option value="">Select Barn</option>
                                    <option value="B1">Barn 1</option>
                                    <option value="B2">Barn 2</option>
                                    <option value="B3">Barn 3</option>
                                    <option value="B4">Barn 4</option>
                                </select>
                            </div>
                            <div class="quick-selector-group">
                                <label for="quickFloorSelect">Floor:</label>
                                <select id="quickFloorSelect" class="form-select">
                                    <option value="">Select Floor</option>
                                    <option value="F1">Floor 1</option>
                                    <option value="F2">Floor 2</option>
                                </select>
                            </div>
                        </div>
                        <div class="location-selection-actions">
                            <button class="btn btn-primary" onclick="processQuickUpload()">
                                <i class="fas fa-upload"></i> Process Upload
                            </button>
                            <button class="btn btn-outline" onclick="resetQuickUpload()">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </div>
                    
                    <div class="quick-upload-progress" id="quickUploadProgress" style="display: none;">
                        <div class="progress-bar">
                            <div class="progress-fill" id="quickProgressFill"></div>
                        </div>
                        <p id="quickProgressText">Processing PDF...</p>
                    </div>
                </div>
                <div class="quick-feed-preview" id="quickFeedPreview" style="display: none;">
                    <h4>Recent Upload</h4>
                    <div class="quick-feed-info" id="quickFeedInfo"></div>
                </div>

                <!-- Upcoming Feed Schedules Section -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="fas fa-calendar-alt"></i> Upcoming Feed Schedules</h2>
                        <button class="btn btn-primary btn-sm" onclick="navigateToSection('feed-schedules')">
                            <i class="fas fa-calendar"></i> View All
                        </button>
                    </div>
                    <div class="upcoming-feed-schedules" id="upcomingFeedSchedules">
                        <div class="loading-upcoming">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading upcoming feed schedules...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>



        <!-- Farm Detail Section (Hidden by default) -->
        <section id="farm-detail" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1 id="farm-detail-title">Farm Management</h1>
                <p id="farm-detail-subtitle">Manage barns and operations for this farm</p>
            </div>

            <div class="barn-selection">
                <h2>Select a Barn</h2>
                <div class="barn-grid" id="barn-grid">
                    <!-- Barns will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Barn Software Section (Hidden by default) -->
        <section id="barn-software" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToBarns()">
                    <i class="fas fa-arrow-left"></i> Back to Barns
                </button>
                <h1 id="barn-software-title">Barn Software Dashboard</h1>
                <p id="barn-software-subtitle">Select a software module to manage barn operations</p>
            </div>

            <div class="software-grid" id="software-grid">
                <!-- Software modules will be populated dynamically -->
            </div>
        </section>

        <!-- Other sections remain the same but are hidden by default -->


                 <section id="feed-schedules" class="app-section" style="display: none;">
            <div class="section-header">
                <h1>Feed Schedules</h1>
                <p>Upload and manage feed delivery schedules across all farms</p>
            </div>

             <!-- Modern Feed Schedules Dashboard -->
            <div class="feed-schedules-dashboard-streamlined">
                 
                 <!-- Feed Schedules Display Section (Full Width) -->
                 <div class="schedules-display-section">
                     <div class="schedules-header modern">

                         
                         <div class="header-top">
                             <div class="header-left">
                                 <div class="header-title-section">
                                     <div class="title-content">
                                         <h2>All Feed Schedules</h2>
                                         <p class="subtitle">Manage and monitor feed schedules across all farms</p>
                                     </div>
                                     <div class="schedule-stats" id="scheduleStats">
                                         <div class="stat-card">
                                             <div class="stat-icon">
                                                 <i class="fas fa-file-pdf"></i>
                                             </div>
                                             <div class="stat-content">
                                                 <span class="stat-number" id="totalSchedules">0</span>
                                                 <span class="stat-label">Active Schedules</span>
                                             </div>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="quick-upload-section">
                                 <div class="upload-card modern compact">
                                     <div class="upload-header">
                                         <h3><i class="fas fa-cloud-upload-alt"></i> Quick Upload</h3>
                                         <p>Upload new feed schedule PDF</p>
                                     </div>
                                     
                                     <div class="upload-content">
                                         <div class="file-upload-area modern compact" id="mainFileUploadArea">
                                             <div class="upload-icon">
                                                 <i class="fas fa-file-pdf"></i>
                                             </div>
                                             <h4>Drop PDF here or click to browse</h4>
                                             <p>Automatic processing</p>
                                             
                                             <input type="file" id="mainPdfFileInput" accept=".pdf" style="display: none;">
                                             <button class="btn btn-primary modern" onclick="document.getElementById('mainPdfFileInput').click()">
                                                 <i class="fas fa-file-pdf"></i> Choose PDF
                                             </button>
                                         </div>
                                     </div>
                                 </div>
                             </div>
                         </div>
                         
                         <div class="header-bottom">
                             <div class="farm-tabs-container">
                                 <div class="farm-tabs">
                                     <button class="farm-tab active" data-farm="all" onclick="filterByFarm('all')">
                                         <i class="fas fa-globe"></i>
                                         <span>All Farms</span>
                                     </button>
                                     <button class="farm-tab" data-farm="VAS" onclick="filterByFarm('VAS')">
                                         <i class="fas fa-tractor"></i>
                                         <span>Vassilakos</span>
                                     </button>
                                     <button class="farm-tab" data-farm="EDG" onclick="filterByFarm('EDG')">
                                         <i class="fas fa-tractor"></i>
                                         <span>EDG Farm</span>
                                     </button>
                                     <button class="farm-tab" data-farm="APO" onclick="filterByFarm('APO')">
                                         <i class="fas fa-tractor"></i>
                                         <span>Apostolakos</span>
                                     </button>
                                     <button class="farm-tab" data-farm="SIG" onclick="filterByFarm('SIG')">
                                         <i class="fas fa-tractor"></i>
                                         <span>Sigma</span>
                                     </button>
                                     <button class="farm-tab" data-farm="DFI" onclick="filterByFarm('DFI')">
                                         <i class="fas fa-tractor"></i>
                                         <span>DFI</span>
                                     </button>
                                 </div>
                             </div>
                             
                             <div class="header-actions">
                                 <div class="pagination-controls modern">
                                     <button class="btn btn-outline btn-sm modern" onclick="previousPage()" id="prevPageBtn">
                                         <i class="fas fa-chevron-left"></i>
                                     </button>
                                     <span class="page-info modern" id="pageInfo">Page 1 of 1</span>
                                     <button class="btn btn-outline btn-sm modern" onclick="nextPage()" id="nextPageBtn">
                                         <i class="fas fa-chevron-right"></i>
                                     </button>
                                 </div>
                                 
                                 <button class="btn btn-danger modern" onclick="deleteAllPDFs()" title="Delete All PDFs">
                                     <i class="fas fa-trash"></i> Clear All
                                 </button>
                             </div>
                         </div>
                         

                     </div>
                     
                     <div class="schedules-container modern" id="schedulesGrid">
                         <!-- Schedules will be loaded here -->
                     </div>
                 </div>
             </div>
         </section>

        <!-- Profile Settings Section -->
        <section id="profile-settings" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1>Profile Settings</h1>
                <p>Manage your personal information and account preferences</p>
            </div>

            <div class="settings-grid">
                <!-- Personal Information -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-user"></i> Personal Information</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="profileFirstName">First Name</label>
                            <input type="text" id="profileFirstName" class="form-input" value="Farm" placeholder="Enter first name">
                        </div>
                        <div class="form-group">
                            <label for="profileLastName">Last Name</label>
                            <input type="text" id="profileLastName" class="form-input" value="Manager" placeholder="Enter last name">
                        </div>
                        <div class="form-group">
                            <label for="profileEmail">Email Address</label>
                            <input type="email" id="profileEmail" class="form-input" value="manager@farm.com" placeholder="Enter email address">
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Phone Number</label>
                            <input type="tel" id="profilePhone" class="form-input" value="+1 (555) 123-4567" placeholder="Enter phone number">
                        </div>
                        <div class="form-group">
                            <label for="profileRole">Role</label>
                            <select id="profileRole" class="form-select">
                                <option value="farm-manager">Farm Manager</option>
                                <option value="supervisor">Supervisor</option>
                                <option value="operator">Operator</option>
                                <option value="admin">Administrator</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveProfileSettings()">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>

                <!-- Security Settings -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-shield-alt"></i> Security Settings</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" class="form-input" placeholder="Enter current password">
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" class="form-input" placeholder="Enter new password">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm new password">
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="twoFactorAuth">
                                <span class="checkmark"></span>
                                Enable Two-Factor Authentication
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="sessionTimeout">
                                <span class="checkmark"></span>
                                Auto-logout after 30 minutes of inactivity
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveSecuritySettings()">
                            <i class="fas fa-save"></i> Update Security
                        </button>
                    </div>
                </div>

                <!-- Notification Preferences -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-bell"></i> Notification Preferences</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="emailNotifications" checked>
                                <span class="checkmark"></span>
                                Email Notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="smsNotifications">
                                <span class="checkmark"></span>
                                SMS Notifications
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="feedScheduleAlerts" checked>
                                <span class="checkmark"></span>
                                Feed Schedule Alerts
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="systemAlerts" checked>
                                <span class="checkmark"></span>
                                System Alerts
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="weeklyReports">
                                <span class="checkmark"></span>
                                Weekly Summary Reports
                            </label>
                        </div>
                        <button class="btn btn-primary" onclick="saveNotificationSettings()">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- System Settings Section -->
        <section id="system-settings" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1>System Settings</h1>
                <p>Configure farm management and system preferences</p>
            </div>

            <div class="settings-grid">
                <!-- Farm Management -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-warehouse"></i> Farm Management</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="defaultFarm">Default Farm</label>
                            <select id="defaultFarm" class="form-select">
                                <option value="VAS">Vassilakos Farm (VAS)</option>
                                <option value="EDG">EDG Farm (EDG)</option>
                                <option value="APO">Apostolakos Farm (APO)</option>
                                <option value="SIG">Sigma Farm (SIG)</option>
                                <option value="DFI">DFI Farm (DFI)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="timezone">Timezone</label>
                            <select id="timezone" class="form-select">
                                <option value="EST">Eastern Standard Time (EST)</option>
                                <option value="CST">Central Standard Time (CST)</option>
                                <option value="MST">Mountain Standard Time (MST)</option>
                                <option value="PST">Pacific Standard Time (PST)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateFormat">Date Format</label>
                            <select id="dateFormat" class="form-select">
                                <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="temperatureUnit">Temperature Unit</label>
                            <select id="temperatureUnit" class="form-select">
                                <option value="celsius">Celsius (°C)</option>
                                <option value="fahrenheit">Fahrenheit (°F)</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveFarmSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <!-- Data Export -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-download"></i> Data Export</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label for="exportFormat">Default Export Format</label>
                            <select id="exportFormat" class="form-select">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel (.xlsx)</option>
                                <option value="csv">CSV</option>
                                <option value="json">JSON</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="autoBackup" checked>
                                <span class="checkmark"></span>
                                Automatic Daily Backup
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="includeMetadata">
                                <span class="checkmark"></span>
                                Include Metadata in Exports
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="retentionPeriod">Data Retention Period</label>
                            <select id="retentionPeriod" class="form-select">
                                <option value="1">1 Year</option>
                                <option value="2">2 Years</option>
                                <option value="3">3 Years</option>
                                <option value="5">5 Years</option>
                                <option value="10">10 Years</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveDataSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>

                <!-- Integration Settings -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-plug"></i> Integration Settings</h2>
                    </div>
                    <div class="settings-content">
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="weatherIntegration" checked>
                                <span class="checkmark"></span>
                                Weather Service Integration
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="marketDataIntegration">
                                <span class="checkmark"></span>
                                Market Data Integration
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="supplierIntegration">
                                <span class="checkmark"></span>
                                Supplier System Integration
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="apiKey">API Key</label>
                            <input type="password" id="apiKey" class="form-input" placeholder="Enter API key for integrations">
                        </div>
                        <button class="btn btn-primary" onclick="saveIntegrationSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </section>
        <!-- Employee Registry Section -->
        <section id="employee-registry" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1>Employee Registry</h1>
                <p>Manage farm employees, roles, and access permissions</p>
            </div>

            <div class="employee-management">
                <!-- Add New Employee -->
                <div class="employee-card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-plus"></i> Add New Employee</h2>
                    </div>
                    <div class="employee-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmployeeFirstName">First Name</label>
                                <input type="text" id="newEmployeeFirstName" class="form-input" placeholder="Enter first name">
                            </div>
                            <div class="form-group">
                                <label for="newEmployeeLastName">Last Name</label>
                                <input type="text" id="newEmployeeLastName" class="form-input" placeholder="Enter last name">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmployeeEmail">Email Address</label>
                                <input type="email" id="newEmployeeEmail" class="form-input" placeholder="Enter email address">
                            </div>
                            <div class="form-group">
                                <label for="newEmployeePhone">Phone Number</label>
                                <input type="tel" id="newEmployeePhone" class="form-input" placeholder="Enter phone number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmployeeRole">Role</label>
                                <select id="newEmployeeRole" class="form-select">
                                    <option value="">Select Role</option>
                                    <option value="farm-manager">Farm Manager</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="operator">Operator</option>
                                    <option value="technician">Technician</option>
                                    <option value="laborer">Laborer</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newEmployeeFarm">Assigned Farm</label>
                                <select id="newEmployeeFarm" class="form-select">
                                    <option value="">Select Farm</option>
                                    <option value="VAS">Vassilakos Farm (VAS)</option>
                                    <option value="EDG">EDG Farm (EDG)</option>
                                    <option value="APO">Apostolakos Farm (APO)</option>
                                    <option value="SIG">Sigma Farm (SIG)</option>
                                    <option value="DFI">DFI Farm (DFI)</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newEmployeeStartDate">Start Date</label>
                                <input type="date" id="newEmployeeStartDate" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="newEmployeeStatus">Status</label>
                                <select id="newEmployeeStatus" class="form-select">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="on-leave">On Leave</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary" onclick="addNewEmployee()">
                                <i class="fas fa-plus"></i> Add Employee
                            </button>
                            <button class="btn btn-outline" onclick="clearEmployeeForm()">
                                <i class="fas fa-times"></i> Clear Form
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Employee List -->
                <div class="employee-card">
                    <div class="card-header">
                        <h2><i class="fas fa-users"></i> Employee Directory</h2>
                        <div class="employee-search">
                            <input type="text" id="employeeSearch" class="form-input" placeholder="Search employees...">
                            <select id="employeeFilter" class="form-select">
                                <option value="all">All Employees</option>
                                <option value="active">Active Only</option>
                                <option value="farm-manager">Farm Managers</option>
                                <option value="supervisor">Supervisors</option>
                                <option value="operator">Operators</option>
                            </select>
                        </div>
                    </div>
                    <div class="employee-list" id="employeeList">
                        <!-- Employee cards will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Notifications Section -->
        <section id="notifications" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1>Notifications</h1>
                <p>Manage your notification preferences and view recent alerts</p>
            </div>

            <div class="notifications-grid">
                <!-- Notification Preferences -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-bell"></i> Notification Preferences</h2>
                    </div>
                    <div class="settings-content">
                        <div class="notification-category">
                            <h3>Feed Schedule Alerts</h3>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="feedScheduleEmail" checked>
                                    <span class="checkmark"></span>
                                    Email Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="feedScheduleSMS">
                                    <span class="checkmark"></span>
                                    SMS Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="feedSchedulePush" checked>
                                    <span class="checkmark"></span>
                                    Push Notifications
                                </label>
                            </div>
                        </div>
                        <div class="notification-category">
                            <h3>System Alerts</h3>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="systemEmail" checked>
                                    <span class="checkmark"></span>
                                    Email Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="systemSMS">
                                    <span class="checkmark"></span>
                                    SMS Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="systemPush" checked>
                                    <span class="checkmark"></span>
                                    Push Notifications
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveNotificationPreferences()">
                            <i class="fas fa-save"></i> Save Preferences
                        </button>
                    </div>
                </div>

                <!-- Recent Notifications -->
                <div class="settings-card">
                    <div class="card-header">
                        <h2><i class="fas fa-history"></i> Recent Notifications</h2>
                    </div>
                    <div class="notifications-list" id="recentNotifications">
                        <!-- Notifications will be populated dynamically -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Help & Support Section -->
        <section id="help-support" class="app-section" style="display: none;">
            <div class="section-header">
                <button class="btn btn-outline" onclick="backToDashboard()">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </button>
                <h1>Help & Support</h1>
                <p>Get help with using the system and contact support</p>
            </div>

            <div class="help-grid">
                <!-- Quick Help -->
                <div class="help-card">
                    <div class="card-header">
                        <h2><i class="fas fa-question-circle"></i> Quick Help</h2>
                    </div>
                    <div class="help-content">
                        <div class="help-item">
                            <h3>How to Upload Feed Schedules</h3>
                            <p>Learn how to upload and manage feed schedule PDFs for your farms.</p>
                            <button class="btn btn-outline btn-sm" onclick="showHelpVideo('feed-upload')">
                                <i class="fas fa-play"></i> Watch Video
                            </button>
                        </div>
                        <div class="help-item">
                            <h3>Managing Employee Access</h3>
                            <p>Set up employee accounts and manage their access permissions.</p>
                            <button class="btn btn-outline btn-sm" onclick="showHelpVideo('employee-management')">
                                <i class="fas fa-play"></i> Watch Video
                            </button>
                        </div>
                        <div class="help-item">
                            <h3>System Settings Guide</h3>
                            <p>Configure your farm management preferences and system settings.</p>
                            <button class="btn btn-outline btn-sm" onclick="showHelpVideo('system-settings')">
                                <i class="fas fa-play"></i> Watch Video
                            </button>
                        </div>
                    </div>
                </div>

                <!-- FAQ -->
                <div class="help-card">
                    <div class="card-header">
                        <h2><i class="fas fa-comments"></i> Frequently Asked Questions</h2>
                    </div>
                    <div class="faq-content">
                        <div class="faq-item">
                            <h3>How do I reset my password?</h3>
                            <p>Go to Profile Settings > Security Settings and click "Change Password".</p>
                        </div>
                        <div class="faq-item">
                            <h3>Can I export data from the system?</h3>
                            <p>Yes, you can export data in various formats from the System Settings > Data Export section.</p>
                        </div>
                        <div class="faq-item">
                            <h3>How do I add a new farm?</h3>
                            <p>Contact your system administrator to add new farms to the network.</p>
                        </div>
                        <div class="faq-item">
                            <h3>What file formats are supported for uploads?</h3>
                            <p>Currently, only PDF files are supported for feed schedule uploads.</p>
                        </div>
                    </div>
                </div>

                <!-- Contact Support -->
                <div class="help-card">
                    <div class="card-header">
                        <h2><i class="fas fa-headset"></i> Contact Support</h2>
                    </div>
                    <div class="support-content">
                        <div class="support-method">
                            <h3><i class="fas fa-envelope"></i> Email Support</h3>
                            <p>support@flockview.com</p>
                            <p>Response time: 24 hours</p>
                        </div>
                        <div class="support-method">
                            <h3><i class="fas fa-phone"></i> Phone Support</h3>
                            <p>1-800-FLOCK-VIEW</p>
                            <p>Available: Mon-Fri 8AM-6PM EST</p>
                        </div>
                        <div class="support-method">
                            <h3><i class="fas fa-comments"></i> Live Chat</h3>
                            <p>Available during business hours</p>
                            <button class="btn btn-primary" onclick="startLiveChat()">
                                <i class="fas fa-comments"></i> Start Chat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Calendar Section -->
        <section id="calendar" class="app-section" style="display: none;">
            <div class="calendar-container">
                <!-- Streamlined Calendar Header -->
                <div class="calendar-header-compact">
                    <!-- Top Row: Title and Main Controls -->
                    <div class="calendar-header-top">
                        <div class="calendar-title-with-arrows">
                            <h1 id="currentMonthTitle">January 2025</h1>
                            <div class="calendar-nav-arrows">
                                <button class="btn btn-outline btn-sm nav-btn" onclick="previousPeriod()" title="Previous">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <button class="btn btn-outline btn-sm nav-btn" onclick="nextPeriod()" title="Next">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="calendar-controls-main">
                        <div class="view-toggle">
                            <button class="btn btn-outline btn-sm view-btn active" id="monthViewBtn" onclick="switchToMonthView()">
                                <i class="fas fa-calendar-alt"></i> Month
                            </button>
                            <button class="btn btn-outline btn-sm view-btn" id="weekViewBtn" onclick="switchToWeekView()">
                                <i class="fas fa-calendar-week"></i> Week
                            </button>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="addNewNoteFromCalendar()" title="Add New Note">
                            <i class="fas fa-plus"></i> Add Event
                        </button>
                    </div>
                </div>

                    <!-- Bottom Row: Filters and Legend Combined -->
                    <div class="calendar-filters-compact">
                        <div class="filters-left">
                            <div class="filter-group-inline">
                                <label>Types:</label>
                                <div class="filter-buttons-compact">
                                    <button class="filter-btn-compact active" data-type="all" onclick="filterEvents('all')">All</button>
                                    <button class="filter-btn-compact" data-type="feed-schedule" onclick="filterEvents('feed-schedule')">Feed</button>
                                    <button class="filter-btn-compact" data-type="note" onclick="filterEvents('note')">Notes</button>
                                    <button class="filter-btn-compact" data-type="crop-start" onclick="filterEvents('crop-start')">Start</button>
                                    <button class="filter-btn-compact" data-type="crop-end" onclick="filterEvents('crop-end')">End</button>
                        </div>
                    </div>
                            <div class="filter-group-inline">
                        <label>Farm:</label>
                                <select class="farm-filter-compact" onchange="filterByFarmCalendar(this.value)">
                            <option value="all">All Farms</option>
                            <option value="VAS">Vassilakos</option>
                            <option value="EDG">EDG Farm</option>
                            <option value="APO">Apostolakos</option>
                            <option value="SIG">Sigma</option>
                            <option value="DFI">DFI</option>
                        </select>
                    </div>
                            <div class="filter-group-inline" id="barnFilterGroup" style="display: none;">
                        <label>Barn:</label>
                                <select class="barn-filter-compact" onchange="filterByBarnCalendar(this.value)">
                            <option value="all">All Barns</option>
                            <option value="B1">Barn 1</option>
                            <option value="B2">Barn 2</option>
                            <option value="B3">Barn 3</option>
                            <option value="B4">Barn 4</option>
                        </select>
                    </div>
                </div>
                        <div class="legend-compact">
                            <span class="legend-title-compact">Colors:</span>
                            <div class="legend-items-compact">
                                <span class="legend-color farm-vas"></span><span class="legend-label-compact">VAS</span>
                                <span class="legend-color farm-edg"></span><span class="legend-label-compact">EDG</span>
                                <span class="legend-color farm-apo"></span><span class="legend-label-compact">APO</span>
                                <span class="legend-color farm-sig"></span><span class="legend-label-compact">SIG</span>
                                <span class="legend-color farm-dfi"></span><span class="legend-label-compact">DFI</span>
                        </div>
                        </div>
                    </div>
                </div>


                <!-- Calendar Grid -->
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar will be populated dynamically -->
                </div>
                
                <!-- Day Events Panel -->
                <div id="calendarDayEventsPanel" class="calendar-day-events" style="display: none;"></div>
            </div>
        </section>

        <!-- Event Popup Modal -->
        <div id="eventPopupOverlay" class="event-popup-overlay" style="display: none;">
            <div class="event-popup">
                <div class="event-popup-header">
                    <h3 class="event-popup-title" id="eventPopupTitle">Events</h3>
                    <button class="event-popup-close" onclick="closeEventPopup()">&times;</button>
                </div>
                <div class="event-popup-content" id="eventPopupContent">
                    <!-- Events will be populated here -->
                </div>
            </div>
        </div>

        <!-- Notes Section -->
        <section id="notes" class="app-section" style="display: none;">
            <div class="section-header">
                <h1>Farm Notes</h1>
                <p>Create and manage notes for farm operations</p>
            </div>

            <div class="notes-dashboard-streamlined">
                <!-- Notes Header with Actions -->
                <div class="notes-header-wide">
                    <div class="notes-title-section">
                        <h2>Farm Notes</h2>
                        <p>Create and manage notes for farm operations</p>
                    </div>
                    <div class="notes-actions">
                        <button class="btn btn-primary" onclick="toggleNoteForm()">
                            <i class="fas fa-plus"></i> New Note
                        </button>
                    </div>
                </div>
                
                <!-- Floating Action Button -->
                <div class="fab-container">
                    <button class="fab-button" onclick="toggleNoteForm()" id="fabButton">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>

                <!-- Note Form Overlay -->
                <div class="note-form-overlay" id="noteFormOverlay" style="display: none;">
                    <div class="note-form-modal">
                        <div class="form-header">
                            <h3>Create New Note</h3>
                            <button class="close-form" onclick="toggleNoteForm()">&times;</button>
                        </div>
                        <form id="quickNoteForm" class="note-form-streamlined" onsubmit="createNote(event)">
                            <div class="title-input">
                                <input type="text" id="noteTitle" placeholder="Note title..." required>
                            </div>
                            
                            <div class="form-row-compact">
                                <div class="farm-select">
                                    <select id="noteFarm" required>
                                        <option value="ALL">All Farms</option>
                                        <option value="VAS">VAS - Vassilakos</option>
                                        <option value="EDG">EDG - EDG Farm</option>
                                        <option value="APO">APO - Apostolakos</option>
                                        <option value="SIG">SIG - Sigma Farm</option>
                                        <option value="DFI">DFI - DFI Farm</option>
                                    </select>
                                </div>
                                <div class="barn-select">
                                    <select id="noteBarn">
                                        <option value="ALL">All Barns</option>
                                        <option value="B1">Barn 1</option>
                                        <option value="B2">Barn 2</option>
                                        <option value="B3">Barn 3</option>
                                        <option value="B4">Barn 4</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row-compact datetime-row">
                                <div class="date-input">
                                    <input type="date" id="noteDate" required>
                                </div>
                                <div class="time-input">
                                    <label for="noteTime">Time (optional)</label>
                                    <input type="time" id="noteTime">
                                </div>
                            </div>
                            
                            <div class="content-input">
                                <textarea id="noteContent" placeholder="Note content..." rows="4" required></textarea>
                            </div>
                            
                            <div class="color-picker-section">
                                <button type="button" class="color-picker-toggle" onclick="toggleColorPicker()">
                                    <i class="fas fa-palette"></i> Color (optional)
                                </button>
                                <div class="color-picker-panel" id="colorPickerPanel" style="display: none;">
                                    <div class="color-swatches">
                                        <button type="button" class="color-swatch" data-color="#2563eb" style="--swatch:#2563eb" onclick="setNoteColor('#2563eb')" title="Blue"></button>
                                        <button type="button" class="color-swatch" data-color="#dc2626" style="--swatch:#dc2626" onclick="setNoteColor('#dc2626')" title="Red"></button>
                                        <button type="button" class="color-swatch" data-color="#059669" style="--swatch:#059669" onclick="setNoteColor('#059669')" title="Green"></button>
                                        <button type="button" class="color-swatch" data-color="#d97706" style="--swatch:#d97706" onclick="setNoteColor('#d97706')" title="Amber"></button>
                                        <button type="button" class="color-swatch" data-color="#7c3aed" style="--swatch:#7c3aed" onclick="setNoteColor('#7c3aed')" title="Purple"></button>
                                        <button type="button" class="color-swatch" data-color="#0ea5e9" style="--swatch:#0ea5e9" onclick="setNoteColor('#0ea5e9')" title="Sky"></button>
                                    </div>
                                    <div class="color-input-inline">
                                        <label for="noteColor">Custom</label>
                                        <input type="color" id="noteColor" value="#2563eb" onchange="setNoteColor(this.value)">
                                    </div>
                                </div>
                            </div>
                            
                            
                            
                            <div class="form-actions-streamlined">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Note
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Smart Search Container -->
                <div class="smart-search-container">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="notesSearchInput" placeholder="Search notes..." onkeyup="searchNotes()">
                        <button class="search-submit" onclick="searchNotes()" title="Search">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="search-filters-toggle" onclick="toggleSearchFilters()" id="searchFiltersToggle" title="Filters">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                    </div>
                    
                    <div class="search-filters" id="searchFilters" style="display: none;">
                        <div class="filter-row">
                            <select id="farmFilter" onchange="filterNotes()">
                                <option value="">All Farms</option>
                                <option value="VAS">VAS - Vassilakos</option>
                                <option value="EDG">EDG - EDG Farm</option>
                                <option value="APO">APO - Apostolakos</option>
                                <option value="SIG">SIG - Sigma Farm</option>
                                <option value="DFI">DFI - DFI Farm</option>
                            </select>
                            
                            <select id="dateFilter" onchange="filterNotes()">
                                <option value="">All Months</option>
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                    </div>
                    
                </div>

                <!-- Notes Container -->
                <div class="notes-container" id="notesContainer">
                    <div class="notes-loading-streamlined">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading notes...</p>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- PDF Viewer Modal -->
    <div id="pdfModal" class="modal" style="display: none;">
        <div class="modal-content pdf-viewer-modal">
            <div class="modal-header">
                <h3 id="pdfModalTitle">PDF Viewer</h3>
                <div class="modal-actions">
                    <button class="close-btn" onclick="closePdfModal()">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div id="pdfViewerContainer">
                    <div id="pdfLoading" class="pdf-loading">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Loading PDF...</p>
                    </div>
                    <div id="pdfError" class="pdf-error" style="display: none;">
                        <div class="error-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <p>Unable to load PDF. You can still download the file.</p>
                        <button class="btn btn-primary" id="downloadFallback">
                            <i class="fas fa-download"></i> Download PDF
                        </button>
                    </div>
                    <div id="pdfContent" class="pdf-content" style="display: none;">
                        <div class="pdf-iframe-container">
                            <iframe id="pdfIframe" frameborder="0"></iframe>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Farm data structure
        const farms = {
            vassilakos: {
                name: "Vassilakos Farm",
                code: "VAS",
                barns: {
                    "barn-1": {
                        name: "Barn 1",
                        software: {
                            "vas-b1-F1-MC": { name: "Daily Records", description: "Monitor and log mortality rates and environment readings for the floor area", priority: "High Priority", file: "barnsoftwares/dailymortality.html" },
                            "vas-b1-F2-MC": { name: "Visitor Log", description: "Register and track all visitor access to maintain biosecurity", priority: "Security", file: "barnsoftwares/vistorlog.html" },
                            "vas-b1-FL": { name: "Flock Log", description: "Comprehensive flock data, health records, and performance metrics", priority: "Management", file: "barnsoftwares/flexample.html" },
                            "vas-b1-SF": { name: "Mortality Card", description: "Detailed mortality tracking and floor-specific management", priority: "Floor 1", file: "barnsoftwares/mortalitycard.html" },
                            "vas-b1-SPC": { name: "Shipping Form", description: "Process shipments and manage transport logistics", priority: "Logistics", file: "barnsoftwares/shippingform.html" },
                            "vas-b1-VF": { name: "New Crop Setup", description: "Initialize new production cycle and setup procedures", priority: "Setup", file: "barnsoftwares/startnewcrop.html" }
                        }
                    },
                    "barn-2": { name: "Barn 2", software: {} },
                    "barn-3": { name: "Barn 3", software: {} },
                    "barn-4": { name: "Barn 4", software: {} }
                }
            },
            edg: {
                name: "EDG Farm",
                code: "EDG",
                barns: {
                    "barn-1": { name: "Barn 1", software: {} },
                    "barn-2": { name: "Barn 2", software: {} },
                    "barn-3": { name: "Barn 3", software: {} },
                    "barn-4": { name: "Barn 4", software: {} }
                }
            },
            apostolakos: {
                name: "Apostolakos Farm",
                code: "APO",
                barns: {
                    "barn-1": { name: "Barn 1", software: {} },
                    "barn-2": { name: "Barn 2", software: {} },
                    "barn-3": { name: "Barn 3", software: {} },
                    "barn-4": { name: "Barn 4", software: {} }
                }
            },
            sigma: {
                name: "Sigma Farm",
                code: "SIG",
                barns: {
                    "barn-1": { name: "Barn 1", software: {} },
                    "barn-2": { name: "Barn 2", software: {} },
                    "barn-3": { name: "Barn 3", software: {} },
                    "barn-4": { name: "Barn 4", software: {} }
                }
            },
            dfi: {
                name: "DFI Farm",
                code: "DFI",
                barns: {
                    "barn-1": { name: "Barn 1", software: {} },
                    "barn-2": { name: "Barn 2", software: {} },
                    "barn-3": { name: "Barn 3", software: {} },
                    "barn-4": { name: "Barn 4", software: {} }
                }
            }
        };

        let currentFarm = null;
        let currentBarn = null;

        // Navigation functions
        function navigateToSection(sectionId) {
            document.querySelectorAll('.app-section').forEach(section => {
                section.style.display = 'none';
            });
            document.getElementById(sectionId).style.display = 'block';

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            // Load data when specific sections are opened
            if (sectionId === 'feed-schedules') {
                console.log('🔄 Feed Schedules tab opened, loading schedules...');
                if (window.loadFeedSchedules) {
                    window.loadFeedSchedules();
                }
            } else if (sectionId === 'calendar') {
                console.log('📅 Calendar tab opened, loading feed schedules and updating display...');
                // Load feed schedules for calendar and then update display
                if (window.loadFeedSchedulesForCalendar) {
                    window.loadFeedSchedulesForCalendar().then(() => {
                        setTimeout(() => {
                            updateCalendarDisplay();
                        }, 100);
                    });
                } else {
                    setTimeout(() => {
                    updateCalendarDisplay();
                    }, 100);
                }
            } else if (sectionId === 'notes') {
                console.log('📝 Notes tab opened, loading notes...');
                console.log('🔍 window.loadNotes exists:', !!window.loadNotes);
                console.log('🔍 db exists:', typeof db !== 'undefined');
                if (window.loadNotes) {
                    window.loadNotes();
                } else {
                    console.error('❌ window.loadNotes function not found!');
                }
            }
        }

        function navigateToFarm(farmId) {
            currentFarm = farmId;
            const farm = farms[farmId];

            document.getElementById('farm-detail-title').textContent = farm.name;
            document.getElementById('farm-detail-subtitle').textContent = `Manage barns and operations for ${farm.name}`;

            // Populate barn grid
            const barnGrid = document.getElementById('barn-grid');
            barnGrid.innerHTML = '';

            Object.entries(farm.barns).forEach(([barnId, barn]) => {
                const barnCard = document.createElement('div');
                barnCard.className = 'barn-card';
                barnCard.onclick = () => navigateToBarn(barnId);

                const isFunctional = farmId === 'vassilakos' && barnId === 'barn-1';
                const statusClass = isFunctional ? 'active' : 'inactive';
                const statusText = isFunctional ? 'Functional' : 'Coming Soon';

                barnCard.innerHTML = `
                    <div class="barn-header">
                        <h3>${barn.name}</h3>
                        <span class="barn-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="barn-info">
                        <p>${isFunctional ? 'Full software suite available' : 'Software integration in progress'}</p>
                    </div>
                    <div class="barn-actions">
                        <button class="btn ${isFunctional ? 'btn-primary' : 'btn-outline'}" onclick="event.stopPropagation(); ${isFunctional ? `navigateToBarn('${barnId}')` : 'showComingSoon()'}">
                            <i class="fas fa-cog"></i> ${isFunctional ? 'Manage' : 'Coming Soon'}
                        </button>
                    </div>
                `;

                barnGrid.appendChild(barnCard);
            });

            navigateToSection('farm-detail');
        }

        function navigateToBarn(barnId) {
            if (currentFarm !== 'vassilakos' || barnId !== 'barn-1') {
                showComingSoon();
                return;
            }

            currentBarn = barnId;
            const farm = farms[currentFarm];
            const barn = farm.barns[barnId];

            document.getElementById('barn-software-title').textContent = `${farm.name} - ${barn.name}`;
            document.getElementById('barn-software-subtitle').textContent = 'Select a software module to manage barn operations';

            // Populate software grid
            const softwareGrid = document.getElementById('software-grid');
            softwareGrid.innerHTML = '';

            Object.entries(barn.software).forEach(([softwareId, software]) => {
                const softwareCard = document.createElement('div');
                softwareCard.className = 'software-card';
                softwareCard.onclick = () => openSoftware(software.file);

                softwareCard.innerHTML = `
                    <div class="software-header">
                        <h3>${software.name}</h3>
                    </div>
                    <div class="software-info">
                        <p>${software.description}</p>
                    </div>
                    <div class="software-actions">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); openSoftware('${software.file}')">
                            <i class="fas fa-external-link-alt"></i> Open
                        </button>
                    </div>
                `;
                
                // Apply priority color as top border
                const priorityClass = getPriorityClass(software.priority);
                softwareCard.classList.add(`priority-${priorityClass}`);

                softwareGrid.appendChild(softwareCard);
            });

            navigateToSection('barn-software');
        }

        // Profile Dropdown Functions
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function openProfileSettings() {
            navigateToSection('profile-settings');
            closeProfileDropdown();
        }

        function openSystemSettings() {
            navigateToSection('system-settings');
            closeProfileDropdown();
        }

        function openNotifications() {
            navigateToSection('notifications');
            closeProfileDropdown();
        }

        function openHelp() {
            navigateToSection('help-support');
            closeProfileDropdown();
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                alert('Signing out...\n\nThis will redirect you to the login page.');
                // In a real application, this would clear session data and redirect
                closeProfileDropdown();
            }
        }

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.remove('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const trigger = document.querySelector('.profile-trigger');
            
            if (!dropdown.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        function openSoftware(filePath) {
            window.open(filePath, '_blank');
        }

        function backToDashboard() {
            currentFarm = null;
            currentBarn = null;
            navigateToSection('dashboard');
        }

        function backToFarms() {
            currentFarm = null;
            currentBarn = null;
            navigateToSection('dashboard');
        }

        function backToBarns() {
            currentBarn = null;
            navigateToSection('farm-detail');
        }

        function getPriorityClass(priority) {
            switch (priority) {
                case 'High Priority': return 'high-priority';
                case 'Optimization': return 'optimization';
                case 'Security': return 'security';
                case 'Management': return 'management';
                case 'Floor 1': return 'floor-1';
                case 'Logistics': return 'logistics';
                case 'Setup': return 'setup';
                default: return 'default';
            }
        }

        function showComingSoon() {
            alert('This feature is coming soon! Only Vassilakos Farm - Barn 1 is currently functional.');
        }

        function viewAllAlerts() {
            alert('Alert management system coming soon!');
        }

        // Settings Functions
        function saveProfileSettings() {
            const firstName = document.getElementById('profileFirstName').value;
            const lastName = document.getElementById('profileLastName').value;
            const email = document.getElementById('profileEmail').value;
            const phone = document.getElementById('profilePhone').value;
            const role = document.getElementById('profileRole').value;

            if (!firstName || !lastName || !email) {
                alert('Please fill in all required fields (First Name, Last Name, Email)');
                return;
            }

            // Update the profile display
            document.querySelector('.profile-trigger .user-name').textContent = `${firstName} ${lastName}`;
            document.querySelector('.profile-details h4').textContent = `${firstName} ${lastName}`;

            alert('Profile settings saved successfully!');
        }

        function saveSecuritySettings() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword && newPassword !== confirmPassword) {
                alert('New passwords do not match!');
                return;
            }

            if (newPassword && newPassword.length < 8) {
                alert('New password must be at least 8 characters long!');
                return;
            }

            // Clear password fields
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';

            alert('Security settings updated successfully!');
        }

        function saveNotificationSettings() {
            const emailNotifications = document.getElementById('emailNotifications').checked;
            const smsNotifications = document.getElementById('smsNotifications').checked;
            const feedScheduleAlerts = document.getElementById('feedScheduleAlerts').checked;
            const systemAlerts = document.getElementById('systemAlerts').checked;
            const weeklyReports = document.getElementById('weeklyReports').checked;

            alert('Notification preferences saved successfully!');
        }

        function saveFarmSettings() {
            const defaultFarm = document.getElementById('defaultFarm').value;
            const timezone = document.getElementById('timezone').value;
            const dateFormat = document.getElementById('dateFormat').value;
            const temperatureUnit = document.getElementById('temperatureUnit').value;

            alert('Farm settings saved successfully!');
        }

        function saveDataSettings() {
            const exportFormat = document.getElementById('exportFormat').value;
            const autoBackup = document.getElementById('autoBackup').checked;
            const includeMetadata = document.getElementById('includeMetadata').checked;
            const retentionPeriod = document.getElementById('retentionPeriod').value;

            alert('Data export settings saved successfully!');
        }

        function saveIntegrationSettings() {
            const weatherIntegration = document.getElementById('weatherIntegration').checked;
            const marketDataIntegration = document.getElementById('marketDataIntegration').checked;
            const supplierIntegration = document.getElementById('supplierIntegration').checked;
            const apiKey = document.getElementById('apiKey').value;

            alert('Integration settings saved successfully!');
        }

        // Employee Registry Functions
        let employees = [
            {
                id: 1,
                firstName: 'John',
                lastName: 'Smith',
                email: 'john.smith@farm.com',
                phone: '+1 (555) 123-4567',
                role: 'farm-manager',
                farm: 'VAS',
                startDate: '2023-01-15',
                status: 'active'
            },
            {
                id: 2,
                firstName: 'Sarah',
                lastName: 'Johnson',
                email: 'sarah.johnson@farm.com',
                phone: '+1 (555) 234-5678',
                role: 'supervisor',
                farm: 'EDG',
                startDate: '2023-03-20',
                status: 'active'
            },
            {
                id: 3,
                firstName: 'Mike',
                lastName: 'Davis',
                email: 'mike.davis@farm.com',
                phone: '+1 (555) 345-6789',
                role: 'operator',
                farm: 'APO',
                startDate: '2023-02-10',
                status: 'active'
            }
        ];

        function addNewEmployee() {
            const firstName = document.getElementById('newEmployeeFirstName').value;
            const lastName = document.getElementById('newEmployeeLastName').value;
            const email = document.getElementById('newEmployeeEmail').value;
            const phone = document.getElementById('newEmployeePhone').value;
            const role = document.getElementById('newEmployeeRole').value;
            const farm = document.getElementById('newEmployeeFarm').value;
            const startDate = document.getElementById('newEmployeeStartDate').value;
            const status = document.getElementById('newEmployeeStatus').value;

            if (!firstName || !lastName || !email || !role || !farm) {
                alert('Please fill in all required fields');
                return;
            }

            const newEmployee = {
                id: employees.length + 1,
                firstName,
                lastName,
                email,
                phone,
                role,
                farm,
                startDate,
                status
            };

            employees.push(newEmployee);
            loadEmployees();
            clearEmployeeForm();
            alert('Employee added successfully!');
        }

        function clearEmployeeForm() {
            document.getElementById('newEmployeeFirstName').value = '';
            document.getElementById('newEmployeeLastName').value = '';
            document.getElementById('newEmployeeEmail').value = '';
            document.getElementById('newEmployeePhone').value = '';
            document.getElementById('newEmployeeRole').value = '';
            document.getElementById('newEmployeeFarm').value = '';
            document.getElementById('newEmployeeStartDate').value = '';
            document.getElementById('newEmployeeStatus').value = 'active';
        }

        function loadEmployees() {
            const employeeList = document.getElementById('employeeList');
            const searchTerm = document.getElementById('employeeSearch').value.toLowerCase();
            const filterValue = document.getElementById('employeeFilter').value;

            let filteredEmployees = employees.filter(employee => {
                const matchesSearch = employee.firstName.toLowerCase().includes(searchTerm) ||
                                    employee.lastName.toLowerCase().includes(searchTerm) ||
                                    employee.email.toLowerCase().includes(searchTerm);
                const matchesFilter = filterValue === 'all' || employee.role === filterValue || employee.status === filterValue;
                return matchesSearch && matchesFilter;
            });

            employeeList.innerHTML = '';

            filteredEmployees.forEach(employee => {
                const employeeCard = document.createElement('div');
                employeeCard.className = 'employee-item';
                employeeCard.innerHTML = `
                    <div class="employee-info">
                        <div class="employee-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="employee-details">
                            <h4>${employee.firstName} ${employee.lastName}</h4>
                            <p>${employee.email}</p>
                            <p>${employee.phone}</p>
                        </div>
                    </div>
                    <div class="employee-meta">
                        <span class="employee-role">${getRoleDisplayName(employee.role)}</span>
                        <span class="employee-farm">${employee.farm}</span>
                        <span class="employee-status ${employee.status}">${employee.status}</span>
                    </div>
                    <div class="employee-actions">
                        <button class="btn btn-outline btn-sm" onclick="editEmployee(${employee.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline btn-sm" onclick="deleteEmployee(${employee.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                employeeList.appendChild(employeeCard);
            });
        }

        function getRoleDisplayName(role) {
            const roleNames = {
                'farm-manager': 'Farm Manager',
                'supervisor': 'Supervisor',
                'operator': 'Operator',
                'technician': 'Technician',
                'laborer': 'Laborer'
            };
            return roleNames[role] || role;
        }

        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                alert(`Edit employee: ${employee.firstName} ${employee.lastName}\n\nThis feature will be implemented in the next update.`);
            }
        }

        function deleteEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (employee && confirm(`Are you sure you want to delete ${employee.firstName} ${employee.lastName}?`)) {
                employees = employees.filter(emp => emp.id !== id);
                loadEmployees();
                alert('Employee deleted successfully!');
            }
        }

        // Notification Functions
        function saveNotificationPreferences() {
            alert('Notification preferences saved successfully!');
        }

        function loadRecentNotifications() {
            const notificationsList = document.getElementById('recentNotifications');
            const notifications = [
                {
                    type: 'feed-schedule',
                    title: 'New Feed Schedule Uploaded',
                    message: 'VAS B3 feed schedule has been uploaded successfully',
                    time: '2 hours ago',
                    read: false
                },
                {
                    type: 'system',
                    title: 'System Maintenance',
                    message: 'Scheduled maintenance completed successfully',
                    time: '1 day ago',
                    read: true
                },
                {
                    type: 'alert',
                    title: 'Temperature Alert',
                    message: 'Temperature in VAS B1 is above normal range',
                    time: '3 days ago',
                    read: true
                }
            ];

            notificationsList.innerHTML = '';
            notifications.forEach(notification => {
                const notificationItem = document.createElement('div');
                notificationItem.className = `notification-item ${notification.type} ${notification.read ? 'read' : 'unread'}`;
                notificationItem.innerHTML = `
                    <div class="notification-icon">
                        <i class="fas ${getNotificationIcon(notification.type)}"></i>
                    </div>
                    <div class="notification-content">
                        <h4>${notification.title}</h4>
                        <p>${notification.message}</p>
                        <span class="notification-time">${notification.time}</span>
                    </div>
                `;
                notificationsList.appendChild(notificationItem);
            });
        }

        function getNotificationIcon(type) {
            const icons = {
                'feed-schedule': 'fa-calendar',
                'system': 'fa-cog',
                'alert': 'fa-exclamation-triangle'
            };
            return icons[type] || 'fa-bell';
        }

        // Help & Support Functions
        function showHelpVideo(videoType) {
            alert(`Loading help video for: ${videoType}\n\nThis feature will be implemented in the next update.`);
        }

        function startLiveChat() {
            alert('Starting live chat...\n\nThis feature will be implemented in the next update.');
        }

        // Update user name display from session storage
        function updateUserNameDisplay() {
            const displayName = sessionStorage.getItem('flockview_display_name');
            const firstName = sessionStorage.getItem('flockview_first_name');
            const lastName = sessionStorage.getItem('flockview_last_name');
            const email = sessionStorage.getItem('flockview_email');
            
            const fullName = displayName || `${firstName || ''} ${lastName || ''}`.trim() || 'Farm Manager';
            
            // Update header
            const headerUserName = document.getElementById('headerUserName');
            if (headerUserName) {
                headerUserName.textContent = fullName;
            }
            
            // Update profile dropdown
            const profileUserName = document.getElementById('profileUserName');
            if (profileUserName) {
                profileUserName.textContent = fullName;
            }
            
            const profileUserEmail = document.getElementById('profileUserEmail');
            if (profileUserEmail && email) {
                profileUserEmail.textContent = email;
            }
            
            console.log('👤 USER DISPLAY: Updated to', fullName);
        }

        // Initialize navigation
        document.addEventListener('DOMContentLoaded', function () {
            // Update user name display
            updateUserNameDisplay();
            // Set up navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    navigateToSection(sectionId);
                });
            });

            // Initialize employee registry
            loadEmployees();

            // Set up employee search and filter
            const employeeSearch = document.getElementById('employeeSearch');
            const employeeFilter = document.getElementById('employeeFilter');

            if (employeeSearch) {
                employeeSearch.addEventListener('input', loadEmployees);
            }

            if (employeeFilter) {
                employeeFilter.addEventListener('change', loadEmployees);
            }

            // Load notifications when notifications section is accessed
            const notificationsSection = document.getElementById('notifications');
            if (notificationsSection) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            if (notificationsSection.style.display === 'block') {
                                loadRecentNotifications();
                            }
                        }
                    });
                });
                observer.observe(notificationsSection, { attributes: true });
            }
        });
    </script>
    <style>
        /* CSS Variables */
        :root {
            --primary-blue: #2563eb;
            --secondary-blue: #3b82f6;
            --accent-blue: #60a5fa;
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --border-color: #e5e7eb;
            --bg-secondary: #f9fafb;
            --bg-hover: #f3f4f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        /* Profile Dropdown Styles */
        .profile-dropdown {
            position: relative;
        }

        .profile-trigger {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .profile-trigger:hover {
            background: var(--bg-hover);
        }

        .profile-trigger .user-avatar {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .profile-trigger .user-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .profile-trigger .fa-chevron-down {
            color: var(--text-secondary);
            transition: transform 0.3s ease;
        }

        .profile-dropdown.active .fa-chevron-down {
            transform: rotate(180deg);
        }

        .profile-menu {
            position: absolute;
            top: 100%;
            right: 0;
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1000;
            margin-top: 0.5rem;
        }

        .profile-dropdown.active .profile-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-avatar {
            width: 48px;
            height: 48px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .profile-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .profile-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .profile-actions {
            padding: 0.5rem;
        }

        .profile-action {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .profile-action:hover {
            background: var(--bg-hover);
            color: var(--primary-blue);
        }

        .profile-action i {
            width: 16px;
            color: var(--text-secondary);
        }

        .profile-action:hover i {
            color: var(--primary-blue);
        }

        .profile-divider {
            height: 1px;
            background: var(--border-color);
            margin: 0.5rem 0;
        }

        .profile-action.logout {
            color: #dc2626;
        }

        .profile-action.logout:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .profile-action.logout i {
            color: #dc2626;
        }
        
        /* Additional styles for the new components */
        .farm-overview {
            margin-top: 1rem;
        }

        .farm-summary {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .farm-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            gap: 1rem;
        }

        .farm-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-blue);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Farm Color Coding */
        .farm-icon.vas {
            background: #dc3545; /* Red for VAS */
        }

        .farm-icon.edg {
            background: #6f42c1; /* Purple for EDG */
        }

        .farm-icon.apo {
            background: #28a745; /* Green for APO */
        }

        .farm-icon.sig {
            background: #fd7e14; /* Orange for SIG */
        }

        .farm-icon.dfi {
            background: #17a2b8; /* Cyan for DFI */
        }

        /* Farm color coding for feed items */
        .feed-item.vas {
            border-left: 4px solid #dc3545;
        }

        .feed-item.edg {
            border-left: 4px solid #6f42c1;
        }

        .feed-item.apo {
            border-left: 4px solid #28a745;
        }

        .feed-item.sig {
            border-left: 4px solid #fd7e14;
        }

        .feed-item.dfi {
            border-left: 4px solid #17a2b8;
        }

        /* Farm color coding for upcoming feed items */
        .upcoming-feed-item.vas {
            border-left: 4px solid #dc3545;
        }

        .upcoming-feed-item.edg {
            border-left: 4px solid #6f42c1;
        }

        .upcoming-feed-item.apo {
            border-left: 4px solid #28a745;
        }

        .upcoming-feed-item.sig {
            border-left: 4px solid #fd7e14;
        }

        .upcoming-feed-item.dfi {
            border-left: 4px solid #17a2b8;
        }

        .farm-details {
            flex: 1;
        }

        /* Quick Calendar Access Styles */
        .quick-calendar-access {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .calendar-access-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--primary-blue);
            border-radius: 8px;
            gap: 1rem;
            color: white;
            transition: all 0.3s ease;
        }

        .calendar-access-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .calendar-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .calendar-details {
            flex: 1;
        }

        .calendar-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 1rem;
            font-weight: 600;
            color: white;
        }

        .calendar-details p {
            margin: 0;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.4;
        }

        .calendar-access-item .btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            transition: all 0.3s ease;
        }

        .calendar-access-item .btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .farm-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
        }

        .farm-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .dashboard-top-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .farms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .farm-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .farm-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .farm-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .farm-status {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .farm-status.active {
            background: var(--success-green);
            color: white;
        }

        .farm-status.inactive {
            background: var(--warning-orange);
            color: white;
        }

        .farm-info h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .farm-info p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
        }

        .farm-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .farm-stats span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .farm-actions {
            display: flex;
            justify-content: flex-end;
        }

        .barn-selection {
            margin-top: 2rem;
        }

        .barn-selection h2 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .barn-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .barn-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .barn-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .barn-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .barn-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .barn-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .barn-status.active {
            background: var(--success-green);
            color: white;
        }

        .barn-status.inactive {
            background: var(--light-gray);
            color: white;
        }

        .barn-info p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .barn-actions {
            display: flex;
            justify-content: flex-end;
        }

        .software-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .software-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .software-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: transparent;
        }

        .software-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-blue);
        }

        .software-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .software-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
            line-height: 1.3;
        }

        /* Priority-based top border colors */
        .software-card.priority-high-priority::before {
            background: #dc2626;
        }

        .software-card.priority-security::before {
            background: #7c3aed;
        }

        .software-card.priority-management::before {
            background: #059669;
        }

        .software-card.priority-floor-1::before {
            background: #ea580c;
        }

        .software-card.priority-logistics::before {
            background: #2563eb;
        }

        .software-card.priority-optimization::before {
            background: #e91e63;
        }

        .software-card.priority-setup::before {
            background: #0891b2;
        }

        .software-card.priority-default::before {
            background: var(--success-green);
        }

        .software-info p {
            margin: 0 0 1.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .software-actions {
            display: flex;
            justify-content: flex-end;
        }

        .software-actions .btn {
            min-width: 100px;
            justify-content: center;
        }

        .alert-list {
            margin-top: 1rem;
        }

        .alert-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            gap: 0.75rem;
        }

        .alert-item.warning {
            background: #fef3c7;
            border-left: 4px solid var(--warning-orange);
        }

        .alert-item.info {
            background: #dbeafe;
            border-left: 4px solid var(--accent-blue);
        }

        .alert-item.success {
            background: #d1fae5;
            border-left: 4px solid var(--success-green);
        }

        .alert-item i {
            margin-top: 0.125rem;
            font-size: 1.125rem;
        }

        .alert-item.warning i {
            color: var(--warning-orange);
        }

        .alert-item.info i {
            color: var(--accent-blue);
        }

        .alert-item.success i {
            color: var(--success-green);
        }

        .alert-content {
            flex: 1;
        }

        .alert-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .alert-content p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .alert-time {
            color: var(--text-light);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--secondary-blue);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .btn-outline:hover {
            background: var(--primary-blue);
            color: white;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
                 /* Quick Upload Styles */
         .quick-upload-section {
             padding: 1rem;
         }

         .quick-upload-area {
             border: 2px dashed var(--border-color);
             border-radius: 8px;
             padding: 1.5rem;
             text-align: center;
             transition: all 0.3s ease;
             background: var(--bg-secondary);
         }

         .quick-upload-area:hover,
         .quick-upload-area.drag-over {
             border-color: var(--primary-blue);
             background: var(--bg-hover);
         }

         .quick-upload-area i {
             font-size: 2.5rem;
             color: var(--text-light);
             margin-bottom: 0.75rem;
         }

         .quick-upload-area h4 {
             margin: 0 0 0.5rem 0;
             color: var(--text-primary);
             font-size: 1.125rem;
         }

         .quick-upload-area p {
             margin: 0 0 1rem 0;
             color: var(--text-secondary);
             font-size: 0.875rem;
         }

         .quick-location-selector {
             display: flex;
             gap: 0.75rem;
             margin-bottom: 1rem;
             padding: 0.75rem;
             background: white;
             border-radius: 6px;
             border: 1px solid var(--border-color);
         }

         .quick-selector-group {
             flex: 1;
             display: flex;
             flex-direction: column;
             gap: 0.25rem;
         }

         .quick-selector-group label {
             font-size: 0.75rem;
             font-weight: 500;
             color: var(--text-primary);
             margin: 0;
         }

         .quick-selector-group .form-select {
             padding: 0.375rem;
             font-size: 0.75rem;
         }

         .quick-feed-preview {
             padding: 1rem;
             border-top: 1px solid var(--border-color);
         }

         .quick-feed-preview h4 {
             margin: 0 0 0.75rem 0;
             color: var(--text-primary);
             font-size: 0.875rem;
         }

         .quick-feed-info {
             background: var(--bg-secondary);
             padding: 0.75rem;
             border-radius: 6px;
             font-size: 0.875rem;
             color: var(--text-secondary);
         }

         /* Modern Feed Schedules Page Styles */
         .feed-schedules-dashboard {
             display: flex;
             flex-direction: column;
             gap: 2rem;
             margin-top: 2rem;
             width: 100%;
             max-width: none;
         }

         /* Streamlined Feed Schedules Styles */
         .feed-schedules-dashboard-streamlined {
             display: flex;
             flex-direction: column;
             gap: 1.5rem;
             margin-top: 1rem;
             width: 100%;
         }

         .feed-schedules-header-wide {
             display: flex;
             justify-content: space-between;
             align-items: flex-start;
             padding: 1.5rem 0;
             border-bottom: 1px solid var(--border-color);
         }

         .feed-schedules-title-section h2 {
             font-size: 1.5rem;
             font-weight: 700;
             color: var(--text-primary);
             margin: 0 0 0.25rem 0;
         }

         .feed-schedules-title-section p {
             color: var(--text-secondary);
             margin: 0;
             font-size: 0.875rem;
         }

         .feed-schedules-actions {
             display: flex;
             gap: 0.75rem;
             align-items: center;
         }

         .farm-filter-tabs {
             display: flex;
             gap: 0.5rem;
             padding: 1rem 0;
             border-bottom: 1px solid var(--border-color);
             flex-wrap: wrap;
         }

         .farm-filter-tab {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             padding: 0.5rem 1rem;
             border: 1px solid var(--border-color);
             border-radius: 8px;
             background: white;
             color: var(--text-secondary);
             font-size: 0.875rem;
             font-weight: 500;
             cursor: pointer;
             transition: all 0.2s ease;
         }

         .farm-filter-tab:hover {
             border-color: var(--primary-blue);
             color: var(--primary-blue);
         }

         .farm-filter-tab.active {
             background: var(--primary-blue);
             color: white;
             border-color: var(--primary-blue);
         }

         .upload-area-streamlined {
             border: 2px dashed var(--border-color);
             border-radius: 12px;
             padding: 2rem;
             text-align: center;
             background: var(--gray-50);
             transition: all 0.2s ease;
             cursor: pointer;
         }

         .upload-area-streamlined:hover {
             border-color: var(--primary-blue);
             background: #f8fafc;
         }

         .upload-area-streamlined.drag-over {
             border-color: var(--primary-blue);
             background: #e0f2fe;
         }

         .upload-area-streamlined .upload-content {
             display: flex;
             flex-direction: column;
             align-items: center;
             gap: 0.75rem;
         }

         .upload-area-streamlined .upload-content i {
             font-size: 2rem;
             color: var(--primary-blue);
         }

         .upload-area-streamlined .upload-content p {
             margin: 0;
             font-size: 1rem;
             color: var(--text-primary);
         }

         .upload-area-streamlined .upload-content .upload-link {
             color: var(--primary-blue);
             text-decoration: underline;
             cursor: pointer;
         }

         .upload-area-streamlined .upload-content small {
             color: var(--text-secondary);
             font-size: 0.75rem;
         }

         .feed-schedules-grid {
             display: grid;
             grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
             gap: 1.5rem;
             margin-top: 1rem;
         }

         .quick-upload-section {
             height: fit-content;
         }

         .upload-card.modern {
             background: #ffffff;
             border-radius: 16px;
             padding: 1.5rem;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             border: 1px solid #e2e8f0;
             transition: all 0.3s ease;
         }

         .upload-card.modern:hover {
             transform: translateY(-2px);
             box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
         }

         .upload-header h2 {
             margin: 0 0 0.5rem 0;
             color: var(--text-primary);
             font-size: 1.25rem;
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-weight: 600;
         }

         .upload-header p {
             margin: 0;
             color: var(--text-secondary);
             font-size: 0.875rem;
             line-height: 1.4;
         }

         .file-upload-area.modern {
             border: 2px dashed #cbd5e1;
             border-radius: 12px;
             padding: 2rem 1.5rem;
             text-align: center;
             transition: all 0.3s ease;
             background: #f8fafc;
             margin: 1rem 0;
         }

         .file-upload-area.modern:hover,
         .file-upload-area.modern.drag-over {
             border-color: #3b82f6;
             background: #eff6ff;
             transform: scale(1.02);
         }

         .upload-icon {
             margin-bottom: 1rem;
         }

         .upload-icon i {
             font-size: 2.5rem;
             color: #3b82f6;
         }

         .file-upload-area.modern h4 {
             margin: 0 0 0.5rem 0;
             color: var(--text-primary);
             font-size: 1rem;
             font-weight: 600;
         }

         .file-upload-area.modern p {
             margin: 0 0 1rem 0;
             color: var(--text-secondary);
             font-size: 0.875rem;
         }

         .btn.modern {
             border-radius: 8px;
             font-weight: 500;
             transition: all 0.2s ease;
             padding: 0.75rem 1.5rem;
         }

         .btn-primary.modern {
             background: #2563eb;
             border: none;
             color: white;
         }

         .btn-primary.modern:hover {
             background: #1d4ed8;
             transform: translateY(-1px);
         }

         .btn-outline.modern {
             background: transparent;
             border: 2px solid #e2e8f0;
             color: var(--text-primary);
         }

         .btn-outline.modern:hover {
             border-color: #3b82f6;
             color: #3b82f6;
             background: #eff6ff;
         }

         .btn-danger.modern {
             background: #dc2626;
             border: none;
             color: white;
         }

         .btn-danger.modern:hover {
             background: #b91c1c;
         }

         .location-selector-grid {
             display: grid;
             grid-template-columns: 1fr;
             gap: 1rem;
             margin: 1rem 0;
         }

         .selector-group label {
             display: block;
             margin-bottom: 0.5rem;
             font-weight: 500;
             color: var(--text-primary);
             font-size: 0.875rem;
         }

         .form-select.modern {
             width: 100%;
             padding: 0.75rem;
             border: 2px solid #e2e8f0;
             border-radius: 8px;
             background: white;
             font-size: 0.875rem;
             transition: all 0.2s ease;
         }

         .form-select.modern:focus {
             outline: none;
             border-color: #3b82f6;
             box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
         }

         .location-actions {
             display: flex;
             gap: 0.75rem;
             margin-top: 1rem;
         }

         .schedules-display-section {
             background: white;
             border-radius: 16px;
             padding: 1.5rem;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             border: 1px solid #e2e8f0;
         }

         .schedules-header.modern {
             display: flex;
             flex-direction: column;
             gap: 2rem;
             margin-bottom: 2rem;
             padding: 2rem;
             background: #ffffff;
             border-radius: 16px;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             border: 1px solid #e2e8f0;
             width: 100%;
             position: relative;
             overflow: hidden;
         }

         .schedules-header.modern::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 4px;
             background: #2563eb;
         }

         .header-top {
             display: flex;
             justify-content: space-between;
             align-items: center;
             width: 100%;
             gap: 2rem;
             margin-bottom: 1rem;
         }

         .header-bottom {
             display: flex;
             justify-content: space-between;
             align-items: center;
             width: 100%;
             gap: 2rem;
             margin-bottom: 1.5rem;
         }

         .header-left {
             display: flex;
             flex-direction: column;
             gap: 1.5rem;
             min-width: 300px;
         }

         .header-title-section {
             display: flex;
             flex-direction: column;
             gap: 1rem;
         }

         .header-title-section h2 {
             margin: 0;
             color: var(--text-primary);
             font-size: 1.5rem;
             font-weight: 600;
         }

         .header-center {
             display: flex;
             flex-direction: column;
             gap: 1.5rem;
             align-items: center;
             flex: 1;
             justify-content: center;
         }

         .header-actions {
             display: flex;
             align-items: center;
             gap: 1rem;
             flex-wrap: wrap;
             justify-content: flex-end;
             min-width: 200px;
         }

         .header-left {
             flex: 1;
             display: flex;
             align-items: center;
             gap: 2rem;
             min-width: 300px;
         }

         .header-title-section {
             display: flex;
             align-items: center;
             gap: 1rem;
             flex-shrink: 0;
         }

         .title-icon {
             width: 48px;
             height: 48px;
             background: #2563eb;
             border-radius: 12px;
             display: flex;
             align-items: center;
             justify-content: center;
             box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
         }

         .title-icon i {
             font-size: 1.5rem;
             color: white;
         }

         .title-content h2 {
             margin: 0 0 0.25rem 0;
             color: var(--text-primary);
             font-size: 1.5rem;
             font-weight: 700;
         }

         .title-content .subtitle {
             margin: 0;
             color: #64748b;
             font-size: 0.875rem;
             font-weight: 500;
         }

         .header-right {
             display: flex;
             flex-direction: column;
             gap: 1rem;
             min-width: 300px;
         }

         .quick-upload-section {
             display: flex;
             align-items: flex-start;
             justify-content: flex-end;
             flex: 1;
         }

         .upload-card.modern.compact {
             padding: 1.25rem;
             background: #ffffff;
             border-radius: 12px;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             border: 1px solid #e2e8f0;
             width: 100%;
             max-width: 500px;
             position: relative;
             overflow: hidden;
         }

         .upload-card.modern.compact::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 4px;
             background: #059669;
         }

         .upload-card.modern.compact .upload-header h3 {
             margin: 0 0 0.25rem 0;
             font-size: 0.95rem;
             color: var(--text-primary);
             font-weight: 600;
         }

         .upload-card.modern.compact .upload-header p {
             margin: 0;
             font-size: 0.8rem;
             color: var(--text-secondary);
             font-weight: 500;
         }

         .file-upload-area.modern.compact {
             padding: 0.75rem;
             border: 2px dashed var(--border-color);
             border-radius: 8px;
             text-align: center;
             margin-top: 0.75rem;
         }

         .file-upload-area.modern.compact h4 {
             margin: 0 0 0.5rem 0;
             font-size: 0.875rem;
         }

         .file-upload-area.modern.compact p {
             margin: 0 0 1rem 0;
             font-size: 0.75rem;
             color: var(--text-secondary);
         }

         .header-left h2 {
             margin: 0 0 0.75rem 0;
             color: var(--text-primary);
             font-size: 1.5rem;
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-weight: 600;
         }

         .schedule-stats {
             display: flex;
             gap: 1rem;
         }

         .stat-card {
             display: flex;
             align-items: center;
             gap: 0.75rem;
             padding: 0.75rem 1rem;
             background: #ffffff;
             border-radius: 10px;
             border: 1px solid #e2e8f0;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
             transition: all 0.3s ease;
         }

         .stat-card:hover {
             transform: translateY(-2px);
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
             border-color: #3b82f6;
         }

         .stat-icon {
             width: 40px;
             height: 40px;
             background: #059669;
             border-radius: 10px;
             display: flex;
             align-items: center;
             justify-content: center;
             box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
         }

         .stat-icon i {
             font-size: 1.25rem;
             color: white;
         }

         .stat-content {
             display: flex;
             flex-direction: column;
             gap: 0.25rem;
         }

         .stat-number {
             font-size: 1.25rem;
             font-weight: 700;
             color: #1e293b;
             line-height: 1;
         }

         .stat-label {
             font-size: 0.875rem;
             color: #64748b;
             font-weight: 500;
         }

         /* Farm Tabs Styles */
         .farm-tabs-container {
             display: flex;
             align-items: center;
             flex: 1;
             justify-content: center;
         }

         .farm-tabs {
             display: flex;
             background: rgba(255, 255, 255, 0.9);
             backdrop-filter: blur(10px);
             border-radius: 12px;
             padding: 0.5rem;
             gap: 0.25rem;
             border: 1px solid rgba(226, 232, 240, 0.8);
             box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
             flex-wrap: wrap;
             justify-content: center;
             width: 100%;
             max-width: 800px;
         }

         .farm-tab {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             padding: 0.75rem 1rem;
             border: none;
             border-radius: 8px;
             background: transparent;
             color: #64748b;
             font-size: 0.875rem;
             font-weight: 600;
             cursor: pointer;
             transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
             white-space: nowrap;
             position: relative;
             overflow: hidden;
             min-width: 100px;
             justify-content: center;
         }

         .farm-tab::before {
             content: '';
             position: absolute;
             top: 0;
             left: -100%;
             width: 100%;
             height: 100%;
             background: transparent;
             transition: left 0.5s;
         }

         .farm-tab:hover::before {
             left: 100%;
         }

         .farm-tab:hover {
             background: #e2e8f0;
             color: #475569;
         }

         .farm-tab.active {
             background: #2563eb;
             color: white;
             box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
             transform: translateY(-2px);
             font-weight: 700;
         }

         .farm-tab i {
             font-size: 0.875rem;
         }

         .farm-tab span {
             font-weight: 500;
         }

         .filter-controls.modern {
             display: flex;
             align-items: center;
             gap: 1rem;
             flex-wrap: wrap;
         }

         .filter-select.modern {
             padding: 0.5rem 0.75rem;
             border: 2px solid #e2e8f0;
             border-radius: 6px;
             background: white;
             font-size: 0.875rem;
             min-width: 150px;
         }

         .pagination-controls.modern {
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }

         .page-info.modern {
             font-size: 0.875rem;
             color: var(--text-secondary);
             font-weight: 500;
             min-width: 80px;
             text-align: center;
         }

         .schedules-container.modern {
             min-height: 400px;
             width: 100%;
         }

         .loading-schedules.modern {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding: 3rem;
             color: var(--text-secondary);
         }

         .loading-spinner {
             margin-bottom: 1rem;
         }

         .loading-spinner i {
             font-size: 2rem;
             color: #3b82f6;
         }

         .empty-schedules {
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             padding: 3rem;
             text-align: center;
             color: var(--text-secondary);
         }

         .empty-schedules i {
             font-size: 3rem;
             margin-bottom: 1rem;
             color: #cbd5e1;
         }

         .empty-schedules p {
             margin: 0.5rem 0;
             font-size: 1rem;
         }

         .empty-schedules p:first-of-type {
             font-size: 1.125rem;
             font-weight: 500;
             color: var(--text-primary);
         }

         /* Modern Schedule Cards */
         .schedule-cards-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
             gap: 2rem;
             margin-top: 1rem;
             width: 100%;
         }

         .schedule-card.modern {
             background: #ffffff;
             border-radius: 16px;
             padding: 1.75rem;
             box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
             border: 1px solid #e2e8f0;
             transition: all 0.3s ease;
             position: relative;
             overflow: hidden;
             backdrop-filter: blur(10px);
         }

         .schedule-card.modern:hover {
             transform: translateY(-4px);
             box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
             border-color: #3b82f6;
         }

         .schedule-card.modern::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 4px;
             background: #3b82f6;
         }

         .schedule-card.modern.vas::before {
             background: #ef4444;
         }

         .schedule-card.modern.apo::before {
             background: #059669;
         }

         .schedule-card.modern.sig::before {
             background: #1d4ed8;
         }

         .schedule-card.modern.dfi::before {
             background: #d97706;
         }

         .schedule-card.modern.edg::before {
             background: #7c3aed;
         }

         .card-header {
             display: flex;
             justify-content: space-between;
             align-items: flex-start;
             margin-bottom: 1rem;
             padding-bottom: 1rem;
             border-bottom: 1px solid #f1f5f9;
         }

         .farm-info h3 {
             margin: 0 0 0.25rem 0;
             color: var(--text-primary);
             font-size: 1.125rem;
             font-weight: 600;
         }

         .upload-date {
             font-size: 0.75rem;
             color: var(--text-secondary);
             font-weight: 500;
         }

         .card-actions {
             display: flex;
             gap: 0.5rem;
         }

         .action-btn {
             width: 32px;
             height: 32px;
             border: none;
             border-radius: 6px;
             display: flex;
             align-items: center;
             justify-content: center;
             cursor: pointer;
             transition: all 0.2s ease;
             font-size: 0.875rem;
         }

         .action-btn.view-btn {
             background: #eff6ff;
             color: #3b82f6;
         }

         .action-btn.view-btn:hover {
             background: #3b82f6;
             color: white;
         }

         .action-btn.download-btn {
             background: #f0fdf4;
             color: #10b981;
         }
         .action-btn.download-btn:hover {
             background: #10b981;
             color: white;
         }

         .action-btn.delete-btn {
             background: #fef2f2;
             color: #ef4444;
         }

         .action-btn.delete-btn:hover {
             background: #ef4444;
             color: white;
         }

         .card-content {
             display: flex;
             flex-direction: column;
             gap: 1rem;
         }

         .schedule-stats {
             display: flex;
             gap: 1.5rem;
         }

         .stat {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             font-size: 0.875rem;
             color: var(--text-secondary);
             font-weight: 500;
         }

         .stat i {
             color: #3b82f6;
             font-size: 1rem;
         }

         .deliveries-preview h4 {
             margin: 0 0 0.75rem 0;
             color: var(--text-primary);
             font-size: 0.875rem;
             font-weight: 600;
         }

         .deliveries-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 0.75rem;
         }

         .deliveries-header h4 {
             margin: 0;
             font-size: 0.875rem;
             color: var(--text-primary);
             font-weight: 600;
         }

         .all-deliveries {
             margin-top: 1rem;
             padding: 1rem;
             background: var(--bg-secondary);
             border-radius: 8px;
             border: 1px solid var(--border-color);
         }

         .all-deliveries h5 {
             margin: 0 0 0.75rem 0;
             font-size: 0.875rem;
             color: var(--text-primary);
             font-weight: 600;
         }

         .all-delivery-list {
             display: flex;
             flex-direction: column;
             gap: 0.5rem;
         }

         .delivery-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.5rem;
             background: white;
             border-radius: 6px;
             border: 1px solid var(--border-color);
         }

         .delivery-date {
             font-weight: 500;
             color: var(--text-primary);
         }

         .delivery-weight {
             font-size: 0.875rem;
             color: var(--text-secondary);
         }

         .delivery-chips {
             display: flex;
             flex-wrap: wrap;
             gap: 0.5rem;
         }

         .delivery-chip {
             display: flex;
             flex-direction: column;
             align-items: center;
             padding: 0.5rem 0.75rem;
             background: #f8fafc;
             border: 1px solid #e2e8f0;
             border-radius: 8px;
             font-size: 0.75rem;
             transition: all 0.2s ease;
             min-width: 80px;
         }

         .delivery-chip:hover {
             background: #eff6ff;
             border-color: #3b82f6;
         }

         .date-text {
             color: var(--text-primary);
             font-weight: 500;
             margin-bottom: 0.25rem;
         }

         .weight-text {
             color: #3b82f6;
             font-weight: 600;
             font-size: 0.7rem;
         }

         .more-deliveries {
             display: flex;
             align-items: center;
             padding: 0.5rem 0.75rem;
             background: #f1f5f9;
             border: 1px solid #e2e8f0;
             border-radius: 8px;
             font-size: 0.75rem;
             color: var(--text-secondary);
             font-weight: 500;
         }

         .no-deliveries {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             padding: 1rem;
             background: #fef2f2;
             border: 1px solid #fecaca;
             border-radius: 8px;
             color: #dc2626;
             font-size: 0.875rem;
             font-weight: 500;
         }

         .no-deliveries i {
             font-size: 1rem;
         }

         /* Responsive Design */
         @media (max-width: 1200px) {
             .header-right {
                 flex-direction: column;
                 gap: 1rem;
             }

             .upload-card.modern.compact {
                 min-width: auto;
                 max-width: none;
             }
         }

         @media (max-width: 1200px) {
             .header-top {
                 flex-direction: column;
                 gap: 1.5rem;
             }
             
             .header-bottom {
                 flex-direction: column;
                 gap: 1.5rem;
             }
             
             .header-left {
                 width: 100%;
             }
             
             .quick-upload-section {
                 width: 100%;
                 max-width: none;
             }

             .upload-card.modern.compact {
                 max-width: 500px;
                 margin: 0 auto;
             }
             
             .farm-tabs-container {
                 width: 100%;
             }
             
             .farm-tabs {
                 max-width: none;
                 flex-wrap: wrap;
                 gap: 0.5rem;
             }

             .farm-tab {
                 padding: 0.5rem 0.75rem;
                 font-size: 0.8rem;
             }
             
             .header-actions {
                 width: 100%;
                 justify-content: center;
                 min-width: auto;
             }
             
             .schedule-cards-grid {
                 grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
             }
         }

         @media (max-width: 768px) {
             .schedules-header.modern {
                 gap: 1.5rem;
             }

             .header-top {
                 gap: 1rem;
             }

             .header-bottom {
                 flex-direction: column;
                 gap: 1rem;
             }

             .header-left {
                 width: 100%;
                 min-width: auto;
             }

             .quick-upload-section {
                 width: 100%;
             }

             .upload-card.modern.compact {
                 max-width: none;
                 margin: 0;
             }

             .farm-tabs-container {
                 width: 100%;
             }

             .farm-tabs {
                 max-width: none;
                 flex-direction: column;
                 width: 100%;
             }

             .farm-tab {
                 width: 100%;
                 justify-content: center;
                 padding: 0.75rem;
                 min-width: auto;
             }

             .header-actions {
                 width: 100%;
                 flex-direction: column;
                 gap: 0.75rem;
                 justify-content: center;
                 min-width: auto;
             }

             .schedule-cards-grid {
                 grid-template-columns: 1fr;
                 gap: 1rem;
             }

             .schedule-stats {
                 flex-direction: column;
                 gap: 0.75rem;
             }

             .stat-card {
                 padding: 0.75rem 1rem;
             }

             .deliveries-header {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 0.5rem;
             }
         }

         .upload-header {
             margin-bottom: 1.5rem;
             text-align: center;
         }

         .upload-header h2 {
             margin: 0 0 0.5rem 0;
             color: var(--text-primary);
             font-size: 1.5rem;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 0.5rem;
         }

         .upload-header p {
             margin: 0;
             color: var(--text-secondary);
             font-size: 0.875rem;
         }

         .upload-content {
             max-width: 600px;
             margin: 0 auto;
         }

         /* File Upload Styles */
         .upload-section {
             padding: 1rem;
         }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            background: var(--bg-secondary);
        }

        .file-upload-area:hover,
        .file-upload-area.drag-over {
            border-color: var(--primary-blue);
            background: var(--bg-hover);
        }

        .file-upload-area i {
            font-size: 3rem;
            color: var(--text-light);
            margin-bottom: 1rem;
        }

        .file-upload-area h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .file-upload-area p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
        }
        
        .upload-note {
            color: #2563eb !important;
            font-size: 0.85rem !important;
            font-style: italic;
            margin-top: 0.5rem !important;
        }

        /* File Location Selector Styles */
        .file-location-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .selector-group {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selector-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin: 0;
        }

        .form-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.875rem;
            background: white;
            color: var(--text-primary);
            cursor: pointer;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .upload-progress {
            padding: 1rem;
            text-align: center;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-blue);
            width: 0%;
            transition: width 0.3s ease;
        }

        .feed-schedule-preview {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .feed-schedule-preview h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .feed-dates-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .feed-date-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 6px;
            border-left: 3px solid var(--primary-blue);
        }

        .feed-date-item i {
            color: var(--primary-blue);
            font-size: 1.25rem;
            margin-top: 0.125rem;
        }

        .feed-date-content h5 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .feed-date-content p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.75rem;
            line-height: 1.4;
        }

        .no-dates {
            text-align: center;
            color: var(--text-secondary);
            font-style: italic;
        }

        .upcoming-alerts {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .upcoming-alerts h4 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
        }

        .alerts-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-content.large {
            max-width: 1400px;
            width: 95vw;
            height: 90vh;
        }

        .modal-content.pdf-viewer-modal {
            max-width: 95vw;
            max-height: 95vh;
            width: 1400px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            z-index: 1001;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: move;
            user-select: none;
        }

        .modal-content.pdf-viewer-modal .modal-header {
            cursor: move;
            background: var(--primary-blue);
            color: white;
        }

        .modal-content.pdf-viewer-modal .modal-header h3 {
            color: white;
        }

        .modal-content.pdf-viewer-modal .close-btn {
            color: white;
        }

        .modal-content.pdf-viewer-modal .close-btn:hover {
            color: #f0f0f0;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            max-height: 60vh;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .modal-body.pdf-viewer-body {
            padding: 0;
            max-height: none;
            overflow: hidden;
        }

        /* PDF Viewer Styles */
        #pdfViewerContainer {
            text-align: center;
            background: #f8f9fa;
            border-radius: 8px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex: 1;
            position: relative;
        }

        .pdf-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            color: var(--text-secondary);
            height: 100%;
            min-height: 300px;
        }

        .loading-spinner {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner i {
            font-size: 1.5rem;
            color: var(--primary-blue);
        }

        .pdf-error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
            color: var(--text-secondary);
            height: 100%;
            min-height: 300px;
        }

        .error-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .error-icon i {
            font-size: 1.5rem;
            color: var(--warning-orange);
        }

        .pdf-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-iframe-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #pdfIframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .modal-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Schedules List Styles */
        .schedules-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding: 1rem;
        }

        .schedule-item {
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            background: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
            position: relative;
        }

        .schedule-item:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
            border-color: var(--primary-blue);
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .schedule-title {
            flex: 1;
        }

        .schedule-title h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1.125rem;
            font-weight: 600;
        }

        .location-badge {
            display: inline-block;
            background: var(--primary-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Farm color coding for location badges */
        .schedule-item.vas .location-badge {
            background: #dc3545; /* Red for VAS */
        }

        .schedule-item.edg .location-badge {
            background: #6f42c1; /* Purple for EDG */
        }

        .schedule-item.apo .location-badge {
            background: #28a745; /* Green for APO */
        }

        .schedule-item.sig .location-badge {
            background: #fd7e14; /* Orange for SIG */
        }

        .schedule-item.dfi .location-badge {
            background: #17a2b8; /* Cyan for DFI */
        }

        .schedule-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .schedule-actions .btn {
            padding: 0.75rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s ease;
            min-width: 100px;
            justify-content: center;
        }

        .schedule-actions .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .schedule-actions .btn-danger {
            background: #dc2626;
            color: white;
            border: 1px solid #dc2626;
        }

        .schedule-actions .btn-danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }

        .schedule-details {
            margin-bottom: 0.75rem;
        }

        .detail-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 0.75rem;
        }

        .schedule-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .schedule-details strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-badge.active {
            background: var(--success-green);
            color: white;
        }

        .schedule-feed-dates h5 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .feed-dates-mini {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .date-badge {
            background: var(--primary-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .more-dates {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-style: italic;
        }

                 .no-schedules {
             text-align: center;
             color: var(--text-secondary);
             font-style: italic;
         }

         /* Location Selection Styles */
         .quick-location-selection,
         .main-location-selection {
             padding: 1.5rem;
             background: var(--bg-secondary);
             border-radius: 8px;
             border: 1px solid var(--border-color);
             margin-top: 1rem;
         }

         .quick-location-selection h4,
         .main-location-selection h4 {
             margin: 0 0 0.5rem 0;
             color: var(--text-primary);
             font-size: 1.125rem;
         }

         .quick-location-selection p,
         .main-location-selection p {
             margin: 0 0 1rem 0;
             color: var(--text-secondary);
             font-size: 0.875rem;
         }

         .location-selection-actions {
             display: flex;
             gap: 0.75rem;
             margin-top: 1rem;
             justify-content: center;
         }

         /* Upcoming Feed Schedules Styles */
         .upcoming-feed-schedules {
             margin-top: 1rem;
         }

         .upcoming-feed-item {
             display: flex;
             justify-content: space-between;
             align-items: center;
             padding: 0.75rem;
             background: var(--bg-secondary);
             border-radius: 8px;
             margin-bottom: 0.5rem;
             border: 1px solid var(--border-color);
             transition: all 0.3s ease;
             max-width: 100%;
         }

         .upcoming-feed-item:hover {
             border-color: var(--primary-blue);
             box-shadow: var(--shadow-sm);
         }

         .feed-date-info {
             flex: 1;
         }

         .feed-date {
             display: flex;
             align-items: center;
             gap: 0.5rem;
             margin-bottom: 0.25rem;
         }

         .feed-date i {
             color: var(--primary-blue);
             font-size: 1rem;
         }

         .feed-date span {
             font-weight: 600;
             color: var(--text-primary);
             font-size: 0.875rem;
         }

         .date-text {
             font-weight: 600;
             color: var(--text-primary);
         }

         .barn-info-bold {
             font-size: 1rem;
             font-weight: 700;
             color: var(--text-primary);
             text-transform: uppercase;
             letter-spacing: 0.5px;
         }

         .weight-badge-bold {
             background: var(--primary-blue);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.875rem;
             font-weight: 700;
             text-align: center;
             min-width: 60px;
         }

         .feed-location {
             color: var(--text-secondary);
             font-size: 0.75rem;
             display: flex;
             flex-direction: column;
             gap: 0.25rem;
         }

         .barn-info {
             font-size: 1.125rem;
             font-weight: 700;
             color: var(--text-primary);
             text-transform: uppercase;
             letter-spacing: 0.5px;
         }

         .farm-info {
             font-size: 0.875rem;
             font-weight: 600;
             color: var(--text-secondary);
         }

         .feed-weight {
             margin-top: 0.5rem;
         }

         .weight-badge {
             background: var(--primary-blue);
             color: white;
             padding: 0.375rem 0.75rem;
             border-radius: 8px;
             font-size: 1rem;
             font-weight: 700;
             text-align: center;
             min-width: 80px;
         }

         .feed-actions {
             display: flex;
             gap: 0.5rem;
         }

         .feed-actions .btn {
             padding: 0.25rem 0.5rem;
             font-size: 0.75rem;
         }

         .view-more-schedules {
             text-align: center;
             margin-top: 1rem;
             padding: 1rem;
             border-top: 1px solid var(--border-color);
         }

         .view-more-schedules .btn {
             background: var(--primary-blue);
             color: white;
             border: none;
             padding: 0.75rem 1.5rem;
             border-radius: 8px;
             font-weight: 600;
             transition: all 0.2s ease;
         }

         .view-more-schedules .btn:hover {
             background: var(--accent-blue);
             transform: translateY(-1px);
         }

         .feed-type-info {
             display: flex;
             gap: 0.5rem;
             margin-top: 0.25rem;
         }

         .feed-type-badge {
             background: var(--primary-blue);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .feed-amount-badge {
             background: var(--success-green);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .feed-plan-info {
             margin-top: 0.25rem;
         }

         .feed-plan-badge {
             background: var(--warning-orange);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .company-badge {
             background: var(--primary-blue);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .bird-type-badge {
             background: var(--success-green);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .no-upcoming-schedules,
         .error-loading {
             text-align: center;
             padding: 2rem;
             color: var(--text-secondary);
         }

         .no-upcoming-schedules i,
         .error-loading i {
             font-size: 2rem;
             margin-bottom: 0.5rem;
             color: var(--text-light);
         }

         .loading-upcoming {
             text-align: center;
             padding: 2rem;
             color: var(--text-secondary);
         }

         .loading-upcoming i {
             font-size: 1.5rem;
             margin-bottom: 0.5rem;
             color: var(--primary-blue);
         }

         /* Feed Schedules Management Styles */
         .feed-schedules-section {
             background: white;
             border-radius: 12px;
             padding: 2rem;
             box-shadow: var(--shadow-md);
             border: 1px solid var(--border-color);
         }

         .schedules-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 2rem;
             flex-wrap: wrap;
             gap: 1rem;
         }

         .schedules-header h2 {
             margin: 0;
             color: var(--text-primary);
             font-size: 1.5rem;
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }

         .schedules-controls {
             display: flex;
             gap: 1rem;
             align-items: center;
             flex-wrap: wrap;
         }

         .search-box {
             position: relative;
             display: flex;
             align-items: center;
         }

         .search-input {
             padding: 0.5rem 1rem 0.5rem 2.5rem;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             font-size: 0.875rem;
             width: 250px;
             background: white;
         }

         .search-input:focus {
             outline: none;
             border-color: var(--primary-blue);
             box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
         }

         .search-box i {
             position: absolute;
             left: 0.75rem;
             color: var(--text-light);
             font-size: 0.875rem;
         }

         .filter-controls {
             display: flex;
             gap: 0.5rem;
             align-items: center;
             flex-wrap: wrap;
         }

         .pagination-controls {
             display: flex;
             align-items: center;
             gap: 0.5rem;
         }

         .page-info {
             font-size: 0.875rem;
             color: var(--text-secondary);
             font-weight: 500;
             min-width: 80px;
             text-align: center;
         }

         .pagination-controls .btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }

         .filter-select {
             padding: 0.5rem;
             border: 1px solid var(--border-color);
             border-radius: 6px;
             font-size: 0.875rem;
             background: white;
             color: var(--text-primary);
             cursor: pointer;
         }

         .filter-select:focus {
             outline: none;
             border-color: var(--primary-blue);
         }
                .schedules-container {
                    display: flex;
                    flex-direction: column;
                    gap: 2rem;
                    width: 100%;
                }
                
                /* Farm Section Styles */
                .farm-section {
                    background: white;
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    overflow: hidden;
                    box-shadow: var(--shadow-sm);
                }
                
                .farm-header {
                    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
                    padding: 1.5rem;
                    border-bottom: 1px solid var(--border-color);
                }
                
                .farm-info {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                }
                
                .farm-info i {
                    color: var(--primary-blue);
                    font-size: 1.5rem;
                }
                
                .farm-info h2 {
                    margin: 0;
                    color: var(--text-primary);
                    font-size: 1.5rem;
                    font-weight: 700;
                }
                
                .schedule-count {
                    background: var(--primary-blue);
                    color: white;
                    padding: 0.25rem 0.75rem;
                    border-radius: 20px;
                    font-size: 0.875rem;
                    font-weight: 500;
                    margin-left: auto;
                }
                
                .farm-date-range {
                    background: var(--bg-secondary);
                    color: var(--text-secondary);
                    padding: 0.25rem 0.75rem;
                    border-radius: 20px;
                    font-size: 0.875rem;
                    font-weight: 500;
                    border: 1px solid var(--border-color);
                }

                /* Farm section color coding */
                .farm-section[data-farm="vas"] .farm-header {
                    background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
                    border-left: 4px solid #dc3545;
                }

                .farm-section[data-farm="edg"] .farm-header {
                    background: linear-gradient(135deg, #faf5ff 0%, #e9d5ff 100%);
                    border-left: 4px solid #6f42c1;
                }

                .farm-section[data-farm="apo"] .farm-header {
                    background: linear-gradient(135deg, #f0fdf4 0%, #bbf7d0 100%);
                    border-left: 4px solid #28a745;
                }

                .farm-section[data-farm="sig"] .farm-header {
                    background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
                    border-left: 4px solid #fd7e14;
                }

                .farm-section[data-farm="dfi"] .farm-header {
                    background: linear-gradient(135deg, #ecfeff 0%, #a5f3fc 100%);
                    border-left: 4px solid #17a2b8;
                }

                .farm-section[data-farm="vas"] .farm-info i {
                    color: #dc3545;
                }

                .farm-section[data-farm="edg"] .farm-info i {
                    color: #6f42c1;
                }

                .farm-section[data-farm="apo"] .farm-info i {
                    color: #28a745;
                }

                .farm-section[data-farm="sig"] .farm-info i {
                    color: #fd7e14;
                }

                .farm-section[data-farm="dfi"] .farm-info i {
                    color: #17a2b8;
                }
                
                /* Schedules List */
                .schedules-list {
                    padding: 1.5rem;
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                }
                
                /* Schedule Item */
                .schedule-item {
                    background: white;
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    padding: 0.75rem;
                    transition: all 0.2s ease;
                    position: relative;
                    max-width: 100%;
                }
                
                .schedule-item:hover {
                    transform: translateY(-1px);
                    box-shadow: var(--shadow-md);
                    border-color: var(--primary-blue);
                }
                
                .schedule-item-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 0.75rem;
                }
                
                .schedule-location {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    flex: 1;
                }
                
                .location-badge {
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 20px;
                    font-size: 0.875rem;
                    font-weight: 600;
                    text-align: center;
                    min-width: 80px;
                }
                
                .schedule-title h3 {
                    margin: 0 0 0.25rem 0;
                    color: var(--text-primary);
                    font-size: 1.125rem;
                    font-weight: 600;
                    line-height: 1.2;
                }
                
                .schedule-date {
                    color: var(--text-secondary);
                    font-size: 0.875rem;
                    font-weight: 500;
                }
                
                .schedule-status {
                    display: flex;
                    align-items: center;
                }
                
                .status-badge {
                    color: white;
                    padding: 0.375rem 0.75rem;
                    border-radius: 16px;
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                /* Schedule Details */
                .schedule-item-details {
                    margin-bottom: 1rem;
                }

                .schedule-location-info {
                    margin-bottom: 1rem;
                }

                .location-details {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background: var(--bg-secondary);
                    border-radius: 8px;
                    padding: 0.75rem;
                    border: 1px solid var(--border-color);
                }

                .farm-barn-info {
                    display: flex;
                    flex-direction: column;
                    gap: 0.25rem;
                }

                .farm-barn-combined {
                    font-size: 1.125rem;
                    font-weight: 700;
                    color: var(--text-primary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .floor-info {
                    font-size: 0.875rem;
                    color: var(--text-secondary);
                    font-weight: 500;
                }

                .total-kgs {
                    display: flex;
                    flex-direction: column;
                    align-items: flex-end;
                    gap: 0.25rem;
                }

                .kgs-label {
                    font-size: 0.75rem;
                    color: var(--text-secondary);
                    font-weight: 500;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }

                .kgs-value {
                    font-size: 1.125rem;
                    font-weight: 700;
                    color: var(--primary-blue);
                    background: var(--primary-blue);
                    color: white;
                    padding: 0.25rem 0.5rem;
                    border-radius: 6px;
                    min-width: 60px;
                    text-align: center;
                }
                
                .extracted-info {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.75rem;
                    margin-bottom: 1rem;
                }
                
                .info-chip {
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 0.375rem 0.75rem;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }
                
                .chip-label {
                    color: var(--text-secondary);
                    font-size: 0.75rem;
                    font-weight: 500;
                }
                
                .chip-value {
                    color: var(--text-primary);
                    font-size: 0.875rem;
                    font-weight: 600;
                }
                
                .feed-dates-preview {
                    display: flex;
                    align-items: flex-start;
                    gap: 1.5rem;
                    background: var(--bg-secondary);
                    padding: 1rem;
                    border-radius: 8px;
                    border: 1px solid var(--border-color);
                }
                
                .dates-label {
                    color: var(--text-primary);
                    font-size: 1rem;
                    font-weight: 600;
                    white-space: nowrap;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                }
                
                .dates-list {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.75rem;
                    padding: 0.5rem 0;
                }
                
                .date-chip {
                    background: var(--primary-blue);
                    color: white;
                    padding: 0.5rem 1rem;
                    border-radius: 12px;
                    font-size: 0.875rem;
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                    white-space: nowrap;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                    border: 2px solid transparent;
                }
                
                .date-chip:hover {
                    background: var(--accent-blue);
                    transform: translateY(-2px);
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
                    border-color: var(--accent-blue);
                }
                
                .more-dates {
                    color: var(--text-secondary);
                    font-size: 0.75rem;
                    font-weight: 500;
                    font-style: italic;
                }
                
                .no-feed-dates {
                    display: flex;
                    align-items: center;
                }
                
                .no-dates-text {
                    color: var(--text-light);
                    font-size: 0.875rem;
                    font-style: italic;
                }
                
                /* Schedule Actions */
                .schedule-item-actions {
                    display: flex !important;
                    gap: 0.5rem;
                    justify-content: flex-end;
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                
                .action-btn {
                    width: 36px;
                    height: 36px;
                    border: none;
                    border-radius: 8px;
                    display: flex !important;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    font-size: 0.875rem;
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                
                .view-btn {
                    background: var(--primary-blue);
                    color: white;
                }
                
                .view-btn:hover {
                    background: var(--accent-blue);
                    transform: scale(1.05);
                }
                
                .download-btn {
                    background: var(--success-color);
                    color: white;
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                
                .download-btn:hover {
                    background: #059669;
                    transform: scale(1.05);
                }
                
                .delete-btn {
                    background: var(--danger-color);
                    color: white;
                    opacity: 1 !important;
                    visibility: visible !important;
                }
                
                .delete-btn:hover {
                    background: #dc2626;
                    transform: scale(1.05);
                }

                /* Force button visibility - override any conflicting styles */
                .schedule-item .schedule-item-actions,
                .schedule-item .schedule-item-actions *,
                .schedule-item .action-btn,
                .schedule-item .view-btn,
                .schedule-item .download-btn,
                .schedule-item .delete-btn {
                    display: flex !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                }

         /* Legacy schedule-card styles removed - using new minimal design */

         .feed-item {
             background: var(--bg-secondary);
             border: 1px solid var(--border-color);
             border-radius: 8px;
             padding: 0.75rem;
         }

         .feed-item-header {
             display: flex;
             justify-content: space-between;
             align-items: center;
             margin-bottom: 0.5rem;
             gap: 0.5rem;
             flex-wrap: wrap;
         }

         .feed-amount {
             background: var(--success-green);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 600;
         }

         .feed-type {
             color: var(--text-primary);
             font-weight: 600;
             font-size: 0.875rem;
         }

         .feed-bin {
             background: var(--primary-blue);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .feed-item-details {
             display: flex;
             flex-direction: column;
             gap: 0.5rem;
         }

         .feed-datetime {
             color: var(--text-secondary);
             font-size: 0.875rem;
             font-weight: 500;
         }

         .feed-medications {
             display: flex;
             flex-wrap: wrap;
             gap: 0.5rem;
         }

         .medication {
             background: var(--warning-orange);
             color: white;
             padding: 0.25rem 0.5rem;
             border-radius: 6px;
             font-size: 0.75rem;
             font-weight: 500;
         }

         .loading-schedules {
             grid-column: 1 / -1;
             text-align: center;
             padding: 3rem;
             color: var(--text-secondary);
         }

         .loading-schedules i {
             font-size: 2rem;
             margin-bottom: 1rem;
             color: var(--primary-blue);
         }

         .empty-schedules {
             grid-column: 1 / -1;
             text-align: center;
             padding: 3rem;
             color: var(--text-secondary);
         }

         .empty-schedules i {
             font-size: 3rem;
             margin-bottom: 1rem;
             color: var(--text-light);
         }

        /* Responsive design */
        @media (max-width: 768px) {
            .dashboard-top-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .farms-grid {
                grid-template-columns: 1fr;
            }

            .barn-grid {
                grid-template-columns: 1fr;
            }

            .software-grid {
                grid-template-columns: 1fr;
            }

            .farm-stats {
                flex-direction: column;
                gap: 0.5rem;
            }

                         .file-location-selector {
                 flex-direction: column;
                 gap: 0.75rem;
             }

             .quick-location-selector {
                 flex-direction: column;
                 gap: 0.5rem;
             }

             .schedules-header {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: 1rem;
             }

             .schedules-controls {
                 width: 100%;
                 flex-direction: column;
                 gap: 0.75rem;
             }

             .search-input {
                 width: 100%;
             }

             .filter-controls {
                 width: 100%;
                 justify-content: space-between;
             }

             .filter-select {
                 flex: 1;
             }

             .schedules-grid {
                 grid-template-columns: 1fr;
             }

             .schedule-card-header {
                 flex-direction: column;
                 gap: 1rem;
                 align-items: flex-start;
             }

             .schedule-card-actions {
                 width: 100%;
                 justify-content: flex-start;
             }

            .detail-row {
                flex-direction: column;
                gap: 0.5rem;
            }

            .schedule-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }

            .schedule-actions {
                width: 100%;
                justify-content: flex-start;
            }

            .modal-content.pdf-viewer-modal {
                width: 95vw;
                height: 95vh;
                max-width: 95vw;
                max-height: 95vh;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-header h3 {
                font-size: 1rem;
            }

            .modal-actions {
                gap: 0.25rem;
            }

            .modal-actions .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.75rem;
            }

            .loading-spinner,
            .error-icon {
                width: 50px;
                height: 50px;
            }

            .loading-spinner i,
            .error-icon i {
                font-size: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .modal-content.pdf-viewer-modal {
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
            }

            .modal-header {
                padding: 0.75rem;
            }

            .modal-header h3 {
                font-size: 0.875rem;
            }

            .modal-actions .btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.7rem;
            }

            .loading-spinner,
            .error-icon {
                width: 40px;
                height: 40px;
            }

            .loading-spinner i,
            .error-icon i {
                font-size: 1rem;
            }
        }

        /* Settings Grid Layout */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .settings-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .settings-card .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .settings-card .card-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .settings-card .card-header h2 i {
            color: var(--primary-blue);
        }

        .settings-content {
            padding: 1.5rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Checkbox Styles */
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            position: relative;
            transition: all 0.3s ease;
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark {
            background: var(--primary-blue);
            border-color: var(--primary-blue);
        }

        .checkbox-label input[type="checkbox"]:checked + .checkmark::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* Employee Registry Styles */
        .employee-management {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .employee-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .employee-card .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .employee-card .card-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .employee-card .card-header h2 i {
            color: var(--primary-blue);
        }

        .employee-search {
            display: flex;
            gap: 1rem;
        }

        .employee-form {
            padding: 1.5rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .employee-list {
            padding: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .employee-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
        }

        .employee-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .employee-details h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
        }

        .employee-details p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .employee-meta {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .employee-role,
        .employee-farm,
        .employee-status {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .employee-role {
            background: var(--primary-blue);
            color: white;
        }

        .employee-farm {
            background: var(--accent-blue);
            color: white;
        }

        .employee-status.active {
            background: var(--success-green);
            color: white;
        }

        .employee-status.inactive {
            background: var(--text-light);
            color: white;
        }

        .employee-status.on-leave {
            background: var(--warning-orange);
            color: white;
        }

        .employee-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Notifications Grid */
        .notifications-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .notification-category {
            margin-bottom: 1.5rem;
        }

        .notification-category h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            transition: all 0.3s ease;
        }

        .notification-item:hover {
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .notification-item.unread {
            border-left: 4px solid var(--primary-blue);
            background: white;
        }

        .notification-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .notification-content h4 {
            margin: 0 0 0.25rem 0;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .notification-content p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .notification-time {
            color: var(--text-light);
            font-size: 0.75rem;
        }

        /* Help & Support Grid */
        .help-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .help-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .help-card .card-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .help-card .card-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .help-card .card-header h2 i {
            color: var(--primary-blue);
        }

        .help-content,
        .faq-content,
        .support-content {
            padding: 1.5rem;
        }

        .help-item,
        .faq-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .help-item:last-child,
        .faq-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .help-item h3,
        .faq-item h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .help-item p,
        .faq-item p {
            margin: 0 0 1rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .support-method {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .support-method:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .support-method h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .support-method h3 i {
            color: var(--primary-blue);
        }

        .support-method p {
            margin: 0 0 0.5rem 0;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

         @media (max-width: 768px) {
            .settings-grid,
            .employee-management,
            .notifications-grid,
            .help-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .employee-search {
                flex-direction: column;
            }

            .employee-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .employee-meta {
                align-items: flex-start;
            }
        }

        .date-text {
            font-weight: 600;
        }

        .date-weight {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.125rem 0.375rem;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Login Page Styles */
        .login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #f8fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-section.active {
            display: flex;
        }

        .login-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 3rem;
            width: 100%;
            max-width: 450px;
            position: relative;
            z-index: 2;
            backdrop-filter: blur(10px);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .login-logo i {
            font-size: 2rem;
            color: var(--primary-blue);
        }

        .login-header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }

        .login-header p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 0;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-wrapper i {
            position: absolute;
            left: 1rem;
            color: var(--text-secondary);
            z-index: 1;
        }

        .input-wrapper input {
            width: 100%;
            padding: 1rem 1rem 1rem 3rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            box-sizing: border-box;
        }

        .input-wrapper input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .password-toggle {
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .password-toggle:hover {
            background: var(--gray-100);
            color: var(--primary-blue);
        }

        .form-options {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0.5rem 0;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary-blue);
        }

        .forgot-password {
            color: var(--primary-blue);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: color 0.2s ease;
        }

        .forgot-password:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .login-btn:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        .login-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-spinner {
            display: none !important;
        }

        .login-btn.loading .btn-text {
            display: none;
        }

        .login-btn.loading .btn-spinner {
            display: block !important;
        }

        .login-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .login-footer {
            text-align: center;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--border-color);
        }

        .login-footer p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .login-footer a {
            color: var(--primary-blue);
            text-decoration: none;
            font-weight: 500;
        }

        .login-footer a:hover {
            text-decoration: underline;
        }


        /* Responsive Login Styles */
        @media (max-width: 768px) {
            .login-card {
                margin: 1rem;
                padding: 2rem;
                border-radius: 16px;
            }

            .login-header h1 {
                font-size: 1.75rem;
            }

            .input-wrapper input {
                padding: 0.875rem 0.875rem 0.875rem 2.75rem;
            }

            .login-btn {
                padding: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            .login-card {
                margin: 0.5rem;
                padding: 1.5rem;
            }

            .login-header h1 {
                font-size: 1.5rem;
            }

            .form-options {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
        }

        /* Multi-Factor Authentication Modal Styles */
        .mfa-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .mfa-modal {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            position: relative;
            animation: mfaSlideIn 0.3s ease-out;
        }

        @keyframes mfaSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .mfa-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .mfa-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }

        .mfa-header p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 0;
        }

        .mfa-content {
            margin-bottom: 2rem;
        }

        .mfa-method {
            background: var(--gray-50);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .mfa-method h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.75rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .mfa-method p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 0 1.5rem 0;
            line-height: 1.5;
        }

        .verification-code {
            margin-top: 1rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .verification-code input {
            flex: 1;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 0.1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .verification-code input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mfa-method input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1.1rem;
            text-align: center;
            letter-spacing: 0.1em;
            font-weight: 600;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .mfa-method input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mfa-footer {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }

        .mfa-footer .btn {
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .mfa-footer .btn:hover {
            transform: translateY(-2px);
        }

        /* reCAPTCHA container */
        #recaptcha-container {
            margin: 1rem 0;
        }

        /* Responsive MFA Styles */
        @media (max-width: 768px) {
            .mfa-modal {
                padding: 2rem;
                margin: 1rem;
                width: calc(100% - 2rem);
            }

            .mfa-header h2 {
                font-size: 1.5rem;
            }

            .verification-code {
                flex-direction: column;
                gap: 1rem;
            }

            .verification-code input,
            .mfa-method input {
                font-size: 1rem;
            }
        }

        @media (max-width: 480px) {
            .mfa-modal {
                padding: 1.5rem;
                border-radius: 16px;
            }

            .mfa-header h2 {
                font-size: 1.25rem;
            }

            .mfa-footer {
                flex-direction: column;
            }
        }

        /* Modern Calendar Styles */
        .calendar-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0.25rem;
        }

        /* Month Navigation Tabs */
        .month-tabs {
            display: flex;
            background: white;
            border-radius: 12px;
            padding: 0.5rem;
            margin-bottom: 0.25rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .month-tabs::-webkit-scrollbar {
            display: none;
        }

        .month-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem 0.75rem;
            margin: 0 0.15rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 50px;
            border: 1px solid transparent;
        }

        .month-tab:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
        }

        .month-tab.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .month-tab .month-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .month-tab .month-year {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .month-tab.active .month-year {
            opacity: 1;
            color: white;
            font-weight: 600;
        }

        /* Compact Calendar Header Styles */
        .calendar-header-compact {
            background: #f8fafc;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.25rem 0.5rem;
            margin-bottom: 0.25rem;
        }

        .calendar-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .calendar-title-with-arrows {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .calendar-title-with-arrows h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .calendar-nav-arrows {
            display: flex;
            gap: 0.25rem;
        }

        .calendar-nav-arrows .nav-btn {
            padding: 0.375rem 0.5rem;
            min-width: auto;
        }

        .calendar-controls-main {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .calendar-filters-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0.25rem 0;
        }

        .filters-left {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group-inline {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .filter-group-inline label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .filter-buttons-compact {
            display: flex;
            gap: 0.125rem;
        }

        .filter-btn-compact {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--gray-600);
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .filter-btn-compact:hover {
            background: var(--light-blue);
            color: var(--primary-blue);
        }

        .filter-btn-compact.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .farm-filter-compact, .barn-filter-compact {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            background: white;
            color: var(--gray-700);
            min-width: 80px;
        }

        .legend-compact {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-title-compact {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.75rem;
            white-space: nowrap;
        }

        .legend-items-compact {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .legend-label-compact {
            font-size: 0.6875rem;
            color: var(--gray-600);
            margin-right: 0.25rem;
        }

        /* Legacy styles for backward compatibility */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-title-section {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .calendar-filters {
            background: #f8fafc;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: 2rem;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .filter-buttons {
            display: flex;
            gap: 0.25rem;
        }

        .filter-btn {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--gray-600);
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn:hover {
            background: var(--light-blue);
            color: var(--primary-blue);
        }

        .filter-btn.active {
            background: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
        }

        .farm-filter, .barn-filter {
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.375rem;
            background: white;
            color: var(--gray-700);
            font-size: 0.875rem;
        }

        .calendar-legend {
            background: #f8fafc;
            padding: 0.75rem 1.5rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .legend-title {
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .legend-items {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            display: inline-block;
        }

        .legend-color.farm-vas {
            background: #dc3545; /* Red for Vassilakos - matching calendar */
        }

        .legend-color.farm-edg {
            background: #6f42c1; /* Purple for EDG Farm - matching calendar */
        }

        .legend-color.farm-apo {
            background: #28a745; /* Green for Apostolakos - matching calendar */
        }

        .legend-color.farm-sig {
            background: #fd7e14; /* Orange for Sigma - matching calendar */
        }

        .legend-color.farm-dfi {
            background: #17a2b8; /* Cyan for DFI - matching calendar */
        }

        .legend-label {
            font-size: 0.75rem;
            color: var(--gray-600);
        }

        .calendar-header h1 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 600;
        }

        .calendar-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .view-toggle {
            display: flex;
            gap: 0.25rem;
            background: var(--gray-100);
            border-radius: 8px;
            padding: 2px;
        }

        .view-btn {
            border: none !important;
            background: transparent !important;
            color: var(--gray-600) !important;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .view-btn.active {
            background: white !important;
            color: var(--primary-blue) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .navigation-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .action-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .calendar-grid {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            min-height: 90vh;
            height: 90vh;
        }

        /* Clean Weekly Calendar Design */
        .calendar-grid.week-view {
            display: flex;
            flex-direction: column;
            width: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: 90vh;
            height: 90vh;
        }

        .week-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 1rem 0;
            box-sizing: border-box;
            width: 100%;
            gap: 0;
        }

        .week-day-header {
            padding: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .week-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 85vh;
            gap: 0;
            width: 100%;
            align-items: start;
        }

        .week-day {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            background: white;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 85vh;
            box-sizing: border-box;
            width: 100%;
            height: auto;
        }

        .week-day:last-child {
            border-right: none;
        }

        .week-day:hover {
            background: #f8f9fa;
        }

        .week-day.today {
            background: #eff6ff;
        }

        .week-day.today .day-number {
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .week-day .day-number {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
            flex-shrink: 0;
        }

        .week-day .events-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            overflow: visible;
            min-height: 0;
            width: 100%;
        }

        .week-event {
            background: #3b82f6;
            color: white;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: normal !important;
            word-break: break-word !important;
            line-height: 1.4;
            flex-shrink: 0;
            cursor: pointer;
            transition: transform 0.2s ease;
            min-height: auto;
            height: auto;
            overflow: visible;
        }

        .week-event:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .week-event-more {
            background: #6b7280;
            color: white;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-style: italic;
            text-align: center;
            margin-top: auto;
            cursor: pointer;
            transition: background-color 0.2s ease;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            white-space: normal !important;
            word-break: break-word !important;
        }

        .week-event-more:hover {
            background: #4b5563;
        }

        /* Week view detailed event styles - better text wrapping */
        .week-event-detailed {
            font-size: 0.6rem;
            line-height: 1.2;
            margin-bottom: 3px;
            padding: 4px;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s ease;
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
        }

        .event-title {
            font-weight: 600;
            margin-bottom: 1px;
            font-size: 0.65rem;
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
        }

        .event-details {
            font-size: 0.55rem;
            opacity: 0.9;
            line-height: 1.1;
            display: block; /* Show details by default in week view */
            word-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
            overflow-wrap: break-word;
        }

        .event-details > div {
            margin-bottom: 1px;
        }

        .event-farm, .event-barn, .event-weight, .event-time, .event-type {
            font-weight: 500;
        }

        .event-content {
            font-style: italic;
            margin-bottom: 2px;
        }

        .event-tags {
            color: rgba(255,255,255,0.8);
            font-size: 0.55rem;
        }


        /* Event text styling - simple and working */
        .event-text {
            font-size: 0.7rem;
            line-height: 1.3;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 3px;
            white-space: normal;
            overflow: hidden;
            max-width: 100%;
            word-wrap: break-word;
            word-break: break-word;
            transition: all 0.2s ease;
            color: white;
            font-weight: 500;
        }
        
        .event-text:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 10;
            position: relative;
        }
        
        /* Ensure event text has proper background visibility */
        .event-text.feed-schedule,
        .event-text.note,
        .event-text.crop-start,
        .event-text.crop-end {
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Clean popup modal styles */
        .event-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .event-popup {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow: hidden;
            position: relative;
            animation: popupSlideIn 0.3s ease-out;
            display: flex;
            flex-direction: column;
        }

        @keyframes popupSlideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .event-popup-header {
            background: var(--primary-blue);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .event-popup-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .event-popup-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .event-popup-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .event-popup-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .event-popup-event {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary-blue);
            position: relative;
        }

        .event-popup-event:last-child {
            margin-bottom: 0;
        }

        .event-popup-event-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .event-popup-event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .event-popup-detail {
            display: flex;
            flex-direction: column;
        }

        .event-popup-detail-label {
            font-size: 0.75rem;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .event-popup-detail-value {
            font-size: 0.9rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .event-popup-event-content {
            background: white;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            border: 1px solid var(--border-color);
        }

        .event-popup-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }

        .event-popup-tag {
            background: var(--primary-blue);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .event-popup-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
            flex-wrap: wrap;
            justify-content: flex-start;
            align-items: center;
        }

        .event-popup-action-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .event-popup-action-btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .event-popup-action-btn.primary:hover {
            background: #2563eb;
        }

        .event-popup-action-btn.outline {
            background: transparent;
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
        }

        .event-popup-action-btn.outline:hover {
            background: var(--primary-blue);
            color: white;
        }

        .event-popup-action-btn.danger {
            background: #dc3545;
            color: white;
        }

        .event-popup-action-btn.danger:hover {
            background: #c82333;
        }

        .week-time-column {
            background: var(--gray-50);
            border-right: 1px solid var(--border-color);
            padding: 0.25rem;
            font-size: 0.7rem;
            color: var(--gray-600);
            display: flex;
            flex-direction: column;
        }

        .week-day-header {
            background: var(--gray-100);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem 0.25rem;
            text-align: center;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .week-day-column {
            border-right: 1px solid var(--border-color);
            min-height: 300px;
            position: relative;
            background: white;
        }

        .week-day-column:last-child {
            border-right: none;
        }

        .week-day-column.today {
            background: rgba(59, 130, 246, 0.05);
        }

        .week-day-column.today .week-day-header {
            background: var(--primary-blue);
            color: white;
        }

        .week-time-slot {
            height: 40px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: var(--gray-500);
        }

        .week-event {
            position: absolute;
            left: 2px;
            right: 2px;
            background: var(--primary-blue);
            color: white;
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.75rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .week-day-column.today {
            background: rgba(59, 130, 246, 0.05);
        }

        .week-day-column.today .week-day-header {
            background: var(--primary-blue);
            color: white;
        }

        .calendar-grid {
            width: 100%;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background: var(--primary-blue);
            color: white;
            font-weight: 600;
            text-align: center;
            padding: 1rem 0;
            box-sizing: border-box;
            width: 100%;
        }

        .weekday {
            padding: 0.5rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }

        .calendar-days {
            display: flex;
            flex-direction: column;
            width: 100%;
        }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            min-height: 120px;
            width: 100%;
            gap: 0;
        }

        .calendar-day {
            border-right: 1px solid var(--border-color);
            border-bottom: 1px solid var(--border-color);
            padding: 0.75rem;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
            min-height: 120px;
            max-height: 120px;
            display: flex;
            flex-direction: column;
            position: relative;
            aspect-ratio: 1;
            box-sizing: border-box;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* Remove right border from last column */
        .calendar-week .calendar-day:nth-child(7n) {
            border-right: none;
        }

        /* Remove bottom border from last row */
        .calendar-days .calendar-week:last-child .calendar-day {
            border-bottom: none;
        }

        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: var(--text-light);
        }

        .calendar-day.today {
            background: #eff6ff;
        }

        .calendar-day.today .day-number {
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .day-number {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .day-events {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            align-items: center;
        }

        .event-text-container {
            margin-top: 4px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-height: 80px;
            overflow: hidden;
            min-height: 20px;
        }

        .event-text {
            font-size: 0.7rem;
            padding: 2px 4px;
            border-radius: 3px;
            color: white;
            white-space: normal;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            line-height: 1.2;
        }

        /* Default background for events without specific type */
        .event-text:not(.feed-schedule):not(.note):not(.vaccination):not(.inspection):not(.maintenance):not(.crop-start):not(.crop-end):not(.view-more) {
            background: var(--primary-blue);
        }

        /* Base feed-schedule color removed - farm-specific colors will be applied via CSS classes and inline styles */
        
        /* Fallback for feed schedules without farm assignment */
        .event-text.feed-schedule:not(.farm-vas):not(.farm-edg):not(.farm-apo):not(.farm-sig):not(.farm-dfi):not(.farm-VAS):not(.farm-EDG):not(.farm-APO):not(.farm-SIG):not(.farm-DFI) {
            background: var(--primary-blue);
        }

        .event-text.note {
            background: #10b981;
        }

        .event-text.vaccination {
            background: #f59e0b;
        }

        .event-text.inspection {
            background: #8b5cf6;
        }

        .event-text.maintenance {
            background: #ef4444;
        }

        .event-text.default {
            background: #6b7280;
        }

        .event-text.crop-start {
            background: #059669;
        }

        .event-text.crop-end {
            background: #dc2626;
        }

        .event-text.view-more {
            background: #6b7280;
            font-style: italic;
            font-size: 0.65rem;
            margin-top: 2px;
            text-align: center;
            font-weight: 600;
        }

        /* Farm-specific color coding for feed schedules - matching Farm Network Overview colors */
        .event-text.feed-schedule.farm-vas,
        .event-text.feed-schedule.farm-VAS {
            background: #dc3545 !important; /* Red for Vassilakos */
        }

        .event-text.feed-schedule.farm-edg,
        .event-text.feed-schedule.farm-EDG {
            background: #6f42c1 !important; /* Purple for EDG Farm */
        }

        .event-text.feed-schedule.farm-apo,
        .event-text.feed-schedule.farm-APO {
            background: #28a745 !important; /* Green for Apostolakos */
        }

        .event-text.feed-schedule.farm-sig,
        .event-text.feed-schedule.farm-SIG {
            background: #fd7e14 !important; /* Orange for Sigma */
        }

        .event-text.feed-schedule.farm-dfi,
        .event-text.feed-schedule.farm-DFI {
            background: #17a2b8 !important; /* Cyan for DFI */
        }


        .calendar-day:hover {
            background: #f8f9fa;
        }

        .calendar-day.other-month {
            background: #f8f9fa;
            color: var(--text-light);
        }

        .calendar-day.today {
            background: #eff6ff;
        }

        .calendar-day.today .day-number {
            background: var(--primary-blue);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .day-header {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.5rem;
        }

        .day-number {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .day-events {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .event-block {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            color: white;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-align: left;
            min-height: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .event-block:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .event-title {
            font-weight: 600;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-weight {
            font-size: 0.7rem;
            opacity: 0.9;
            margin-top: 0.125rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f1f5f9;
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-event-item {
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            background: white;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .event-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .event-type {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .event-details p {
            margin: 0.5rem 0;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .event-details strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .calendar-placeholder {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }

        .calendar-placeholder i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--text-light);
        }

        .calendar-placeholder h3 {
            margin: 0 0 1rem 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .calendar-placeholder p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }

        .calendar-sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            padding: 1.5rem;
        }

        .upcoming-events h3 {
            margin: 0 0 1.5rem 0;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.125rem;
        }

        .events-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .event-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .event-item:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .event-date {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
        }

        .event-day {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-blue);
            line-height: 1;
        }

        .event-month {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 500;
        }
        .event-details h4 {
            margin: 0 0 0.25rem 0;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .event-details p {
            margin: 0;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Responsive Calendar */
        @media (max-width: 768px) {
            .calendar-container {
                padding: 0.5rem;
            }

            .month-tabs {
                padding: 0.25rem;
                margin-bottom: 1rem;
            }

            .month-tab {
                padding: 0.5rem 0.75rem;
                min-width: 50px;
            }

            .month-tab .month-name {
                font-size: 0.75rem;
            }

            .month-tab .month-year {
                font-size: 0.625rem;
            }

            /* Compact header mobile styles */
            .calendar-header-compact {
                padding: 0.5rem;
            }

            .calendar-header-top {
                flex-direction: column;
                gap: 0.5rem;
                text-align: center;
                margin-bottom: 0.5rem;
            }

            .calendar-header-top h1 {
                font-size: 1.25rem;
            }

            .calendar-controls-main {
                justify-content: center;
                flex-direction: column;
                gap: 0.5rem;
            }

            .calendar-filters-compact {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .filters-left {
                justify-content: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .legend-compact {
                justify-content: center;
            }

            .legend-items-compact {
                flex-wrap: wrap;
                justify-content: center;
            }

            /* Legacy header mobile styles */
            .calendar-header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .calendar-header h1 {
                font-size: 1.5rem;
            }

            .calendar-controls {
                justify-content: center;
                flex-direction: column;
                gap: 0.5rem;
            }

            .view-toggle {
                order: 1;
            }

            .navigation-controls {
                order: 2;
            }

            .action-controls {
                order: 3;
            }

            .calendar-grid.week-view .calendar-week {
                min-height: 400px;
            }

            .calendar-grid.week-view .calendar-day {
                padding: 0.75rem;
                min-height: 400px;
            }

            .week-event-detailed {
                font-size: 0.7rem;
                padding: 4px;
            }

            .event-title {
                font-size: 0.75rem;
            }

            .event-details {
                font-size: 0.65rem;
            }

            .day-number {
                font-size: 0.75rem;
            }

            .event-text {
                font-size: 0.6rem;
                padding: 1px 3px;
            }
        }

        @media (max-width: 480px) {
            .month-tabs {
                overflow-x: auto;
                justify-content: flex-start;
            }

            .month-tab {
                flex-shrink: 0;
            }

            .calendar-weekdays {
                padding: 0.75rem 0;
            }

            .weekday {
                font-size: 0.75rem;
                padding: 0.25rem;
            }
        }

        /* Enhanced Notes System Styles */
        .notes-dashboard-streamlined {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            background: #f8fafc;
            min-height: calc(100vh - 200px);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 999;
        }

        .fab-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--primary-blue);
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-button:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(59, 130, 246, 0.4);
        }

        .fab-button:active {
            transform: scale(0.95);
        }

        /* Note Form Overlay */
        .note-form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .note-form-modal {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-header {
            background: var(--primary-blue);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #ffffff !important;
        }

        .close-form {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .close-form:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Note Form Styles */
        .note-form-streamlined {
            padding: 2rem;
        }
        
        /* Color picker compact UI */
        .color-picker-section {
            margin: 0 0 1.25rem 0;
        }
        .color-picker-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: #f1f5f9;
            color: var(--text-primary);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
        }
        .color-picker-toggle:hover {
            background: #e2e8f0;
        }
        .color-picker-panel {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .color-swatches {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .color-swatch {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 2px solid #e2e8f0;
            background: var(--swatch);
            cursor: pointer;
        }
        .color-swatch:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }
        .color-swatch.active {
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
        }
        .color-input-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .color-input-inline input[type="color"] {
            width: 40px;
            height: 32px;
            padding: 0;
            border: none;
            background: transparent;
        }

        .title-input input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: all 0.2s ease;
        }

        .title-input input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-row-compact {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .datetime-row {
            grid-template-columns: 1fr 1fr;
            align-items: end;
        }
        
        .farm-select, .barn-select, .date-input, .time-input {
            display: flex;
            flex-direction: column;
        }
        
        .time-input label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .form-row-compact select, .form-row-compact input {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .form-row-compact select:focus, .form-row-compact input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .content-input textarea {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            color: var(--text-primary);
            line-height: 1.5;
            font-family: inherit;
            margin-bottom: 1.5rem;
            resize: vertical;
            min-height: 120px;
            transition: all 0.2s ease;
        }

        .content-input textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Tags Section */
        .tags-section {
            margin-bottom: 2rem;
        }

        .tags-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }

        .tags-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .tag-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }

        .tag-option:hover {
            border-color: var(--primary-blue);
            background: #f8fafc;
        }

        .tag-option.selected {
            border-color: var(--primary-blue);
            background: var(--primary-blue);
            color: white;
        }

        .tag-option input[type="checkbox"] {
            display: none;
        }

        .tag-name {
            font-weight: 600;
            flex: 1;
        }

        .tag-category {
            font-size: 0.75rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tags-toggle-btn {
            width: 100%;
            margin-top: 0.5rem;
            padding: 0.75rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border: 2px dashed #e2e8f0;
            background: transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .tags-toggle-btn:hover {
            background: #f8fafc;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
        }

        .tags-toggle-btn.expanded {
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            background: #f8fafc;
        }

        .tags-collapse-container {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
        }

        .custom-tag-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .custom-tag-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .custom-tag-input input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions-streamlined {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .form-actions-streamlined button {
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        /* Smart Search Container */
        .smart-search-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-bar i {
            color: var(--text-secondary);
            font-size: 1.125rem;
        }

        .search-bar input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .search-submit, .search-select-toggle {
            padding: 0.65rem 0.75rem;
            background: #f1f5f9;
            color: var(--text-primary);
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .search-submit:hover, .search-select-toggle:hover {
            background: #e2e8f0;
        }
        .search-select-toggle.active {
            background: var(--primary-blue);
            color: #fff;
            border-color: var(--primary-blue);
        }

        .search-bar input:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-filters-toggle {
            padding: 0.75rem;
            background: var(--primary-blue);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .search-filters-toggle:hover {
            background: var(--accent-blue);
        }
        .search-filters-toggle i {
            color: #ffffff;
        }

        .search-filters {
            margin-top: 1rem;
        }

        .bulk-actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        .bulk-actions-bar .select-all {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
        }
        .bulk-actions-buttons {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .filter-row select {
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .filter-row select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Notes Container */
        .notes-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        /* Month Grouping */
        .notes-group {
            grid-column: 1 / -1;
        }
        .notes-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1.25rem 0 0.75rem 0;
            padding: 0.75rem 0.75rem;
            border-left: 4px solid var(--primary-blue);
            background: #eff6ff;
            border-radius: 8px;
        }
        .notes-group-title {
            font-weight: 800;
            font-size: 1.05rem;
            color: var(--primary-blue);
        }
        .notes-group-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }

        .note-card-streamlined {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .note-card-streamlined::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--note-color, var(--primary-blue));
        }

        .note-card-streamlined:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
            border-color: var(--primary-blue);
        }

        .note-header-streamlined {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .note-title-streamlined {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.3;
            flex: 1;
            margin-right: 1rem;
        }


        .note-details {
            padding: 1rem 0;
        }

        .note-meta {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .note-meta p {
            margin: 0.5rem 0;
            color: var(--text-secondary);
        }

        .note-content {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .note-content h4 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .note-content p {
            margin: 0;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .modal-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--gray-50);
        }

        .note-meta-streamlined {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .note-meta-streamlined span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note-meta-streamlined i {
            color: var(--primary-blue);
            width: 14px;
        }

        .note-content-streamlined {
            color: var(--text-primary);
            line-height: 1.6;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-tags-streamlined {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .note-tag-streamlined {
            padding: 0.25rem 0.75rem;
            background: #f1f5f9;
            color: var(--text-secondary);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .note-actions-streamlined {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
        }

        .note-actions-streamlined button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .notes-loading-streamlined {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            grid-column: 1 / -1;
        }

        .notes-loading-streamlined i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--primary-blue);
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            .notes-dashboard-streamlined {
                padding: 1rem;
                margin: 0.5rem;
                border-radius: 12px;
            }

            .form-row-compact {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .tags-container {
                grid-template-columns: 1fr;
            }

            .notes-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .fab-container {
                bottom: 1rem;
                right: 1rem;
            }

            .fab-button {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .note-form-modal {
                width: 95%;
                margin: 0.5rem;
            }

            .note-form-streamlined {
                padding: 1.5rem;
            }

            .custom-tag-input {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .search-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }

            .note-header-streamlined {
                flex-direction: column;
                gap: 0.5rem;
                align-items: flex-start;
            }

            .note-meta-streamlined {
                flex-direction: column;
                gap: 0.5rem;
            }

            .note-actions-streamlined {
                justify-content: center;
            }
        }
    </style>
    <!-- Firebase Configuration -->
    <script src="config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            getDocs, 
            query, 
            where, 
            orderBy, 
            serverTimestamp,
            deleteDoc,
            doc,
            getDoc,
            updateDoc,
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged,
            getMultiFactorResolver,
            PhoneAuthProvider,
            PhoneMultiFactorGenerator,
            RecaptchaVerifier,
            TotpMultiFactorGenerator
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";
        import { 
            getStorage, 
            ref, 
            uploadBytes, 
            getDownloadURL 
        } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-storage.js";

        // Firebase Configuration (embedded for production)
        const firebaseConfig = {
            apiKey: "AIzaSyAyRSlxMXzJDxOoQNC7tSEaymmslMvdnco",
            authDomain: "chicken-project-2.firebaseapp.com",
            projectId: "chicken-project-2",
            storageBucket: "chicken-project-2.firebasestorage.app",
            messagingSenderId: "596273529964",
            appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
            measurementId: "G-9YLPHR08DB"
        };

        // Initialize Firebase with error handling
        let app, auth, db, storage;
        
        try {
            app = initializeApp(firebaseConfig);
            
            // Initialize Firebase Auth
            auth = getAuth(app);
            
            // Initialize Firestore and Storage
            db = getFirestore(app);
            storage = getStorage(app);
            
        console.log('🔥 Firebase initialized:', !!app);
        console.log('🔥 Firestore initialized:', !!db);
        console.log('🔥 Auth initialized:', !!auth);
        
        // Test Firebase connection
        if (auth) {
            console.log('🔐 Firebase Auth ready for authentication');
            console.log('🔐 Multi-Factor Authentication support available');
        }
        if (db) {
            console.log('🗄️ Firestore ready for database operations');
        }
            
        } catch (error) {
            console.error('❌ Firebase initialization failed:', error);
            console.warn('⚠️ Using mock Firebase services for development');
            
            // Create mock services for development
            auth = { currentUser: null };
            db = null;
            storage = null;
        }
        
        // Make Firebase services available globally
        window.firebaseAuth = auth;
        window.firebaseSignIn = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;
        window.firebaseAuthStateChanged = onAuthStateChanged;
        window.db = db;
        window.storage = storage;
        
        // Handle authentication state - SIMPLIFIED VERSION
        function setupAuthState() {
            // Check if user is logged in via bypass
            const isLoggedIn = sessionStorage.getItem('flockview_logged_in');
            const authBypass = sessionStorage.getItem('flockview_auth_bypass');
            
            if (isLoggedIn === 'true' && authBypass === 'true') {
                console.log('🔐 AUTH: Bypass authentication detected - using simple approach');
                
                // Simple mock user for UI only
                const mockUser = {
                    uid: sessionStorage.getItem('flockview_user') || 'test-user-123',
                    email: sessionStorage.getItem('flockview_email') || 'test@example.com',
                    displayName: sessionStorage.getItem('flockview_user_display') || 'Test User'
                };
                
                // Update UI to show authenticated user
                updateUserInterface(mockUser);
                console.log('✅ AUTH: Simple bypass setup complete');
                
            } else if (auth && onAuthStateChanged) {
                // Set up normal Firebase auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log('✅ AUTH: User authenticated:', user.email);
                        sessionStorage.setItem('flockview_logged_in', 'true');
                        sessionStorage.setItem('flockview_user', user.uid);
                        sessionStorage.setItem('flockview_email', user.email);
                        updateUserInterface(user);
                    } else {
                        console.log('❌ AUTH: User not authenticated');
                        sessionStorage.removeItem('flockview_logged_in');
                        sessionStorage.removeItem('flockview_user');
                        sessionStorage.removeItem('flockview_email');
                        // Redirect to login if not authenticated
                        if (!sessionStorage.getItem('flockview_auth_bypass')) {
                            window.location.href = 'login.html';
                        }
                    }
                });
            } else {
                console.log('⚠️ AUTH: No authentication method available');
            }
        }
        
        // Create a proper mock Firebase user with all required methods
        function createMockFirebaseUser(userData) {
            const mockUser = {
                uid: userData.uid,
                email: userData.email,
                emailVerified: true,
                displayName: userData.displayName,
                photoURL: null,
                phoneNumber: null,
                providerId: 'firebase',
                isAnonymous: false,
                metadata: {
                    creationTime: new Date().toISOString(),
                    lastSignInTime: new Date().toISOString()
                },
                providerData: [],
                refreshToken: 'mock-refresh-token',
                tenantId: null,
                delete: () => Promise.resolve(),
                getIdToken: () => Promise.resolve('mock-id-token'),
                getIdTokenResult: () => Promise.resolve({
                    token: 'mock-id-token',
                    authTime: new Date().toISOString(),
                    issuedAtTime: new Date().toISOString(),
                    expirationTime: new Date(Date.now() + 3600000).toISOString(),
                    signInProvider: 'password',
                    signInSecondFactor: null,
                    claims: {}
                }),
                reload: () => Promise.resolve(),
                toJSON: () => ({
                    uid: userData.uid,
                    email: userData.email,
                    emailVerified: true,
                    displayName: userData.displayName,
                    photoURL: null,
                    phoneNumber: null,
                    providerId: 'firebase',
                    isAnonymous: false
                }),
                // Add the missing methods that Firebase Auth expects
                _startProactiveRefresh: () => {},
                _stopProactiveRefresh: () => {},
                _updateProactiveRefresh: () => {}
            };
            
            return mockUser;
        }
        
        // Update user interface with authenticated user info
        function updateUserInterface(user) {
            try {
                // Update user name in navigation
                const userNameElements = document.querySelectorAll('.user-name');
                userNameElements.forEach(el => {
                    el.textContent = user.displayName || user.email || 'Farm Manager';
                });
                
                // Update profile details
                const profileDetails = document.querySelector('.profile-details h4');
                if (profileDetails) {
                    profileDetails.textContent = user.displayName || user.email || 'Farm Manager';
                }
                
                console.log('✅ UI: User interface updated');
            } catch (error) {
                console.error('❌ UI: Error updating user interface:', error);
            }
        }
        
        // Initialize auth state
        setupAuthState();
        
        // Ensure data loading works with bypass authentication
        function ensureDataAccess() {
            const authBypass = sessionStorage.getItem('flockview_auth_bypass');
            const emergencyMode = sessionStorage.getItem('flockview_emergency_mode');
            
            if (authBypass === 'true' || emergencyMode === 'true') {
                console.log('🔓 DATA: Bypass mode - loading data without auth requirement...');
                
                // Load data immediately without waiting for auth
                setTimeout(() => {
                    console.log('🔄 DATA: Loading data in bypass mode...');
                    
                    // Load feed schedules if function exists
                    if (window.loadFeedSchedules) {
                        console.log('📊 DATA: Loading feed schedules...');
                        window.loadFeedSchedules();
                    }
                    
                    // Load notes if function exists
                    if (window.loadNotes) {
                        console.log('📝 DATA: Loading notes...');
                        window.loadNotes();
                    }
                    
                    // Load calendar data if function exists
                    if (window.loadFeedSchedulesForCalendar) {
                        console.log('📅 DATA: Loading calendar data...');
                        window.loadFeedSchedulesForCalendar();
                    }
                    
                    console.log('✅ DATA: All data loading initiated in bypass mode');
                    
                }, 1000);
            }
        }
        
        // Initialize data access
        ensureDataAccess();
        
        // Make Firestore functions available globally
        window.addDoc = addDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.where = where;
        window.orderBy = orderBy;
        window.serverTimestamp = serverTimestamp;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
    </script>

    <!-- PDF Processing and File Upload Script -->
    <script>
        // PDF.js worker configuration
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Pagination variables for feed schedules
        let currentPage = 1;
        let schedulesPerPage = 10;
        let allSchedules = [];
        let filteredSchedules = [];

                 // File upload functionality
         document.addEventListener('DOMContentLoaded', function() {
             // Main upload elements - only reference elements that actually exist
             
             // Main upload elements
             const mainFileInput = document.getElementById('mainPdfFileInput');
             const mainFileUploadArea = document.getElementById('mainFileUploadArea');
             

             
             // Feed schedules page elements
             const schedulesGrid = document.getElementById('schedulesGrid');
             const locationFilter = document.getElementById('locationFilter');
             const statusFilter = document.getElementById('statusFilter');



             // Main upload drag and drop functionality
             if (mainFileUploadArea) {
             mainFileUploadArea.addEventListener('dragover', (e) => {
                 e.preventDefault();
                 mainFileUploadArea.classList.add('drag-over');
             });

             mainFileUploadArea.addEventListener('dragleave', () => {
                 mainFileUploadArea.classList.remove('drag-over');
             });

             mainFileUploadArea.addEventListener('drop', (e) => {
                 e.preventDefault();
                 mainFileUploadArea.classList.remove('drag-over');
                 const files = e.dataTransfer.files;
                 if (files.length > 0 && files[0].type === 'application/pdf') {
                     handleMainFileUpload(files[0]);
                 }
             });
             }

             // Main file input change - AUTO-PROCESS PDF
             if (mainFileInput) {
             mainFileInput.addEventListener('change', (e) => {
                 if (e.target.files.length > 0) {
                     handleMainFileUpload(e.target.files[0]);
                 }
             });
             }

                         // Load existing alerts on page load
             loadUpcomingAlerts();
             
             // Load upcoming feed schedules on page load
             if (typeof loadUpcomingFeedSchedules === 'function') {
             loadUpcomingFeedSchedules();
             }

             // Load feed schedules when page loads (moved to after function definition)
             // loadFeedSchedules();

             // Close modals when clicking outside
             document.addEventListener('click', function(e) {
                 if (e.target.classList.contains('modal')) {
                     e.target.style.display = 'none';
                 }
             });

             // Filter functionality (search removed as requested)
             if (locationFilter) {
                 locationFilter.addEventListener('change', filterSchedules);
             }

             // Show quick location selection
             function showQuickLocationSelection(file) {
                 const quickLocationSelection = document.getElementById('quickLocationSelection');
                 
                 if (quickLocationSelection) {
                 quickLocationSelection.style.display = 'block';
                 }
                 
                 // Store the file globally for processing
                 window.selectedQuickFile = file;
             }
             
             // Reset quick upload
             window.resetQuickUpload = function() {
                 const quickLocationSelection = document.getElementById('quickLocationSelection');
                 
                 if (quickLocationSelection) {
                 quickLocationSelection.style.display = 'none';
                 }
                 
                 window.selectedQuickFile = null;
             }
             
             // Process quick upload
             window.processQuickUpload = async function() {
                 const farmSelect = document.getElementById('quickFarmSelect');
                 const barnSelect = document.getElementById('quickBarnSelect');
                 const floorSelect = document.getElementById('quickFloorSelect');
                 
                 if (!farmSelect.value || !barnSelect.value || !floorSelect.value) {
                     alert('Please select farm, barn, and floor before processing.');
                     return;
                 }
                 
                 const file = window.selectedQuickFile;
                 if (!file) {
                     alert('No file selected. Please choose a file first.');
                     return;
                 }
                 
                 await handleQuickFileUpload(file, {
                     farm: farmSelect.value,
                     barn: barnSelect.value,
                     floor: floorSelect.value
                 });
             }
             
             // Show main location selection
             function showMainLocationSelection(file) {
                 const mainFileUploadArea = document.getElementById('mainFileUploadArea');
                 const mainLocationSelection = document.getElementById('mainLocationSelection');
                 
                 if (mainFileUploadArea) {
                 mainFileUploadArea.style.display = 'none';
                 }
                 if (mainLocationSelection) {
                 mainLocationSelection.style.display = 'block';
                 }
                 
                 // Store the file globally for processing
                 window.selectedMainFile = file;
             }
             
             // Reset main upload
             window.resetMainUpload = function() {
                 const mainFileUploadArea = document.getElementById('mainFileUploadArea');
                 const mainLocationSelection = document.getElementById('mainLocationSelection');
                 const mainFileInput = document.getElementById('mainPdfFileInput');
                 
                 if (mainFileUploadArea) {
                 mainFileUploadArea.style.display = 'block';
                 }
                 if (mainLocationSelection) {
                 mainLocationSelection.style.display = 'none';
                 }
                 if (mainFileInput) {
                 mainFileInput.value = '';
                 }
                 window.selectedMainFile = null;
             }
             
             // Process main upload
             window.processMainUpload = async function() {
                 const farmSelect = document.getElementById('mainFarmSelect');
                 const barnSelect = document.getElementById('mainBarnSelect');
                 const floorSelect = document.getElementById('mainFloorSelect');
                 
                 if (!farmSelect.value || !barnSelect.value || !floorSelect.value) {
                     alert('Please select farm, barn, and floor before processing.');
                     return;
                 }
                 
                 const file = window.selectedMainFile;
                 if (!file) {
                     alert('No file selected. Please choose a file first.');
                     return;
                 }
                 
                 await handleMainFileUpload(file, {
                     farm: farmSelect.value,
                     barn: barnSelect.value,
                     floor: floorSelect.value
                 });
             }
             
             // Quick file upload handler - AUTO-EXTRACT FARM/BARN INFO
             async function handleQuickFileUpload(file, locationData = null) {
                 try {
                     // Show progress - check if elements exist
                     const quickUploadProgress = document.getElementById('quickUploadProgress');
                     const quickProgressFill = document.getElementById('quickProgressFill');
                     const quickProgressText = document.getElementById('quickProgressText');
                     
                     if (quickUploadProgress) {
                     quickUploadProgress.style.display = 'block';
                     }
                     if (quickProgressFill) {
                     quickProgressFill.style.width = '0%';
                     }
                     quickProgressText.textContent = 'Processing PDF...';

                     // Process the file to extract farm/barn info and feed dates
                     const result = await processPdfFile(file);
                     const feedDates = result.feedDates;
                     const extractedInfo = result.extractedInfo;
                     
                     // Use auto-extracted farm/barn info or fallback to manual input
                     const farmInfo = extractedInfo.farmInfo;
                     const farm = farmInfo.farmName || (locationData ? locationData.farm : 'Unknown Farm');
                     const barn = farmInfo.barnNumber || (locationData ? locationData.barn : 'Unknown Barn');
                     const floor = farmInfo.floorNumber || (locationData ? locationData.floor : '1');
                     
                     // Generate custom filename using extracted info
                     const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                     const customFileName = `${farm}_${barn}_${floor}_FeedSchedule_${timestamp}.pdf`;
                     
                     // Debug logging for upload
                     console.log('Quick Upload Debug:');
                     console.log('Feed Dates Found:', feedDates.length);
                     console.log('Extracted Info:', extractedInfo);
                     console.log('PDF Date:', extractedInfo.pdfDate);
                     
                     // Save to Firestore with auto-extracted farm/barn info
                     await saveFeedScheduleToFirestore(customFileName, feedDates, '', file, {
                         farm: farm,
                         barn: barn,
                         floor: floor,
                         originalFileName: file.name,
                         extractedInfo: extractedInfo
                     });

                     if (quickProgressFill) {
                     quickProgressFill.style.width = '100%';
                     }
                     if (quickProgressText) {
                     quickProgressText.textContent = 'Upload complete!';
                     }

                     // Show success info
                     const quickFeedInfo = document.getElementById('quickFeedInfo');
                     const quickFeedPreview = document.getElementById('quickFeedPreview');
                     
                     if (quickFeedInfo) {
                     quickFeedInfo.innerHTML = `
                         <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                             <i class="fas fa-check-circle" style="color: var(--success-green);"></i>
                             <strong>${customFileName}</strong>
                         </div>
                         <div>Feed dates found: ${feedDates.length}</div>
                         <div>PDF Date: ${extractedInfo.pdfDate || 'Not found'}</div>
                         <div>Location: ${farm} - ${barn} - ${floor}</div>
                     `;
                     }
                     if (quickFeedPreview) {
                     quickFeedPreview.style.display = 'block';
                     }

                     // Load and display upcoming alerts
                     await loadUpcomingAlerts();
                     
                     // Refresh upcoming feed schedules
                     await loadUpcomingFeedSchedules();

                     // Reset after 3 seconds
                     setTimeout(() => {
                         if (quickUploadProgress) {
                         quickUploadProgress.style.display = 'none';
                         }
                         if (quickFeedPreview) {
                         quickFeedPreview.style.display = 'none';
                         }
                         if (quickProgressFill) {
                         quickProgressFill.style.width = '0%';
                         }
                         
                         // Hide location selection after successful upload
                         const quickLocationSelection = document.getElementById('quickLocationSelection');
                         if (quickLocationSelection) {
                             quickLocationSelection.style.display = 'none';
                         }
                     }, 3000);

                 } catch (error) {
                     console.error('Error processing quick upload:', error);
                     if (quickProgressText) {
                     quickProgressText.textContent = 'Error processing PDF. Please try again.';
                     }
                     setTimeout(() => {
                         if (quickUploadProgress) {
                         quickUploadProgress.style.display = 'none';
                         }
                         if (quickProgressFill) {
                         quickProgressFill.style.width = '0%';
                         }
                     }, 3000);
                 }
             }

             // Main file upload handler - AUTO-EXTRACT FARM/BARN INFO
             async function handleMainFileUpload(file, locationData = null) {
                 try {
                     // Show progress - check if elements exist
                     const mainFileUploadArea = document.getElementById('mainFileUploadArea');
                     const mainUploadProgress = document.getElementById('mainUploadProgress');
                     const mainProgressFill = document.getElementById('mainProgressFill');
                     const mainProgressText = document.getElementById('mainProgressText');
                     
                     if (mainFileUploadArea) {
                     mainFileUploadArea.style.display = 'none';
                     }
                     if (mainUploadProgress) {
                     mainUploadProgress.style.display = 'block';
                     }
                     if (mainProgressFill) {
                     mainProgressFill.style.width = '0%';
                     }
                     if (mainProgressText) {
                     mainProgressText.textContent = 'Processing PDF...';
                     }

                     // Process the file to extract farm/barn info and feed dates
                     const result = await processPdfFile(file);
                     const feedDates = result.feedDates;
                     const extractedInfo = result.extractedInfo;
                     
                     // Use auto-extracted farm/barn info or fallback to manual input
                     const farmInfo = extractedInfo.farmInfo;
                     const farm = farmInfo.farmName || (locationData ? locationData.farm : 'Unknown Farm');
                     const barn = farmInfo.barnNumber || (locationData ? locationData.barn : 'Unknown Barn');
                     const floor = farmInfo.floorNumber || (locationData ? locationData.floor : '1');
                     
                     // Generate custom filename using extracted info
                     const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                     const customFileName = `${farm}_${barn}_${floor}_FeedSchedule_${timestamp}.pdf`;

                     // Debug logging for upload
                     console.log('Main Upload Debug:');
                     console.log('Feed Dates Found:', feedDates.length);
                     console.log('Extracted Info:', extractedInfo);
                     console.log('PDF Date:', extractedInfo.pdfDate);
                     
                     // Save to Firestore with auto-extracted farm/barn info
                     await saveFeedScheduleToFirestore(customFileName, feedDates, '', file, {
                         farm: farm,
                         barn: barn,
                         floor: floor,
                         originalFileName: file.name,
                         extractedInfo: extractedInfo
                     });

                     if (mainProgressFill) {
                     mainProgressFill.style.width = '100%';
                     }
                     if (mainProgressText) {
                     mainProgressText.textContent = 'Upload complete!';
                     }

                     // Show preview
                     showMainFeedSchedulePreview(feedDates, extractedInfo);

                     // Reload schedules
                     if (window.loadFeedSchedules) {
                         window.loadFeedSchedules();
                     }
                     
                     // Refresh upcoming feed schedules
                     await loadUpcomingFeedSchedules();

                     // Reset after 3 seconds
                     setTimeout(() => {
                         if (mainUploadProgress) {
                         mainUploadProgress.style.display = 'none';
                         }
                         if (mainFileUploadArea) {
                         mainFileUploadArea.style.display = 'block';
                         }
                         if (mainProgressFill) {
                         mainProgressFill.style.width = '0%';
                         }
                         
                         // Hide location selection after successful upload
                         const mainLocationSelection = document.getElementById('mainLocationSelection');
                         if (mainLocationSelection) {
                             mainLocationSelection.style.display = 'none';
                         }
                     }, 3000);

                 } catch (error) {
                     console.error('Error processing main upload:', error);
                     if (mainProgressText) {
                     mainProgressText.textContent = 'Error processing PDF. Please try again.';
                     }
                     setTimeout(() => {
                         if (mainUploadProgress) {
                         mainUploadProgress.style.display = 'none';
                         }
                         if (mainFileUploadArea) {
                         mainFileUploadArea.style.display = 'block';
                         }
                         if (mainProgressFill) {
                         mainProgressFill.style.width = '0%';
                         }
                     }, 3000);
                 }
             }

             // Handle file upload (legacy function for backward compatibility)
             async function handleFileUpload(file) {
                try {
                    // Show location selector after file is chosen
                    const locationSelector = document.getElementById('locationSelector');
                    const fileUploadArea = document.getElementById('fileUploadArea');
                    
                    if (locationSelector) {
                    locationSelector.style.display = 'flex';
                    }
                    
                    if (fileUploadArea) {
                    // Update upload area to show file info
                    fileUploadArea.innerHTML = `
                        <i class="fas fa-file-pdf"></i>
                        <h4>Selected File: ${file.name}</h4>
                        <p>Please select the floor and click "Process PDF" to continue</p>
                        <div class="file-location-selector" style="display: flex; margin-top: 1rem;">
                            <div class="selector-group">
                                <label for="farmSelect">Farm:</label>
                                <select id="farmSelect" class="form-select">
                                    <option value="VAS" selected>Vassilakos Farm (VAS)</option>
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="barnSelect">Barn:</label>
                                <select id="barnSelect" class="form-select">
                                    <option value="B1" selected>Barn 1</option>
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="floorSelect">Floor:</label>
                                <select id="floorSelect" class="form-select">
                                    <option value="">Select Floor</option>
                                    <option value="F1">Floor 1</option>
                                    <option value="F2">Floor 2</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem;">
                            <button class="btn btn-primary" onclick="processSelectedFile()">
                                <i class="fas fa-upload"></i> Process PDF
                            </button>
                            <button class="btn btn-outline" onclick="resetFileUpload()" style="margin-left: 0.5rem;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    `;
                    }
                    
                    // Store the file globally for processing
                    window.selectedFile = file;
                    
                } catch (error) {
                    console.error('Error handling file selection:', error);
                    alert('Error selecting file. Please try again.');
                }
            }
            // Process the selected file
            window.processSelectedFile = async function() {
                try {
                    const farmSelect = document.getElementById('farmSelect');
                    const barnSelect = document.getElementById('barnSelect');
                    const floorSelect = document.getElementById('floorSelect');
                    
                    if (!floorSelect.value) {
                        alert('Please select a floor before processing the PDF.');
                        return;
                    }

                    const file = window.selectedFile;
                    if (!file) {
                        alert('No file selected. Please choose a file first.');
                        return;
                    }

                    // Generate custom filename
                    const timestamp = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const customFileName = `${farmSelect.value}_${barnSelect.value}_${floorSelect.value}_FeedSchedule_${timestamp}.pdf`;

                    // Show progress - check if elements exist
                    const fileUploadArea = document.getElementById('fileUploadArea');
                    const uploadProgress = document.getElementById('uploadProgress');
                    const progressFill = document.getElementById('progressFill');
                    const progressText = document.getElementById('progressText');
                    
                    if (fileUploadArea) {
                    fileUploadArea.style.display = 'none';
                    }
                    if (uploadProgress) {
                    uploadProgress.style.display = 'block';
                    }
                    if (progressFill) {
                    progressFill.style.width = '0%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Reading PDF file...';
                    }

                    // Read PDF file
                    const arrayBuffer = await file.arrayBuffer();
                    if (progressFill) {
                    progressFill.style.width = '30%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Extracting text from PDF...';
                    }

                    // Load PDF document
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    if (progressFill) {
                    progressFill.style.width = '50%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Processing feed dates...';
                    }

                    // Extract text from all pages
                    let fullText = '';
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        fullText += pageText + ' ';
                    }

                    if (progressFill) {
                    progressFill.style.width = '80%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Extracting feed dates...';
                    }

                    // Extract feed dates from text with improved algorithm
                    const feedDates = extractFeedDates(fullText);
                    
                    if (progressFill) {
                    progressFill.style.width = '90%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Uploading file to storage...';
                    }

                    // Save to Firestore with file upload
                    await saveFeedScheduleToFirestore(customFileName, feedDates, fullText, file, {
                        farm: farmSelect.value,
                        barn: barnSelect.value,
                        floor: floorSelect.value,
                        originalFileName: file.name
                    });

                    if (progressFill) {
                    progressFill.style.width = '100%';
                    }
                    if (progressText) {
                    progressText.textContent = 'Upload complete! PDF stored successfully.';
                    }

                    // Show preview
                    showFeedSchedulePreview(feedDates);
                    
                    // Load and display upcoming alerts
                    await loadUpcomingAlerts();
                    
                    // Show success message
                    setTimeout(() => {
                        alert(`PDF "${customFileName}" uploaded successfully!\n\nFeed dates found: ${feedDates.length}\nFile is now available for viewing and download.`);
                    }, 500);

                                         // Reset form and UI after 2 seconds
                     setTimeout(() => {
                         if (uploadProgress) {
                         uploadProgress.style.display = 'none';
                         }
                         resetFileUpload();
                     }, 2000);

                                 } catch (error) {
                     console.error('Error processing PDF:', error);
                     if (progressText) {
                     progressText.textContent = 'Error processing PDF. Please try again.';
                     }
                     setTimeout(() => {
                         if (uploadProgress) {
                         uploadProgress.style.display = 'none';
                         }
                         resetFileUpload();
                     }, 3000);
                 }
             }

             // Reset file upload interface
             window.resetFileUpload = function() {
                 const fileUploadArea = document.getElementById('fileUploadArea');
                 const locationSelector = document.getElementById('locationSelector');
                 
                 if (fileUploadArea) {
                 fileUploadArea.innerHTML = `
                     <i class="fas fa-cloud-upload-alt"></i>
                     <h4>Upload Feed Schedule PDF</h4>
                     <p>Drag and drop your PDF file here or click to browse</p>
                     <input type="file" id="pdfFileInput" accept=".pdf" style="display: none;">
                     <button class="btn btn-outline" onclick="document.getElementById('pdfFileInput').click()">
                         <i class="fas fa-file-pdf"></i> Choose PDF File
                     </button>
                 `;
                 }
                 
                 if (locationSelector) {
                 locationSelector.style.display = 'none';
                 }
                 
                 // Reset file input
                 const pdfFileInput = document.getElementById('pdfFileInput');
                 if (pdfFileInput) {
                     pdfFileInput.value = '';
                 
                 // Re-attach event listeners
                     pdfFileInput.addEventListener('change', (e) => {
                     if (e.target.files.length > 0) {
                         handleFileUpload(e.target.files[0]);
                     }
                 });
                 }
                 
                 // Clear global file
                 window.selectedFile = null;
             }

                         // Process PDF file and extract feed dates
             async function processPdfFile(file) {
                 try {
                     // Read PDF file
                     const arrayBuffer = await file.arrayBuffer();
                     
                     // Load PDF document
                     const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                     
                     // Extract text from all pages
                     let fullText = '';
                     for (let i = 1; i <= pdf.numPages; i++) {
                         const page = await pdf.getPage(i);
                         const textContent = await page.getTextContent();
                         const pageText = textContent.items.map(item => item.str).join(' ');
                         fullText += pageText + ' ';
                     }
                     
                     // Extract feed dates from text
                     return extractFeedDates(fullText);
                 } catch (error) {
                     console.error('Error processing PDF:', error);
                     throw error;
                 }
             }

             // Show main feed schedule preview
             function showMainFeedSchedulePreview(feedDates, extractedInfo) {
                 const mainFeedDatesList = document.getElementById('mainFeedDatesList');
                 const mainFeedSchedulePreview = document.getElementById('mainFeedSchedulePreview');
                 
                 if (!mainFeedDatesList || !mainFeedSchedulePreview) {
                     console.log('Preview elements not found, skipping preview display');
                     return;
                 }
                 
                 if (feedDates.length === 0) {
                     mainFeedDatesList.innerHTML = '<p class="no-dates">No feed dates found in the PDF.</p>';
                 } else {
                     let previewHTML = '';
                     
                     // Add farm/barn info header
                     const farmInfo = extractedInfo.farmInfo;
                     previewHTML += `
                         <div class="feed-date-item" style="background: var(--bg-secondary); border-left: 4px solid var(--primary-blue);">
                             <i class="fas fa-map-marker-alt"></i>
                             <div class="feed-date-content">
                                 <h5>${farmInfo.farmName} - ${farmInfo.barnNumber}</h5>
                                 <p>Farm and barn extracted from PDF</p>
                             </div>
                         </div>
                     `;
                     
                     // Add feed dates in clean format
                     previewHTML += feedDates.map(item => `
                         <div class="feed-date-item">
                             <i class="fas fa-calendar-day"></i>
                             <div class="feed-date-content">
                                 <h5>${item.formattedDate}</h5>
                                 <p>${item.weight ? `${item.weight} KG` : 'Date only'}</p>
                             </div>
                         </div>
                     `).join('');
                     
                     mainFeedDatesList.innerHTML = previewHTML;
                 }
                 
                 mainFeedSchedulePreview.style.display = 'block';
             }

            // Load feed schedules for the management page
            let isLoadingFeedSchedules = false;
            window.loadFeedSchedules = async function() {
                if (isLoadingFeedSchedules) {
                    console.log('⏳ loadFeedSchedules already in progress, skipping...');
                    return;
                }
                
                isLoadingFeedSchedules = true;
                console.log('🔄 Starting loadFeedSchedules...');
                if (!schedulesGrid) {
                    console.error('❌ schedulesGrid not found!');
                    isLoadingFeedSchedules = false;
                    return;
                }
                 
                 try {
                     console.log('🔍 Checking if db is available:', !!db);
                     
                     // Check if Firebase is properly initialized
                     if (!db) {
                         throw new Error('Firebase database not initialized. Please refresh the page.');
                     }
                     
                     if (schedulesGrid) {
                     schedulesGrid.innerHTML = `
                         <div class="loading-schedules modern">
                             <div class="loading-spinner">
                                 <i class="fas fa-spinner fa-spin"></i>
                             </div>
                             <p>Loading feed schedules...</p>
                         </div>
                     `;
                     }

                    // Check if we're in bypass mode - if so, skip database query and go straight to sample data
                    const authBypass = sessionStorage.getItem('flockview_auth_bypass');
                    if (authBypass === 'true') {
                        console.log('🔓 Bypass mode: Loading sample data directly...');
                        // Go directly to sample data without throwing error
                        const sampleSchedules = [
                            {
                                id: 'sample-1',
                                fileName: 'VAS_B3_F1_Sample.pdf',
                                farmName: 'VAS',
                                barnNumber: 'B3',
                                floorNumber: 'F1',
                                uploadDate: new Date(),
                                totalKGs: '137,000',
                                feedDates: [
                                    { formattedDate: 'Monday, July 14, 2025', weight: '8000 KG' },
                                    { formattedDate: 'Tuesday, July 29, 2025', weight: '9000 KG' },
                                    { formattedDate: 'Friday, August 1, 2025', weight: '9000 KG' }
                                ],
                                farmColorClass: 'vas'
                            },
                            {
                                id: 'sample-2',
                                fileName: 'APO_B2_F1_Sample.pdf',
                                farmName: 'APO',
                                barnNumber: 'B2',
                                floorNumber: 'F1',
                                uploadDate: new Date(),
                                totalKGs: '95,000',
                                feedDates: [
                                    { formattedDate: 'Wednesday, July 16, 2025', weight: '7000 KG' },
                                    { formattedDate: 'Thursday, July 30, 2025', weight: '8000 KG' }
                                ],
                                farmColorClass: 'apo'
                            }
                        ];
                        
                        console.log('📝 Displaying sample schedules...');
                        
                        // Add a visual indicator that this is sample data
                        if (schedulesGrid) {
                            const sampleIndicator = document.createElement('div');
                            sampleIndicator.className = 'sample-data-indicator';
                            sampleIndicator.style.cssText = `
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white;
                                padding: 10px 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                text-align: center;
                                font-weight: bold;
                                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                            `;
                            sampleIndicator.innerHTML = `
                                <i class="fas fa-flask" style="margin-right: 8px;"></i>
                                Sample Data Mode - Demo Feed Schedules
                            `;
                            schedulesGrid.insertBefore(sampleIndicator, schedulesGrid.firstChild);
                        }
                        
                        displaySchedules(sampleSchedules);
                        return;
                    }

                    const q = query(collection(db, 'feed_schedules'), orderBy('uploadDate', 'desc'));
                    console.log('🔍 Query created, getting docs...');
                    
                    // Add timeout to prevent hanging
                    const queryPromise = getDocs(q);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Query timeout after 10 seconds')), 10000)
                    );
                    
                    const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                     console.log('🔍 QuerySnapshot received, size:', querySnapshot.size);
                     
                     allSchedules = [];
                     querySnapshot.forEach((doc) => {
                         const data = doc.data();
                         console.log(`🔍 Loading schedule ${doc.id}:`, data);
                         console.log(`🔍 Feed dates for ${doc.id}:`, data.feedDates);
                         allSchedules.push({
                             id: doc.id,
                             ...data
                         });
                     });
                     
                     console.log('📊 Total schedules loaded:', allSchedules.length);
                     
                     // Initialize filtered schedules and display
                     filteredSchedules = [...allSchedules];
                     currentPage = 1;
                     console.log('🔄 Calling displaySchedules with', filteredSchedules.length, 'schedules');
                     displaySchedules(filteredSchedules);
                     
                     // If no schedules found, show sample data for demo
                     if (allSchedules.length === 0) {
                         console.log('📝 No schedules found, showing sample data for demo...');
                         const sampleSchedules = [
                             {
                                 id: 'sample-1',
                                 fileName: 'VAS_B3_F1_Sample.pdf',
                                 farmName: 'VAS',
                                 barnNumber: 'B3',
                                 floorNumber: 'F1',
                                 uploadDate: new Date(),
                                 totalKGs: '137,000',
                                 feedDates: [
                                     { formattedDate: 'Monday, July 14, 2025', weight: '8000 KG' },
                                     { formattedDate: 'Tuesday, July 29, 2025', weight: '9000 KG' },
                                     { formattedDate: 'Friday, August 1, 2025', weight: '9000 KG' }
                                 ],
                                 farmColorClass: 'vas'
                             },
                             {
                                 id: 'sample-2',
                                 fileName: 'APO_B2_F1_Sample.pdf',
                                 farmName: 'APO',
                                 barnNumber: 'B2',
                                 floorNumber: 'F1',
                                 uploadDate: new Date(Date.now() - 86400000),
                                 totalKGs: '89,500',
                                 feedDates: [
                                     { formattedDate: 'Wednesday, July 16, 2025', weight: '7500 KG' },
                                     { formattedDate: 'Saturday, July 19, 2025', weight: '8500 KG' }
                                 ],
                                 farmColorClass: 'apo'
                             }
                         ];
                         
                         console.log('📝 Displaying sample schedules...');
                         displaySchedules(sampleSchedules);
                     }
                 } catch (error) {
                     console.error('❌ Error loading feed schedules:', error);
                     console.error('❌ Error details:', {
                         message: error.message,
                         stack: error.stack,
                         db: !!db,
                         schedulesGrid: !!schedulesGrid
                     });
                     
                     // Show sample data instead of error message
                     console.log('📝 Error occurred, showing sample data for demo...');
                     const sampleSchedules = [
                         {
                             id: 'sample-1',
                             fileName: 'VAS_B3_F1_Sample.pdf',
                             farmName: 'VAS',
                             barnNumber: 'B3',
                             floorNumber: 'F1',
                             uploadDate: new Date(),
                             totalKGs: '137,000',
                             feedDates: [
                                 { formattedDate: 'Monday, July 14, 2025', weight: '8000 KG' },
                                 { formattedDate: 'Tuesday, July 29, 2025', weight: '9000 KG' },
                                 { formattedDate: 'Friday, August 1, 2025', weight: '9000 KG' }
                             ],
                             farmColorClass: 'vas'
                         },
                         {
                             id: 'sample-2',
                             fileName: 'APO_B2_F1_Sample.pdf',
                             farmName: 'APO',
                             barnNumber: 'B2',
                             floorNumber: 'F1',
                             uploadDate: new Date(),
                             totalKGs: '95,000',
                             feedDates: [
                                 { formattedDate: 'Wednesday, July 16, 2025', weight: '7000 KG' },
                                 { formattedDate: 'Thursday, July 30, 2025', weight: '8000 KG' }
                             ],
                             farmColorClass: 'apo'
                         }
                     ];
                     
                     console.log('📝 Displaying sample schedules...');
                     displaySchedules(sampleSchedules);
                 } finally {
                     isLoadingFeedSchedules = false;
                 }
             }

            // Display schedules with modern design and pagination
                         window.displaySchedules = function(schedules) {
                // Update statistics
                const totalSchedules = schedules.length;
                let totalWeight = 0;
                
                                     schedules.forEach(schedule => {
                         if (schedule.feedDates && schedule.feedDates.length > 0) {
                             schedule.feedDates.forEach(date => {
                                 if (date.weight) {
                                     // Handle both string and number weights
                                     let weightValue = date.weight;
                                     if (typeof weightValue === 'string') {
                                         weightValue = weightValue.replace(/,/g, '');
                                     }
                                     const weight = parseFloat(weightValue);
                                     if (!isNaN(weight)) {
                                         totalWeight += weight;
                                     }
                                 }
                             });
                         }
                     });
                
                // Update stats display
                const statsElement = document.getElementById('scheduleStats');
                if (statsElement) {
                    document.getElementById('totalSchedules').textContent = totalSchedules;
                }
                
                if (schedules.length === 0) {
                    schedulesGrid.innerHTML = `
                        <div class="empty-schedules">
                            <i class="fas fa-calendar-times"></i>
                            <p>No feed schedules found</p>
                            <p>Upload your first feed schedule to get started</p>
                        </div>
                    `;
                    
                    // Update pagination controls
                    document.getElementById('pageInfo').textContent = 'Page 1 of 1';
                    document.getElementById('prevPageBtn').disabled = true;
                    document.getElementById('nextPageBtn').disabled = true;
                    return;
                }

                // Calculate pagination
                const totalPages = Math.ceil(schedules.length / schedulesPerPage);
                const startIndex = (currentPage - 1) * schedulesPerPage;
                const endIndex = startIndex + schedulesPerPage;
                const currentSchedules = schedules.slice(startIndex, endIndex);

                // Update pagination controls
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                document.getElementById('prevPageBtn').disabled = currentPage <= 1;
                document.getElementById('nextPageBtn').disabled = currentPage >= totalPages;

                // Create modern schedule cards
                const scheduleCards = currentSchedules.map(schedule => {
                    // Extract farm, barn, floor from location or fileName
                    let farmName = 'Unknown Farm';
                    let barnNumber = 'Unknown Barn';
                    let floorNumber = 'Unknown Floor';
                    
                    if (schedule.location) {
                        const locationParts = schedule.location.split(' - ');
                        if (locationParts.length >= 3) {
                            farmName = locationParts[0];
                            barnNumber = locationParts[1];
                            floorNumber = locationParts[2];
                        }
                    } else if (schedule.fileName) {
                        // Try to extract from filename if location is not available
                        const fileNameParts = schedule.fileName.split('_');
                        if (fileNameParts.length >= 3) {
                            farmName = fileNameParts[0];
                            barnNumber = fileNameParts[1];
                            floorNumber = fileNameParts[2];
                        }
                    }
                    
                    // Get PDF date from extracted info
                    const pdfDate = schedule.extractedInfo?.pdfDate || 'Unknown Date';
                    
                    // If PDF date is still unknown, try to use the first feed date as fallback
                    if (pdfDate === 'Unknown Date' && schedule.feedDates && schedule.feedDates.length > 0) {
                        const firstFeedDate = schedule.feedDates[0];
                        if (firstFeedDate && firstFeedDate.date) {
                            const fallbackDate = new Date(firstFeedDate.date.toDate ? firstFeedDate.date.toDate() : firstFeedDate.date);
                            if (!isNaN(fallbackDate.getTime())) {
                                schedule.extractedInfo = schedule.extractedInfo || {};
                                schedule.extractedInfo.pdfDate = fallbackDate.toLocaleDateString('en-US');
                            }
                        }
                    }
                    
                    // Calculate total KGs
                    const totalKGs = calculateTotalKGs(schedule.feedDates);
                    
                    // Get farm color class
                    const farmColorClass = getFarmColorClass(farmName);
                    
                    return {
                        ...schedule,
                        farmName,
                        barnNumber,
                        floorNumber,
                        pdfDate,
                        totalKGs,
                        farmColorClass
                    };
                });
                
                // Generate HTML for modern card design
                let html = '<div class="schedule-cards-grid">';
                
                scheduleCards.forEach(schedule => {
                    const uploadDate = schedule.uploadDate ? new Date(schedule.uploadDate.toDate ? schedule.uploadDate.toDate() : schedule.uploadDate) : new Date();
                    const formattedUploadDate = uploadDate.toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric'
                    });
                    
                    html += `
                        <div class="schedule-card modern ${schedule.farmColorClass}">
                            <div class="card-header">
                                <div class="farm-info">
                                    <h3>${schedule.farmName} ${schedule.barnNumber}</h3>
                                    <span class="upload-date">Uploaded ${formattedUploadDate}</span>
                                </div>
                                <div class="card-actions">
                                    <button class="action-btn view-btn" onclick="viewPdf('${schedule.fileData || ''}', '${schedule.fileName}')" title="View PDF">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn download-btn" onclick="downloadPdf('${schedule.fileData || ''}', '${schedule.fileName}')" title="Download PDF">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button class="action-btn delete-btn" onclick="removeSchedule('${schedule.id}', '${schedule.fileName}')" title="Delete Schedule">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card-content">
                                <div class="schedule-stats">
                                    <div class="stat">
                                        <i class="fas fa-calendar-day"></i>
                                        <span>${schedule.feedDates ? schedule.feedDates.length : 0} Deliveries</span>
                                    </div>
                                </div>
                                
                                ${schedule.feedDates && schedule.feedDates.length > 0 ? `
                                    <div class="deliveries-preview">
                                        <div class="deliveries-header">
                                            <h4>Upcoming Deliveries</h4>
                                            <button class="btn btn-outline btn-sm" onclick="toggleAllDeliveries('${schedule.id}')" id="toggleBtn_${schedule.id}">
                                                <i class="fas fa-eye"></i> Show All
                                            </button>
                                        </div>
                                        <div class="delivery-chips" id="deliveryChips_${schedule.id}">
                                            ${schedule.feedDates.slice(0, 3).map((date, index) => {
                                                console.log(`🔍 Displaying date ${index}:`, date);
                                                const weightDisplay = date.weight ? 
                                                    (typeof date.weight === 'string' ? date.weight : date.weight.toString()) + ' KG' : 
                                                    'No weight';
                                                return `
                                                <span class="delivery-chip" title="${weightDisplay}">
                                                    <span class="date-text">${date.formattedDate}</span>
                                                    ${date.weight ? `<span class="weight-text">${typeof date.weight === 'string' ? date.weight : date.weight.toString()} KG</span>` : '<span class="weight-text">No weight</span>'}
                                                </span>
                                            `;
                                            }).join('')}
                                            ${schedule.feedDates.length > 3 ? `
                                                <span class="more-deliveries">+${schedule.feedDates.length - 3} more</span>
                                            ` : ''}
                                        </div>
                                        <div class="all-deliveries" id="allDeliveries_${schedule.id}" style="display: none;">
                                            <h5>All Delivery Dates:</h5>
                                            <div class="all-delivery-list">
                                                ${schedule.feedDates.map((date, index) => {
                                                    const weightDisplay = date.weight ? 
                                                        (typeof date.weight === 'string' ? date.weight : date.weight.toString()) + ' KG' : 
                                                        'No weight';
                                                    return `
                                                    <div class="delivery-item">
                                                        <span class="delivery-date">${date.formattedDate}</span>
                                                        <span class="delivery-weight">${weightDisplay}</span>
                                                    </div>
                                                `;
                                                }).join('')}
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="no-deliveries">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>No deliveries found</span>
                                    </div>
                                `}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                schedulesGrid.innerHTML = html;
            }

                         // Pagination functions
            window.previousPage = function() {
                if (currentPage > 1) {
                    currentPage--;
                    displaySchedules(filteredSchedules);
                }
            };

            window.nextPage = function() {
                const totalPages = Math.ceil(filteredSchedules.length / schedulesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    displaySchedules(filteredSchedules);
                }
            };

            // Filter by farm using tabs
            window.filterByFarm = function(farmCode) {
                console.log('🔍 Filtering by farm:', farmCode);
                
                // Update active tab
                document.querySelectorAll('.farm-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const activeTab = document.querySelector(`[data-farm="${farmCode}"]`);
                if (activeTab) {
                    activeTab.classList.add('active');
                }
                
                // Filter the schedules array
                if (farmCode === 'all') {
                    filteredSchedules = [...allSchedules];
                } else {
                    filteredSchedules = allSchedules.filter(schedule => {
                        const scheduleFarm = schedule.farmName || schedule.farm || 'Unknown';
                        return scheduleFarm === farmCode;
                    });
                }
                
                console.log('📊 Filtered schedules:', filteredSchedules.length);
                
                // Reset to first page when filtering
                currentPage = 1;
                displaySchedules(filteredSchedules);
            }

            // Filter schedules based on location filter only (search removed as requested)
            function filterSchedules() {
                const locationFilter = document.getElementById('locationFilter')?.value || '';
                
                // Filter the schedules array
                filteredSchedules = allSchedules.filter(schedule => {
                    const farm = schedule.farmName?.toLowerCase() || '';
                    const barn = schedule.barnNumber?.toLowerCase() || '';
                    const floor = schedule.floorNumber?.toLowerCase() || '';
                    const location = `${farm} ${barn} ${floor}`;
                    
                    // Check location filter only
                    return !locationFilter || 
                        farm.includes(locationFilter.toLowerCase()) ||
                        location.includes(locationFilter.toLowerCase());
                });
                
                // Reset to first page when filtering
                currentPage = 1;
                displaySchedules(filteredSchedules);
            }
             // SMART PDF data extraction - ONLY delivery dates under delivery columns
             function extractFeedDates(text) {
                console.log('🔄 Starting SMART PDF extraction - Delivery Column Focus...');
                
                const extractedInfo = {
                    farm: 'Unknown',
                    barn: 'Unknown',
                    deliveryDates: []
                };
                
                // STEP 1: Extract farm and barn information
                console.log('🔍 Extracting farm and barn information...');
                
                const lines = text.split('\n');
                let farmName = 'Unknown';
                let barnNumber = 'Unknown';
                
                // Look in first 50 lines for farm and barn info
                for (let i = 0; i < Math.min(50, lines.length); i++) {
                    const line = lines[i].trim().toUpperCase();
                    
                    // Find farm name patterns
                    if (line.includes('VAS') || line.includes('VASSILAKOS')) {
                        farmName = 'VAS';
                    } else if (line.includes('EDG') || line.includes('EDGE')) {
                        farmName = 'EDG';
                    } else if (line.includes('APO') || line.includes('APOSTOLAKOS')) {
                        farmName = 'APO';
                    } else if (line.includes('SIG') || line.includes('SIGMA')) {
                        farmName = 'SIG';
                    } else if (line.includes('DFI')) {
                        farmName = 'DFI';
                    }
                    
                    // Find barn number patterns
                    const barnMatch = line.match(/B\s*(\d+)/);
                    if (barnMatch) {
                        barnNumber = `B${barnMatch[1]}`;
                    } else if (line.includes('BARN 1') || line.includes('B1')) {
                        barnNumber = 'B1';
                    } else if (line.includes('BARN 2') || line.includes('B2')) {
                        barnNumber = 'B2';
                    } else if (line.includes('BARN 3') || line.includes('B3')) {
                        barnNumber = 'B3';
                    } else if (line.includes('BARN 4') || line.includes('B4')) {
                        barnNumber = 'B4';
                    }
                    
                    // If we found both, we can stop searching
                    if (farmName !== 'Unknown' && barnNumber !== 'Unknown') {
                        break;
                    }
                }
                
                extractedInfo.farm = farmName;
                extractedInfo.barn = barnNumber;
                
                console.log(`✅ Extracted Farm: ${farmName}, Barn: ${barnNumber}`);
                
                // STEP 2: Find delivery table/column sections
                console.log('🔍 Looking for delivery table sections...');
                
                // Look for delivery-related headers
                const deliveryHeaders = [
                    /delivery/i,
                    /schedule/i,
                    /feed\s+schedule/i,
                    /deliveries/i
                ];
                
                let deliverySectionStart = -1;
                let deliverySectionEnd = -1;
                
                // Find where delivery information starts
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    
                    // Check if this line contains delivery headers
                    for (const headerPattern of deliveryHeaders) {
                        if (headerPattern.test(line)) {
                            deliverySectionStart = i;
                            console.log(`📍 Found delivery section at line ${i}: "${line}"`);
                            break;
                        }
                    }
                    
                    if (deliverySectionStart !== -1) break;
                }
                
                // If no delivery header found, look for table patterns
                if (deliverySectionStart === -1) {
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        // Look for table-like patterns with dates and weights
                        if (line.includes('Date') && line.includes('Weight') || 
                            line.includes('Delivery') && line.includes('KG') ||
                            /\d{1,2}\/\d{1,2}\/\d{4}.*\d{3,}/.test(line)) {
                            deliverySectionStart = i;
                            console.log(`📍 Found table pattern at line ${i}: "${line}"`);
                            break;
                        }
                    }
                }
                
                // STEP 3: Extract delivery dates and weights from the delivery section
                if (deliverySectionStart !== -1) {
                    console.log('🔍 Extracting delivery dates from delivery section...');
                    
                                         // Look for delivery patterns in the delivery section
                     const deliveryPatterns = [
                         // Pattern 1: HD feed format with delivery dates (Mon Jul-14-2025)
                         /(\d+(?:,\d{3})*(?:\.\d+)?)\s+HD\s+[^\n]*?(\w{3}\s+\w{3}-\d{1,2}-\d{4})/gi,
                         // Pattern 2: Day name format (Mon Jul-14-2025) followed by weight
                         /(\w{3}\s+\w{3}-\d{1,2}-\d{4})\s+(\d+(?:,\d{3})*(?:\.\d+)?)/gi,
                         // Pattern 3: Date followed by weight in delivery format (07/21/2025 2920)
                         /(\d{1,2}\/\d{1,2}\/\d{4})\s+(\d+(?:,\d{3})*(?:\.\d+)?)\s*(?:KG|MT|TONS?)?/gi,
                         // Pattern 4: Weight followed by date in delivery format
                         /(\d+(?:,\d{3})*(?:\.\d+)?)\s+(?:KG|MT|TONS?)?\s+(\d{1,2}\/\d{1,2}\/\d{4})/gi,
                         // Pattern 5: Day name format (Tue Jul 15) followed by weight
                         /(\w{3}\s+\w{3}\s+\d{1,2})\s+(\d+(?:,\d{3})*(?:\.\d+)?)/gi,
                         // Pattern 6: Day name format (Mon Jul 28) followed by weight
                         /(\w{3}\s+\w{3}\s+\d{1,2})\s+(\d+(?:,\d{3})*(?:\.\d+)?)/gi
                     ];
                    
                                         // Search in the delivery section (from start to end of document)
                     const deliveryText = lines.slice(deliverySectionStart).join('\n');
                     
                     console.log('🔍 Delivery section text preview:', deliveryText.substring(0, 500) + '...');
                    
                                         for (let i = 0; i < deliveryPatterns.length; i++) {
                         const pattern = deliveryPatterns[i];
                         console.log(`🔍 Testing pattern ${i + 1}:`, pattern.source);
                         const matches = deliveryText.matchAll(pattern);
                        
                                                 for (const match of matches) {
                             let deliveryDate = '';
                             let deliveryWeight = '';
                             
                             if (i === 0) { // HD feed format (Mon Jul-14-2025)
                                 deliveryWeight = match[1];
                                 deliveryDate = match[2];
                             } else if (i === 1) { // Day name format (Mon Jul-14-2025) followed by weight
                                 deliveryDate = match[1];
                                 deliveryWeight = match[2];
                             } else if (i === 2) { // Date followed by weight (07/21/2025 2920)
                                 deliveryDate = match[1];
                                 deliveryWeight = match[2];
                             } else if (i === 3) { // Weight followed by date
                                 deliveryWeight = match[1];
                                 deliveryDate = match[2];
                             } else if (i === 4 || i === 5) { // Day name format (Tue Jul 15) followed by weight
                                 deliveryDate = match[1];
                                 deliveryWeight = match[2];
                             }
                            
                            // Validate the date and weight
                            if (deliveryDate && deliveryWeight) {
                                const cleanWeight = deliveryWeight.replace(/,/g, '');
                                if (!isNaN(parseFloat(cleanWeight)) && parseFloat(cleanWeight) >= 100) {
                                    // Validate date format
                                    let validDate = false;
                                    let parsedDate = '';
                                    
                                                                         // Try different date formats
                                     if (deliveryDate.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
                                         // MM/DD/YYYY format
                                         parsedDate = deliveryDate;
                                         validDate = true;
                                     } else if (deliveryDate.match(/^\w{3}\s+\w{3}-\d{1,2}-\d{4}$/)) {
                                         // Mon Jul-14-2025 format
                                         const dateParts = deliveryDate.split('-');
                                         const monthDay = dateParts[0].split(' ')[1]; // Jul
                                         const day = dateParts[1]; // 14
                                         const year = dateParts[2]; // 2025
                                         
                                         // Convert month name to number
                                         const monthMap = {
                                             'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                             'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                             'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                                         };
                                         
                                         const monthNum = monthMap[monthDay];
                                         if (monthNum) {
                                             parsedDate = `${monthNum}/${day}/${year}`;
                                             validDate = true;
                                         }
                                     } else if (deliveryDate.match(/^\w{3}\s+\w{3}\s+\d{1,2}$/)) {
                                         // Tue Jul 15 format - need to add year
                                         const dateParts = deliveryDate.split(' ');
                                         const dayName = dateParts[0]; // Tue
                                         const monthName = dateParts[1]; // Jul
                                         const day = dateParts[2]; // 15
                                         
                                         // Convert month name to number
                                         const monthMap = {
                                             'Jan': '01', 'Feb': '02', 'Mar': '03', 'Apr': '04',
                                             'May': '05', 'Jun': '06', 'Jul': '07', 'Aug': '08',
                                             'Sep': '09', 'Oct': '10', 'Nov': '11', 'Dec': '12'
                                         };
                                         
                                         const monthNum = monthMap[monthName];
                                         if (monthNum) {
                                             // Assume current year or extract from context
                                             const currentYear = new Date().getFullYear();
                                             parsedDate = `${monthNum}/${day}/${currentYear}`;
                                             validDate = true;
                                         }
                                     }
                                    
                                    if (validDate) {
                                        extractedInfo.deliveryDates.push({
                                            date: parsedDate,
                                            weight: parseFloat(cleanWeight),
                                            originalText: `${deliveryDate} - ${cleanWeight} KG`
                                        });
                                        console.log(`✅ Found delivery: ${parsedDate} - ${cleanWeight} KG`);
                                    }
                                }
                            }
                        }
                    }
                } else {
                    console.log('⚠️ No delivery section found, trying fallback patterns...');
                    
                    // Fallback: Look for any date-weight combinations that look like deliveries
                    const fallbackPatterns = [
                        /(\d{1,2}\/\d{1,2}\/\d{4})\s+(\d{3,}(?:,\d{3})*(?:\.\d+)?)/gi,
                        /(\d{3,}(?:,\d{3})*(?:\.\d+)?)\s+(\d{1,2}\/\d{1,2}\/\d{4})/gi
                    ];
                    
                    for (const pattern of fallbackPatterns) {
                        const matches = text.matchAll(pattern);
                        for (const match of matches) {
                            const deliveryDate = match[1];
                            const deliveryWeight = match[2];
                            
                            if (deliveryDate && deliveryWeight) {
                                const cleanWeight = deliveryWeight.replace(/,/g, '');
                                if (!isNaN(parseFloat(cleanWeight)) && parseFloat(cleanWeight) >= 100) {
                                    extractedInfo.deliveryDates.push({
                                        date: deliveryDate,
                                        weight: parseFloat(cleanWeight),
                                        originalText: `${deliveryDate} - ${cleanWeight} KG`
                                    });
                                    console.log(`✅ Found delivery (fallback): ${deliveryDate} - ${cleanWeight} KG`);
                                }
                            }
                        }
                    }
                }
                
                // Remove duplicates and sort by date
                const uniqueDeliveries = [];
                const seenDates = new Set();
                
                extractedInfo.deliveryDates.forEach(delivery => {
                    if (!seenDates.has(delivery.date)) {
                        seenDates.add(delivery.date);
                        uniqueDeliveries.push(delivery);
                    }
                });
                
                extractedInfo.deliveryDates = uniqueDeliveries.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                console.log(`✅ Total deliveries found: ${extractedInfo.deliveryDates.length}`);
                
                // Convert to old format for compatibility
                const feedDates = extractedInfo.deliveryDates.map(delivery => ({
                    date: new Date(delivery.date),
                    originalText: delivery.originalText,
                    formattedDate: new Date(delivery.date).toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    weight: delivery.weight
                }));
                
                console.log('📊 Feed dates with weights:', feedDates.map(fd => `${fd.formattedDate}: ${fd.weight} KG`));
                
                // Return both new and old format for compatibility
                return {
                    feedDates: feedDates,
                    extractedInfo: {
                        ...extractedInfo,
                        farmInfo: {
                            farmName: extractedInfo.farm,
                            barnNumber: extractedInfo.barn,
                            floorNumber: '1'
                        }
                    }
                };
            }

            // Save feed schedule to Firestore
            async function saveFeedScheduleToFirestore(fileName, feedDates, fullText, file, locationData) {
                try {
                    // Convert file to base64 for storage in Firestore
                    const base64Data = await fileToBase64(file);
                    
                    const feedScheduleData = {
                        fileName: fileName,
                        originalFileName: locationData.originalFileName,
                        uploadDate: serverTimestamp(),
                        feedDates: feedDates.map(item => ({
                            date: item.date,
                            originalText: item.originalText,
                            formattedDate: item.formattedDate,
                            weight: item.weight
                        })),
                        fullText: fullText,
                        fileData: base64Data, // Store file as base64
                        fileSize: file.size,
                        fileType: file.type,
                        status: 'active',
                        // Location information
                        farm: locationData.farm,
                        barn: locationData.barn,
                        floor: locationData.floor,
                        location: `${locationData.farm} - ${locationData.barn} - ${locationData.floor}`,
                        // Extracted detailed information
                        extractedInfo: locationData.extractedInfo || {}
                    };

                    await addDoc(collection(db, 'feed_schedules'), feedScheduleData);
                    console.log('Feed schedule saved to Firestore');

                    // Also create system alerts for upcoming feed dates
                    await createSystemAlertsFromFeedDates(feedDates, fileName, locationData);
                } catch (error) {
                    console.error('Error saving to Firestore:', error);
                    throw error;
                }
            }

            // Convert file to base64
            function fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            // Format file size
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Test function for PDF date extraction (call from browser console)
            window.testPdfDateExtraction = function(testText) {
                console.log('Testing PDF Date Extraction with text:');
                console.log(testText);
                const result = extractFeedDates(testText);
                console.log('Extraction Result:', result);
                console.log('Farm:', result.extractedInfo.farm);
                console.log('Barn:', result.extractedInfo.barn);
                console.log('Deliveries found:', result.feedDates.length);
                return result;
            };
            
            // Test with sample data from your PDFs
            window.testWithSampleData = function() {
                const sampleText = `
                ED PLAN: HD NicarbSacox - AW L0R 2A0
                NUMBER PLACED: 24,000
                DATE PLACED: 07/21/2025
                BIN & SIZE: 3B / 10.00 MT
                BIN & SIZE: 3A / 18.00 MT
                BARN 3 - VASSILAKOS FARMS INC
                BARN: 3 VAS 01
                CROP CYCLE: 21982
                SHIPMENT ID: Cockerel Bin ID
                PHONE: 905-741-1544
                SALESPERSON: SCOTT NIEUWLAND
                QUOTA PERIOD: A197
                
                8,000.00 HD Broiler Starter 1 3A Mon Jul-14-2025 12:00
                9,000.00 HD Broiler Starter 2 3A Tue Jul-29-2025 00:00
                12,000.00 HD Broiler Grower 3A Fri Aug-08-2025 00:00
                `;
                
                console.log('Testing with sample data from your PDFs...');
                return testPdfDateExtraction(sampleText);
            };

            // Create system alerts from feed dates
            async function createSystemAlertsFromFeedDates(feedDates, fileName, locationData) {
                try {
                    for (const feedDate of feedDates) {
                        const alertData = {
                            type: 'feed_schedule',
                            title: 'Feed Schedule Alert',
                            message: `Feed scheduled for ${feedDate.formattedDate} at ${locationData.farm} - ${locationData.barn} - ${locationData.floor}`,
                            originalText: feedDate.originalText,
                            scheduledDate: feedDate.date,
                            createdAt: serverTimestamp(),
                            status: 'active',
                            farm: locationData.farm,
                            barn: locationData.barn,
                            floor: locationData.floor,
                            fileName: fileName
                        };

                        await addDoc(collection(db, 'system_alerts'), alertData);
                    }
                    console.log(`Created ${feedDates.length} system alerts for feed dates`);
                } catch (error) {
                    console.error('Error creating system alerts:', error);
                }
            }

            // Show feed schedule preview
            function showFeedSchedulePreview(feedDates) {
                const feedDatesList = document.getElementById('feedDatesList');
                const feedSchedulePreview = document.getElementById('feedSchedulePreview');
                
                if (!feedDatesList || !feedSchedulePreview) {
                    console.log('Preview elements not found, skipping preview display');
                    return;
                }
                
                if (feedDates.length === 0) {
                    feedDatesList.innerHTML = '<p class="no-dates">No feed dates found in the PDF.</p>';
                } else {
                    feedDatesList.innerHTML = feedDates.map(item => `
                        <div class="feed-date-item">
                            <i class="fas fa-calendar-day"></i>
                            <div class="feed-date-content">
                                <h5>${item.formattedDate}</h5>
                                <p>${item.weight ? `${item.weight} KG` : 'Date only'}</p>
                            </div>
                        </div>
                    `).join('');
                }
                
                feedSchedulePreview.style.display = 'block';
            }

                         // Helper function to get farm color class
                         function getFarmColorClass(farmName) {
                             if (!farmName) return '';
                             const farm = farmName.toUpperCase();
                             if (farm.includes('VAS')) return 'vas';
                             if (farm.includes('EDG')) return 'edg';
                             if (farm.includes('APO')) return 'apo';
                             if (farm.includes('SIG')) return 'sig';
                             if (farm.includes('DFI')) return 'dfi';
                             return '';
                         }

                         // Helper function to calculate total KGs from feed dates
                         function calculateTotalKGs(feedDates) {
                             if (!feedDates || feedDates.length === 0) return '0';
                             
                             console.log('🔍 Calculating total KGs from feed dates:', feedDates);
                             let totalKGs = 0;
                             feedDates.forEach((date, index) => {
                                 console.log(`🔍 Date ${index} weight:`, date.weight, 'deliveryInfo:', date.deliveryInfo);
                                 if (date.weight) {
                                     // Handle both string and number weights
                                     let weightValue = date.weight;
                                     if (typeof weightValue === 'string') {
                                         weightValue = weightValue.replace(/,/g, '');
                                     }
                                     const weight = parseFloat(weightValue);
                                     if (!isNaN(weight)) {
                                         totalKGs += weight;
                                         console.log(`✅ Added ${weight} to total (now ${totalKGs})`);
                                     }
                                 } else if (date.deliveryInfo && date.deliveryInfo.weight) {
                                     let weightValue = date.deliveryInfo.weight;
                                     if (typeof weightValue === 'string') {
                                         weightValue = weightValue.replace(/,/g, '');
                                     }
                                     const weight = parseFloat(weightValue);
                                     if (!isNaN(weight)) {
                                         totalKGs += weight;
                                         console.log(`✅ Added ${weight} from deliveryInfo to total (now ${totalKGs})`);
                                     }
                                 } else {
                                     console.log(`❌ No weight found for date ${index}`);
                                 }
                             });
                             
                             console.log(`📊 Final total KGs: ${totalKGs.toLocaleString()}`);
                             return totalKGs.toLocaleString();
                         }

                         // Load upcoming feed schedules
                         async function loadUpcomingFeedSchedules() {
                             try {
                                 const upcomingFeedSchedules = document.getElementById('upcomingFeedSchedules');
                                 
                                 if (!upcomingFeedSchedules) {
                                     console.log('Upcoming feed schedules element not found, skipping loading');
                                     return;
                                 }
                                 
                                 const q = query(collection(db, 'feed_schedules'), orderBy('uploadDate', 'desc'));
                                 const querySnapshot = await getDocs(q);
                                 
                                 const allUpcomingDates = [];
                                 const now = new Date();
                                 
                                 querySnapshot.forEach((doc) => {
                                     const data = doc.data();
                                     if (data.feedDates && data.feedDates.length > 0) {
                                         // Get ALL upcoming feed dates from this schedule
                                         const upcomingDates = data.feedDates
                                             .map(date => ({
                                                 ...date,
                                                 date: date.date.toDate ? date.date.toDate() : new Date(date.date),
                                                 scheduleId: doc.id,
                                                 fileName: data.fileName,
                                                 farm: data.farm,
                                                 barn: data.barn,
                                                 floor: data.floor,
                                                 fileData: data.fileData
                                             }))
                                             .filter(date => date.date > now);
                                         
                                         allUpcomingDates.push(...upcomingDates);
                                     }
                                 });
                                 
                                 // Sort ALL upcoming dates from closest to furthest
                                 allUpcomingDates.sort((a, b) => a.date - b.date);
                                 
                                 if (allUpcomingDates.length === 0) {
                                     upcomingFeedSchedules.innerHTML = `
                                         <div class="no-upcoming-schedules">
                                             <i class="fas fa-calendar-times"></i>
                                             <p>No upcoming feed schedules</p>
                                         </div>
                                     `;
                                 } else {
                                     // Show only first 3 schedules
                                     const displaySchedules = allUpcomingDates.slice(0, 3);
                                     const hasMore = allUpcomingDates.length > 3;
                                     
                                     upcomingFeedSchedules.innerHTML = displaySchedules.map(feedDate => {
                                         const farmColorClass = getFarmColorClass(feedDate.farm);
                                         
                                         // Get weight from the feed date if available
                                         const weight = feedDate.weight || feedDate.deliveryInfo?.weight || '';
                                         
                                         // Format the date
                                         const formattedDate = feedDate.formattedDate || feedDate.date.toLocaleDateString();
                                         
                                         return `
                                             <div class="upcoming-feed-item ${farmColorClass}">
                                                 <div class="feed-date-info">
                                                     <div class="feed-date">
                                                         <i class="fas fa-calendar-day"></i>
                                                         <span class="date-text">${formattedDate}</span>
                                                     </div>
                                                     <div class="feed-location">
                                                         <span class="barn-info-bold">${feedDate.farm} ${feedDate.barn}</span>
                                                     </div>
                                                     ${weight ? `
                                                         <div class="feed-weight">
                                                             <span class="weight-badge-bold">${weight} KG</span>
                                                         </div>
                                                     ` : ''}
                                                 </div>
                                                 <div class="feed-actions">
                                                     <button class="btn btn-outline btn-sm" onclick="viewPdf('${feedDate.fileData || ''}', '${feedDate.fileName}')">
                                                         <i class="fas fa-eye"></i> View
                                                     </button>
                                                 </div>
                                             </div>
                                         `;
                                     }).join('') + (hasMore ? `
                                         <div class="view-more-schedules">
                                             <button class="btn btn-primary" onclick="navigateToSection('feed-schedules')">
                                                 <i class="fas fa-chevron-down"></i> View ${allUpcomingDates.length - 3} More Schedules
                                             </button>
                                         </div>
                                     ` : '');
                                 }
                             } catch (error) {
                                 console.error('Error loading upcoming feed schedules:', error);
                                 const upcomingFeedSchedules = document.getElementById('upcomingFeedSchedules');
                                 upcomingFeedSchedules.innerHTML = `
                                     <div class="error-loading">
                                         <i class="fas fa-exclamation-triangle"></i>
                                         <p>Error loading upcoming schedules</p>
                                     </div>
                                 `;
                             }
                         }
             
             // Load and display upcoming alerts
             async function loadUpcomingAlerts() {
                try {
                    // Check if required elements exist before proceeding
                    const alertsList = document.getElementById('alertsList');
                    const upcomingAlerts = document.getElementById('upcomingAlerts');
                    
                    if (!alertsList || !upcomingAlerts) {
                        console.log('Alert elements not found, skipping alert loading');
                        return;
                    }
                    
                    const q = query(
                        collection(db, 'system_alerts'), 
                        orderBy('scheduledDate', 'asc')
                    );
                    const querySnapshot = await getDocs(q);
                    
                    const alerts = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.type === 'feed_schedule' && data.status === 'active') {
                            const scheduledDate = data.scheduledDate ? new Date(data.scheduledDate.toDate()) : new Date();
                            if (scheduledDate > new Date()) {
                                alerts.push({
                                    id: doc.id,
                                    ...data,
                                    scheduledDate: scheduledDate
                                });
                            }
                        }
                    });

                    if (alerts.length > 0) {
                        alertsList.innerHTML = alerts.slice(0, 5).map(alert => `
                            <div class="alert-item info">
                                <i class="fas fa-calendar-day"></i>
                                <div class="alert-content">
                                    <h4>${alert.title}</h4>
                                    <p>${alert.message}</p>
                                </div>
                                <span class="alert-time">${alert.scheduledDate.toLocaleDateString()}</span>
                            </div>
                        `).join('');
                        upcomingAlerts.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading upcoming alerts:', error);
                }
            }

            // PDF viewing variables
            let currentPdfUrl = null;
            let currentFileName = null;

            // View PDF function
            window.viewPdf = async function(fileData, fileName) {
                try {
                    if (!fileData) {
                        alert('No PDF file available for this schedule.');
                        return;
                    }
                    
                    currentPdfUrl = fileData;
                    currentFileName = fileName;
                    
                    const modal = document.getElementById('pdfModal');
                    const modalBody = modal.querySelector('.modal-body');
                    const modalContent = modal.querySelector('.modal-content');
                    
                    document.getElementById('pdfModalTitle').textContent = fileName;
                    modal.style.display = 'block';
                    
                    // Add PDF viewer specific class to modal body and content
                    modalBody.classList.add('pdf-viewer-body');
                    modalContent.classList.add('pdf-viewer-modal');
                    
                    // Make modal draggable
                    makeModalDraggable(modalContent);
                    
                    // Show loading state
                    document.getElementById('pdfLoading').style.display = 'flex';
                    document.getElementById('pdfError').style.display = 'none';
                    document.getElementById('pdfContent').style.display = 'none';
                    
                    // Try to load PDF in iframe using base64 data
                    const iframe = document.getElementById('pdfIframe');
                    iframe.src = fileData;
                    
                    // Set up iframe load event
                    iframe.onload = function() {
                        document.getElementById('pdfLoading').style.display = 'none';
                        document.getElementById('pdfContent').style.display = 'block';
                    };
                    
                    // Set up iframe error event
                    iframe.onerror = function() {
                        showPdfError();
                    };
                    
                                         // Set up fallback download
                     document.getElementById('downloadFallback').onclick = function() {
                         downloadPdfFile(fileData, fileName);
                     };
                    
                    // Timeout fallback
                    setTimeout(() => {
                        if (document.getElementById('pdfLoading').style.display !== 'none') {
                            showPdfError();
                        }
                    }, 10000);
                    
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    showPdfError();
                }
            };

            // Make modal draggable
            function makeModalDraggable(modalContent) {
                let isDragging = false;
                let currentX;
                let currentY;
                let initialX;
                let initialY;
                let xOffset = 0;
                let yOffset = 0;

                const header = modalContent.querySelector('.modal-header');
                
                header.addEventListener('mousedown', dragStart);
                document.addEventListener('mousemove', drag);
                document.addEventListener('mouseup', dragEnd);

                function dragStart(e) {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;

                    if (e.target === header || header.contains(e.target)) {
                        isDragging = true;
                    }
                }

                function drag(e) {
                    if (isDragging) {
                        e.preventDefault();
                        currentX = e.clientX - initialX;
                        currentY = e.clientY - initialY;

                        xOffset = currentX;
                        yOffset = currentY;

                        setTranslate(currentX, currentY, modalContent);
                    }
                }

                function setTranslate(xPos, yPos, el) {
                    el.style.transform = `translate(${xPos}px, ${yPos}px)`;
                }

                function dragEnd(e) {
                    initialX = currentX;
                    initialY = currentY;
                    isDragging = false;
                }
            }

            // Show PDF error
            function showPdfError() {
                document.getElementById('pdfLoading').style.display = 'none';
                document.getElementById('pdfContent').style.display = 'none';
                document.getElementById('pdfError').style.display = 'flex';
            }

            // Download PDF function
            window.downloadPdf = function(fileData, fileName) {
                if (!fileData) {
                    alert('No PDF file available for this schedule.');
                    return;
                }
                downloadPdfFile(fileData, fileName);
            };
            // Enhanced download function for base64 data
            function downloadPdfFile(fileData, fileName) {
                try {
                    // Convert base64 to blob and download
                    const base64Response = fetch(fileData);
                    base64Response.then(res => res.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = fileName;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            console.error('Download failed:', error);
                            // Fallback: open in new tab
                            window.open(fileData, '_blank');
                        });
                } catch (error) {
                    console.error('Download failed:', error);
                    // Fallback: open in new tab
                    window.open(fileData, '_blank');
                }
            }

            // Close PDF modal
            window.closePdfModal = function() {
                const modal = document.getElementById('pdfModal');
                const modalBody = modal.querySelector('.modal-body');
                const modalContent = modal.querySelector('.modal-content');
                
                modal.style.display = 'none';
                modalBody.classList.remove('pdf-viewer-body');
                modalContent.classList.remove('pdf-viewer-modal');
                
                // Reset transform to center the modal
                modalContent.style.transform = 'translate(-50%, -50%)';
                
                const iframe = document.getElementById('pdfIframe');
                iframe.src = '';
                currentPdfUrl = null;
                currentFileName = null;
            };

            // View all feed schedules
            window.viewAllFeedSchedules = async function() {
                try {
                    const q = query(collection(db, 'feed_schedules'), orderBy('uploadDate', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    const schedules = [];
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        schedules.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    showSchedulesModal(schedules);
                } catch (error) {
                    console.error('Error fetching feed schedules:', error);
                    alert('Error fetching feed schedules');
                }
            };

                         // Show schedules modal
             function showSchedulesModal(schedules) {
                 const modal = document.createElement('div');
                 modal.className = 'modal';
                 modal.id = 'schedulesModal';
                 modal.style.display = 'block';
                 
                 let schedulesHtml = '';
                 if (schedules.length === 0) {
                     schedulesHtml = '<p class="no-schedules">No schedules found</p>';
                 } else {
                     schedulesHtml = schedules.map(schedule => `
                         <div class="schedule-item">
                             <div class="schedule-header">
                                 <div class="schedule-title">
                                     <h4>${schedule.fileName}</h4>
                                     ${schedule.location ? `<span class="location-badge">${schedule.location}</span>` : ''}
                                 </div>
                                 <div class="schedule-actions">
                                     <button class="btn btn-outline" onclick="viewPdf('${schedule.fileData || ''}', '${schedule.fileName}')">
                                         <i class="fas fa-eye"></i> View PDF
                                     </button>
                                     <button class="btn btn-outline" onclick="downloadPdf('${schedule.fileData || ''}', '${schedule.fileName}')">
                                         <i class="fas fa-download"></i> Download
                                     </button>
                                     <button class="btn btn-danger" onclick="removeSchedule('${schedule.id}', '${schedule.fileName}')">
                                         <i class="fas fa-trash"></i> Remove
                                     </button>
                                 </div>
                             </div>
                             <div class="schedule-details">
                                 <div class="detail-row">
                                     <p><strong>Uploaded:</strong> ${schedule.uploadDate ? new Date(schedule.uploadDate.toDate()).toLocaleDateString() : 'N/A'}</p>
                                     <p><strong>Feed Dates Found:</strong> ${schedule.feedDates ? schedule.feedDates.length : 0}</p>
                                 </div>
                                 <div class="detail-row">
                                     <p><strong>File Size:</strong> ${schedule.fileSize ? formatFileSize(schedule.fileSize) : 'N/A'}</p>
                                     <p><strong>Status:</strong> <span class="status-badge ${schedule.status}">${schedule.status}</span></p>
                                 </div>
                                 ${schedule.originalFileName ? `<p><strong>Original File:</strong> ${schedule.originalFileName}</p>` : ''}
                             </div>
                             ${schedule.feedDates && schedule.feedDates.length > 0 ? `
                                 <div class="schedule-feed-dates">
                                     <h5>Feed Dates:</h5>
                                     <div class="feed-dates-mini">
                                         ${schedule.feedDates.slice(0, 3).map(date => `
                                             <span class="date-badge">${date.formattedDate}${date.weight ? ` - ${date.weight} KG` : ''}</span>
                                         `).join('')}
                                         ${schedule.feedDates.length > 3 ? `<span class="more-dates">+${schedule.feedDates.length - 3} more</span>` : ''}
                                     </div>
                                 </div>
                             ` : ''}
                         </div>
                     `).join('');
                 }
                 
                 modal.innerHTML = `
                     <div class="modal-content large">
                         <div class="modal-header">
                             <h3>All Feed Schedules (${schedules.length})</h3>
                             <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                         </div>
                         <div class="modal-body">
                             <div class="schedules-list">
                                 ${schedulesHtml}
                             </div>
                         </div>
                     </div>
                 `;
                 
                 document.body.appendChild(modal);
             }

             // Remove schedule function
             window.removeSchedule = async function(scheduleId, fileName) {
                 if (confirm(`Are you sure you want to remove "${fileName}"? This action cannot be undone.`)) {
                     try {
                         // Delete from Firestore
                         await deleteDoc(doc(db, 'feed_schedules', scheduleId));
                         
                         // Also delete associated system alerts
                         const alertsQuery = query(
                             collection(db, 'system_alerts'),
                             orderBy('fileName', 'asc')
                         );
                         const alertsSnapshot = await getDocs(alertsQuery);
                         
                         const deletePromises = [];
                         alertsSnapshot.forEach((alertDoc) => {
                             const alertData = alertDoc.data();
                             if (alertData.fileName === fileName) {
                                 deletePromises.push(deleteDoc(alertDoc.ref));
                             }
                         });
                         
                         if (deletePromises.length > 0) {
                             await Promise.all(deletePromises);
                         }
                         
                         // Show success message
                         alert(`"${fileName}" has been successfully removed.`);
                         
                                                   // Refresh the schedules display
                          if (window.loadFeedSchedules) {
                              window.loadFeedSchedules();
                          }
                          
                          // Refresh upcoming feed schedules
                          await loadUpcomingFeedSchedules();
                          
                          // Also refresh the modal if it exists
                          const currentModal = document.getElementById('schedulesModal');
                          if (currentModal) {
                              currentModal.remove();
                              viewAllFeedSchedules();
                          }
                         
                     } catch (error) {
                         console.error('Error removing schedule:', error);
                         alert('Error removing schedule. Please try again.');
                     }
                 }
             }

            // Edit date name function
            window.editDateName = async function(scheduleId, dateIndex, currentName) {
                const customName = prompt('Enter a custom name for this feed date:', currentName);
                
                if (customName && customName.trim() !== '') {
                    try {
                        // Get the current schedule document
                        const scheduleRef = doc(db, 'feed_schedules', scheduleId);
                        
                        // We need to get the current data first
                        const scheduleDoc = await getDoc(scheduleRef);
                        if (!scheduleDoc.exists()) {
                            alert('Schedule not found.');
                            return;
                        }
                        
                        const scheduleData = scheduleDoc.data();
                        const updatedFeedDates = [...scheduleData.feedDates];
                        
                        // Update the specific date with custom name
                        if (updatedFeedDates[dateIndex]) {
                            updatedFeedDates[dateIndex] = {
                                ...updatedFeedDates[dateIndex],
                                customName: customName.trim()
                            };
                        }
                        
                        // Update the document
                        await updateDoc(scheduleRef, {
                            feedDates: updatedFeedDates
                        });
                        
                        // Reload the schedules to show the updated name
                        if (window.loadFeedSchedules) {
                            window.loadFeedSchedules();
                        }
                        
                        alert('Date name updated successfully!');
                        
                    } catch (error) {
                        console.error('Error updating date name:', error);
                        alert('Error updating date name. Please try again.');
                    }
                }
            }

            // Helper function to get farm color class
            function getFarmColorClass(farmName) {
                if (!farmName) return '';
                const farm = farmName.toUpperCase();
                if (farm.includes('VAS')) return 'vas';
                if (farm.includes('EDG')) return 'edg';
                if (farm.includes('APO')) return 'apo';
                if (farm.includes('SIG')) return 'sig';
                if (farm.includes('DFI')) return 'dfi';
                return '';
            }

            // Function to delete all PDFs from feed_schedules collection
            async function deleteAllPDFs() {
                try {
                    console.log('🗑️ Starting deletion of all PDFs...');
                    
                    const q = query(collection(db, 'feed_schedules'));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        console.log('📭 No PDFs found to delete');
                        alert('No PDFs found to delete');
                        return;
                    }
                    
                    const deletePromises = querySnapshot.docs.map(doc => deleteDoc(doc.ref));
                    await Promise.all(deletePromises);
                    
                    console.log(`✅ Successfully deleted ${querySnapshot.docs.length} PDFs`);
                    alert(`Successfully deleted ${querySnapshot.docs.length} PDFs`);
                    
                    // Refresh the display
                    if (window.loadFeedSchedules) {
                        await window.loadFeedSchedules();
                    }
                    await loadUpcomingFeedSchedules();
                    
                } catch (error) {
                    console.error('❌ Error deleting PDFs:', error);
                    alert('Error deleting PDFs. Check console for details.');
                }
            }

            // Make the function globally accessible
            window.deleteAllPDFs = deleteAllPDFs;

            // Wrapper functions for calendar feed schedule actions
            window.viewFeedSchedulePdf = async function(scheduleId, fileName) {
                // Find the schedule in feedScheduleEvents to get fileData
                const schedule = feedScheduleEvents.find(e => e.id === scheduleId || e.scheduleId === scheduleId);
                if (schedule && schedule.fileData) {
                    viewPdf(schedule.fileData, fileName);
                } else {
                    // Try to fetch the schedule from Firestore if fileData is not available
                    try {
                        if (typeof db !== 'undefined') {
                            const docRef = doc(db, 'feed_schedules', scheduleId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.fileData) {
                                    viewPdf(data.fileData, fileName);
                                } else {
                                    alert('PDF file not found for this schedule.');
                                }
                            } else {
                                alert('Schedule not found.');
                            }
                        } else {
                            alert('PDF file not found for this schedule.');
                        }
                    } catch (error) {
                        console.error('Error fetching schedule:', error);
                        alert('Error loading PDF. Please try again.');
                    }
                }
            };

            window.downloadFeedSchedule = async function(scheduleId, fileName) {
                // Find the schedule in feedScheduleEvents to get fileData
                const schedule = feedScheduleEvents.find(e => e.id === scheduleId || e.scheduleId === scheduleId);
                if (schedule && schedule.fileData) {
                    downloadPdf(schedule.fileData, fileName);
                } else {
                    // Try to fetch the schedule from Firestore if fileData is not available
                    try {
                        if (typeof db !== 'undefined') {
                            const docRef = doc(db, 'feed_schedules', scheduleId);
                            const docSnap = await getDoc(docRef);
                            if (docSnap.exists()) {
                                const data = docSnap.data();
                                if (data.fileData) {
                                    downloadPdf(data.fileData, fileName);
                                } else {
                                    alert('PDF file not found for this schedule.');
                                }
                            } else {
                                alert('Schedule not found.');
                            }
                        } else {
                            alert('PDF file not found for this schedule.');
                        }
                    } catch (error) {
                        console.error('Error fetching schedule:', error);
                        alert('Error loading PDF. Please try again.');
                    }
                }
            };

            window.deleteFeedSchedule = async function(scheduleId, fileName, year, month, day) {
                if (confirm(`Are you sure you want to delete "${fileName}"? This action cannot be undone.`)) {
                    try {
                        // Use the existing removeSchedule function
                        await removeSchedule(scheduleId, fileName);
                        
                        // Refresh the calendar display
                        updateCalendarDisplay();
                        
                        // Show success message
                        alert('Schedule deleted successfully.');
                    } catch (error) {
                        console.error('Error deleting schedule:', error);
                        alert('Error deleting schedule. Please try again.');
                    }
                }
            };

            // Monday.com Style Calendar
            let currentDate = new Date();
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Auto-load calendar when section is shown
            document.addEventListener('DOMContentLoaded', function() {
                // Set up calendar auto-loading
                const calendarSection = document.getElementById('calendar');
                if (calendarSection) {
                    const observer = new MutationObserver(function(mutations) {
                        mutations.forEach(function(mutation) {
                            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                                if (calendarSection.style.display !== 'none') {
                                    // Calendar section is now visible, load events
                                    setTimeout(() => {
                                        try {
                                            if (window.loadFeedSchedulesForCalendar) {
                                                window.loadFeedSchedulesForCalendar().then(() => {
                                                    rebuildCalendarEventMap();
                                                    updateCalendarDisplay();
                                                    focusNearestEventMonthIfNeeded();
                                                });
                                            } else {
                                                rebuildCalendarEventMap();
                                                updateCalendarDisplay();
                                                focusNearestEventMonthIfNeeded();
                                            }
                                        } catch (e) {
                                            console.warn('⚠️ Calendar auto-load error:', e);
                                            try { rebuildCalendarEventMap(); updateCalendarDisplay(); } catch(_) {}
                                        }
                                    }, 100);
                                }
                            }
                        });
                    });
                    
                    observer.observe(calendarSection, { attributes: true });
                }
                
                // Auto-load feed schedules when page loads
                if (window.loadFeedSchedules) {
                    setTimeout(() => {
                        window.loadFeedSchedules();
                    }, 500);
                }
            });

            // Sample events data (like Monday.com) - Events for different months
            const sampleEvents = [
                {
                    id: 1,
                    title: 'Feed Delivery - VAS Barn B2',
                    startDate: new Date(2025, 0, 15), // January 15, 2025
                    endDate: new Date(2025, 0, 15),
                    type: 'feed-delivery',
                    farm: 'VAS',
                    barn: 'B2',
                    weight: '5,250 KG',
                    color: '#3b82f6'
                },
                {
                    id: 2,
                    title: 'Feed Delivery - EDG Barn B1',
                    startDate: new Date(2025, 0, 18), // January 18, 2025
                    endDate: new Date(2025, 0, 18),
                    type: 'feed-delivery',
                    farm: 'EDG',
                    barn: 'B1',
                    weight: '8,000 KG',
                    color: '#10b981'
                },
                {
                    id: 3,
                    title: 'Vaccination Schedule',
                    startDate: new Date(2025, 0, 22), // January 22, 2025
                    endDate: new Date(2025, 0, 24), // January 24, 2025
                    type: 'vaccination',
                    farm: 'VAS',
                    barn: 'B3',
                    color: '#f59e0b'
                },
                {
                    id: 4,
                    title: 'Equipment Maintenance',
                    startDate: new Date(2025, 0, 28), // January 28, 2025
                    endDate: new Date(2025, 0, 28),
                    type: 'maintenance',
                    farm: 'APO',
                    barn: 'B1',
                    color: '#ef4444'
                },
                {
                    id: 5,
                    title: 'Feed Delivery - SIG Barn B2',
                    startDate: new Date(2025, 0, 30), // January 30, 2025
                    endDate: new Date(2025, 0, 30),
                    type: 'feed-delivery',
                    farm: 'SIG',
                    barn: 'B2',
                    weight: '6,500 KG',
                    color: '#8b5cf6'
                },
                // February events (28 days)
                {
                    id: 6,
                    title: 'Feed Delivery - VAS Barn B1',
                    startDate: new Date(2025, 1, 5), // February 5, 2025
                    endDate: new Date(2025, 1, 5),
                    type: 'feed-delivery',
                    farm: 'VAS',
                    barn: 'B1',
                    weight: '4,800 KG',
                    color: '#3b82f6'
                },
                {
                    id: 7,
                    title: 'Health Check',
                    startDate: new Date(2025, 1, 14), // February 14, 2025
                    endDate: new Date(2025, 1, 14),
                    type: 'health-check',
                    farm: 'EDG',
                    barn: 'B2',
                    color: '#10b981'
                },
                // March events (31 days)
                {
                    id: 8,
                    title: 'Feed Delivery - APO Barn B3',
                    startDate: new Date(2025, 2, 10), // March 10, 2025
                    endDate: new Date(2025, 2, 10),
                    type: 'feed-delivery',
                    farm: 'APO',
                    barn: 'B3',
                    weight: '7,200 KG',
                    color: '#8b5cf6'
                }
            ];

            // Feed schedule events for calendar
            let feedScheduleEvents = [];
            let currentEventFilter = ['all'];
            let currentFarmFilter = 'all';
            let currentBarnFilter = 'all';

            // Function to load feed schedules and notes for calendar
            let isLoadingCalendar = false;
            async function loadFeedSchedulesForCalendar() {
                if (isLoadingCalendar) {
                    console.log('⏳ loadFeedSchedulesForCalendar already in progress, skipping...');
                    return;
                }
                
                isLoadingCalendar = true;
                try {
                    console.log('🔄 Loading feed schedules and notes for calendar...');
                    
                    // Check if Firebase is available
                    if (typeof db === 'undefined') {
                        console.log('⚠️ Firebase not available, using sample data');
                        
                        // Create sample feed schedule events for testing
                        feedScheduleEvents = [
                            {
                                id: 'sample_feed_1',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 14), // July 14, 2025
                                endDate: new Date(2025, 6, 14),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '8,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_2',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 29), // July 29, 2025
                                endDate: new Date(2025, 6, 29),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_3',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 7, 1), // August 1, 2025
                                endDate: new Date(2025, 7, 1),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_4',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 16), // July 16, 2025
                                endDate: new Date(2025, 6, 16),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '7,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_5',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 30), // July 30, 2025
                                endDate: new Date(2025, 6, 30),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '8,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            }
                        ];
                        
                        // Add sample note events
                        const sampleNoteEvents = [
                            {
                                id: 'sample_note_1',
                                title: 'Barn 1 Ventilation Check',
                                startDate: new Date(2025, 6, 15), // July 15, 2025
                                endDate: new Date(2025, 6, 15),
                                type: 'note',
                                farm: 'VAS',
                                barn: 'B1',
                                color: '#f59e0b',
                                source: 'note'
                            },
                            {
                                id: 'sample_note_2',
                                title: 'Feed Quality Inspection',
                                startDate: new Date(2025, 6, 20), // July 20, 2025
                                endDate: new Date(2025, 6, 20),
                                type: 'note',
                                farm: 'APO',
                                barn: 'B2',
                                color: '#f59e0b',
                                source: 'note'
                            }
                        ];
                        feedScheduleEvents = [...feedScheduleEvents, ...sampleNoteEvents];
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.length} sample events for calendar`);
                        
                        // Set calendar to July 2025 to show the sample events
                        currentDate = new Date(2025, 6, 1); // July 2025
                        console.log('📅 Setting calendar to July 2025 to show sample events');
                        
                        rebuildCalendarEventMap();
                        updateCalendarDisplay();
                        return;
                    }
                    
                    // Check if we're in bypass mode - if so, skip database query and go straight to sample data
                    const authBypass = sessionStorage.getItem('flockview_auth_bypass');
                    if (authBypass === 'true') {
                        console.log('🔓 Bypass mode: Skipping database query, using sample data...');
                        
                        // Use the same sample data as above
                        feedScheduleEvents = [
                            {
                                id: 'sample_feed_1',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 14), // July 14, 2025
                                endDate: new Date(2025, 6, 14),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '8,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_2',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 29), // July 29, 2025
                                endDate: new Date(2025, 6, 29),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_3',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 7, 1), // August 1, 2025
                                endDate: new Date(2025, 7, 1),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_4',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 16), // July 16, 2025
                                endDate: new Date(2025, 6, 16),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '7,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_5',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 30), // July 30, 2025
                                endDate: new Date(2025, 6, 30),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '8,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            }
                        ];
                        
                        // Add sample note events
                        const sampleNoteEvents = [
                            {
                                id: 'sample_note_1',
                                title: 'Barn 1 Ventilation Check',
                                startDate: new Date(2025, 6, 15), // July 15, 2025
                                endDate: new Date(2025, 6, 15),
                                type: 'note',
                                farm: 'VAS',
                                barn: 'B1',
                                color: '#f59e0b',
                                source: 'note'
                            },
                            {
                                id: 'sample_note_2',
                                title: 'Feed Quality Inspection',
                                startDate: new Date(2025, 6, 20), // July 20, 2025
                                endDate: new Date(2025, 6, 20),
                                type: 'note',
                                farm: 'APO',
                                barn: 'B2',
                                color: '#f59e0b',
                                source: 'note'
                            }
                        ];
                        feedScheduleEvents = [...feedScheduleEvents, ...sampleNoteEvents];
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.length} sample events for calendar (bypass mode)`);
                        
                        // Set calendar to July 2025 to show the sample events
                        currentDate = new Date(2025, 6, 1); // July 2025
                        console.log('📅 Setting calendar to July 2025 to show sample events');
                        
                        // Add sample data indicator to calendar
                        const calendarSection = document.getElementById('calendar');
                        if (calendarSection) {
                            const sampleIndicator = document.createElement('div');
                            sampleIndicator.className = 'sample-data-indicator';
                            sampleIndicator.style.cssText = `
                                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
                                color: white;
                                padding: 10px 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                text-align: center;
                                font-weight: bold;
                                box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
                            `;
                            sampleIndicator.innerHTML = `
                                <i class="fas fa-calendar-alt" style="margin-right: 8px;"></i>
                                Sample Data Mode - Demo Calendar Events
                            `;
                            const calendarContent = calendarSection.querySelector('.calendar-content');
                            if (calendarContent) {
                                calendarContent.insertBefore(sampleIndicator, calendarContent.firstChild);
                            }
                        }
                        
                        rebuildCalendarEventMap();
                        updateCalendarDisplay();
                        return;
                    }
                    
                    feedScheduleEvents = [];
                    
                    // Load feed schedules
                    try {
                        const feedQuery = query(collection(db, 'feed_schedules'), orderBy('uploadDate', 'desc'));
                        
                        // Add timeout to prevent hanging
                        const feedQueryPromise = getDocs(feedQuery);
                        const feedTimeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Feed query timeout after 10 seconds')), 10000)
                        );
                        
                        const feedSnapshot = await Promise.race([feedQueryPromise, feedTimeoutPromise]);
                        
                        feedSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.feedDates && data.feedDates.length > 0) {
                                // Convert each feed date to a calendar event
                                data.feedDates.forEach((feedDate, index) => {
                                    const eventDate = parseEventDateLoose(feedDate.date);
                                    
                                    // Get weight from the feed date if available
                                    const weight = feedDate.weight || feedDate.deliveryInfo?.weight || 'Unknown';
                                    
                                    if (eventDate) {
                                        const event = {
                                            id: `${doc.id}_${index}`,
                                            title: `Feed Delivery - ${data.farmName || 'Unknown'} Barn ${data.barnNumber || 'Unknown'}`,
                                            startDate: eventDate,
                                            endDate: eventDate,
                                            type: 'feed-delivery',
                                            farm: data.farmName || 'Unknown',
                                            barn: data.barnNumber || 'Unknown',
                                            weight: weight,
                                            color: getFarmColor(data.farmName),
                                            source: 'feed-schedule'
                                        };
                                        feedScheduleEvents.push(event);
                                    }
                                });
                            }
                        });
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.filter(e => e.source === 'feed-schedule').length} feed schedule events`);
                    } catch (error) {
                        console.error('❌ Error loading feed schedules:', error);
                        // Add sample feed schedule events when query fails
                        console.log('📝 Adding sample feed schedule events for calendar...');
                        feedScheduleEvents = [
                            {
                                id: 'sample_feed_1',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 14), // July 14, 2025
                                endDate: new Date(2025, 6, 14),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '8,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_2',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 29), // July 29, 2025
                                endDate: new Date(2025, 6, 29),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_3',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 7, 1), // August 1, 2025
                                endDate: new Date(2025, 7, 1),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_4',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 16), // July 16, 2025
                                endDate: new Date(2025, 6, 16),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '7,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_5',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 30), // July 30, 2025
                                endDate: new Date(2025, 6, 30),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '8,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            }
                        ];
                        console.log(`✅ Added ${feedScheduleEvents.length} sample feed schedule events`);
                    }
                    
                    // Load notes
                    try {
                        const notesQuery = query(collection(db, 'farm_notes'), orderBy('createdAt', 'desc'));
                        
                        // Add timeout to prevent hanging
                        const notesQueryPromise = getDocs(notesQuery);
                        const notesTimeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Notes query timeout after 10 seconds')), 10000)
                        );
                        
                        const notesSnapshot = await Promise.race([notesQueryPromise, notesTimeoutPromise]);
                        
                        notesSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (!data) return;
                            
                            // Convert note to calendar event if it has a date
                            if (data.date) {
                                const eventDate = parseEventDateLoose(data.date);
                                if (eventDate) {
                                    const event = {
                                        id: `note_${doc.id}`,
                                        title: data.title || 'Note',
                                        startDate: eventDate,
                                        endDate: eventDate,
                                        type: 'note',
                                        farm: data.farm || 'Unknown',
                                        barn: data.barn || 'Unknown',
                                        content: data.content || '',
                                        tags: data.tags || [],
                                        color: '#f59e0b',
                                        source: 'note'
                                    };
                                    feedScheduleEvents.push(event);
                                }
                            }
                        });
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.filter(e => e.source === 'note').length} note events`);
                        
                        // Also include any currently loaded notes from the Notes section
                        try {
                            if (Array.isArray(window.allNotes) && window.allNotes.length > 0) {
                                window.allNotes.forEach((note) => {
                                    if (!note || !note.date) return;
                                    const eventDate = new Date(note.date);
                                    if (isNaN(eventDate)) return;
                                    const noteEvent = {
                                        id: `note_local_${note.id || Math.random().toString(36).slice(2)}`,
                                        title: note.title || 'Note',
                                        startDate: eventDate,
                                        endDate: eventDate,
                                        type: 'note',
                                        farm: note.farm || 'Unknown',
                                        barn: note.barn || null,
                                        content: note.content || '',
                                        tags: note.tags || [],
                                        color: note.color || getNoteColor(),
                                        noteId: note.id || null,
                                        source: 'note'
                                    };
                                    feedScheduleEvents.push(noteEvent);
                                });
                                console.log(`📝 Added ${feedScheduleEvents.filter(e => e.source === 'note').length} note events from local notes`);
                            }
                        } catch (e) {
                            console.warn('⚠️ Could not include local notes in calendar:', e);
                        }
                        
                        // Add sample farm management events
                        const sampleFarmEvents = [
                            {
                                id: 'vacc_1',
                                source: 'vaccination',
                                title: 'Newcastle Disease Vaccination',
                                farmName: 'VAS',
                                startDate: new Date('2025-01-15'),
                                endDate: new Date('2025-01-15')
                            },
                            {
                                id: 'insp_1',
                                source: 'inspection',
                                title: 'Monthly Health Inspection',
                                farmName: 'EDG',
                                startDate: new Date('2025-01-20'),
                                endDate: new Date('2025-01-20')
                            },
                            {
                                id: 'maint_1',
                                source: 'maintenance',
                                title: 'Feed System Maintenance',
                                farmName: 'APO',
                                startDate: new Date('2025-01-25'),
                                endDate: new Date('2025-01-25')
                            },
                            {
                                id: 'vacc_2',
                                source: 'vaccination',
                                title: 'IBD Vaccination',
                                farmName: 'SIG',
                                startDate: new Date('2025-02-05'),
                                endDate: new Date('2025-02-05')
                            },
                            {
                                id: 'insp_2',
                                source: 'inspection',
                                title: 'Biosecurity Audit',
                                farmName: 'DFI',
                                startDate: new Date('2025-02-10'),
                                endDate: new Date('2025-02-10')
                            }
                        ];
                        
                        feedScheduleEvents = [...feedScheduleEvents, ...sampleFarmEvents];
                        
                        console.log(`✅ Created ${feedScheduleEvents.length} sample events for testing`);
                        rebuildCalendarEventMap();
                        updateCalendarDisplay();
                        return;
                    } catch (error) {
                        console.error('❌ Error loading notes:', error);
                        // Add sample note events when query fails
                        console.log('📝 Adding sample note events for calendar...');
                        const sampleNoteEvents = [
                            {
                                id: 'sample_note_1',
                                title: 'Barn 1 Ventilation Check',
                                startDate: new Date(2025, 6, 15), // July 15, 2025
                                endDate: new Date(2025, 6, 15),
                                type: 'note',
                                farm: 'VAS',
                                barn: 'B1',
                                color: '#f59e0b',
                                source: 'note'
                            },
                            {
                                id: 'sample_note_2',
                                title: 'Feed Quality Inspection',
                                startDate: new Date(2025, 6, 20), // July 20, 2025
                                endDate: new Date(2025, 6, 20),
                                type: 'note',
                                farm: 'APO',
                                barn: 'B2',
                                color: '#f59e0b',
                                source: 'note'
                            }
                        ];
                        feedScheduleEvents = [...feedScheduleEvents, ...sampleNoteEvents];
                        console.log(`✅ Added ${sampleNoteEvents.length} sample note events`);
                    }

                    feedScheduleEvents = [];
                    
                    // Load feed schedules
                    try {
                        const feedQuery = query(collection(db, 'feed_schedules'), orderBy('uploadDate', 'desc'));
                        
                        // Add timeout to prevent hanging
                        const feedQueryPromise = getDocs(feedQuery);
                        const feedTimeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Feed query timeout after 10 seconds')), 10000)
                        );
                        
                        const feedSnapshot = await Promise.race([feedQueryPromise, feedTimeoutPromise]);
                        
                        feedSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (data.feedDates && data.feedDates.length > 0) {
                                // Convert each feed date to a calendar event
                                data.feedDates.forEach((feedDate, index) => {
                                    const eventDate = parseEventDateLoose(feedDate.date);
                                    
                                    // Get weight from the feed date if available
                                    const weight = feedDate.weight || feedDate.deliveryInfo?.weight || '';
                                    
                                    // Create calendar event
                                    const event = {
                                        id: `feed_${doc.id}_${index}`,
                                        title: `Feed Delivery - ${data.farm} ${data.barn}`,
                                        startDate: eventDate,
                                        endDate: eventDate,
                                        type: 'feed-delivery',
                                        farm: data.farm || 'Unknown',
                                        barn: data.barn || 'Unknown',
                                        weight: weight,
                                        color: getFarmColor(data.farm),
                                        scheduleId: doc.id,
                                        fileName: data.fileName,
                                        fileData: data.fileData,
                                        source: 'feed-schedule'
                                    };
                                    
                                    feedScheduleEvents.push(event);
                                });
                            }
                        });
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.filter(e => e.source === 'feed-schedule').length} feed schedule events`);
                    } catch (error) {
                        console.error('❌ Error loading feed schedules:', error);
                        // Add sample feed schedule events when query fails
                        console.log('📝 Adding sample feed schedule events for calendar...');
                        feedScheduleEvents = [
                            {
                                id: 'sample_feed_1',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 14), // July 14, 2025
                                endDate: new Date(2025, 6, 14),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '8,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_2',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 6, 29), // July 29, 2025
                                endDate: new Date(2025, 6, 29),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_3',
                                title: 'Feed Delivery - VAS Barn B3',
                                startDate: new Date(2025, 7, 1), // August 1, 2025
                                endDate: new Date(2025, 7, 1),
                                type: 'feed-delivery',
                                farm: 'VAS',
                                barn: 'B3',
                                weight: '9,000 KG',
                                color: '#3b82f6',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_4',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 16), // July 16, 2025
                                endDate: new Date(2025, 6, 16),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '7,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            },
                            {
                                id: 'sample_feed_5',
                                title: 'Feed Delivery - APO Barn B2',
                                startDate: new Date(2025, 6, 30), // July 30, 2025
                                endDate: new Date(2025, 6, 30),
                                type: 'feed-delivery',
                                farm: 'APO',
                                barn: 'B2',
                                weight: '8,000 KG',
                                color: '#10b981',
                                source: 'feed-schedule'
                            }
                        ];
                        console.log(`✅ Added ${feedScheduleEvents.length} sample feed schedule events`);
                    }
                    
                    // Load notes
                    try {
                        const notesQuery = query(collection(db, 'farm_notes'), orderBy('createdAt', 'desc'));
                        
                        // Add timeout to prevent hanging
                        const notesQueryPromise = getDocs(notesQuery);
                        const notesTimeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Notes query timeout after 10 seconds')), 10000)
                        );
                        
                        const notesSnapshot = await Promise.race([notesQueryPromise, notesTimeoutPromise]);
                        
                        notesSnapshot.forEach((doc) => {
                            const data = doc.data();
                            if (!data) return;
                            
                            // Prefer explicit date, else fall back to createdAt
                            let eventDate = data.date ? parseEventDateLoose(data.date) : null;
                            if (!eventDate && data.createdAt) {
                                eventDate = parseEventDateLoose(data.createdAt);
                            }
                            if (!eventDate) return;
                            
                            // Apply optional time ("HH:mm") if provided
                            if (data.time && typeof data.time === 'string' && data.time.includes(':')) {
                                const [hoursStr, minutesStr] = data.time.split(':');
                                const hours = parseInt(hoursStr, 10);
                                const minutes = parseInt(minutesStr || '0', 10);
                                if (!Number.isNaN(hours) && !Number.isNaN(minutes)) {
                                    eventDate.setHours(hours, minutes, 0, 0);
                                }
                            }
                            
                            if (isNaN(eventDate)) return;
                                
                                // Create calendar event for note
                                const event = {
                                    id: `note_${doc.id}`,
                                title: data.title || 'Note',
                                    startDate: eventDate,
                                    endDate: eventDate,
                                    type: 'note',
                                    farm: data.farm || 'Unknown',
                                    barn: data.barn || null,
                                content: data.content || '',
                                    tags: data.tags || [],
                                color: data.color || getNoteColor(),
                                    noteId: doc.id,
                                    source: 'note'
                                };
                                
                                feedScheduleEvents.push(event);
                        });
                        
                        console.log(`✅ Loaded ${feedScheduleEvents.filter(e => e.source === 'note').length} note events`);
                        // Fallback: if no Firestore notes loaded but we have in-memory notes, use them too
                        if (feedScheduleEvents.filter(e => e.source === 'note').length === 0 && Array.isArray(window.allNotes) && window.allNotes.length > 0) {
                            window.allNotes.forEach((note) => {
                                try {
                                    if (!note || !note.date) return;
                                    const eventDate = parseEventDateLoose(note.date);
                                    if (!eventDate) return;
                                    const evt = {
                                        id: `note_local_${note.id || Math.random().toString(36).slice(2)}`,
                                        title: note.title || 'Note',
                                        startDate: eventDate,
                                        endDate: eventDate,
                                        type: 'note',
                                        farm: note.farm || 'Unknown',
                                        barn: note.barn || null,
                                        content: note.content || '',
                                        tags: note.tags || [],
                                        color: note.color || getNoteColor(),
                                        noteId: note.id || null,
                                        source: 'note'
                                    };
                                    feedScheduleEvents.push(evt);
                                } catch (e) { /* ignore malformed note */ }
                            });
                            console.log(`📝 Fallback added ${feedScheduleEvents.filter(e => e.source === 'note').length} note events from in-memory notes`);
                        }
                    } catch (error) {
                        console.error('❌ Error loading notes:', error);
                        // Add sample note events when query fails
                        console.log('📝 Adding sample note events for calendar...');
                        const sampleNoteEvents = [
                            {
                                id: 'sample_note_1',
                                title: 'Barn 1 Ventilation Check',
                                startDate: new Date(2025, 6, 15), // July 15, 2025
                                endDate: new Date(2025, 6, 15),
                                type: 'note',
                                farm: 'VAS',
                                barn: 'B1',
                                color: '#f59e0b',
                                source: 'note'
                            },
                            {
                                id: 'sample_note_2',
                                title: 'Feed Quality Inspection',
                                startDate: new Date(2025, 6, 20), // July 20, 2025
                                endDate: new Date(2025, 6, 20),
                                type: 'note',
                                farm: 'APO',
                                barn: 'B2',
                                color: '#f59e0b',
                                source: 'note'
                            }
                        ];
                        feedScheduleEvents = [...feedScheduleEvents, ...sampleNoteEvents];
                        console.log(`✅ Added ${sampleNoteEvents.length} sample note events`);
                    }
                    
                    console.log(`✅ Total calendar events: ${feedScheduleEvents.length}`);
                    
                    // Rebuild fast event map and update calendar display
                    rebuildCalendarEventMap();
                    updateCalendarDisplay();
                    
                } catch (error) {
                    console.error('❌ Error loading calendar events:', error);
                    feedScheduleEvents = [];
                    updateCalendarDisplay();
                } finally {
                    isLoadingCalendar = false;
                }
            }

            // Robust date parser: supports Firestore Timestamp, ISO strings, and 'YYYY-MM-DD' as local date
            function parseEventDateLoose(value) {
                try {
                    if (!value) return null;
                    if (typeof value.toDate === 'function') {
                        return value.toDate();
                    }
                    if (typeof value === 'string') {
                        // Handle 'YYYY-MM-DD' as local date at 00:00
                        const ymdMatch = value.match(/^\d{4}-\d{2}-\d{2}$/);
                        if (ymdMatch) {
                            const [y, m, d] = value.split('-').map(n => parseInt(n, 10));
                            return new Date(y, m - 1, d);
                        }
                        const d = new Date(value);
                        if (!isNaN(d)) return d;
                        return null;
                    }
                    const d = new Date(value);
                    return isNaN(d) ? null : d;
                } catch (e) {
                    console.warn('⚠️ parseEventDateLoose error:', e);
                    return null;
                }
            }

            // Calendar event map keyed by YYYY-MM-DD for fast lookup
            let calendarEventMap = {};

            function dateToKey(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            }

            function rebuildCalendarEventMap() {
                try {
                    calendarEventMap = {};
                    if (!Array.isArray(feedScheduleEvents)) return;
                    feedScheduleEvents.forEach(evt => {
                        try {
                            const start = new Date(evt.startDate);
                            const end = new Date(evt.endDate || evt.startDate);
                            if (isNaN(start) || isNaN(end)) return;
                            // normalize to start of day
                            let cursor = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                            const last = new Date(end.getFullYear(), end.getMonth(), end.getDate());
                            while (cursor <= last) {
                                const key = dateToKey(cursor);
                                if (!calendarEventMap[key]) calendarEventMap[key] = [];
                                calendarEventMap[key].push(evt);
                                cursor.setDate(cursor.getDate() + 1);
                            }
                        } catch (_) {}
                    });
                    console.log('🗺️ Rebuilt calendarEventMap with keys:', Object.keys(calendarEventMap).length);
                } catch (e) {
                    console.warn('⚠️ rebuildCalendarEventMap error:', e);
                }
            }

            function getEventsForDate(year, month, day) {
                try {
                    const key = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    return calendarEventMap[key] || [];
                } catch (e) {
                    return [];
                }
            }

            // Function to get farm color based on farm code
            function getFarmColor(farmCode) {
                // Align with dashboard/feed schedules color coding
                const farmColors = {
                    'VAS': '#dc3545', // Red
                    'EDG': '#6f42c1', // Purple
                    'APO': '#28a745', // Green
                    'SIG': '#fd7e14', // Orange
                    'DFI': '#17a2b8'  // Cyan
                };
                return farmColors[farmCode] || '#6b7280'; // Default gray
            }

            // Function to get default note color (no priority system)
            function getNoteColor() {
                return '#3b82f6'; // Default blue
            }


            function previousMonth() {
                currentDate.setMonth(currentDate.getMonth() - 1);
                updateCalendarDisplay();
            }

            function nextMonth() {
                currentDate.setMonth(currentDate.getMonth() + 1);
                updateCalendarDisplay();
            }


            // Weekly view functions
            let currentView = 'month'; // 'month' or 'week'

            function switchToMonthView() {
                currentView = 'month';
                document.getElementById('monthViewBtn').classList.add('active');
                document.getElementById('weekViewBtn').classList.remove('active');
                updateCalendarDisplay();
            }

            function switchToWeekView() {
                currentView = 'week';
                document.getElementById('weekViewBtn').classList.add('active');
                document.getElementById('monthViewBtn').classList.remove('active');
                updateCalendarDisplay();
            }

            function previousPeriod() {
                if (currentView === 'month') {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                } else {
                    currentDate.setDate(currentDate.getDate() - 7);
                }
                updateCalendarDisplay();
            }

            function nextPeriod() {
                if (currentView === 'month') {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                } else {
                    currentDate.setDate(currentDate.getDate() + 7);
                }
                updateCalendarDisplay();
            }
            window.updateCalendarDisplay = function() {
                console.log('🔄 Updating calendar display...');
                const monthTitleElement = document.getElementById('currentMonthTitle');
                const calendarGrid = document.getElementById('calendarGrid');
                
                if (!calendarGrid) {
                    console.error('❌ Calendar grid element not found!');
                    return;
                }
                
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                
                if (currentView === 'week') {
                    // Update title for week view
                    const startOfWeek = new Date(currentDate);
                    const dayOfWeek = startOfWeek.getDay();
                    startOfWeek.setDate(startOfWeek.getDate() - dayOfWeek);
                    
                    const endOfWeek = new Date(startOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 6);
                    
                    if (startOfWeek.getMonth() === endOfWeek.getMonth()) {
                        monthTitleElement.textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()}-${endOfWeek.getDate()}, ${year}`;
                    } else {
                        monthTitleElement.textContent = `${monthNames[startOfWeek.getMonth()]} ${startOfWeek.getDate()} - ${monthNames[endOfWeek.getMonth()]} ${endOfWeek.getDate()}, ${year}`;
                    }
                    
                    renderWeekView(startOfWeek);
                } else {
                    // Update title for month view
                    monthTitleElement.textContent = `${monthNames[month]} ${year}`;
                    renderMonthView(year, month);
                }
            }

            function renderMonthView(year, month) {
                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.className = 'calendar-grid';
                
                // Remove body class for weekly view styling
                document.body.classList.remove('weekly-view');
                
                
                // Calculate days in month correctly
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 = Sunday, 1 = Monday, etc.
                
                console.log(`📅 Month: ${monthNames[month]} ${year}`);
                console.log(`📅 Days in month: ${daysInMonth}`);
                console.log(`📅 First day of month: ${firstDayOfMonth} (0=Sunday, 1=Monday, etc.)`);
                
                // Get previous month's days for padding
                const prevMonth = new Date(year, month, 0);
                const prevMonthDays = prevMonth.getDate();
                
                let calendarHTML = `
                    <div class="calendar-weekdays">
                        <div class="weekday">Sun</div>
                        <div class="weekday">Mon</div>
                        <div class="weekday">Tue</div>
                        <div class="weekday">Wed</div>
                        <div class="weekday">Thu</div>
                        <div class="weekday">Fri</div>
                        <div class="weekday">Sat</div>
                    </div>
                    <div class="calendar-days">
                `;
                
                let dayCount = 1;
                let nextMonthDay = 1;
                const today = new Date();
                
                // Generate calendar grid
                for (let week = 0; week < 6; week++) {
                    calendarHTML += '<div class="calendar-week">';
                    
                    for (let dayOfWeek = 0; dayOfWeek < 7; dayOfWeek++) {
                        let dayNumber, dayClass = 'calendar-day';
                        let cellYear = year;
                        let cellMonthIndex = month;
                        let dayEvents = [];
                        
                        if (week === 0 && dayOfWeek < firstDayOfMonth) {
                            // Previous month
                            dayNumber = prevMonthDays - firstDayOfMonth + dayOfWeek + 1;
                            dayClass += ' other-month';
                            cellYear = prevMonth.getFullYear();
                            cellMonthIndex = prevMonth.getMonth();
                        } else if (dayCount > daysInMonth) {
                            // Next month
                            dayNumber = nextMonthDay++;
                            dayClass += ' other-month';
                            const nextMonthDate = new Date(year, month + 1, 1);
                            cellYear = nextMonthDate.getFullYear();
                            cellMonthIndex = nextMonthDate.getMonth();
                        } else {
                            // Current month
                            dayNumber = dayCount++;
                            dayClass += ' current-month';
                            
                            // Check if it's today
                            if (year === today.getFullYear() && month === today.getMonth() && dayNumber === today.getDate()) {
                                dayClass += ' today';
                            }
                            
                            // Get events for this day (inclusive overlap within the day)
                            const dayStart = new Date(year, month, dayNumber, 0, 0, 0, 0);
                            const dayEnd = new Date(year, month, dayNumber, 23, 59, 59, 999);
                            dayEvents = feedScheduleEvents.filter(event => {
                                const eventStart = new Date(event.startDate);
                                const eventEnd = new Date(event.endDate || event.startDate);
                                const dateMatch = eventStart <= dayEnd && eventEnd >= dayStart;
                                
                                // Apply event type filter (support multiple selections)
                                const typeMatch = !currentEventFilter || currentEventFilter.includes('all') || currentEventFilter.includes(event.source);
                                
                                // Apply farm filter
                                const eventFarm = event.farmName || event.farm;
                                const farmMatch = !currentFarmFilter || currentFarmFilter === 'all' || eventFarm === currentFarmFilter;
                                
                                // Apply barn filter
                                const eventBarn = event.barnNumber || event.barn;
                                const barnMatch = !currentBarnFilter || currentBarnFilter === 'all' || eventBarn === currentBarnFilter;
                                
                                return dateMatch && typeMatch && farmMatch && barnMatch;
                            });
                            
                            // Sort events by time/date - closest to furthest
                            dayEvents.sort((a, b) => {
                                // If both have time, sort by time
                                if (a.time && b.time) {
                                    return a.time.localeCompare(b.time);
                                }
                                // If only one has time, prioritize it
                                if (a.time && !b.time) return -1;
                                if (!a.time && b.time) return 1;
                                // If neither has time, sort by creation/upload date
                                const aDate = new Date(a.startDate);
                                const bDate = new Date(b.startDate);
                                return aDate - bDate;
                            });
                        }
                        
                        // Add event text instead of dots - show events with proper overflow handling
                        let eventText = '';
                        if (dayEvents.length > 0) {
                            
                            // Show more events to maximize usability - show up to 4 events if they fit
                            let eventsToShow;
                            let remainingCount;
                            
                            if (dayEvents.length <= 4) {
                                // Show all events if 4 or fewer
                                eventsToShow = dayEvents;
                                remainingCount = 0;
                            } else if (dayEvents.length <= 6) {
                                // Show first 4 events if 5-6 total
                                eventsToShow = dayEvents.slice(0, 4);
                                remainingCount = dayEvents.length - 4;
                            } else {
                                // Show first 3 events if more than 6 total
                                eventsToShow = dayEvents.slice(0, 3);
                                remainingCount = dayEvents.length - 3;
                            }
                            
                            eventsToShow.forEach(event => {
                                let eventTitle = '';
                                let eventClass = 'event-text';
                                
                                if (event.source === 'feed-schedule') {
                                    const farmName = event.farmName || event.farm;
                                    const barnNumber = event.barnNumber || event.barn;
                                    const weight = event.weight;
                                    
                                    // Create more informative title with "Feed Date" label
                                    if (farmName && barnNumber) {
                                        // Check if barnNumber already starts with 'B' to avoid BB1, BB2, etc.
                                        const barnDisplay = barnNumber.toString().startsWith('B') ? barnNumber : `B${barnNumber}`;
                                        eventTitle = `Feed Date: ${farmName} ${barnDisplay}`;
                                    } else if (farmName) {
                                        eventTitle = `Feed Date: ${farmName}`;
                                    } else {
                                        eventTitle = 'Feed Date';
                                    }
                                    
                                    // Add weight if available and short enough
                                    if (weight && eventTitle.length < 12) {
                                        eventTitle += ` ${weight}kg`;
                                    }
                                    
                                    eventClass += ' feed-schedule';
                                    // Add farm-specific color coding
                                    let inlineStyle = '';
                                    if (farmName) {
                                        eventClass += ` farm-${farmName.toLowerCase()}`;
                                        // Add inline style as backup - using Farm Network Overview colors
                                        const farmColors = {
                                            'vas': '#dc3545',  // Red for VAS
                                            'edg': '#6f42c1',  // Purple for EDG
                                            'apo': '#28a745',  // Green for APO
                                            'sig': '#fd7e14',  // Orange for SIG
                                            'dfi': '#17a2b8',  // Cyan for DFI
                                            // Also support uppercase versions
                                            'VAS': '#dc3545',
                                            'EDG': '#6f42c1',
                                            'APO': '#28a745',
                                            'SIG': '#fd7e14',
                                            'DFI': '#17a2b8'
                                        };
                                        const farmKey = farmName.toLowerCase();
                                        if (farmColors[farmKey] || farmColors[farmName]) {
                                            const color = farmColors[farmKey] || farmColors[farmName];
                                            inlineStyle = ` style="background: ${color} !important;"`;
                                        }
                                        console.log('🎨 Adding farm color class:', `farm-${farmName.toLowerCase()}`, 'with inline style:', inlineStyle, 'for event:', eventTitle);
                                    }
                                    eventText += `<div class="${eventClass}"${inlineStyle}>${eventTitle}</div>`;
                                } else if (event.source === 'note') {
                                    // Create more informative note title
                                    if (event.title && event.title.length <= 15) {
                                        eventTitle = event.title;
                                    } else if (event.content) {
                                        eventTitle = event.content.substring(0, 15);
                                        if (event.content.length > 15) eventTitle += '...';
                                    } else {
                                        eventTitle = 'Note';
                                    }
                                    
                                    eventClass += ' note';
                                    // Apply note color with inline style
                                    const noteColor = event.color || '#3b82f6';
                                    const noteInlineStyle = ` style="background: ${noteColor} !important;"`;
                                    eventText += `<div class="${eventClass}"${noteInlineStyle}>${eventTitle}</div>`;
                                    console.log('🎨 Note color for monthly view:', eventTitle, 'Color:', noteColor);
                                } else if (event.source === 'vaccination') {
                                    const farmName = event.farmName || event.farm;
                                    eventTitle = event.title || `Vaccination: ${farmName || 'Farm'}`;
                                    eventClass += ' vaccination';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                } else if (event.source === 'inspection') {
                                    const farmName = event.farmName || event.farm;
                                    eventTitle = event.title || `Inspection: ${farmName || 'Farm'}`;
                                    eventClass += ' inspection';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                } else if (event.source === 'maintenance') {
                                    const farmName = event.farmName || event.farm;
                                    eventTitle = event.title || `Maintenance: ${farmName || 'Farm'}`;
                                    eventClass += ' maintenance';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                } else if (event.source === 'crop-start') {
                                    const farmName = event.farmName || event.farm;
                                    eventTitle = event.title || `Crop Start: ${farmName || 'Farm'}`;
                                    eventClass += ' crop-start';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                } else if (event.source === 'crop-end') {
                                    const farmName = event.farmName || event.farm;
                                    eventTitle = event.title || `Crop End: ${farmName || 'Farm'}`;
                                    eventClass += ' crop-end';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                } else {
                                    eventTitle = event.title || 'Event';
                                    eventClass += ' default';
                                    eventText += `<div class="${eventClass}">${eventTitle}</div>`;
                                }
                                
                                console.log('🎨 Generated event HTML:', `<div class="${eventClass}">${eventTitle}</div>`);
                            });
                            
                            if (remainingCount > 0) {
                                eventText += `<div class="event-text view-more">+${remainingCount} more...</div>`;
                            }
                        }
                        
                        const dataDate = `${cellYear}-${String(cellMonthIndex + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                        calendarHTML += `
                            <div class="${dayClass}" data-date="${dataDate}" onclick="showDayEvents(${cellYear}, ${cellMonthIndex}, ${dayNumber})">
                                <div class="day-number">${dayNumber}</div>
                                <div class="event-text-container">${eventText}</div>
                            </div>
                        `;
                    }
                    
                    calendarHTML += '</div>';
                }
                
                calendarHTML += '</div>';
                console.log('📅 Generated calendar HTML length:', calendarHTML.length);
                calendarGrid.innerHTML = calendarHTML;
                
                // Statistics removed as requested
                // Delegate click handling as a backup to inline handlers
                calendarGrid.onclick = function(ev) {
                    const cell = ev.target.closest('.calendar-day');
                    if (!cell) return;
                    const iso = cell.getAttribute('data-date');
                    if (iso && typeof showDayEventsFromISO === 'function') {
                        showDayEventsFromISO(iso);
                    }
                };
                console.log('✅ Calendar HTML inserted into DOM');
                console.log('📅 Final calendar grid content length:', calendarGrid.innerHTML.length);
            }

            function renderWeekView(startOfWeek) {
                const calendarGrid = document.getElementById('calendarGrid');
                calendarGrid.className = 'calendar-grid week-view';
                
                // Add body class for weekly view styling
                document.body.classList.add('weekly-view');
                
                const today = new Date();
                
                // Create a clean, simple weekly calendar
                let weekHTML = `
                    <div class="week-header">
                        <div class="week-day-header">Sun</div>
                        <div class="week-day-header">Mon</div>
                        <div class="week-day-header">Tue</div>
                        <div class="week-day-header">Wed</div>
                        <div class="week-day-header">Thu</div>
                        <div class="week-day-header">Fri</div>
                        <div class="week-day-header">Sat</div>
                    </div>
                    <div class="week-body">
                `;
                
                // Generate exactly 7 days
                for (let dayIndex = 0; dayIndex < 7; dayIndex++) {
                    const currentDay = new Date(startOfWeek);
                    currentDay.setDate(startOfWeek.getDate() + dayIndex);
                    
                    const dayNumber = currentDay.getDate();
                    const month = currentDay.getMonth();
                    const year = currentDay.getFullYear();
                    const isToday = year === today.getFullYear() && month === today.getMonth() && dayNumber === today.getDate();
                    
                    // Get events for this day
                    const dayStart = new Date(year, month, dayNumber, 0, 0, 0, 0);
                    const dayEnd = new Date(year, month, dayNumber, 23, 59, 59, 999);
                    
                    let dayEvents = feedScheduleEvents.filter(event => {
                        const eventStart = new Date(event.startDate);
                        const eventEnd = new Date(event.endDate || event.startDate);
                        const dateMatch = eventStart <= dayEnd && eventEnd >= dayStart;
                        
                        // Apply filters (support multiple selections)
                        const typeMatch = !currentEventFilter || currentEventFilter.includes('all') || currentEventFilter.includes(event.source);
                        const eventFarm = event.farmName || event.farm;
                        const farmMatch = !currentFarmFilter || currentFarmFilter === 'all' || eventFarm === currentFarmFilter;
                        const eventBarn = event.barnNumber || event.barn;
                        const barnMatch = !currentBarnFilter || currentBarnFilter === 'all' || eventBarn === currentBarnFilter;
                        
                        return dateMatch && typeMatch && farmMatch && barnMatch;
                    });
                    
                    // Create day cell
                    let dayClass = 'week-day';
                    if (isToday) dayClass += ' today';
                    
                    weekHTML += `<div class="${dayClass}" data-date="${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}" onclick="showDayEventsFromISO('${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}')">`;
                    
                    // Day number
                    weekHTML += `<div class="day-number">${dayNumber}</div>`;
                    
                    // Events container
                    weekHTML += `<div class="events-container">`;
                    
                    // Show all events in weekly view (no limit)
                    const eventsToShow = dayEvents;
                    
                    eventsToShow.forEach(event => {
                        let eventTitle = '';
                        let eventColor = '#3b82f6';
                        
                        if (event.source === 'feed-schedule') {
                            const farmName = event.farmName || event.farm;
                            const barnNumber = event.barnNumber || event.barn;
                            const weight = event.weight;
                            const time = event.time;
                            
                            // Create more informative title for weekly view with "Feed Date" label
                            if (farmName && barnNumber) {
                                // Check if barnNumber already starts with 'B' to avoid BB1, BB2, etc.
                                const barnDisplay = barnNumber.toString().startsWith('B') ? barnNumber : `B${barnNumber}`;
                                eventTitle = `Feed Date: ${farmName} ${barnDisplay}`;
                            } else if (farmName) {
                                eventTitle = `Feed Date: ${farmName}`;
                            } else {
                                eventTitle = 'Feed Date';
                            }
                            
                            // Add weight if available
                            if (weight) {
                                eventTitle += ` ${weight}kg`;
                            }
                            
                            // Add time if available (shorter format)
                            if (time) {
                                const timeOnly = time.includes(':') ? time.split(' ')[0] : time;
                                eventTitle += ` ${timeOnly}`;
                            }
                            
                            // Farm colors
                            const farmColors = {
                                'vas': '#dc3545', 'edg': '#6f42c1', 'apo': '#28a745', 'sig': '#fd7e14', 'dfi': '#17a2b8'
                            };
                            if (farmName && farmColors[farmName.toLowerCase()]) {
                                eventColor = farmColors[farmName.toLowerCase()];
                            }
                        } else if (event.source === 'note') {
                            const content = event.content || '';
                            // Create more informative note title for weekly view
                            if (event.title && event.title.length <= 25) {
                                eventTitle = event.title;
                            } else if (content) {
                                eventTitle = content.substring(0, 25);
                                if (content.length > 25) eventTitle += '...';
                            } else {
                                eventTitle = 'Note';
                            }
                            eventColor = event.color || '#3b82f6';
                        } else {
                            eventTitle = event.title || 'Event';
                        }
                        
                        weekHTML += `<div class="week-event" style="background-color: ${eventColor};" onclick="event.stopPropagation(); showDayEventsFromISO('${year}-${String(month + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}')">
                            ${eventTitle}
                        </div>`;
                    });
                    
                    weekHTML += `</div>`; // Close events container
                
                    weekHTML += '</div>'; // Close day cell
                }
                
                weekHTML += '</div>'; // Close week-body
                
                calendarGrid.innerHTML = weekHTML;
                
                // Calculate optimal height based on content
                setTimeout(() => {
                    const dayCells = document.querySelectorAll('.week-day');
                    let maxHeight = 600; // minimum height
                    
                    dayCells.forEach(cell => {
                        const cellHeight = cell.offsetHeight;
                        if (cellHeight > maxHeight) {
                            maxHeight = cellHeight;
                        }
                    });
                    
                    // Apply the maximum height to all cells for consistency
                    if (maxHeight > 600) {
                        document.querySelector('.week-body').style.minHeight = `${maxHeight}px`;
                        dayCells.forEach(cell => {
                            cell.style.minHeight = `${maxHeight}px`;
                        });
                    }
                }, 100);
                
                console.log('✅ Clean week view rendered with 7 days');
            }

            // Helper: check if any events exist in the given month
            function monthHasEvents(year, month) {
                try {
                    return feedScheduleEvents.some(evt => {
                        const d = new Date(evt.startDate);
                        return d.getFullYear() === year && d.getMonth() === month;
                    });
                } catch (e) {
                    console.warn('⚠️ monthHasEvents error:', e);
                    return false;
                }
            }

            // Helper: focus calendar on the nearest event month if current month has none
            function focusNearestEventMonthIfNeeded() {
                try {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    if (monthHasEvents(year, month)) {
                        return; // current month already has events
                    }
                    if (!Array.isArray(feedScheduleEvents) || feedScheduleEvents.length === 0) {
                        return;
                    }
                    const today = new Date();
                    // Find nearest event to today
                    let nearest = null;
                    let nearestDiff = Infinity;
                    feedScheduleEvents.forEach(evt => {
                        const d = new Date(evt.startDate);
                        const diff = Math.abs(d - today);
                        if (diff < nearestDiff) {
                            nearest = d;
                            nearestDiff = diff;
                        }
                    });
                    if (nearest) {
                        currentDate = new Date(nearest.getFullYear(), nearest.getMonth(), 1);
                        updateCalendarDisplay();
                    }
                } catch (e) {
                    console.warn('⚠️ focusNearestEventMonthIfNeeded error:', e);
                }
            }

            function switchMonth(monthIndex) {
                try {
                currentDate.setMonth(monthIndex);
                    if (!Array.isArray(feedScheduleEvents) || feedScheduleEvents.length === 0) {
                        loadCalendarEvents();
                    } else {
                updateCalendarDisplay();
                        focusNearestEventMonthIfNeeded();
                    }
                } catch (e) {
                    console.warn('⚠️ switchMonth error:', e);
                    try { updateCalendarDisplay(); } catch(_) {}
                }
            }

            function showDayEvents(year, month, day) {
                const selectedDate = new Date(year, month, day);
                let dayEvents = [];
                try {
                    // Inclusive day window to match calendar dots logic
                    const dayStart = new Date(year, month, day, 0, 0, 0, 0);
                    const dayEnd = new Date(year, month, day, 23, 59, 59, 999);
                    dayEvents = Array.isArray(feedScheduleEvents) ? feedScheduleEvents.filter(event => {
                        const eventStart = new Date(event.startDate);
                        const eventEnd = new Date(event.endDate || event.startDate);
                        const dateMatch = eventStart <= dayEnd && eventEnd >= dayStart;
                        
                        // Apply filters (support multiple selections)
                        const typeMatch = !currentEventFilter || currentEventFilter.includes('all') || currentEventFilter.includes(event.source);
                        const eventFarm = event.farmName || event.farm;
                        const farmMatch = !currentFarmFilter || currentFarmFilter === 'all' || eventFarm === currentFarmFilter;
                        const eventBarn = event.barnNumber || event.barn;
                        const barnMatch = !currentBarnFilter || currentBarnFilter === 'all' || eventBarn === currentBarnFilter;
                        
                        return dateMatch && farmMatch && barnMatch;
                    }) : [];
                } catch (e) {
                    console.warn('⚠️ showDayEvents filter error:', e);
                    dayEvents = [];
                }
                
                // Use popup instead of underneath display
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                showEventPopup(dateString, dayEvents);
            }
            
            // Function to show day events from ISO date string
            function showDayEventsFromISO(isoDate) {
                const [year, month, day] = isoDate.split('-').map(Number);
                showDayEvents(year, month - 1, day); // month is 0-indexed in JavaScript
            }

            // Toggle all deliveries function
            function toggleAllDeliveries(scheduleId) {
                const deliveryChips = document.getElementById(`deliveryChips_${scheduleId}`);
                const allDeliveries = document.getElementById(`allDeliveries_${scheduleId}`);
                const toggleBtn = document.getElementById(`toggleBtn_${scheduleId}`);
                
                if (allDeliveries.style.display === 'none') {
                    // Show all deliveries
                    deliveryChips.style.display = 'none';
                    allDeliveries.style.display = 'block';
                    toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide All';
                } else {
                    // Hide all deliveries
                    deliveryChips.style.display = 'flex';
                    allDeliveries.style.display = 'none';
                    toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Show All';
                }
            }

            // Make calendar functions globally accessible
            window.previousMonth = previousMonth;
            window.nextMonth = nextMonth;
            window.showDayEvents = showDayEvents;
            window.showDayEventsFromISO = showDayEventsFromISO;
            window.switchMonth = switchMonth;
            window.updateCalendarDisplay = updateCalendarDisplay;
            window.toggleAllDeliveries = toggleAllDeliveries;
            window.switchToMonthView = switchToMonthView;
            window.switchToWeekView = switchToWeekView;
            window.previousPeriod = previousPeriod;
            window.nextPeriod = nextPeriod;
            window.loadFeedSchedulesForCalendar = loadFeedSchedulesForCalendar;
            
            // Filter events by type (now supports multiple selections with proper "All" logic)
            window.filterEvents = function(eventType) {
                console.log('🔍 Filtering events by type:', eventType);
                
                const button = document.querySelector(`[data-type="${eventType}"]`);
                if (!button) return;
                
                // Special handling for "All" button
                if (eventType === 'all') {
                    // If "All" is clicked, deselect all other buttons and select only "All"
                    document.querySelectorAll('.filter-btn, .filter-btn-compact').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    button.classList.add('active');
                    currentEventFilter = ['all'];
                } else {
                    // For other buttons, toggle their state
                    if (button.classList.contains('active')) {
                        button.classList.remove('active');
                    } else {
                        button.classList.add('active');
                    }
                    
                    // If "All" is currently active, deselect it when selecting specific types
                    const allButton = document.querySelector(`[data-type="all"]`);
                    if (allButton && allButton.classList.contains('active')) {
                        allButton.classList.remove('active');
                    }
                    
                    // Get all active filter types (excluding "all")
                    const activeFilters = Array.from(document.querySelectorAll('.filter-btn.active, .filter-btn-compact.active'))
                        .map(btn => btn.getAttribute('data-type'))
                        .filter(type => type !== 'all');
                    
                    // If no specific filters are active, activate "All"
                    if (activeFilters.length === 0) {
                        allButton.classList.add('active');
                        currentEventFilter = ['all'];
                    } else {
                        currentEventFilter = activeFilters;
                    }
                }
                
                // Re-render calendar with filtered events
                updateCalendarDisplay();
            };

            // Event popup functions
            window.showEventPopup = function(date, events) {
                const popupOverlay = document.getElementById('eventPopupOverlay');
                const popupTitle = document.getElementById('eventPopupTitle');
                const popupContent = document.getElementById('eventPopupContent');
                
                if (!popupOverlay || !popupTitle || !popupContent) return;
                
                // Format date for display
                const dateObj = new Date(date);
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                popupTitle.textContent = `Events for ${formattedDate}`;
                
                // Generate events HTML
                let eventsHTML = '';
                if (events && events.length > 0) {
                    events.forEach(event => {
                        // Determine event color first
                        let eventColor = '#3b82f6'; // Default blue
                        if (event.source === 'feed-schedule') {
                            const farmColors = {
                                'vas': '#dc3545', 'edg': '#6f42c1', 'apo': '#28a745', 'sig': '#fd7e14', 'dfi': '#17a2b8',
                                'VAS': '#dc3545', 'EDG': '#6f42c1', 'APO': '#28a745', 'SIG': '#fd7e14', 'DFI': '#17a2b8'
                            };
                            const farmName = event.farmName || event.farm;
                            if (farmName && (farmColors[farmName.toLowerCase()] || farmColors[farmName])) {
                                eventColor = farmColors[farmName.toLowerCase()] || farmColors[farmName];
                            }
                        } else if (event.source === 'note') {
                            eventColor = event.color || '#3b82f6';
                        }
                        
                        let eventHTML = `<div class="event-popup-event" style="border-left: 4px solid ${eventColor};">`;
                        eventHTML += `<div class="event-popup-event-title">${event.title || 'Event'}</div>`;
                        
                        // Event details
                        eventHTML += `<div class="event-popup-event-details">`;
                        
                        if (event.source === 'feed-schedule') {
                            const farmName = event.farmName || event.farm;
                            
                            eventHTML += `<div class="event-popup-detail">
                                <div class="event-popup-detail-label">Farm</div>
                                <div class="event-popup-detail-value">${farmName || 'Unknown'}</div>
                            </div>`;
                            eventHTML += `<div class="event-popup-detail">
                                <div class="event-popup-detail-label">Barn</div>
                                <div class="event-popup-detail-value">${event.barnNumber || event.barn || 'N/A'}</div>
                            </div>`;
                            if (event.weight) {
                                eventHTML += `<div class="event-popup-detail">
                                    <div class="event-popup-detail-label">Weight</div>
                                    <div class="event-popup-detail-value">${event.weight} KG</div>
                                </div>`;
                            }
                            if (event.time) {
                                eventHTML += `<div class="event-popup-detail">
                                    <div class="event-popup-detail-label">Time</div>
                                    <div class="event-popup-detail-value">${event.time}</div>
                                </div>`;
                            }
                            
                            eventHTML += `</div>`; // Close event-details div
                            
                            // Add action buttons for feed schedules
                            eventHTML += `<div class="event-popup-actions">`;
                            if (event.scheduleId && event.fileName) {
                                eventHTML += `<button class="event-popup-action-btn primary" onclick="viewFeedSchedulePdf('${event.scheduleId}', '${event.fileName}')" title="View PDF">
                                    <i class="fas fa-eye"></i> View PDF
                                </button>`;
                                eventHTML += `<button class="event-popup-action-btn outline" onclick="downloadFeedSchedule('${event.scheduleId}', '${event.fileName}')" title="Download PDF">
                                    <i class="fas fa-download"></i> Download
                                </button>`;
                                eventHTML += `<button class="event-popup-action-btn danger" onclick="deleteFeedSchedule('${event.scheduleId}', '${event.fileName}')" title="Delete Schedule">
                                    <i class="fas fa-trash"></i> Delete
                                </button>`;
                            }
                            eventHTML += `</div>`;
                        } else if (event.source === 'note') {
                            // Use the actual note color
                            const noteColor = event.color || '#3b82f6';
                            
                            if (event.content) {
                                eventHTML += `<div class="event-popup-event-content">${event.content}</div>`;
                            }
                            if (event.tags && event.tags.length > 0) {
                                eventHTML += `<div class="event-popup-tags">`;
                                event.tags.forEach(tag => {
                                    eventHTML += `<span class="event-popup-tag">${tag}</span>`;
                                });
                                eventHTML += `</div>`;
                            }
                            
                            eventHTML += `</div>`; // Close event-details div
                            
                            // Add action buttons for notes
                            eventHTML += `<div class="event-popup-actions">`;
                            if (event.noteId) {
                                eventHTML += `<button class="event-popup-action-btn outline" onclick="editNote('${event.noteId}')" title="Edit Note">
                                    <i class="fas fa-edit"></i> Edit
                                </button>`;
                                eventHTML += `<button class="event-popup-action-btn danger" onclick="deleteNote('${event.noteId}')" title="Delete Note">
                                    <i class="fas fa-trash"></i> Delete
                                </button>`;
                            }
                            eventHTML += `</div>`;
                        } else if (event.source === 'crop-start' || event.source === 'crop-end') {
                            eventHTML += `<div class="event-popup-detail">
                                <div class="event-popup-detail-label">Farm</div>
                                <div class="event-popup-detail-value">${event.farmName || event.farm || 'Unknown'}</div>
                            </div>`;
                            eventHTML += `<div class="event-popup-detail">
                                <div class="event-popup-detail-label">Barn</div>
                                <div class="event-popup-detail-value">${event.barnNumber || event.barn || 'N/A'}</div>
                            </div>`;
                            eventHTML += `<div class="event-popup-detail">
                                <div class="event-popup-detail-label">Type</div>
                                <div class="event-popup-detail-value">${event.source === 'crop-start' ? 'Crop Start' : 'Crop End'}</div>
                            </div>`;
                            
                            eventHTML += `</div>`; // Close event-details div
                        }
                        
                        eventHTML += `</div></div>`;
                        eventsHTML += eventHTML;
                    });
                } else {
                    eventsHTML = '<div class="event-popup-event"><div class="event-popup-event-title">No events scheduled</div><div class="event-popup-event-content">There are no events scheduled for this date.</div></div>';
                }
                
                popupContent.innerHTML = eventsHTML;
                popupOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Prevent background scrolling
            };
            
            window.closeEventPopup = function() {
                const popupOverlay = document.getElementById('eventPopupOverlay');
                if (popupOverlay) {
                    popupOverlay.style.display = 'none';
                    document.body.style.overflow = ''; // Restore scrolling
                }
            };
            
            // Close popup when clicking outside
            window.addEventListener('click', function(e) {
                const popupOverlay = document.getElementById('eventPopupOverlay');
                if (e.target === popupOverlay) {
                    closeEventPopup();
                }
            });
            
            // Close popup with Escape key
            window.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeEventPopup();
                }
            });

            // Filter events by farm
            window.filterByFarmCalendar = function(farmCode) {
                console.log('🔍 Filtering events by farm:', farmCode);
                
                // Store current farm filter
                currentFarmFilter = farmCode;
                
                // Show/hide barn filter based on farm selection
                const barnFilterGroup = document.getElementById('barnFilterGroup');
                if (farmCode === 'all') {
                    barnFilterGroup.style.display = 'none';
                    currentBarnFilter = 'all';
                } else {
                    barnFilterGroup.style.display = 'flex';
                }
                
                // Re-render calendar with filtered events
                updateCalendarDisplay();
            };

            // Filter events by barn
            window.filterByBarnCalendar = function(barnCode) {
                console.log('🔍 Filtering events by barn:', barnCode);
                
                // Store current barn filter
                currentBarnFilter = barnCode;
                
                // Re-render calendar with filtered events
                updateCalendarDisplay();
            };

            // Add new note from calendar
            window.addNewNoteFromCalendar = function() {
                // Navigate to notes section
                navigateToSection('notes');
                
                // Open the note form modal
                setTimeout(() => {
                    if (window.toggleNoteForm) {
                        window.toggleNoteForm();
                    }
                }, 100);
            };

            // Add new farm event
            window.addFarmEvent = function() {
                const eventType = prompt('Event Type (vaccination, inspection, maintenance):');
                if (!eventType) return;
                
                const title = prompt('Event Title:');
                if (!title) return;
                
                const farm = prompt('Farm (VAS, EDG, APO, SIG, DFI):');
                if (!farm) return;
                
                const date = prompt('Date (YYYY-MM-DD):');
                if (!date) return;
                
                // Create new event
                const newEvent = {
                    id: 'event_' + Date.now(),
                    source: eventType,
                    title: title,
                    farmName: farm,
                    startDate: new Date(date),
                    endDate: new Date(date)
                };
                
                // Add to events array
                if (!feedScheduleEvents) feedScheduleEvents = [];
                feedScheduleEvents.push(newEvent);
                
                // Update calendar
                updateCalendarDisplay();
                
                console.log('✅ Added new farm event:', newEvent);
            };


            // Load calendar events
            window.loadCalendarEvents = async function() {
                try {
                    console.log('🔄 Loading calendar events...');
                    await loadFeedSchedulesForCalendar();
                    updateCalendarDisplay();
                    // If current month has no events, auto-focus nearest event month
                    focusNearestEventMonthIfNeeded();
                    console.log('✅ Calendar events loaded');
                } catch (error) {
                    console.error('❌ Error loading calendar events:', error);
                }
            };

            // Login Page Functionality
            function togglePassword() {
                const passwordInput = document.getElementById('password');
                const toggleIcon = document.getElementById('passwordToggleIcon');
                
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.className = 'fas fa-eye-slash';
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.className = 'fas fa-eye';
                }
            }

            function showForgotPassword() {
                alert('Forgot Password functionality will be implemented soon.\n\nPlease contact your system administrator to reset your password.');
            }

            function showSignUp() {
                alert('User registration is managed by administrators.\n\nPlease contact your system administrator to create an account.');
            }

            function showLoginError(message) {
                console.log('🔍 ERROR DEBUG: showLoginError called with message:', message);
                
                const errorDiv = document.getElementById('loginError');
                const errorMessage = document.getElementById('errorMessage');
                
                console.log('🔍 ERROR DEBUG: Error elements found:', {
                    errorDiv: !!errorDiv,
                    errorMessage: !!errorMessage
                });
                
                if (errorMessage) {
                    errorMessage.textContent = message;
                    console.log('✅ ERROR DEBUG: Error message set');
                } else {
                    console.error('❌ ERROR DEBUG: Error message element not found!');
                }
                
                if (errorDiv) {
                    errorDiv.style.display = 'flex';
                    console.log('✅ ERROR DEBUG: Error div shown');
                } else {
                    console.error('❌ ERROR DEBUG: Error div not found!');
                }
                
                // Hide error after 5 seconds
                setTimeout(() => {
                    if (errorDiv) {
                        errorDiv.style.display = 'none';
                        console.log('✅ ERROR DEBUG: Error auto-hidden after 5 seconds');
                    }
                }, 5000);
            }

            function hideLoginError() {
                const errorDiv = document.getElementById('loginError');
                errorDiv.style.display = 'none';
            }

            function setLoginLoading(loading) {
                console.log('🔍 LOADING DEBUG: setLoginLoading called with:', loading);
                
                const loginBtn = document.querySelector('.login-btn');
                const btnText = document.querySelector('.btn-text');
                const btnSpinner = document.querySelector('.btn-spinner');
                
                console.log('🔍 LOADING DEBUG: Elements found:', {
                    loginBtn: !!loginBtn,
                    btnText: !!btnText,
                    btnSpinner: !!btnSpinner
                });
                
                if (loading) {
                    console.log('🔍 LOADING DEBUG: Setting loading state to true');
                    if (loginBtn) {
                        loginBtn.classList.add('loading');
                        loginBtn.disabled = true;
                        console.log('✅ LOADING DEBUG: Login button set to loading');
                    } else {
                        console.error('❌ LOADING DEBUG: Login button not found!');
                    }
                } else {
                    console.log('🔍 LOADING DEBUG: Setting loading state to false');
                    if (loginBtn) {
                        loginBtn.classList.remove('loading');
                        loginBtn.disabled = false;
                        console.log('✅ LOADING DEBUG: Login button set to normal');
                    } else {
                        console.error('❌ LOADING DEBUG: Login button not found!');
                    }
                }
            }

            // Multi-Factor Authentication Support
            let mfaResolver = null;
            let recaptchaVerifier = null;

            // Initialize reCAPTCHA for MFA
            function initRecaptcha() {
                if (!recaptchaVerifier && window.firebaseAuth) {
                    recaptchaVerifier = new RecaptchaVerifier(window.firebaseAuth, 'recaptcha-container', {
                        size: 'invisible',
                        callback: () => {
                            console.log('✅ reCAPTCHA verified for MFA');
                        }
                    });
                }
                return recaptchaVerifier;
            }

            // Show MFA verification modal
            function showMFAVerification(hints) {
                const mfaModal = document.createElement('div');
                mfaModal.id = 'mfa-modal';
                mfaModal.innerHTML = `
                    <div class="mfa-overlay">
                        <div class="mfa-modal">
                            <div class="mfa-header">
                                <h2>🔐 Two-Factor Authentication</h2>
                                <p>Please verify your identity to continue</p>
                            </div>
                            <div class="mfa-content">
                                <div class="mfa-method" id="phone-mfa" style="display: none;">
                                    <h3>📱 SMS Verification</h3>
                                    <p>We'll send a verification code to your registered phone number.</p>
                                    <button class="btn btn-primary" onclick="sendSMSVerification()">
                                        Send SMS Code
                                    </button>
                                    <div class="verification-code" id="sms-code-input" style="display: none;">
                                        <input type="text" id="sms-code" placeholder="Enter 6-digit code" maxlength="6">
                                        <button class="btn btn-primary" onclick="verifySMSCode()">Verify</button>
                                    </div>
                                </div>
                                <div class="mfa-method" id="totp-mfa" style="display: none;">
                                    <h3>🔑 Authenticator App</h3>
                                    <p>Enter the 6-digit code from your authenticator app.</p>
                                    <input type="text" id="totp-code" placeholder="Enter 6-digit code" maxlength="6">
                                    <button class="btn btn-primary" onclick="verifyTOTPCode()">Verify</button>
                                </div>
                            </div>
                            <div class="mfa-footer">
                                <button class="btn btn-outline" onclick="cancelMFA()">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(mfaModal);

                // Show appropriate MFA method based on available hints
                hints.forEach((hint, index) => {
                    if (hint.factorId === PhoneMultiFactorGenerator.FACTOR_ID) {
                        document.getElementById('phone-mfa').style.display = 'block';
                    } else if (hint.factorId === TotpMultiFactorGenerator.FACTOR_ID) {
                        document.getElementById('totp-mfa').style.display = 'block';
                    }
                });
            }

            // Send SMS verification code
            async function sendSMSVerification() {
                try {
                    initRecaptcha();
                    const phoneInfoOptions = {
                        multiFactorHint: mfaResolver.hints.find(h => h.factorId === PhoneMultiFactorGenerator.FACTOR_ID),
                        session: mfaResolver.session
                    };
                    
                    const verificationId = await PhoneAuthProvider.verifyPhoneNumber(phoneInfoOptions, recaptchaVerifier);
                    window.mfaVerificationId = verificationId;
                    
                    document.getElementById('sms-code-input').style.display = 'block';
                    console.log('✅ SMS verification code sent');
                } catch (error) {
                    console.error('❌ SMS verification failed:', error);
                    alert('Failed to send SMS code. Please try again.');
                }
            }

            // Verify SMS code
            async function verifySMSCode() {
                const code = document.getElementById('sms-code').value;
                if (!code || code.length !== 6) {
                    alert('Please enter a valid 6-digit code');
                    return;
                }

                try {
                    const cred = PhoneAuthProvider.credential(window.mfaVerificationId, code);
                    const multiFactorAssertion = PhoneMultiFactorGenerator.assertion(cred);
                    
                    const userCredential = await mfaResolver.resolveSignIn(multiFactorAssertion);
                    console.log('✅ MFA login successful');
                    
                    // Complete login process
                    completeMFAFlow(userCredential.user);
                } catch (error) {
                    console.error('❌ SMS verification failed:', error);
                    alert('Invalid verification code. Please try again.');
                }
            }

            // Verify TOTP code
            async function verifyTOTPCode() {
                const code = document.getElementById('totp-code').value;
                if (!code || code.length !== 6) {
                    alert('Please enter a valid 6-digit code');
                    return;
                }

                try {
                    const cred = TotpMultiFactorGenerator.credential(code);
                    const multiFactorAssertion = TotpMultiFactorGenerator.assertion(cred);
                    
                    const userCredential = await mfaResolver.resolveSignIn(multiFactorAssertion);
                    console.log('✅ MFA login successful');
                    
                    // Complete login process
                    completeMFAFlow(userCredential.user);
                } catch (error) {
                    console.error('❌ TOTP verification failed:', error);
                    alert('Invalid verification code. Please try again.');
                }
            }

            // Complete MFA login flow
            function completeMFAFlow(user) {
                const email = document.getElementById('email').value.trim();
                const rememberMe = document.getElementById('rememberMe').checked;
                
                if (rememberMe) {
                    localStorage.setItem('flockview_remember', 'true');
                    localStorage.setItem('flockview_email', email);
                }
                
                // Store login state
                sessionStorage.setItem('flockview_logged_in', 'true');
                sessionStorage.setItem('flockview_user', user.uid);
                sessionStorage.setItem('flockview_email', email);
                
                // Hide MFA modal and show company selection
                document.getElementById('mfa-modal').remove();
                document.getElementById('login').style.display = 'none';
                document.getElementById('choose-company').style.display = 'block';
                
                console.log('✅ User logged in successfully with MFA:', email);
            }

            // Cancel MFA
            function cancelMFA() {
                document.getElementById('mfa-modal').remove();
                setLoginLoading(false);
            }

            // Make MFA functions globally accessible
            window.sendSMSVerification = sendSMSVerification;
            window.verifySMSCode = verifySMSCode;
            window.verifyTOTPCode = verifyTOTPCode;
            window.cancelMFA = cancelMFA;

            async function loginUser() {
                console.log('🚀 LOGIN DEBUG: loginUser() function called');
                
                const email = document.getElementById('email').value.trim();
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;

                console.log('🔍 LOGIN DEBUG: Form data collected:', {
                    email: email ? `${email.substring(0, 3)}***` : 'EMPTY',
                    passwordLength: password ? password.length : 0,
                    rememberMe: rememberMe
                });

                // Validate inputs
                if (!email || !password) {
                    console.log('❌ LOGIN DEBUG: Validation failed - missing email or password');
                    showLoginError('Please enter both email and password');
                    return;
                }

                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    console.log('❌ LOGIN DEBUG: Validation failed - invalid email format');
                    showLoginError('Please enter a valid email address');
                    return;
                }

                console.log('✅ LOGIN DEBUG: Form validation passed');
                hideLoginError();
                setLoginLoading(true);

                try {
                    console.log('🔍 LOGIN DEBUG: Checking Firebase initialization...');
                    console.log('🔍 LOGIN DEBUG: window.firebaseAuth:', !!window.firebaseAuth);
                    console.log('🔍 LOGIN DEBUG: window.firebaseSignIn:', !!window.firebaseSignIn);
                    
                    // Check if Firebase is properly initialized
                    if (!window.firebaseAuth || !window.firebaseSignIn) {
                        console.error('❌ LOGIN DEBUG: Firebase not properly initialized');
                        throw new Error('Firebase not properly initialized');
                    }
                    
                    console.log('✅ LOGIN DEBUG: Firebase is initialized, attempting authentication...');
                    console.log('🔍 LOGIN DEBUG: Calling window.firebaseSignIn with:', {
                        auth: window.firebaseAuth,
                        email: email,
                        passwordLength: password.length
                    });
                    
                    // Firebase authentication
                    const userCredential = await window.firebaseSignIn(window.firebaseAuth, email, password);
                    const user = userCredential.user;
                    
                    console.log('✅ LOGIN DEBUG: Firebase authentication successful:', {
                        userId: user.uid,
                        email: user.email,
                        emailVerified: user.emailVerified
                    });
                    
                    // Check if user exists in Firestore database
                    console.log('🔍 LOGIN DEBUG: Checking if user exists in database...');
                    try {
                        const userDoc = await getDoc(doc(db, 'users', user.uid));
                        
                        if (userDoc.exists()) {
                            console.log('✅ LOGIN DEBUG: User found in database:', userDoc.data());
                            
                            // Successful login - user exists in database
                            if (rememberMe) {
                                console.log('🔍 LOGIN DEBUG: Storing remember me data');
                                localStorage.setItem('flockview_remember', 'true');
                                localStorage.setItem('flockview_email', email);
                            }
                            
                            console.log('🔍 LOGIN DEBUG: Storing session data');
                            // Store login state
                            sessionStorage.setItem('flockview_logged_in', 'true');
                            sessionStorage.setItem('flockview_user', user.uid);
                            sessionStorage.setItem('flockview_email', email);
                            
                            console.log('🔍 LOGIN DEBUG: Hiding login page and showing company selection');
                            // Hide login page and show company selection
                            const loginElement = document.getElementById('login');
                            const companyElement = document.getElementById('choose-company');
                            
                            console.log('🔍 LOGIN DEBUG: Elements found:', {
                                loginElement: !!loginElement,
                                companyElement: !!companyElement
                            });
                            
                            if (loginElement) {
                                loginElement.style.display = 'none';
                                console.log('✅ LOGIN DEBUG: Login page hidden');
                            } else {
                                console.error('❌ LOGIN DEBUG: Login element not found!');
                            }
                            
                            if (companyElement) {
                                companyElement.style.display = 'block';
                                console.log('✅ LOGIN DEBUG: Company selection shown');
                            } else {
                                console.error('❌ LOGIN DEBUG: Company element not found!');
                            }
                            
                            console.log('✅ LOGIN DEBUG: User logged in successfully:', email);
                            
                        } else {
                            console.log('❌ LOGIN DEBUG: User not found in database, creating user...');
                            
                            // Create user in database if they don't exist
                            await setDoc(doc(db, 'users', user.uid), {
                                email: user.email,
                                uid: user.uid,
                                createdAt: serverTimestamp(),
                                lastLogin: serverTimestamp(),
                                role: 'user',
                                status: 'active'
                            });
                            
                            console.log('✅ LOGIN DEBUG: User created in database');
                            
                            // Successful login after creating user
                            if (rememberMe) {
                                console.log('🔍 LOGIN DEBUG: Storing remember me data');
                                localStorage.setItem('flockview_remember', 'true');
                                localStorage.setItem('flockview_email', email);
                            }
                            
                            console.log('🔍 LOGIN DEBUG: Storing session data');
                            // Store login state
                            sessionStorage.setItem('flockview_logged_in', 'true');
                            sessionStorage.setItem('flockview_user', user.uid);
                            sessionStorage.setItem('flockview_email', email);
                            
                            console.log('🔍 LOGIN DEBUG: Hiding login page and showing company selection');
                            // Hide login page and show company selection
                            const loginElement = document.getElementById('login');
                            const companyElement = document.getElementById('choose-company');
                            
                            console.log('🔍 LOGIN DEBUG: Elements found:', {
                                loginElement: !!loginElement,
                                companyElement: !!companyElement
                            });
                            
                            if (loginElement) {
                                loginElement.style.display = 'none';
                                console.log('✅ LOGIN DEBUG: Login page hidden');
                            } else {
                                console.error('❌ LOGIN DEBUG: Login element not found!');
                            }
                            
                            if (companyElement) {
                                companyElement.style.display = 'block';
                                console.log('✅ LOGIN DEBUG: Company selection shown');
                            } else {
                                console.error('❌ LOGIN DEBUG: Company element not found!');
                            }
                            
                            console.log('✅ LOGIN DEBUG: User logged in successfully after creation:', email);
                        }
                        
                    } catch (dbError) {
                        console.error('❌ LOGIN DEBUG: Database check failed:', dbError);
                        
                        // If database check fails, still allow login but log the issue
                        console.log('⚠️ LOGIN DEBUG: Allowing login despite database check failure');
                        
                        if (rememberMe) {
                            console.log('🔍 LOGIN DEBUG: Storing remember me data');
                            localStorage.setItem('flockview_remember', 'true');
                            localStorage.setItem('flockview_email', email);
                        }
                        
                        console.log('🔍 LOGIN DEBUG: Storing session data');
                        // Store login state
                        sessionStorage.setItem('flockview_logged_in', 'true');
                        sessionStorage.setItem('flockview_user', user.uid);
                        sessionStorage.setItem('flockview_email', email);
                        
                        console.log('🔍 LOGIN DEBUG: Hiding login page and showing company selection');
                        // Hide login page and show company selection
                        const loginElement = document.getElementById('login');
                        const companyElement = document.getElementById('choose-company');
                        
                        console.log('🔍 LOGIN DEBUG: Elements found:', {
                            loginElement: !!loginElement,
                            companyElement: !!companyElement
                        });
                        
                        if (loginElement) {
                            loginElement.style.display = 'none';
                            console.log('✅ LOGIN DEBUG: Login page hidden');
                        } else {
                            console.error('❌ LOGIN DEBUG: Login element not found!');
                        }
                        
                        if (companyElement) {
                            companyElement.style.display = 'block';
                            console.log('✅ LOGIN DEBUG: Company selection shown');
                        } else {
                            console.error('❌ LOGIN DEBUG: Company element not found!');
                        }
                        
                        console.log('✅ LOGIN DEBUG: User logged in successfully (database check failed):', email);
                    }
                    
                } catch (error) {
                    console.error('❌ LOGIN DEBUG: Login error caught:', error);
                    console.error('❌ LOGIN DEBUG: Error details:', {
                        code: error.code,
                        message: error.message,
                        stack: error.stack
                    });
                    
                    // Handle Multi-Factor Authentication requirement
                    if (error.code === 'auth/multi-factor-auth-required') {
                        console.log('🔐 LOGIN DEBUG: Multi-Factor Authentication required');
                        
                        // Get the multi-factor resolver
                        mfaResolver = getMultiFactorResolver(window.firebaseAuth, error);
                        console.log('🔍 LOGIN DEBUG: MFA resolver created:', !!mfaResolver);
                        
                        // Show MFA verification modal
                        showMFAVerification(mfaResolver.hints);
                        console.log('✅ LOGIN DEBUG: MFA modal shown');
                        
                        return; // Don't show error, MFA modal is handling it
                    }
                    
                    // Handle other Firebase auth errors
                    let errorMessage = 'Login failed. Please try again.';
                    
                    if (error.message === 'Firebase not properly initialized') {
                        errorMessage = 'Authentication service is not available. Please contact support.';
                        console.log('❌ LOGIN DEBUG: Firebase initialization error');
                    } else {
                        console.log('🔍 LOGIN DEBUG: Processing Firebase error code:', error.code);
                        switch (error.code) {
                            case 'auth/user-not-found':
                                errorMessage = 'No account found with this email address.';
                                console.log('❌ LOGIN DEBUG: User not found error');
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'Incorrect password. Please try again.';
                                console.log('❌ LOGIN DEBUG: Wrong password error');
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'Please enter a valid email address.';
                                console.log('❌ LOGIN DEBUG: Invalid email error');
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'This account has been disabled. Please contact support.';
                                console.log('❌ LOGIN DEBUG: User disabled error');
                                break;
                            case 'auth/too-many-requests':
                                errorMessage = 'Too many failed attempts. Please try again later.';
                                console.log('❌ LOGIN DEBUG: Too many requests error');
                                break;
                            case 'auth/network-request-failed':
                                errorMessage = 'Network error. Please check your connection and try again.';
                                console.log('❌ LOGIN DEBUG: Network error');
                                break;
                            case 'auth/invalid-credential':
                                errorMessage = 'Invalid email or password.';
                                console.log('❌ LOGIN DEBUG: Invalid credential error');
                                break;
                            default:
                                console.log('❌ LOGIN DEBUG: Unknown error code:', error.code);
                                break;
                        }
                    }
                    
                    console.log('🔍 LOGIN DEBUG: Showing error message:', errorMessage);
                    showLoginError(errorMessage);
                    setLoginLoading(false);
                }
            }

            async function logout() {
                try {
                    // Firebase sign out
                    await window.firebaseSignOut(window.firebaseAuth);
                    
                    // Clear session data
                    sessionStorage.removeItem('flockview_logged_in');
                    sessionStorage.removeItem('flockview_user');
                    sessionStorage.removeItem('flockview_email');
                    
                    // Redirect to login page
                    window.location.href = 'login.html';
                    
                    console.log('✅ User logged out successfully');
                } catch (error) {
                    console.error('❌ Logout error:', error);
                    // Still clear local data even if Firebase logout fails
                    sessionStorage.removeItem('flockview_logged_in');
                    sessionStorage.removeItem('flockview_user');
                    sessionStorage.removeItem('flockview_email');
                    
                    // Redirect to login page
                    window.location.href = 'login.html';
                }
            }

            function checkLoginStatus() {
                const isLoggedIn = sessionStorage.getItem('flockview_logged_in');
                
                if (isLoggedIn !== 'true') {
                    // User is not logged in, redirect to login page
                    window.location.href = 'login.html';
                } else {
                    // User is logged in, show main app
                    console.log('✅ User is logged in, showing main application');
                }
            }

            // Firebase Auth State Listener
            function initFirebaseAuth() {
                if (window.firebaseAuthStateChanged && window.firebaseAuth && window.firebaseAuth.currentUser !== undefined) {
                    try {
                        window.firebaseAuthStateChanged(window.firebaseAuth, (user) => {
                            if (user) {
                                // User is signed in
                                console.log('✅ Firebase auth state: User is signed in', user.uid);
                                sessionStorage.setItem('flockview_logged_in', 'true');
                                sessionStorage.setItem('flockview_user', user.uid);
                                sessionStorage.setItem('flockview_email', user.email);
                                
                                // Show company selection page
                                document.getElementById('login').style.display = 'none';
                                document.getElementById('choose-company').style.display = 'block';
                            } else {
                                // User is signed out
                                console.log('❌ Firebase auth state: User is signed out');
                                sessionStorage.removeItem('flockview_logged_in');
                                sessionStorage.removeItem('flockview_user');
                                sessionStorage.removeItem('flockview_email');
                                
                                // Show login page
                                document.getElementById('login').style.display = 'block';
                                document.getElementById('mainNavigation').style.display = 'none';
                                document.getElementById('mainContent').style.display = 'none';
                            }
                        });
                    } catch (error) {
                        console.warn('⚠️ Firebase auth state listener failed:', error);
                        console.log('🔧 Using fallback authentication check');
                        checkLoginStatus();
                    }
                } else {
                    console.warn('⚠️ Firebase auth not properly initialized, using fallback');
                    checkLoginStatus();
                }
            }

            // Comprehensive debugging function
            function debugLoginSystem() {
                console.log('🔍 SYSTEM DEBUG: Starting comprehensive login system check...');
                
                // Check if all required elements exist
                const elements = {
                    'loginForm': document.getElementById('loginForm'),
                    'email': document.getElementById('email'),
                    'password': document.getElementById('password'),
                    'loginBtn': document.querySelector('.login-btn'),
                    'loginError': document.getElementById('loginError'),
                    'errorMessage': document.getElementById('errorMessage'),
                    'login': document.getElementById('login'),
                    'choose-company': document.getElementById('choose-company')
                };
                
                console.log('🔍 SYSTEM DEBUG: Element check results:');
                Object.entries(elements).forEach(([name, element]) => {
                    if (element) {
                        console.log(`✅ ${name}: Found`);
                    } else {
                        console.error(`❌ ${name}: NOT FOUND!`);
                    }
                });
                
                // Check Firebase initialization
                console.log('🔍 SYSTEM DEBUG: Firebase check:');
                console.log('🔍 window.firebaseAuth:', !!window.firebaseAuth);
                console.log('🔍 window.firebaseSignIn:', !!window.firebaseSignIn);
                console.log('🔍 window.firebaseSignOut:', !!window.firebaseSignOut);
                
                // Check if functions are defined
                console.log('🔍 SYSTEM DEBUG: Function check:');
                console.log('🔍 loginUser:', typeof loginUser);
                console.log('🔍 setLoginLoading:', typeof setLoginLoading);
                console.log('🔍 showLoginError:', typeof showLoginError);
                
                console.log('✅ SYSTEM DEBUG: Login system check complete');
            }

            // Login form event listeners
            document.addEventListener('DOMContentLoaded', function() {
                console.log('🚀 DOM DEBUG: DOMContentLoaded event fired');
                
                // Run comprehensive debug check
                setTimeout(debugLoginSystem, 1000);
                
                const loginForm = document.getElementById('loginForm');
                
                if (loginForm) {
                    console.log('✅ FORM DEBUG: Login form found, adding submit listener');
                    loginForm.addEventListener('submit', function(e) {
                        console.log('🚀 FORM DEBUG: Form submit event triggered');
                        e.preventDefault();
                        console.log('🔍 FORM DEBUG: Calling loginUser() function');
                        loginUser();
                    });
                } else {
                    console.error('❌ FORM DEBUG: Login form not found!');
                }
                
                // Initialize Firebase auth state listener
                setTimeout(() => {
                    initFirebaseAuth();
                }, 2000); // Wait for Firebase to load
                
                // Check login status on page load
                checkLoginStatus();
            });


            // Firebase helper functions
            window.createTestUser = async function(email, password) {
                try {
                    // This would typically be done server-side or through Firebase Console
                    console.log('📝 To create test users:');
                    console.log('1. Go to Firebase Console > Authentication > Users');
                    console.log('2. Click "Add user" and enter email/password');
                    console.log('3. Or use Firebase Admin SDK on your server');
                    console.log(`Suggested test user: ${email}`);
                    alert(`To create a test user:\n\n1. Go to Firebase Console\n2. Authentication > Users\n3. Click "Add user"\n4. Email: ${email}\n5. Password: ${password}`);
                } catch (error) {
                    console.error('Error creating test user:', error);
                }
            };

            // Test login function for debugging
            async function testLogin(email = 'test@example.com', password = 'testpass') {
                console.log('🧪 TEST DEBUG: Manual login test started');
                console.log('🧪 TEST DEBUG: Using test credentials:', { email, password });
                
                // Set test values in form
                document.getElementById('email').value = email;
                document.getElementById('password').value = password;
                
                // Call login function directly
                await loginUser();
            }

            // Force login function for testing
            async function forceLogin() {
                console.log('🚀 FORCE DEBUG: Force login triggered');
                
                const email = prompt('Enter email:');
                const password = prompt('Enter password:');
                
                if (email && password) {
                    console.log('🚀 FORCE DEBUG: Calling loginUser with:', { email, password });
                    document.getElementById('email').value = email;
                    document.getElementById('password').value = password;
                    await loginUser();
                } else {
                    console.log('🚀 FORCE DEBUG: Login cancelled');
                }
            }

            // Bypass login function for testing
            function bypassLogin() {
                console.log('🚀 BYPASS DEBUG: Bypassing login completely');
                
                // Store fake session data
                sessionStorage.setItem('flockview_logged_in', 'true');
                sessionStorage.setItem('flockview_user', 'test-user-123');
                sessionStorage.setItem('flockview_email', 'test@example.com');
                
                // Hide login page and show company selection
                const loginElement = document.getElementById('login');
                const companyElement = document.getElementById('choose-company');
                
                console.log('🔍 BYPASS DEBUG: Elements found:', {
                    loginElement: !!loginElement,
                    companyElement: !!companyElement
                });
                
                if (loginElement) {
                    loginElement.style.display = 'none';
                    console.log('✅ BYPASS DEBUG: Login page hidden');
                }
                
                if (companyElement) {
                    companyElement.style.display = 'block';
                    console.log('✅ BYPASS DEBUG: Company selection shown');
                }
                
                console.log('✅ BYPASS DEBUG: Login bypassed successfully');
            }

            // Make essential functions globally accessible
            window.logout = logout;
            

            window.getFarmColor = getFarmColor;
            window.getNoteColor = getNoteColor;
            
            // Load feed schedules after all functions are defined
            if (window.loadFeedSchedules) {
                window.loadFeedSchedules();
            }
            
            // Calendar will be initialized when the calendar section is opened
            console.log('📅 Calendar functions loaded and ready');

            // Notes System
            let allNotes = [];
            let filteredNotes = [];

            // Predefined tags for farm operations
            const predefinedTags = [
                // Repairs & Maintenance
                { name: 'repairs', category: 'maintenance', display: 'Repairs' },
                { name: 'maintenance', category: 'maintenance', display: 'Maintenance' },
                { name: 'equipment', category: 'maintenance', display: 'Equipment' },
                { name: 'machinery', category: 'maintenance', display: 'Machinery' },
                
                // Employee Management
                { name: 'employee', category: 'personnel', display: 'Employee' },
                { name: 'training', category: 'personnel', display: 'Training' },
                { name: 'schedule', category: 'personnel', display: 'Schedule' },
                { name: 'payroll', category: 'personnel', display: 'Payroll' },
                
                // Vehicle Operations
                { name: 'vehicle', category: 'transport', display: 'Vehicle' },
                { name: 'delivery', category: 'transport', display: 'Delivery' },
                { name: 'transport', category: 'transport', display: 'Transport' },
                { name: 'fuel', category: 'transport', display: 'Fuel' },
                
                // Health & Safety
                { name: 'health', category: 'safety', display: 'Health' },
                { name: 'safety', category: 'safety', display: 'Safety' },
                { name: 'vaccination', category: 'safety', display: 'Vaccination' },
                { name: 'biosecurity', category: 'safety', display: 'Biosecurity' },
                
                // Feed & Nutrition
                { name: 'feed', category: 'nutrition', display: 'Feed' },
                { name: 'nutrition', category: 'nutrition', display: 'Nutrition' },
                { name: 'supplements', category: 'nutrition', display: 'Supplements' },
                { name: 'water', category: 'nutrition', display: 'Water' },
                
                // Environment & Climate
                { name: 'temperature', category: 'environment', display: 'Temperature' },
                { name: 'humidity', category: 'environment', display: 'Humidity' },
                { name: 'ventilation', category: 'environment', display: 'Ventilation' },
                { name: 'heating', category: 'environment', display: 'Heating' },
                
                // Production & Performance
                { name: 'production', category: 'performance', display: 'Production' },
                { name: 'performance', category: 'performance', display: 'Performance' },
                { name: 'mortality', category: 'performance', display: 'Mortality' },
                { name: 'growth', category: 'performance', display: 'Growth' },
                
                // Financial & Business
                { name: 'costs', category: 'financial', display: 'Costs' },
                { name: 'budget', category: 'financial', display: 'Budget' },
                { name: 'inventory', category: 'financial', display: 'Inventory' },
                { name: 'sales', category: 'financial', display: 'Sales' },
                
                // Quality & Standards
                { name: 'quality', category: 'standards', display: 'Quality' },
                { name: 'inspection', category: 'standards', display: 'Inspection' },
                { name: 'compliance', category: 'standards', display: 'Compliance' },
                { name: 'certification', category: 'standards', display: 'Certification' }
            ];

            // Load notes from Firestore
            let isLoadingNotes = false;
            window.loadNotes = async function() {
                if (isLoadingNotes) {
                    console.log('⏳ loadNotes already in progress, skipping...');
                    return;
                }
                
                isLoadingNotes = true;
                try {
                    console.log('🔄 Loading notes...');
                    console.log('🔍 db type:', typeof db);
                    console.log('🔍 db value:', db);
                    
                    if (typeof db === 'undefined') {
                        console.log('⚠️ Firebase not available, loading sample notes');
                        loadSampleNotes();
                        return;
                    }

                    // Check if we're in bypass mode - if so, skip database query and go straight to sample data
                    const authBypass = sessionStorage.getItem('flockview_auth_bypass');
                    if (authBypass === 'true') {
                        console.log('🔓 Bypass mode: Skipping database query, loading sample notes...');
                        
                        // Add sample data indicator to notes
                        const notesContainer = document.getElementById('notesContainer');
                        if (notesContainer) {
                            const sampleIndicator = document.createElement('div');
                            sampleIndicator.className = 'sample-data-indicator';
                            sampleIndicator.style.cssText = `
                                background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                                color: white;
                                padding: 10px 15px;
                                border-radius: 8px;
                                margin-bottom: 20px;
                                text-align: center;
                                font-weight: bold;
                                box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
                            `;
                            sampleIndicator.innerHTML = `
                                <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>
                                Sample Data Mode - Demo Notes
                            `;
                            notesContainer.insertBefore(sampleIndicator, notesContainer.firstChild);
                        }
                        
                        loadSampleNotes();
                        return;
                    }

                    const q = query(collection(db, 'farm_notes'), orderBy('createdAt', 'desc'));
                    
                    // Add timeout to prevent hanging
                    const queryPromise = getDocs(q);
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Notes query timeout after 10 seconds')), 10000)
                    );
                    
                    const querySnapshot = await Promise.race([queryPromise, timeoutPromise]);
                    
                    allNotes = [];
                    querySnapshot.forEach((doc) => {
                        allNotes.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    filteredNotes = [...allNotes];
                    displayNotes(filteredNotes);
                    
                    console.log(`✅ Loaded ${allNotes.length} notes`);
                    // If calendar is visible, refresh calendar events to include notes
                    try {
                        const calendarSection = document.getElementById('calendar');
                        if (calendarSection && calendarSection.style.display !== 'none' && window.loadFeedSchedulesForCalendar) {
                            await window.loadFeedSchedulesForCalendar();
                        }
                    } catch (e) {
                        console.warn('⚠️ Could not refresh calendar after loading notes:', e);
                    }
                    
                } catch (error) {
                    console.error('❌ Error loading notes:', error);
                    loadSampleNotes();
                } finally {
                    isLoadingNotes = false;
                }
            }

            // Load sample notes for testing
            function loadSampleNotes() {
                console.log('🔄 Loading sample notes...');
                
                // Add sample data indicator to notes if not already present
                const notesContainer = document.getElementById('notesContainer');
                if (notesContainer && !notesContainer.querySelector('.sample-data-indicator')) {
                    const sampleIndicator = document.createElement('div');
                    sampleIndicator.className = 'sample-data-indicator';
                    sampleIndicator.style.cssText = `
                        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 8px;
                        margin-bottom: 20px;
                        text-align: center;
                        font-weight: bold;
                        box-shadow: 0 4px 15px rgba(240, 147, 251, 0.3);
                    `;
                    sampleIndicator.innerHTML = `
                        <i class="fas fa-sticky-note" style="margin-right: 8px;"></i>
                        Sample Data Mode - Demo Notes
                    `;
                    notesContainer.insertBefore(sampleIndicator, notesContainer.firstChild);
                }
                
                allNotes = [
                    {
                        id: 'sample1',
                        title: 'Barn 1 Ventilation Check',
                        farm: 'VAS',
                        barn: 'B1',
                        date: new Date().toISOString().split('T')[0],
                        time: '09:00',
                        content: 'Check ventilation system in Barn 1. Temperature readings seem high.',
                        tags: ['maintenance', 'ventilation', 'temperature'],
                        createdAt: new Date()
                    },
                    {
                        id: 'sample2',
                        title: 'Feed Delivery Scheduled',
                        farm: 'EDG',
                        barn: 'B2',
                        date: new Date().toISOString().split('T')[0],
                        time: '14:00',
                        content: 'Feed delivery scheduled for tomorrow. Ensure storage bins are ready.',
                        tags: ['feed', 'delivery', 'schedule'],
                        createdAt: new Date()
                    }
                ];
                filteredNotes = [...allNotes];
                console.log('✅ Sample notes loaded:', allNotes.length);
                displayNotes(filteredNotes);
                // If calendar is visible, refresh calendar events to include sample notes
                try {
                    const calendarSection = document.getElementById('calendar');
                    if (calendarSection && calendarSection.style.display !== 'none' && window.loadFeedSchedulesForCalendar) {
                        window.loadFeedSchedulesForCalendar();
                    }
                } catch (e) {
                    console.warn('⚠️ Could not refresh calendar after loading sample notes:', e);
                }
            }

            // Display notes in the container (grouped by Month)
            function displayNotes(notes) {
                console.log('🔄 Displaying notes:', notes.length);
                const notesContainer = document.getElementById('notesContainer');
                if (!notesContainer) {
                    console.error('❌ notesContainer element not found!');
                    return;
                }
                
                if (notes.length === 0) {
                    // Check if there's already a sample data indicator
                    const existingIndicator = notesContainer.querySelector('.sample-data-indicator');
                    if (existingIndicator) {
                        // Keep the indicator and add "no notes" message
                        notesContainer.innerHTML = existingIndicator.outerHTML + `
                            <div class="notes-loading-streamlined">
                                <i class="fas fa-sticky-note"></i>
                                <p>No notes found</p>
                                <p>Create your first note to get started</p>
                            </div>
                        `;
                    } else {
                        notesContainer.innerHTML = `
                            <div class="notes-loading-streamlined">
                                <i class="fas fa-sticky-note"></i>
                                <p>No notes found</p>
                                <p>Create your first note to get started</p>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Group notes by month-year key using note.date
                const monthGroups = {};
                notes.forEach(note => {
                    const d = note.date ? new Date(note.date) : (note.createdAt ? new Date(note.createdAt) : new Date());
                    const year = d.getFullYear();
                    const month = d.getMonth(); // 0-11
                    const key = `${year}-${String(month + 1).padStart(2, '0')}`;
                    if (!monthGroups[key]) monthGroups[key] = [];
                    monthGroups[key].push(note);
                });
                
                // Sort groups latest to oldest
                const sortedKeys = Object.keys(monthGroups).sort((a, b) => b.localeCompare(a));
                
                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                
                // Check if there's already a sample data indicator
                const existingIndicator = notesContainer.querySelector('.sample-data-indicator');
                const indicatorHTML = existingIndicator ? existingIndicator.outerHTML : '';
                
                notesContainer.innerHTML = indicatorHTML + sortedKeys.map(key => {
                    const [yearStr, monthStr] = key.split('-');
                    const year = yearStr;
                    const monthIndex = parseInt(monthStr, 10) - 1;
                    const title = `${monthNames[monthIndex]} ${year}`;
                    const items = monthGroups[key]
                        .map(note => `
                            <div class="note-card-streamlined" data-note-id="${note.id}" style="--note-color: ${note.color || '#2563eb'}">
                                <div class="note-header-streamlined">
                                    <div class="note-title-streamlined">${note.title}</div>
                                </div>
                                <div class="note-meta-streamlined">
                                    <span><i class="fas fa-map-marker-alt"></i> ${note.farm}${note.barn ? ` ${note.barn === 'ALL' ? ' All Barns' : note.barn}` : ''}</span>
                                    <span><i class="fas fa-calendar"></i> ${note.date}</span>
                                    ${note.time ? `<span><i class=\"fas fa-clock\"></i> ${note.time}</span>` : ''}
                                </div>
                                <div class="note-content-streamlined">${note.content}</div>
                                <div class="note-actions-streamlined">
                                    <button class="btn btn-outline btn-sm" onclick="editNote('${note.id}')" title="Edit Note">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteNote('${note.id}')" title="Delete Note">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </div>
                            </div>
                        `).join('');
                    return `
                        <div class="notes-group">
                            <div class="notes-group-header">
                                <div class="notes-group-title">${title}</div>
                                <button class="btn btn-danger btn-sm" onclick="deleteNotesForMonth('${key}')" title="Delete all notes for ${title}">
                                    <i class="fas fa-trash"></i> Delete Month
                                </button>
                            </div>
                            <div class="notes-group-items">${items}</div>
                        </div>
                    `;
                }).join('');
            }

            // Search notes
            function searchNotes() {
                const searchTerm = document.getElementById('notesSearchInput').value.toLowerCase();
                const farmFilter = document.getElementById('farmFilter').value;
                const dateFilter = document.getElementById('dateFilter').value; // "" or MM
                
                filteredNotes = allNotes.filter(note => {
                    const matchesSearch = note.title.toLowerCase().includes(searchTerm) || 
                                        note.content.toLowerCase().includes(searchTerm) ||
                                        false;
                    
                    const matchesFarm = !farmFilter || note.farm === farmFilter;
                    
                    let matchesDate = true;
                    if (dateFilter) {
                        const d = note.date ? new Date(note.date) : (note.createdAt ? new Date(note.createdAt) : null);
                        if (!d) {
                            matchesDate = false;
                        } else {
                            const mm = String(d.getMonth() + 1).padStart(2, '0');
                            matchesDate = mm === dateFilter;
                        }
                    }
                    
                    return matchesSearch && matchesFarm && matchesDate;
                });
                
                displayNotes(filteredNotes);
                
            }

            // Filter notes
            function filterNotes() { searchNotes(); }

            // Delete all notes for a specific month key (YYYY-MM)
            async function deleteNotesForMonth(monthKey) {
                const ids = filteredNotes
                    .filter(n => {
                        const d = n.date ? new Date(n.date) : (n.createdAt ? new Date(n.createdAt) : new Date());
                        const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                        return key === monthKey;
                    })
                    .map(n => n.id);
                if (ids.length === 0) return;
                const [y, m] = monthKey.split('-');
                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                const title = `${monthNames[parseInt(m, 10) - 1]} ${y}`;
                if (!confirm(`Delete all ${ids.length} note(s) for ${title}?`)) return;
                try {
                    if (typeof db !== 'undefined') {
                        for (const id of ids) {
                            await deleteDoc(doc(db, 'farm_notes', id));
                        }
                    }
                    allNotes = allNotes.filter(n => !ids.includes(n.id));
                    filteredNotes = filteredNotes.filter(n => !ids.includes(n.id));
                    displayNotes(filteredNotes);
                    console.log(`✅ Deleted all notes for ${title}`);
                } catch (err) {
                    console.error('❌ Error deleting notes for month:', err);
                    alert('Error deleting notes for this month. Please try again.');
                }
            }

            // Clear note form
            function clearNoteForm() {
                document.getElementById('quickNoteForm').reset();
                document.getElementById('noteDate').value = new Date().toISOString().split('T')[0];
                
                // Clear selected tags
                
                // Reset color to default blue
                const colorInput = document.getElementById('noteColor');
                if (colorInput) colorInput.value = '#2563eb';
                const colorPanel = document.getElementById('colorPickerPanel');
                if (colorPanel) colorPanel.style.display = 'none';
                
                // Reset form to create mode
                const submitBtn = document.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Note';
                submitBtn.onclick = null;
                
                // Remove cancel button if it exists
                const cancelBtn = document.querySelector('.btn-cancel');
                if (cancelBtn) cancelBtn.remove();
            }

            // Initialize tags when form is opened
            function initializeTags() { /* Tags deprecated */ }

            // Helper function to create tag elements
            function createTagElement() { /* Tags deprecated */ }

            // Toggle tags collapse
            function toggleTagsCollapse() { /* Tags deprecated */ }

            // Toggle tag selection
            function toggleTag() { /* Tags deprecated */ }

            // Get selected tags
            function getSelectedTags() { return []; }

            // Add custom tag from input
            function addCustomTagFromInput() { /* Tags deprecated */ }

            // Handle Enter key in custom tag input
            function addCustomTag() { /* Tags deprecated */ }

            // Edit note
            function editNote(noteId) {
                const note = allNotes.find(n => n.id === noteId);
                if (!note) return;
                
                // Populate form with note data
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteFarm').value = note.farm;
                document.getElementById('noteBarn').value = note.barn || 'ALL';
                document.getElementById('noteDate').value = note.date;
                document.getElementById('noteTime').value = note.time || '';
                document.getElementById('noteContent').value = note.content;
                
                // Set color if present
                const colorInput = document.getElementById('noteColor');
                if (colorInput) colorInput.value = note.color || '#2563eb';
                // reflect active swatch
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                const sw = document.querySelector(`.color-swatch[data-color="${note.color || '#2563eb'}"]`);
                if (sw) sw.classList.add('active');
                
                // Change form to edit mode
                const form = document.getElementById('quickNoteForm');
                const submitBtn = form.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-save"></i> Update Note';
                submitBtn.onclick = (e) => {
                    e.preventDefault();
                    updateNote(noteId);
                };
                
                // Add cancel button
                if (!form.querySelector('.btn-cancel')) {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.className = 'btn btn-outline btn-cancel';
                    submitBtn.parentNode.insertBefore(cancelBtn, submitBtn);
                    cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                    cancelBtn.onclick = () => {
                        clearNoteForm();
                        submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Note';
                        submitBtn.onclick = null;
                        form.querySelector('.btn-cancel')?.remove();
                    };
                }
                
                // Show form
                toggleNoteForm();
            }

            // Update note
            async function updateNote(noteId) {
                try {
                    const noteData = {
                        title: document.getElementById('noteTitle').value,
                        farm: document.getElementById('noteFarm').value,
                        barn: document.getElementById('noteBarn').value || null,
                        color: document.getElementById('noteColor').value || '#2563eb',
                        date: document.getElementById('noteDate').value,
                        time: document.getElementById('noteTime').value || null,
                        content: document.getElementById('noteContent').value,
                        
                        updatedAt: new Date()
                    };
                    
                    if (typeof db !== 'undefined') {
                        await updateDoc(doc(db, 'farm_notes', noteId), noteData);
                        console.log('✅ Note updated in Firestore');
                    }
                    
                    // Update local data
                    const noteIndex = allNotes.findIndex(n => n.id === noteId);
                    if (noteIndex !== -1) {
                        allNotes[noteIndex] = { ...allNotes[noteIndex], ...noteData };
                        filteredNotes = [...allNotes];
                    }
                    
                    // Close the form overlay
                    toggleNoteForm();
                    
                    // Refresh calendar if it's visible
                    if (document.getElementById('calendar').style.display !== 'none') {
                        loadFeedSchedulesForCalendar();
                    }
                    
                    console.log('✅ Note updated successfully');
                    
                } catch (error) {
                    console.error('❌ Error updating note:', error);
                    alert('Error updating note. Please try again.');
                }
            }
            // Delete note
            async function deleteNote(noteId) {
                if (!confirm('Are you sure you want to delete this note?')) {
                    return;
                }
                
                try {
                    if (typeof db !== 'undefined') {
                        await deleteDoc(doc(db, 'farm_notes', noteId));
                        console.log('✅ Note deleted from Firestore');
                    }
                    
                    // Remove from local data
                    allNotes = allNotes.filter(n => n.id !== noteId);
                    filteredNotes = filteredNotes.filter(n => n.id !== noteId);
                    
                    // Refresh display
                    displayNotes(filteredNotes);
                    
                    // Refresh calendar if it's visible
                    if (document.getElementById('calendar').style.display !== 'none') {
                        loadFeedSchedulesForCalendar();
                    }
                    
                    console.log('✅ Note deleted successfully');
                    
                } catch (error) {
                    console.error('❌ Error deleting note:', error);
                    alert('Error deleting note. Please try again.');
                }
            }
            // Create note
            async function createNote(event) {
                event.preventDefault();
                
                try {
                    const noteData = {
                        title: document.getElementById('noteTitle').value,
                        farm: document.getElementById('noteFarm').value,
                        barn: document.getElementById('noteBarn').value || null,
                        color: document.getElementById('noteColor').value || '#2563eb',
                        date: document.getElementById('noteDate').value,
                        time: document.getElementById('noteTime').value || null,
                        content: document.getElementById('noteContent').value,
                        
                        createdAt: new Date()
                    };
                    
                    if (typeof db !== 'undefined') {
                        const docRef = await addDoc(collection(db, 'farm_notes'), noteData);
                        noteData.id = docRef.id;
                        console.log('✅ Note created in Firestore');
                    }
                    
                    // Add to local data
                    allNotes.unshift(noteData);
                    filteredNotes = [...allNotes];
                    
                    // Refresh display
                    displayNotes(filteredNotes);
                    
                    // Clear form and close overlay
                    clearNoteForm();
                    toggleNoteForm();
                    
                    // Refresh calendar if it's visible
                    if (document.getElementById('calendar').style.display !== 'none') {
                        loadFeedSchedulesForCalendar();
                    }
                    
                    console.log('✅ Note created successfully');
                    
                } catch (error) {
                    console.error('❌ Error creating note:', error);
                    alert('Error creating note. Please try again.');
                }
            }

            // Toggle note form
            window.toggleNoteForm = function() {
                const overlay = document.getElementById('noteFormOverlay');
                const fabButton = document.getElementById('fabButton');
                
                if (overlay.style.display === 'none') {
                    overlay.style.display = 'flex';
                    fabButton.innerHTML = '<i class="fas fa-times"></i>';
                    // open color panel and set default if empty
                    const colorPanel = document.getElementById('colorPickerPanel');
                    if (colorPanel) colorPanel.style.display = 'block';
                    const colorInput = document.getElementById('noteColor');
                    if (colorInput && !colorInput.value) colorInput.value = '#2563eb';
                    // set active swatch for blue on open
                    document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                    const defaultSwatch = document.querySelector('.color-swatch[data-color="#2563eb"]');
                    if (defaultSwatch) defaultSwatch.classList.add('active');
                } else {
                    overlay.style.display = 'none';
                    fabButton.innerHTML = '<i class="fas fa-plus"></i>';
                    clearNoteForm();
                }
            }

            // Toggle search filters
            function toggleSearchFilters() {
                const filters = document.getElementById('searchFilters');
                const toggle = document.getElementById('searchFiltersToggle');
                
                if (filters.style.display === 'none') {
                    filters.style.display = 'block';
                    toggle.classList.add('active');
                } else {
                    filters.style.display = 'none';
                    toggle.classList.remove('active');
                }
            }


            // Make Notes functions globally accessible
            window.searchNotes = searchNotes;
            window.filterNotes = filterNotes;
            window.clearNoteForm = clearNoteForm;
            window.editNote = editNote;
            window.updateNote = updateNote;
            window.deleteNote = deleteNote;
            window.createNote = createNote;
            window.toggleNoteForm = toggleNoteForm;
            window.toggleSearchFilters = toggleSearchFilters;
            // window.viewNote = viewNote; // Function not defined, removing to prevent error
            window.initializeTags = initializeTags;
            window.toggleTag = toggleTag;
            window.getSelectedTags = getSelectedTags;
            window.addCustomTagFromInput = addCustomTagFromInput;
            window.addCustomTag = addCustomTag;
            window.createTagElement = createTagElement;
            window.toggleTagsCollapse = toggleTagsCollapse;
            window.deleteNotesForMonth = deleteNotesForMonth;
            // Color picker helpers
            window.toggleColorPicker = function() {
                const panel = document.getElementById('colorPickerPanel');
                if (!panel) return;
                panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            }
            window.setNoteColor = function(color) {
                const input = document.getElementById('noteColor');
                if (input) input.value = color;
                // mark active swatch
                document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
                const active = document.querySelector(`.color-swatch[data-color="${color}"]`);
                if (active) active.classList.add('active');
            }
        });
    </script>
</body>
</html>