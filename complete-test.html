<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete System Test - FlockView</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .feature-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background: #f9f9f9;
        }
        .feature-card h3 {
            margin-top: 0;
            color: #333;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Complete FlockView System Test</h1>
        <p>This comprehensive test checks all your FlockView features and data connections.</p>
        
        <div id="testResults"></div>
        
        <button onclick="runAllTests()">üß™ Run Complete Test</button>
        <button onclick="testFirebase()" class="btn-warning">üî• Test Firebase</button>
        <button onclick="testAuth()" class="btn-warning">üîê Test Auth</button>
        <button onclick="testDataAccess()" class="btn-warning">üìä Test Data</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        <button onclick="autoBypass()" class="btn-success">üöÄ Auto-Bypass & Test</button>
        
        <div style="margin-top: 20px;">
            <a href="login.html">‚Üê Back to Login</a> | 
            <a href="flockview-app-cursor-notoffical.html">‚Üí Go to App</a>
        </div>
    </div>

    <div class="feature-grid">
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="feed-status"></span>Feed Schedules</h3>
            <p>Test feed schedule loading, viewing, and editing capabilities.</p>
            <button onclick="testFeedSchedules()">Test Feed Schedules</button>
        </div>
        
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="notes-status"></span>Notes System</h3>
            <p>Test notes creation, loading, and management.</p>
            <button onclick="testNotes()">Test Notes</button>
        </div>
        
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="calendar-status"></span>Calendar</h3>
            <p>Test calendar data loading and event display.</p>
            <button onclick="testCalendar()">Test Calendar</button>
        </div>
        
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="barn-status"></span>Barn Software</h3>
            <p>Test barn monitoring and management features.</p>
            <button onclick="testBarnSoftware()">Test Barn Software</button>
        </div>
        
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="auth-status"></span>Authentication</h3>
            <p>Test login system and user authentication.</p>
            <button onclick="testAuthentication()">Test Authentication</button>
        </div>
        
        <div class="feature-card">
            <h3><span class="status-indicator status-pending" id="data-status"></span>Data Access</h3>
            <p>Test all database connections and permissions.</p>
            <button onclick="testDataConnections()">Test Data Access</button>
        </div>
    </div>

    <script src="config.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-auth.js";

        let app, db, auth;
        let testResults = {};

        function addResult(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function updateStatus(feature, status) {
            const indicator = document.getElementById(`${feature}-status`);
            if (indicator) {
                indicator.className = `status-indicator status-${status}`;
            }
            testResults[feature] = status;
        }

        async function testFirebase() {
            addResult('üî• Testing Firebase initialization...', 'info');
            updateStatus('firebase', 'pending');
            
            try {
                if (!window.firebaseConfig) {
                    throw new Error('Firebase config not found in config.js');
                }
                
                app = initializeApp(window.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                addResult('‚úÖ Firebase initialized successfully', 'success');
                updateStatus('firebase', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
                updateStatus('firebase', 'error');
                return false;
            }
        }

        async function testAuth() {
            addResult('üîê Testing authentication...', 'info');
            updateStatus('auth', 'pending');
            
            try {
                const isLoggedIn = sessionStorage.getItem('flockview_logged_in');
                const authBypass = sessionStorage.getItem('flockview_auth_bypass');
                
                if (isLoggedIn === 'true') {
                    if (authBypass === 'true') {
                        addResult('‚úÖ Bypass authentication active', 'success');
                        updateStatus('auth', 'success');
                        return true;
                    } else {
                        addResult('‚úÖ User authentication active', 'success');
                        updateStatus('auth', 'success');
                        return true;
                    }
                } else {
                    addResult('‚ùå No authentication found', 'error');
                    updateStatus('auth', 'error');
                    return false;
                }
            } catch (error) {
                addResult(`‚ùå Authentication test failed: ${error.message}`, 'error');
                updateStatus('auth', 'error');
                return false;
            }
        }

        async function testDataAccess() {
            addResult('üìä Testing data access...', 'info');
            updateStatus('data', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                // Test reading from feed_schedules collection
                const feedSchedulesRef = collection(db, 'feed_schedules');
                const snapshot = await getDocs(feedSchedulesRef);
                
                addResult(`‚úÖ Data access successful - Found ${snapshot.size} feed schedules`, 'success');
                updateStatus('data', 'success');
                return true;
            } catch (error) {
                if (error.code === 'permission-denied') {
                    addResult('‚ùå Permission denied - Check Firestore rules', 'error');
                } else {
                    addResult(`‚ùå Data access failed: ${error.message}`, 'error');
                }
                updateStatus('data', 'error');
                return false;
            }
        }

        async function testFeedSchedules() {
            addResult('üìÖ Testing feed schedules...', 'info');
            updateStatus('feed', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                const feedSchedulesRef = collection(db, 'feed_schedules');
                const snapshot = await getDocs(feedSchedulesRef);
                
                addResult(`‚úÖ Feed schedules test passed - ${snapshot.size} schedules found`, 'success');
                updateStatus('feed', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Feed schedules test failed: ${error.message}`, 'error');
                updateStatus('feed', 'error');
                return false;
            }
        }

        async function testNotes() {
            addResult('üìù Testing notes system...', 'info');
            updateStatus('notes', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                const notesRef = collection(db, 'notes');
                const snapshot = await getDocs(notesRef);
                
                addResult(`‚úÖ Notes test passed - ${snapshot.size} notes found`, 'success');
                updateStatus('notes', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Notes test failed: ${error.message}`, 'error');
                updateStatus('notes', 'error');
                return false;
            }
        }

        async function testCalendar() {
            addResult('üìÖ Testing calendar system...', 'info');
            updateStatus('calendar', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                // Test multiple collections that feed into calendar
                const collections = ['feed_schedules', 'notes', 'startnewcrop'];
                let totalEvents = 0;
                
                for (const collectionName of collections) {
                    const ref = collection(db, collectionName);
                    const snapshot = await getDocs(ref);
                    totalEvents += snapshot.size;
                }
                
                addResult(`‚úÖ Calendar test passed - ${totalEvents} total events found`, 'success');
                updateStatus('calendar', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Calendar test failed: ${error.message}`, 'error');
                updateStatus('calendar', 'error');
                return false;
            }
        }

        async function testBarnSoftware() {
            addResult('üè† Testing barn software...', 'info');
            updateStatus('barn', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                // Test barn monitoring collections
                const barnCollections = ['vas-b1-f1-MC', 'vas-b1-f2-MC', 'ammonia_levels', 'humidity-density'];
                let totalRecords = 0;
                
                for (const collectionName of barnCollections) {
                    const ref = collection(db, collectionName);
                    const snapshot = await getDocs(ref);
                    totalRecords += snapshot.size;
                }
                
                addResult(`‚úÖ Barn software test passed - ${totalRecords} monitoring records found`, 'success');
                updateStatus('barn', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Barn software test failed: ${error.message}`, 'error');
                updateStatus('barn', 'error');
                return false;
            }
        }

        async function testAuthentication() {
            addResult('üîê Testing authentication system...', 'info');
            updateStatus('auth', 'pending');
            
            try {
                const isLoggedIn = sessionStorage.getItem('flockview_logged_in');
                const authBypass = sessionStorage.getItem('flockview_auth_bypass');
                
                if (isLoggedIn === 'true') {
                    addResult('‚úÖ Authentication system working', 'success');
                    updateStatus('auth', 'success');
                    return true;
                } else {
                    addResult('‚ùå Authentication system not working', 'error');
                    updateStatus('auth', 'error');
                    return false;
                }
            } catch (error) {
                addResult(`‚ùå Authentication test failed: ${error.message}`, 'error');
                updateStatus('auth', 'error');
                return false;
            }
        }

        async function testDataConnections() {
            addResult('üîó Testing all data connections...', 'info');
            updateStatus('data', 'pending');
            
            try {
                if (!db) {
                    throw new Error('Database not initialized');
                }
                
                // Test all major collections
                const collections = [
                    'feed_schedules', 'notes', 'startnewcrop', 'visitor_logs', 
                    'shippingLogs', 'vas-b1-f1-MC', 'vas-b1-f2-MC', 'ammonia_levels', 
                    'humidity-density', 'system_alerts'
                ];
                
                let totalRecords = 0;
                let workingCollections = 0;
                
                for (const collectionName of collections) {
                    try {
                        const ref = collection(db, collectionName);
                        const snapshot = await getDocs(ref);
                        totalRecords += snapshot.size;
                        workingCollections++;
                    } catch (error) {
                        addResult(`‚ö†Ô∏è Collection ${collectionName} has issues: ${error.message}`, 'warning');
                    }
                }
                
                addResult(`‚úÖ Data connections test passed - ${workingCollections}/${collections.length} collections working, ${totalRecords} total records`, 'success');
                updateStatus('data', 'success');
                return true;
            } catch (error) {
                addResult(`‚ùå Data connections test failed: ${error.message}`, 'error');
                updateStatus('data', 'error');
                return false;
            }
        }

        async function runAllTests() {
            clearResults();
            addResult('üöÄ Starting comprehensive system test...', 'info');
            
            const firebaseOk = await testFirebase();
            const authOk = await testAuth();
            const dataOk = await testDataAccess();
            const feedOk = await testFeedSchedules();
            const notesOk = await testNotes();
            const calendarOk = await testCalendar();
            const barnOk = await testBarnSoftware();
            const authSystemOk = await testAuthentication();
            const dataConnOk = await testDataConnections();
            
            const allTests = [firebaseOk, authOk, dataOk, feedOk, notesOk, calendarOk, barnOk, authSystemOk, dataConnOk];
            const passedTests = allTests.filter(test => test === true).length;
            
            if (passedTests === allTests.length) {
                addResult('üéâ ALL TESTS PASSED! Your FlockView system is working perfectly!', 'success');
            } else {
                addResult(`‚ö†Ô∏è ${passedTests}/${allTests.length} tests passed. Some features may not work properly.`, 'warning');
            }
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = '';
            // Reset all status indicators
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(indicator => {
                indicator.className = 'status-indicator status-pending';
            });
            testResults = {};
        }

        function autoBypass() {
            addResult('üöÄ Setting up auto-bypass authentication...', 'info');
            
            // Clear any existing session data
            sessionStorage.clear();
            
            // Set up bypass authentication
            sessionStorage.setItem('flockview_logged_in', 'true');
            sessionStorage.setItem('flockview_user', 'test-user-123');
            sessionStorage.setItem('flockview_email', 'test@example.com');
            sessionStorage.setItem('flockview_auth_bypass', 'true');
            sessionStorage.setItem('flockview_user_display', 'Test User');
            
            addResult('‚úÖ Auto-bypass authentication set up', 'success');
            
            // Run tests after bypass
            setTimeout(() => {
                runAllTests();
            }, 1000);
        }

        // Make functions globally available
        window.runAllTests = runAllTests;
        window.testFirebase = testFirebase;
        window.testAuth = testAuth;
        window.testDataAccess = testDataAccess;
        window.testFeedSchedules = testFeedSchedules;
        window.testNotes = testNotes;
        window.testCalendar = testCalendar;
        window.testBarnSoftware = testBarnSoftware;
        window.testAuthentication = testAuthentication;
        window.testDataConnections = testDataConnections;
        window.clearResults = clearResults;
        window.autoBypass = autoBypass;

        // Auto-run tests on page load
        setTimeout(() => {
            addResult('üîß System ready for testing. Click "Auto-Bypass & Test" to begin.', 'info');
        }, 1000);
    </script>
</body>
</html>
