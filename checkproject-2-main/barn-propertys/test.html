<!DOCTYPE html>
<html lang="en">
<head>

    <link rel="icon" type="image/png" href="/icon.png?v=2">
    <link rel="apple-touch-icon" href="/icon.png?v=2">
    <link rel="icon" type="image/png" sizes="192x192" href="/iconcropped.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/iconcropped.png">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a365d">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Management Hub</title>
    
<script type="module">
   import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-app.js";
   import { 
       getFirestore, collection, addDoc, serverTimestamp, doc, onSnapshot, 
       query, where, getDocs, deleteDoc, updateDoc, getDoc, setDoc
   } from "https://www.gstatic.com/firebasejs/11.3.1/firebase-firestore.js";

   const firebaseConfig = {
       apiKey: "AIzaSyB20OmcQemfIXm4712im9mqiBnpeVt8sJQ",
       authDomain: "chicken-project-2.firebaseapp.com",
       projectId: "chicken-project-2",
       storageBucket: "chicken-project-2.firebasestorage.app",
       messagingSenderId: "596273529964",
       appId: "1:596273529964:web:bd51e2646d5ed48afa4449",
       measurementId: "G-9YLPHR08DB"
   };

   const app = initializeApp(firebaseConfig);
   const db = getFirestore(app);

   let startCropDate = null;
   let currentFloor = 2; // Track current active floor

  function fetchStartDate() {
    const docRef = doc(db, "startnewcrop", "vas-b1-snc");
    const dateInput = document.getElementById("date");

    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const localToday = `${year}-${month}-${day}`;

    if (!dateInput.value) {
        dateInput.value = localToday;
    }

    console.log(`üìÖ Defaulting Bird Adder Date to Today's Date: ${localToday}`);

    onSnapshot(docRef, (docSnap) => {
        if (docSnap.exists() && docSnap.data().date_started) {  
            const data = docSnap.data();
            const firestoreTimestamp = data.date_started.seconds * 1000;
            const originalStartDate = new Date(firestoreTimestamp);
            originalStartDate.setUTCHours(0, 0, 0, 0);

            if (currentFloor === 1) {
                // Floor 1 logic - use original date
                startCropDate = new Date(originalStartDate);
                console.log(`üìÖ Floor 1 Start Date: ${startCropDate.toISOString().split('T')[0]}`);
            } else {
                // Floor 2 logic - use the SAME date as Floor 1, don't subtract
                startCropDate = new Date(originalStartDate);
                console.log(`üìÖ Floor 2 Start Date (same as Floor 1): ${startCropDate.toISOString().split('T')[0]}`);
            }

            const dateStartedField = document.getElementById("date_started");
            if (dateStartedField) {
                dateStartedField.value = startCropDate.toISOString().split('T')[0];
            }

            setTimeout(checkAmmoniaInput, 200);
        } else {
            console.warn("‚ö†Ô∏è No Start Date Found in Firestore. Birds can be added anytime.");
        }
    });
}
window.checkAmmoniaInput = function () {
    if (!startCropDate) return;

    const selectedDate = new Date(document.getElementById("date").value);
    selectedDate.setUTCHours(0, 0, 0, 0);
    
    const daysDiff = Math.floor((selectedDate - startCropDate) / (1000 * 60 * 60 * 24)) + 1;
    const birdCycleDay = daysDiff;

    console.log(`üìÖ Bird Cycle Day: ${birdCycleDay}`);

    let ammoniaDays, displayDay;
    if (currentFloor === 1) {
        ammoniaDays = [21, 28, 35, 42, 49, 56];
        displayDay = birdCycleDay;
    } else {
        // Floor 2: Check for the same days as Floor 1, but save to different collection
        ammoniaDays = [21, 28, 35, 42, 49, 56]; // Same days as Floor 1
        displayDay = birdCycleDay; // Same display
    }

    console.log(`üîç Checking if day ${birdCycleDay} is in ammonia days:`, ammoniaDays);
    console.log(`üìä Current Floor: ${currentFloor}`);

    if (ammoniaDays.includes(birdCycleDay)) {
        document.getElementById("ammonia-input-box").style.display = "block";
        document.getElementById("ammonia-day").innerText = displayDay;
        console.log(`‚úÖ Showing ammonia input for day ${displayDay}`);
    } else {
        document.getElementById("ammonia-input-box").style.display = "none";
        console.log(`‚ùå Hiding ammonia input - day ${birdCycleDay} not in required days`);
    }
};

// Add this event listener in the window.onload function
document.getElementById("date").addEventListener('change', checkAmmoniaInput);

   function validateDateRange() {
       if (!startCropDate) return true;
       
       const selectedDate = new Date(document.getElementById("date").value);
       selectedDate.setUTCHours(0, 0, 0, 0);
       
       const maxDate = new Date(startCropDate);
       if (currentFloor === 1) {
           maxDate.setDate(startCropDate.getDate() + 55);
       } else {
           maxDate.setDate(startCropDate.getDate() + 56);
       }
       maxDate.setUTCHours(0, 0, 0, 0);
       
       if (selectedDate < startCropDate) {
           alert("‚ö†Ô∏è Date reset to Date Placed. Cannot select earlier dates.");
           document.getElementById("date").value = startCropDate.toISOString().split('T')[0];
           return false;
       }
       
       if (selectedDate > maxDate) {
           const maxDays = currentFloor === 1 ? 56 : 56;
           alert(`‚ö†Ô∏è Date reset to maximum allowed (${maxDays} days after Date Placed).`);
           document.getElementById("date").value = maxDate.toISOString().split('T')[0];
           return false;
       }
       
       return true;
   }

   window.saveData = async function () {
       if (!validateDateRange()) return;
       
       const date = document.getElementById("date").value;
       const culls = parseInt(document.getElementById("culls").value) || 0;
       const mortality = parseInt(document.getElementById("mortality").value) || 0;
       const totalDeadBirds = culls + mortality;
       const ammoniaLevel = document.getElementById("ammonia-level").value.trim();
       const formattedDate = date;

       if (!startCropDate) {
           alert("‚ö†Ô∏è Start Date not available. Cannot add birds until it's set in Firestore.");
           return;
       }

       const selectedDate = new Date(date);
       selectedDate.setUTCHours(0, 0, 0, 0);
       const daysDiff = Math.floor((selectedDate - startCropDate) / (1000 * 60 * 60 * 24)) + 1;
       const birdCycleDay = daysDiff;

       try {
           const collectionName = currentFloor === 1 ? "vas-b1-f1-MC" : "vas-b1-f2-MC";
           const mortalityCollection = collection(db, collectionName);
           
           if (currentFloor === 1) {
               // Floor 1: Delete existing records first
               const q = query(mortalityCollection, where("date", "==", formattedDate));
               const querySnapshot = await getDocs(q);

               if (!querySnapshot.empty) {
                   const deletePromises = querySnapshot.docs.map((doc) => deleteDoc(doc.ref));
                   await Promise.all(deletePromises);
                   console.log(`üóëÔ∏è Deleted existing records for ${formattedDate}`);
               }
           }

           let firestoreData = {
               date: formattedDate,
               culls: culls,
               mortality: mortality,
               totalDeadBirds: totalDeadBirds,
               timestamp: serverTimestamp()
           };

           await addDoc(mortalityCollection, firestoreData);
           console.log(`‚úÖ Saved mortality/culls data for ${formattedDate} on Floor ${currentFloor}`);

  // In saveData function, change this part:
let ammoniaDays, ammoniaCollection, ammoniaField;
if (currentFloor === 1) {
    ammoniaDays = [21, 28, 35, 42, 49, 56]; // Same as checkAmmoniaInput
    ammoniaCollection = "ammonia_levels";
    ammoniaField = `day_${birdCycleDay}`;
} else {
    ammoniaDays = [21, 28, 35, 42, 49, 56]; // Same as checkAmmoniaInput and Floor 1
    ammoniaCollection = "ammonia_levels_f2";
    ammoniaField = `day_${birdCycleDay}`; // Same as Floor 1
}

           if (ammoniaDays.includes(birdCycleDay)) {
               if (ammoniaLevel === "") {
                   alert("‚ö†Ô∏è Please enter an ammonia level for this required day.");
                   return;
               }

               const ammoniaDocRef = doc(db, ammoniaCollection, "fixed_days");
               
               try {
                   const docSnap = await getDoc(ammoniaDocRef);
                   
                   if (docSnap.exists()) {
                       await updateDoc(ammoniaDocRef, {
                           [ammoniaField]: Number(ammoniaLevel),
                           timestamp: serverTimestamp()
                       });
                       console.log(`‚úÖ Updated Ammonia Level ${ammoniaField}: ${ammoniaLevel} PPM in ${ammoniaCollection}`);
                   } else {
                       console.error(`‚ùå 'fixed_days' document does not exist in ${ammoniaCollection}!`);
                       // Create the document if it doesn't exist
                       await setDoc(ammoniaDocRef, {
                           [ammoniaField]: Number(ammoniaLevel),
                           timestamp: serverTimestamp()
                       });
                       console.log(`‚úÖ Created new document and saved ammonia level ${ammoniaField}: ${ammoniaLevel} PPM`);
                   }
               } catch (error) {
                   console.error(`‚ùå Error saving ammonia level:`, error);
                   alert("Failed to save ammonia level. Check console for details.");
               }
           }

           alert(`‚úÖ Data saved successfully for ${formattedDate} on Floor ${currentFloor}`);
       } catch (error) {
           console.error("‚ùå Error saving data:", error);
           alert("Failed to save data. Check the console for details.");
       }
   };

   // Adjustment functions for quick +/- buttons
   window.adjustCull = function(change) {
       const cullInput = document.getElementById('culls');
       const currentValue = parseInt(cullInput.value) || 0;
       const newValue = Math.max(0, currentValue + change);
       cullInput.value = newValue;
       
       cullInput.style.background = '#e8f5e8';
       setTimeout(() => {
           cullInput.style.background = '';
       }, 300);
   };

   window.adjustMortality = function(change) {
       const mortalityInput = document.getElementById('mortality');
       const currentValue = parseInt(mortalityInput.value) || 0;
       const newValue = Math.max(0, currentValue + change);
       mortalityInput.value = newValue;
       
       mortalityInput.style.background = '#e8f5e8';
       setTimeout(() => {
           mortalityInput.style.background = '';
       }, 300);
   };

   // Touch swipe functionality for mobile
   let touchStartX = null;
   let touchStartY = null;
   const minSwipeDistance = 50; // Minimum distance for a swipe
   const maxVerticalDistance = 100; // Maximum vertical movement to still count as horizontal swipe

   function handleTouchStart(e) {
       touchStartX = e.touches[0].clientX;
       touchStartY = e.touches[0].clientY;
   }

window.switchFloor = function(floor) {
    currentFloor = floor;
    
    // Update toggle position to match floor
    const toggle = document.getElementById('floor_toggle');
    toggle.checked = (floor === 2); // FIXED: Floor 1 = checked (right/top), Floor 2 = unchecked (left/bottom)
    
    // Update header to show correct floor number
    document.getElementById('floor-title').textContent = `Vassilakos Farm - Barn 1 - Floor ${floor}`;
    
    // Clear form
    document.getElementById("date").value = "";
    document.getElementById("culls").value = "";
    document.getElementById("mortality").value = "";
    document.getElementById("ammonia-level").value = "";
    document.getElementById("ammonia-input-box").style.display = "none";
    
    // Refresh start date for new floor
    fetchStartDate();
    
    // Update button panel visibility
    updateButtonPanel();
};

window.switchFloorToggle = function() {
    const toggle = document.getElementById('floor_toggle');
    const newFloor = toggle.checked ? 2 : 1; // FLIPPED: checked = bottom (Floor 2), unchecked = top (Floor 1)
    switchFloor(newFloor);
};
   function handleTouchEnd(e) {
       if (!touchStartX || !touchStartY) return;

       const touchEndX = e.changedTouches[0].clientX;
       const touchEndY = e.changedTouches[0].clientY;
       
       const deltaX = touchEndX - touchStartX;
       const deltaY = Math.abs(touchEndY - touchStartY);
       
       // Check if it's a horizontal swipe (not too much vertical movement)
       if (deltaY > maxVerticalDistance) {
           touchStartX = null;
           touchStartY = null;
           return;
       }
       
       // Check if swipe distance is sufficient
       if (Math.abs(deltaX) > minSwipeDistance) {
           if (deltaX > 0) {
               // Swipe right - go to Floor 1
               if (currentFloor !== 1) {
                   switchFloor(1);
               }
           } else {
               // Swipe left - go to Floor 2
               if (currentFloor !== 2) {
                   switchFloor(2);
               }
           }
       }
       
       touchStartX = null;
       touchStartY = null;
   }

   // Add touch event listeners
   document.addEventListener('touchstart', handleTouchStart, { passive: true });
   document.addEventListener('touchend', handleTouchEnd, { passive: true });

window.onload = function() {
    console.log("üöÄ Combined Farm Management page loaded");
    
    // Set initial floor to 2 (Bottom Floor)
    switchFloor(1);
    

    
    // Initialize touch events for swipe functionality
    console.log("üì± Touch swipe functionality enabled");
};
</script>
<style>
body {
    margin-top: 140px !important;
    padding-top: 20px !important;
}
</style>
</head>
<script src="load-header.js"></script>
<body>
<!-- Floor Toggle Navigation -->
<div class="floor-toggle-container">
    <span class="floor-label">Bottom Floor</span>
    <label class="floor-toggle">
<input type="checkbox" id="floor_toggle" checked onchange="switchFloorToggle()">
        <span class="floor-toggle-slider"></span>
    </label>
    <span class="floor-label">Top Floor</span>
</div>
    <h2 id="floor-title">Vassilakos Farm - Barn 1 - Floor 1</h2>
    
    <div class="container">
        <label>Date</label><br>
        <input type="date" id="date" required onchange="checkAmmoniaInput()"><br>

        <label>Culls</label><br>
        <input type="number" id="culls" min="0" placeholder="Enter culls"><br>

        <label>Mortality</label><br>
        <input type="number" id="mortality" min="0" placeholder="Enter mortality"><br>

        <!-- Ammonia Level Input (Hidden by Default) -->
        <div id="ammonia-input-box" class="ammonia-box" style="display: none;">
            <h3>Enter Ammonia Level for Day <span id="ammonia-day"></span></h3>
            <label for="ammonia-level">PPM:</label>
            <input type="number" id="ammonia-level" placeholder="Enter PPM">
        </div>

        <button onclick="saveData()">SAVE</button>
    </div>

    <!-- Quick Adjustment Buttons (Only shown for Floor 1) -->
    <div class="button-panel" id="button-panel">
        <button class="side-button plus-cull" onclick="adjustCull(1)" data-tooltip="Add Cull">+1<br>CULL</button>
        <button class="side-button minus-cull" onclick="adjustCull(-1)" data-tooltip="Remove Cull">-1<br>CULL</button>
        <button class="side-button plus-mort" onclick="adjustMortality(1)" data-tooltip="Add Mortality">+1<br>MORT</button>
        <button class="side-button minus-mort" onclick="adjustMortality(-1)" data-tooltip="Remove Mortality">-1<br>MORT</button>
    </div>
</body>

<style>
    body {
        font-family: 'Arial', sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Tab Styles */
    .tab-container {
        display: flex;
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .tab-button {
        background-color: #e0e0e0;
        color: #333;
        border: none;
        padding: 12px 24px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        transition: all 0.3s ease;
        border-right: 1px solid #ccc;
    }

    .tab-button:last-child {
        border-right: none;
    }

    .tab-button:hover {
        background-color: #d0d0d0;
    }

    .tab-button.active {
        background-color: #2e7d32;
        color: white;
    }

    h2 {
        color: #2e7d32;
        text-align: center;
        margin-bottom: 20px;
        font-size: 28px;
    }

    .container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 25px;
        width: 100%;
        max-width: 400px;
    }

    label {
        font-weight: bold;
        color: #333;
        display: block;
        margin-bottom: 5px;
    }

    input {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }

    input:focus {
        outline: none;
        border-color: #2e7d32;
        box-shadow: 0 0 5px rgba(46, 125, 50, 0.3);
    }

    button {
        background-color: #2e7d32;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 12px 20px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        font-weight: bold;
        text-transform: uppercase;
        transition: background-color 0.3s;
    }

    button:hover {
        background-color: #1b5e20;
    }

    .ammonia-box {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
    }

    .ammonia-box h3 {
        margin: 0 0 10px 0;
        color: #856404;
    }

    /* Make inputs bigger on mobile for better touch targets */
    @media (max-width: 600px) {
        input {
            padding: 12px;
        }
        
        button {
            padding: 14px 20px;
        }
    }

    /* Right Side Button Panel (Only for Floor 1) */
    .button-panel {
        position: fixed;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 15px;
        z-index: 1000;
    }

    .side-button {
        width: 80px;
        height: 80px;
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 14px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        text-align: center;
        line-height: 1.2;
    }

    .side-button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }

    .side-button.plus-cull {
        background: #2e7d32;
    }

    .side-button.minus-cull {
        background: #d32f2f;
    }

    .side-button.plus-mort {
        background: #2e7d32;
    }

    .side-button.minus-mort {
        background: #d32f2f;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .button-panel {
            right: 10px;
            gap: 10px;
        }
        
        .side-button {
            width: 60px;
            height: 60px;
            font-size: 12px;
        }

        .tab-container {
            width: 100%;
            max-width: 400px;
        }
    }

    /* Tooltip for buttons */
    .side-button::before {
        content: attr(data-tooltip);
        position: absolute;
        right: 90px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 12px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .side-button:hover::before {
        opacity: 1;
    }

    /* Hide button panel for Floor 2 */
    body:not(.floor-1) .button-panel {
        display: none;
    }

    /* Floor Toggle Styles */
.floor-toggle-container {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
    padding: 15px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.floor-label {
    font-weight: bold;
    color: #333;
    font-size: 16px;
    transition: color 0.3s ease;
}

.floor-toggle {
    position: relative;
    display: inline-block;
    width: 200px;
    height: 50px;
    cursor: pointer;
}

.floor-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.floor-toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #2e7d32;
    transition: .4s;
    border-radius: 25px;
}

.floor-toggle-slider:before {
    position: absolute;
    content: "";
    height: 42px;
    width: 42px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

.floor-toggle input:checked + .floor-toggle-slider:before {
    transform: translateX(150px);
}

@media (max-width: 768px) {
    .floor-toggle-container {
        gap: 15px;
    }
    
    .floor-label {
        font-size: 14px;
    }
    
    .floor-toggle {
        width: 160px;
        height: 40px;
    }
    
    .floor-toggle-slider:before {
        height: 32px;
        width: 32px;
    }
    
    .floor-toggle input:checked + .floor-toggle-slider:before {
        transform: translateX(116px);
    }
}
</style>

<script>
    // Add this to handle showing/hiding the button panel based on floor
    function updateButtonPanel() {
        const buttonPanel = document.getElementById('button-panel');
        if (currentFloor === 1) {
            buttonPanel.style.display = 'flex';
        } else {
            buttonPanel.style.display = 'none';
        }
    }

    // Initialize button panel on load
    window.addEventListener('load', updateButtonPanel);
</script>
</html>